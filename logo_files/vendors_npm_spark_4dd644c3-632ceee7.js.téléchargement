(window.webpackJsonptheoWebApp=window.webpackJsonptheoWebApp||[]).push([[15],{"13MC":function(t,e,i){var n,r,a,s,o,l,u,c=e,h=i("oAGj"),f=i("SpAV"),p=i("fVJ2"),d=i("dJuF"),m=i("SmK9");c.IDBObjectState=h.defineProtocol("IDBObjectState",{id:"String",className:"String",properties:"Dictionary<String>",allProperties:"Dictionary<String>",object:"IDBObject",checkpoint:"() -> IDBObjectState",getProperty:"(String) -> DBProperty",apply:"(Array<IDBObjectState>) -> Void",diff:"(IDBObjectState) -> Dictionary<String>",depth:"Integer",forEachProperty:"(Boolean, (String, DBProperty) -> Void) -> Void"}),c.IDBObjectAncestorState=h.defineProtocol("IDBObjectAncestorState",{isAncestorOf:"(IDBObjectDerivedState) -> Boolean"}),c.IDBObjectDerivedState=h.defineProtocol("IDBObjectDerivedState",{basedOn:"IDBObjectAncestorState"}),c.IDBObjectMutableState=h.defineProtocol("IDBObjectMutableState",{setProperty:"(String, DBProperty) -> Void",updateProperty:"(String, Any, DBPropertyCodec) -> Boolean",removeProperty:"(String) -> Void",clear:"() -> Void",assign:"(IDBObject) -> IDBObjectState",commit:"() -> IDBObjectState"}),c.IDBObjectMutableAncestorState=h.defineProtocol("IDBObjectMutableAncestorState",{flattenFrom:"(IDBObjectDerivedState) -> Void"}),c.IDBObjectMutableDerivedState=h.defineProtocol("IDBObjectMutableDerivedState",{}),c.IDBState=h.defineProtocol("IDBState",{guid:"String",branch:"String",basedOn:"IDBState",database:"IDatabase",objectStates:"Dictionary<String>",allObjectStates:"Dictionary<String>",getDerivedState:"(String) -> IDBState",apply:"() -> Void",getObjectStateByID:"(String) -> IDBObjectState",getObjectState:"(DBObject) -> IDBObjectState",forEachObjectState:"(Boolean, (String, IDBObjectState) -> Void) -> Void",validate:"() -> IDBValidationResult",encode:"(IExportDataObject, Integer) -> Void"}),c.IDBMutableState=h.defineProtocol("IDBMutableState",{makeObjectMutable:"(DBObject) -> Void",newObjectState:"(DBObject) -> IDBObjectMutableState",setObjectState:"(DBObject, IDBObjectState) -> Void",addNewObject:"(DBObject, IDBObjectState) -> Void",commit:"() -> IDBState",abandon:"() -> Void",flattenFrom:"(IDBState) -> Void"}),c.DBObjectBaseState=(n=function(){},h.defineClass({name:"DBObjectBaseState",ctor:n,props:{basedOn:{get:function(){return null}},isAncestorOf:function(t){for(var e=t.basedOn;null!=e;){if(e===this)return!0;e=h.opt(h.as(e,c.IDBObjectDerivedState),(function(t){return t.basedOn}))}return!1},properties:{get:function(){return{}}},id:{get:function(){return h.opt(this.properties.id,(function(t){return t.stringValue}))}},depth:{get:function(){return 0}},allProperties:{get:function(){var t=h.clone(this.properties);if(null!=this.basedOn)for(var e=h.iter(h.opt(this.basedOn,(function(t){return t.allProperties})));!e.done;e.next()){var i=e.key,n=e.value;null==t[i]&&(t[i]=n)}for(var r=h.keys(t).filter((function(e){return t[e]instanceof d.DBDeletedProperty}),this),a=h.iter(r);!a.done;a.next()){var s=a.value;h.removeKey(t,s)}return t}},getProperty:function(t){return this.properties[t]||h.opt(this.basedOn,(function(e){return e.getProperty(t)}))},diff:function(t){var e=this,i={};if(t!==this)if(null!=this.basedOn&&h.as(t,c.IDBObjectAncestorState)===this.basedOn)this.forEachProperty(!1,(function(e,n){var r;(r=t.getProperty(e))?r.isEqual(n)||(i[e]=[n,r]):i[e]=[n,null]}));else if(h.opt(h.as(t,c.IDBObjectDerivedState),(function(t){return t.basedOn===e})))t.forEachProperty(!1,(function(t,n){var r;(r=e.getProperty(t))?r.isEqual(n)||(i[t]=[r,n]):i[t]=[null,n]}));else{var n=h.clone(this.allProperties);t.forEachProperty(!0,(function(t,e){var r;(r=h.removeKey(n,t))?r.isEqual(e)||(i[t]=[r,e]):i[t]=[null,e]})),h.each(n,(function(t,e){i[t]=[e,null]}))}return i},forEachProperty:function(t,e){var i,n={};h.each(this.properties,(function(t,i){e(t,i),n[t]=!0})),t&&(i=this.basedOn)&&i.forEachProperty(!0,(function(t,i){null==n[t]&&(e(t,i),n[t]=!0)}))},notifyParentChange:function(t,e,i){if(null!=e&&0==!e.length)for(var n=h.iter(e);!n.done;n.next()){var r,a=n.value;if(r=h.as(a,c.DBChildObjectState)){for(var s=r.propertyPath,o=h.as(h.opt(r.parentObject,(function(t){return t.state})),c.DBChildObjectState);null!=o;)s=o.propertyPath.appendPath(s),o=h.as(h.opt(h.opt(o,(function(t){return t.parentObject})),(function(t){return t.state})),c.DBChildObjectState);i(r,h.clone(r.deltaForPropertyPath(h.clone(t),s)))}}},notifyParentWillChange:function(t,e){this.notifyParentChange(h.clone(t),h.clone(e),(function(t,e){return t.parentWillChangeState(h.clone(e))}))},notifyParentDidChange:function(t,e){this.notifyParentChange(h.clone(t),h.clone(e),(function(t,e){return t.parentDidChangeState(h.clone(e))}))}}}),n),c.DBObjectDeletedState=(r=function(t){this.obj_=t},h.defineClass({name:"DBObjectDeletedState",ctor:r,statics:{_implements:function(t){return"IDBObjectState"==t}},props:{id:{get:function(){return null}},className:{get:function(){return""}},properties:{get:function(){return{}}},allProperties:{get:function(){return{}}},object:{get:function(){return this.obj_}},checkpoint:function(){return new r(this.object)},depth:{get:function(){return 0}},getProperty:function(t){return null},apply:function(t){},diff:function(t){var e={};if(t!==this)for(var i=h.clone(t.allProperties),n=h.iter(h.keys(i));!n.done;n.next()){var r=n.value;e[r]=[null,i[r]]}return e},forEachProperty:function(t,e){}}}),r),c.DBObjectState=(a=function(){},h.defineClass({name:"DBObjectState",ctor:a,superName:"DBObjectBaseState",statics:{_implements:function(t){return"IDBObjectDerivedState"==t||"IDBObjectState"==t||"IDBObjectAncestorState"==t}},props:{init_be8f:function(t){this.basedOn_=null,this.properties_={},this.obj_=t,this.className_=t.className,c.DBObjectBaseState.call(this)},init_2a9a:function(t,e){this.basedOn_=null,this.properties_=h.clone(e),this.obj_=t,this.className_=t.className,c.DBObjectBaseState.call(this)},init_9f95:function(t,e){this.basedOn_=t,this.properties_=h.clone(e),this.obj_=t.obj_,this.className_=t.className_,f.CoreAssert.isTrue(null!=this.obj_,"Created a new state on an object that has been destroyed.","DBObjectState.init","DBState.swift",425),c.DBObjectBaseState.call(this)},basedOn:{get:function(){return this.basedOn_}},className:{get:function(){return this.className_}},properties:{get:function(){return this.properties_}},getProperty:function(t){return this.properties_[t]||h.opt(this.basedOn_,(function(e){return e.getProperty(t)}))},object:{get:function(){return this.obj_}},checkpoint:function(){return a.init_2a9a(this.object,h.clone(this.allProperties))},apply:function(t){if(this.obj_.state!==this){var e=h.clone(this.diff(this.obj_.state));h.count(e)>0&&this.notifyParentWillChange(h.clone(e),h.clone(t)),this.obj_.state=this,h.count(e)>0&&this.notifyParentDidChange(h.clone(e),h.clone(t))}}}}),a),c.DBObjectMutableState=(s=function(){this.mutableProperties_={}},h.defineClass({name:"DBObjectMutableState",ctor:s,superName:"DBObjectBaseState",statics:{_implements:function(t){return"IDBObjectDerivedState"==t||"IDBObjectState"==t||"IDBObjectMutableAncestorState"==t||"IDBObjectAncestorState"==t||"IDBObjectMutableState"==t||"IDBObjectMutableDerivedState"==t}},props:{init_6f66:function(t){this.className_=t,c.DBObjectBaseState.call(this)},init_226b:function(t){this.obj_=t.object,this.basedOn_=t,this.className_=t.className,c.DBObjectBaseState.call(this)},init_be8f:function(t){this.obj_=t,this.className_=t.className,c.DBObjectBaseState.call(this)},init_6271:function(t,e){this.mutableProperties_=h.clone(e),this.className_=t,c.DBObjectBaseState.call(this)},init_2a9a:function(t,e){this.obj_=t,this.mutableProperties_=h.clone(e),this.className_=t.className,c.DBObjectBaseState.call(this)},init_9f95:function(t,e){this.obj_=t.object,this.basedOn_=t,this.mutableProperties_=h.clone(e),this.className_=t.className,c.DBObjectBaseState.call(this)},basedOn:{get:function(){return this.basedOn_}},className:{get:function(){return this.className_}},properties:{get:function(){return this.mutableProperties_}},getProperty:function(t){return this.mutableProperties_[t]||h.opt(this.basedOn_,(function(e){return e.getProperty(t)}))},object:{get:function(){var t=null!=this.obj_?this.obj_:h.opt(this.basedOn,(function(t){return t.object}));return f.CoreAssert.isTrue(null!=t,"Mutable state not yet committed to an object","DBObjectMutableState","DBState.swift",529),t}},checkpoint:function(){return s.init_2a9a(this.object,h.clone(this.allProperties))},setProperty:function(t,e){f.CoreAssert.isTrue(t==e.name,"Setting property for field "+e.name+" to field "+t,"DBObjectMutableState.setProperty","DBState.swift",538),this.mutableProperties_[t]=e},updateProperty:function(t,e,i){var n,r;if((n=this.mutableProperties_[t])&&null!=(r=i.update)&&!(n instanceof d.DBDeletedProperty)){var a=r(n,e);return a!==n&&this.setProperty(t,a),!0}return!1},removeProperty:function(t){this.mutableProperties_[t]=d.DBProperty.deleted(d.DBNamePath.init_b14a(t))},clear:function(){for(var t=h.iter(h.keys(this.allProperties));!t.done;t.next()){var e=t.value;this.removeProperty(e)}},apply:function(t){var e;if(e=null!=this.obj_?this.obj_:h.opt(this.basedOn,(function(t){return t.object}))){var i=h.clone(this.diff(e.state));this.notifyParentWillChange(h.clone(i),h.clone(t)),e.state=this,this.notifyParentDidChange(h.clone(i),h.clone(t))}},assign:function(t){var e=null;this.basedOn_ instanceof c.DBObjectState?e=this.basedOn_:this.basedOn_ instanceof s&&(e=this.basedOn_.assign(t));var i=h.as(t,p.DBObject);h.opt(i,(function(t){return t.willCommitState()}));var n=null!=e?c.DBObjectState.init_9f95(e,h.clone(this.mutableProperties_)):c.DBObjectState.init_2a9a(t,h.clone(this.mutableProperties_));return t.state=n,this.obj_=t,h.opt(i,(function(t){return t.didCommitState()})),n},commit:function(){return this.assign(this.object)},flattenFrom:function(t){for(var e=[],i=t;i!==this&&null!=i;)e.splice(0,0,i),i=h.as(i.basedOn,c.IDBObjectDerivedState);for(var n=h.iter(e);!n.done;n.next())for(var r=n.value,a=h.clone(this.diff(r)),s=h.iter(a);!s.done;s.next()){var o=s.key,l=s.value;null!=l[1]?this.mutableProperties_[o]=l[1]:h.removeKey(this.mutableProperties_,o)}}}}),s),c.DBChildObjectState=(o=function(){},h.defineClass({name:"DBChildObjectState",ctor:o,statics:{_implements:function(t){return"IDBObjectState"==t||"IDBObjectMutableState"==t}},props:{pendingProperties:{get:function(){return this.pendingProperties_}},init_7008:function(t,e,i){this.obj_=t,this.parentObject_=e,this.propertyPath_=i},init_94ed:function(t,e){this.obj_=null,this.parentObject_=t,this.propertyPath_=e},id:{get:function(){return h.opt(this.properties.id,(function(t){return t.stringValue}))}},className:{get:function(){return this.obj_.className}},parentObject:{get:function(){return this.parentObject_}},propertyPath:{get:function(){return this.propertyPath_}},parentProperty:{get:function(){var t,e=null;return(t=h.opt(this.parentObject_,(function(t){return t.state})))&&this.propertyPath_.forEach((function(i){var n,r;null==e?e=t.getProperty(i.name):null!=(n=h.toInt(i.name))&&(r=h.opt(e,(function(t){return t.arrayValue})))?n<r.length&&(e=r[n]):null!=e&&e.isDictionary&&(e=e.getDictionaryProperty(i.name))})),e}},properties:{get:function(){return null!=this.pendingProperties_?this.pendingProperties_:h.opt(this.parentProperty,(function(t){return t.dictionaryValue}))||{}}},depth:{get:function(){var t;return((t=h.opt(h.as(h.opt(this.parentObject_,(function(t){return t.state})),c.IDBObjectMutableState),(function(t){return t.depth})))||null!=t?t:0)+1}},allProperties:{get:function(){return this.properties}},object:{get:function(){return this.obj_},set:function(t){this.obj_!==t&&(f.CoreAssert.isTrue(null==this.obj_,"This state already has an object assigned","DBChildObjectState","DBState.swift",697),this.obj_=t)}},checkpoint:function(){return this},getProperty:function(t){return null!=this.pendingProperties_?this.pendingProperties_[t]:h.opt(this.parentProperty,(function(e){return e.getDictionaryProperty(t)}))},deltaFromParentDelta:function(t){return this.deltaForPropertyPath(h.clone(t),this.propertyPath)},parentWillChangeState:function(t){var e;(e=h.as(this.obj_,p.DBObject))&&h.count(t)>0&&e.willChangeState(h.clone(t))},parentDidChangeState:function(t){var e;(e=h.as(this.obj_,p.DBObject))&&h.count(t)>0&&(e.clearCache(),e.didChangeState(h.clone(t)))},savePropertyDict:function(t){var e,i;if((e=h.as(this.parentObject_,p.DBObject))&&(i=h.as(this.object,p.DBObject))){if(null==e.childObjects.find((function(t){return t.id==i.id}),this))return;for(var n=h.clone(m.DBSchema.getCodecChain(h.clone(this.propertyPath_.path),this.parentObject_)),r=this.propertyPath_,a=h.last(n)[0].encode(r,this.obj_,null);0==!n.length;){n.pop();var s=r.name;if(r=r.parent,0==n.length)e.setProperty(s,a);else{var o,l,u=null;if(null!=(o=h.last(n))&&(u=o[1]),u instanceof d.DBDeletedProperty)a=u;else if(null!=(l=h.toInt(s))){for(var c=h.clone(u.arrayValue);l>=c.length;)c.push(d.DBProperty.deleted(r.append(h.toString(c.length))));c[l]=a,a=d.DBProperty.arrayProperty(r,h.clone(c))}else{var f=h.clone(u.dictionaryValue);f[s]=a,a=d.DBProperty.dictProperty(r,h.clone(f))}}}}},savePendingProperties:function(){null!=this.pendingProperties_&&(this.savePropertyDict(h.clone(this.pendingProperties_)),this.pendingProperties_=null)},abandonPendingProperties:function(){this.pendingProperties_=null},setProperty:function(t,e){if(null==this.pendingProperties_){for(var i={},n=h.iter(this.properties);!n.done;n.next()){var r=n.key,a=n.value;r!=t&&(i[r]=a.copy())}this.pendingProperties_=h.clone(i)}e.reroot(d.DBNamePath.init_b14a(t)),this.pendingProperties_[t]=e,this.savePropertyDict(h.clone(this.pendingProperties_))},canUpdate:{get:function(){var t;return(t=h.opt(h.as(h.opt(this.parentObject_,(function(t){return t.state})),o),(function(t){return t.canUpdate})))||null!=t?t:h.is(h.opt(this.parentObject_,(function(t){return t.state})),c.IDBObjectMutableState)}},updateProperty:function(t,e,i){var n,r;if(null!=this.pendingProperties_&&(n=this.properties[t])&&null!=(r=i.update)&&!(n instanceof d.DBDeletedProperty)&&this.canUpdate){var a=r(n,e);return a!==n&&this.setProperty(t,a),!0}return!1},removeProperty:function(t){this.setProperty(t,new d.DBDeletedProperty(d.DBNamePath.init_b14a(t)))},setProperties:function(t){if(null==this.pendingProperties_){for(var e={},i=h.iter(this.properties);!i.done;i.next()){var n=i.key,r=i.value;null==t[n]&&(e[n]=r.copy())}for(var a=h.iter(t);!a.done;a.next())n=a.key,(r=a.value).reroot(d.DBNamePath.init_b14a(n)),e[n]=r;this.pendingProperties_=h.clone(e),this.savePropertyDict(h.clone(this.pendingProperties_))}},clear:function(){if(null==this.pendingProperties_){for(var t=h.clone(this.properties),e=h.iter(h.keys(this.properties));!e.done;e.next()){var i=e.value;t[i]=new d.DBDeletedProperty(d.DBNamePath.init_b14a(i))}this.pendingProperties_=h.clone(t),this.savePropertyDict(h.clone(this.pendingProperties_))}},deltaForPropertyPath:function(t,e){var i,n,r,a={},s=h.clone(e.path);if(null!=(r=t[s.shift()])){for(var o=r[0],l=r[1];0==!s.length&&(null!=o||null!=l);){var u,c=s.shift();if(null!=(u=h.toInt(c))){var f=(i=h.opt(h.opt(o,(function(t){return t.arrayValue})),(function(t){return t.length})))||null!=i?i:0,p=(n=h.opt(h.opt(l,(function(t){return t.arrayValue})),(function(t){return t.length})))||null!=n?n:0;o=u<f?h.opt(h.opt(o,(function(t){return t.arrayValue})),(function(t){return t[u]})):null,l=u<p?h.opt(h.opt(l,(function(t){return t.arrayValue})),(function(t){return t[u]})):null}else o=h.opt(o,(function(t){return t.getDictionaryProperty(c)})),l=h.opt(l,(function(t){return t.getDictionaryProperty(c)}))}null!=o&&o.isDictionary?(o.forEachDictionaryProperty((function(t,e){a[t]=[e,h.opt(l,(function(e){return e.getDictionaryProperty(t)}))]})),null!=l&&l.isDictionary&&l.forEachDictionaryProperty((function(t,e){h.keys(a).includes(t)||(a[t]=[null,e])}))):null!=l&&l.isDictionary&&l.forEachDictionaryProperty((function(t,e){a[t]=[null,e]}))}return a},diff:function(t){var e={};if(t!==this){for(var i=h.clone(this.properties),n=h.clone(t.properties),r=h.iter(h.keys(i));!r.done;r.next()){var a,s=i[c=r.value];(a=t.getProperty(c))?s.isEqual(a)||(e[c]=[s,t.getProperty(c)]):e[c]=[s,null]}for(var o=h.keys(n),l=h.keys(i),u=h.iter(o);!u.done;u.next()){var c=u.value;l.includes(c)||(e[c]=[null,n[c]])}}return e},forEachProperty:function(t,e){h.each(this.properties,(function(t,i){return e(t,i)}))},apply:function(t){h.opt(this.parentObject_,(function(t){return t.state.apply(null)}))},assign:function(t){return o.init_7008(t,this.parentObject_,this.propertyPath_)},commit:function(){return this}}}),o),c.DBState=(l=function(){this.derivedStateIDs={}},h.defineClass({name:"DBState",ctor:l,statics:{_implements:function(t){return"IDBState"==t}},props:{database:{get:function(){return this.db_}},objectStates:{get:function(){return this.objectStates_}},allObjectStates:{get:function(){var t=h.dict([this.guid,this]),e=h.clone(this.objectStates),i=this.basedOn;for(f.CoreAssert.isTrue(this.generation_<200,"Depth of database states unusually high","DBState","DBState.swift",990);null!=i&&(f.CoreAssert.isTrue(null==t[i.guid],"Found a state cycle","DBState","DBState.swift",993),null==t[i.guid]);){t[i.guid]=i;for(var n=h.iter(i.objectStates);!n.done;n.next()){var r=n.key,a=n.value;null==e[r]&&(e[r]=a)}i=i.basedOn}return e}},init_40bf:function(t,e,i,n){this.db_=t,this.basedOn=null,this.generation_=0,this.objectStates_=h.clone(n),this.branch=e,this.guid=i},init_62ed:function(t,e,i,n){this.db_=t.database,this.basedOn=t,this.generation_=t.generation_+1,this.objectStates_=h.clone(n),this.branch=e,this.guid=i,t.derivedStateIDs[e]=i},checkpoint:function(){var t={};return this.forEachObjectState(!0,(function(e,i){t[e]=i.checkpoint()})),l.init_40bf(this.db_,this.branch,this.guid,h.clone(t))},descendsFrom:function(t){return this===t||this.basedOn instanceof l&&this.basedOn.descendsFrom(t)},getDerivedState:function(t){return null!=this.derivedStateIDs[t]?this.db_.getState(this.derivedStateIDs[t]):null},apply:function(){this.applyInternal(!0)},applyInternal:function(t){var e=[];this.forEachObjectState(!0,(function(t,i){return e.push([t,i])}));for(var i=h.iter(e);!i.done;i.next()){var n,r=i.value,a=r[0],s=r[1],o=this.db_.getObject(a);if(n=h.opt(o,(function(t){return t.descendantObjects}))){var l=n.map((function(t){return t.state}),this);s.apply(h.clone(l))}else s.apply(null)}t&&this.db_.stateChanged(this)},getObjectStateByID:function(t){return null!=t?this.objectStates_[t]||h.opt(this.basedOn,(function(e){return e.getObjectStateByID(t)})):null},getObjectState:function(t){return this.getObjectStateByID(t.id)},forEachObjectState:function(t,e){var i,n={};h.each(this.objectStates_,(function(t,i){e(t,i),n[t]=!0})),t&&(i=this.basedOn)&&i.forEachObjectState(!0,(function(t,i){null==n[t]&&(e(t,i),n[t]=!0)}))},validate:function(){var t,e,i=h.clone(this.allObjectStates);return(t=h.as(this.database.host,p.DBObject))&&(e=i[t.id])?m.DBSchema.getValidator(t.className)(e):new m.DBValidationErrorNoHost},encode:function(t,e){var i;if(m.DBSchema.currentSchema=m.DBSchema.init_2af7(e),i=h.as(this.database.host,p.DBObject)){var n=m.DBSchema.getDataObjectWriter(t,i.id,this,this.database);m.DBSchema.getSerializer(i.className)(this.getObjectState(i),n)}}}}),l),c.DBMutableState=(u=function(){this.objectMutableStates_={},this.newObjectIDs_=[]},h.defineClass({name:"DBMutableState",ctor:u,superName:"DBState",statics:{_implements:function(t){return"IDBMutableState"==t||"IDBState"==t}},props:{objectStates:{get:function(){return this.objectMutableStates_}},init_4be2:function(t,e,i){h.super_init(this,c.DBState,c.DBState.prototype.init_40bf,t,e,i,{})},init_1198:function(t,e,i){var n;if(h.super_init(this,c.DBState,c.DBState.prototype.init_62ed,t,e,i,{}),n=h.as(t,u))for(var r=h.iter(n.objectMutableStates_);!r.done;r.next()){var a,s=r.key,o=r.value;(a=h.as(o,c.IDBObjectAncestorState))&&(this.objectMutableStates_[s]=c.DBObjectMutableState.init_226b(a))}},init_40bf:function(t,e,i,n){h.super_init(this,c.DBState,c.DBState.prototype.init_40bf,t,e,i,h.clone(n));for(var r=h.iter(this.objectStates_);!r.done;r.next()){var a,s=r.key,o=r.value;(a=h.as(o,c.IDBObjectAncestorState))&&(this.objectMutableStates_[s]=c.DBObjectMutableState.init_226b(a))}},init_62ed:function(t,e,i,n){h.super_init(this,c.DBState,c.DBState.prototype.init_62ed,t,e,i,h.clone(n));for(var r=h.iter(this.objectStates_);!r.done;r.next()){var a,s=r.key,o=r.value;(a=h.as(o,c.IDBObjectAncestorState))&&(this.objectMutableStates_[s]=c.DBObjectMutableState.init_226b(a))}},getObjectStateByID:function(t){return null!=t?this.objectMutableStates_[t]||c.DBState.prototype.getObjectStateByID.call(this,t):null},forEachObjectState:function(t,e){var i,n={};h.each(this.objectMutableStates_,(function(t,i){e(t,i),n[t]=!0})),t&&(i=this.basedOn)&&i.forEachObjectState(!0,(function(t,i){null==n[t]&&(e(t,i),n[t]=!0)}))},stateToMutableState:function(t){var e,i,n;return(e=h.as(t,c.IDBObjectMutableState))?e:(i=h.as(t,c.IDBObjectDerivedState))&&(n=i.basedOn)?c.DBObjectMutableState.init_9f95(n,h.clone(t.properties)):c.DBObjectMutableState.init_2a9a(t.object,h.clone(t.properties))},makeObjectMutable:function(t){null==h.indexForKey(this.objectMutableStates_,t.id)&&this.newObjectState(t)},newObjectState:function(t){if(t.isChildObject)return this.objectMutableStates_[t.id]=t.state,t.state;var e=this.basedOn,i=h.as(h.opt(e,(function(e){return e.getObjectState(t)})),c.DBObjectState);f.CoreAssert.isTrue(null!=i||!(t.initialized&&t.persisted),"Object "+t.id+" (current state: ) is initialized, but could not find an existing state","DBMutableState.newObjectState","DBState.swift",1261);var n=null!=i?c.DBObjectMutableState.init_226b(i):c.DBObjectMutableState.init_be8f(t),r=t.id;return f.CoreAssert.isTrue(null==h.indexForKey(this.objectMutableStates_,r),"Object "+r+" already has a state","DBMutableState.newObjectState","DBState.swift",1267),this.objectMutableStates_[t.id]=n,t.state=n,n},setObjectState:function(t,e){var i=this.stateToMutableState(e),n=t.id;f.CoreAssert.isTrue(e instanceof c.DBChildObjectState||null==h.indexForKey(this.objectMutableStates_,n),"Object "+n+" already has a state","DBMutableState.setObjectState","DBState.swift",1278),this.objectMutableStates_[t.id]=i,t.state=i},addNewObject:function(t,e){this.newObjectIDs_.push(t.id),this.setObjectState(t,e)},removeObject:function(t){this.newObjectIDs_.includes(t)?(h.remove(this.newObjectIDs_,t),h.removeKey(this.objectMutableStates_,t),this.db_.removeObject(t)):null!=this.objectMutableStates_[t]&&(this.objectMutableStates_[t]=this.db_.deletedObject.state)},forEachInCommitList:function(t){for(var e=[],i={},n=0;n<h.count(this.objectMutableStates_);)for(var r=h.keys(this.objectMutableStates_),a=h.iter(r);!a.done;a.next()){var s;if(null==i[u=a.value])(s=this.database.getObject(u))&&(s.willCommitState(),(l=h.as(s.state,c.DBChildObjectState))&&l.savePendingProperties()),i[u]=!0,n+=1}for(var o=h.iter(this.objectMutableStates_);!o.done;o.next()){var l,u=o.key;(d=o.value)instanceof c.DBObjectDeletedState||(f.CoreAssert.isTrue(h.is(d,c.IDBObjectMutableState),"Immutable state in mutable states dictionary","DBMutableState.forEachInCommitList","DBState.swift",1322),(l=h.as(h.opt(this.database.getObject(u),(function(t){return t.state})),c.DBChildObjectState))?e.push([u,l]):e.push([u,d]))}h.sortInPlace(e,(function(t,e){return e[1].depth<t[1].depth}));for(var p=h.iter(e);!p.done;p.next()){var d,m=p.value;t(u=m[0],d=m[1]),h.opt(this.database.getObject(u),(function(t){return t.didCommitState()}))}},commit:function(){var t,e=this,i={};if(this.forEachInCommitList((function(t,n){var r,a,s;(r=h.as(n,c.DBObjectMutableState))?null==r.basedOn?(s=e.database.getObject(t))&&(i[t]=r.assign(s)):i[t]=r.commit():(a=h.as(n,c.DBChildObjectState))?i[t]=a:(f.CoreAssert.isTrue(n instanceof c.DBObjectDeletedState,"The only immutable object state in a mutable DB state should be the deleted object state","DBMutableState.commit","DBState.swift",1358),i[t]=e.db_.deletedObject.state)})),t=h.as(this.basedOn,c.DBState)){var n=c.DBState.init_62ed(t,this.branch,this.guid,h.clone(i));return t.generation_>25?n.checkpoint():n}return c.DBState.init_40bf(this.db_,this.branch,this.guid,h.clone(i))},abandon:function(){var t=h.clone(this.newObjectIDs_);this.newObjectIDs_.splice(0);for(var e=h.clone(this.objectMutableStates_),i=h.iter(e);!i.done;i.next()){var n,r,a=i.key,s=i.value;(n=h.as(s,c.DBChildObjectState))&&n.abandonPendingProperties(),(r=this.database.getObject(a))&&r.abandonChanges()}for(var o=h.iter(t);!o.done;o.next())a=o.value,h.removeKey(this.objectMutableStates_,a),this.db_.removeObject(a)},flattenFrom:function(t){for(var e=this,i=[],n=t;n!==this&&null!=n;)i.splice(0,0,n),n=n.basedOn;for(var r=h.iter(i);!r.done;r.next()){var a,s=r.value;if(a=h.as(s,u))a.forEachInCommitList((function(t,i){var n;if(i instanceof c.DBObjectDeletedState)e.objectMutableStates_[t]=e.db_.deletedObject.state;else if(null==e.objectMutableStates_[t])e.objectMutableStates_[t]=e.stateToMutableState(i);else if(n=h.as(e.objectMutableStates_[t],c.DBObjectMutableState))for(var r=h.iter(i.properties);!r.done;r.next()){var a=r.key,s=r.value;n.setProperty(a,s)}}));else for(var o=h.iter(s.objectStates);!o.done;o.next()){var l,f=o.key;if((n=o.value)instanceof c.DBObjectDeletedState)this.objectMutableStates_[f]=this.db_.deletedObject.state;else if(null==this.objectMutableStates_[f])this.objectMutableStates_[f]=this.stateToMutableState(n);else if(l=h.as(this.objectMutableStates_[f],c.DBObjectMutableState))for(var p=h.iter(n.properties);!p.done;p.next()){var d=p.key,m=p.value;l.setProperty(d,m)}}}}}}),u)},N5RB:function(t,e,i){var n,r,a,s,o,l=e,u=i("oAGj"),c=i("SpAV"),h=i("fVJ2"),f=i("13MC"),p=i("ZhwN");l.IDatabase=u.defineProtocol("IDatabase",{host:"IDBObject",deletedObject:"IDBObject",transactionDepth:"Integer",beginTransaction:"(String, IDBState) -> ITransaction",endTransaction:"(ITransaction) -> Void",addListener:"(IDatabaseListener) -> Void",removeListener:"(IDatabaseListener) -> Void",mutableState:"IDBMutableState",immutableState:"IDBState",beginBranch:"(String, IDBState, Boolean) -> IDBState",applyBranch:"(String) -> Void",branch:"String",getState:"(String) -> IDBState",getAppliedState:"() -> IDBState",newState:"(String, IDBState) -> (String, IDBMutableState)",commitState:"(IDBMutableState) -> Void",commitAndMergeState:"(IDBMutableState) -> Void",abandonState:"(IDBMutableState) -> Void",stateChanged:"(IDBState) -> Void",objectStateChanged:"(IDBObjectState) -> Void",getBranch:"(String, IDBState) -> Array<IDBState>",getBranchHead:"(String) -> IDBState",getObject:"(String) -> DBObject",createObject:"(String, IDBLink) -> DBObject",addObject:"(String, DBObject) -> Void",stageObjectState:"(String, String, IDBObjectState) -> Void",removeObject:"(String) -> Void"}),l.IDatabaseListener=u.defineProtocol("IDatabaseListener",{onBeginTransaction:"(IDatabase, ITransaction) -> Void",onEndTransaction:"(IDatabase, ITransaction) -> Void",onStateChanged:"(IDatabase, IDBState) -> Void",onObjectStateChanged:"(IDatabase, IDBObjectState) -> Void"}),l.PostDBTransaction=(n=function(t,e,i,n,r){var a;void 0===r&&(r=null);var s=n||t.mutableState,o=t.newState((a=r)||null!=a?a:l.PostDB.undoBranchID,s);this.name=i,this.parent=e,this.parentDB_=t,this.state=o.state},u.defineClass({name:"PostDBTransaction",ctor:n,statics:{_implements:function(t){return"ITransaction"==t}},props:{end:function(){this.parentDB_.commitState(this.state),this.parentDB_.endTransaction(this)},mergeWithPrevious:function(){this.parentDB_.commitAndMergeState(this.state),this.parentDB_.endTransaction(this)},rollback:function(){this.parentDB_.abandonState(this.state),this.parentDB_.endTransaction(this)}}}),n),l.WeakListener=(r=function(){},u.defineClass({name:"WeakListener",ctor:r,props:{init_cbb0:function(t,e){this.listener_=t,this.db_=e},onBeginTransaction:function(t){var e=this;null!=this.db_&&u.opt(this.listener_,(function(i){return i.onBeginTransaction(e.db_,t)}))},onEndTransaction:function(t){var e=this;null!=this.db_&&u.opt(this.listener_,(function(i){return i.onEndTransaction(e.db_,t)}))},onStateChanged:function(t){var e=this;null!=this.db_&&u.opt(this.listener_,(function(i){return i.onStateChanged(e.db_,t)}))},onObjectStateChanged:function(t){var e=this;null!=this.db_&&u.opt(this.listener_,(function(i){return i.onObjectStateChanged(e.db_,t)}))},init_implicit:function(t,e){this.listener_=t,this.db_=e},clone:function(){return r.init_implicit(this.listener_,this.db_)}}}),r),l.WeakState=(a=function(){},u.defineClass({name:"WeakState",ctor:a,props:{init_9ed3:function(t){this.state=t},init_implicit:function(t){this.state=t},clone:function(){return a.init_implicit(this.state)}}}),a),l.PostDocumentState=(s=function(t){this.state_=t},u.defineClass({name:"PostDocumentState",ctor:s,statics:{_implements:function(t){return"IDocumentState"==t}},props:{state:{get:function(){return this.state_}},stateGUID:{get:function(){return this.state.guid}},updateStateFromDatabase:function(t){var e;(e=t.getState(this.stateGUID))&&(this.state_=e)}}}),s),l.PostDB=(o=function(){this.transactions_=[],this.listeners_=[],this.states_={},this.branches_={},this.mutableState_=null,this.appliedState_=null,this.hostObjectID_=null,this.objects_={},this.objectInitialStates_={},this.objectTypes_={},this.deletedObject_=null,this.rootState=null,this.currentState=null,this.stateManagerTransactions=[]},u.defineClass({name:"PostDB",ctor:o,statics:{undoBranchID:"undo",_implements:function(t){return"IDatabase"==t||"IDocumentStateManager"==t}},props:{deletedObject:{get:function(){return null==this.deletedObject_&&(this.deletedObject_=new h.DBDeletedObject(this)),this.deletedObject_}},transactionDepth:{get:function(){return this.transactions_.length}},transactionStackDescription:{get:function(){return this.transactions_.map((function(t){return t.name}),this).join(", ")}},nthTransactionName:function(t){return c.CoreAssert.isTrue(t>=0&&t<this.transactionDepth,void 0,"PostDB.nthTransactionName","Database.swift",250),this.transactions_[t].name},beginTransaction:function(t,e){var i=new l.PostDBTransaction(this,u.last(this.transactions_),t,e,u.opt(e,(function(t){return t.branch}))),n="["+(0==this.transactions_.length?"":this.transactionStackDescription+", ")+"+"+t+"]";c.CoreAssert.info("transaction: begin "+n),this.transactions_.push(i);for(var r=u.iter(this.listeners_);!r.done;r.next())r.value.onBeginTransaction(i);return i},beginBranch:function(t,e,i){c.CoreAssert.isTrue(e instanceof f.DBState||null==e&&this.immutableState instanceof f.DBState,"The database may only be branched from an immutable state.","PostDB.beginBranch","Database.swift",270);var n=p.GUIDUtils.makeGUID(),r=e||this.immutableState,a=f.DBState.init_62ed(r,t,n,u.clone({}));return i&&(a.apply(),this.appliedState_=a),this.branches_[t]=a,a},applyBranch:function(t){var e;(e=this.getBranchHead(t))&&(e.apply(),this.appliedState_=e)},branch:{get:function(){var t;return(t=u.opt(this.appliedState_,(function(t){return t.branch})))||null!=t?t:o.undoBranchID}},endTransaction:function(t){var e,i=this.transactions_.pop(),n=(e=u.opt(i,(function(t){return t.name})))||null!=e?e:"none",r=0==this.transactions_.length?"":this.transactionStackDescription+", ",a="current: "+n+" ending: "+t.name+" stack: ["+this.transactionStackDescription+"]";c.CoreAssert.isTrue(t===i,"endTransaction transaction not equal backTransaction. "+a,"PostDB.endTransaction","Database.swift",301),c.CoreAssert.isTrue(t!==u.last(this.stateManagerTransactions),"endTransaction ending a transaction ["+t.name+"] managed by undo","PostDB.endTransaction","Database.swift",303);var s="["+r+"-"+t.name+"]";c.CoreAssert.info("transaction: end   "+s);for(var o=u.iter(this.listeners_);!o.done;o.next())o.value.onEndTransaction(i)},addListener:function(t){this.removeListener(t),this.listeners_.push(u.clone(l.WeakListener.init_cbb0(t,this)))},removeListener:function(t){this.listeners_=this.listeners_.filter((function(e){return null!=e.listener_&&e.listener_!==t}),this)},mutableState:{get:function(){return this.mutableState_}},immutableState:{get:function(){for(var t=this.appliedState_||this.stateFromDocumentState(this.currentState)||this.branches_[o.undoBranchID];u.is(t,f.IDBMutableState);)t=u.opt(t,(function(t){return t.basedOn}));return t}},getState:function(t){return u.opt(this.states_[t],(function(t){return t.state}))},getAppliedState:function(){return this.appliedState_},newState:function(t,e){c.CoreAssert.isTrue(null==this.mutableState_||e instanceof f.DBState&&e.descendsFrom(this.mutableState_),void 0,"PostDB.newState","Database.swift",340);var i=p.GUIDUtils.makeGUID(),n=e||this.appliedState_||this.stateFromDocumentState(this.currentState)||this.branches_[t],r=null==e||this.appliedState_===e&&u.opt(this.appliedState_,(function(e){return e.branch==t}));if(c.CoreAssert.isTrue(null==this.mutableState_||this.mutableState_===n,void 0,"PostDB.newState","Database.swift",346),this.mutableState_=null!=n?f.DBMutableState.init_1198(n,t,i):f.DBMutableState.init_4be2(this,t,i),r)for(var a=u.iter(this.mutableState_.objectStates);!a.done;a.next())a.value.apply(null);return this.states_[i]=u.clone(l.WeakState.init_9ed3(this.mutableState_)),r&&(this.branches_[t]=this.mutableState_,this.appliedState_=this.mutableState_),{guid:i,state:this.mutableState_}},commitState:function(t){var e,i,n=(e=u.opt(u.last(this.transactions_),(function(t){return t.name})))||null!=e?e:"nil";if(c.CoreAssert.isTrue(null!=u.last(this.transactions_),"commitState transaction stack underflow","PostDB.commitState","Database.swift",370),c.CoreAssert.isTrue(null!=this.mutableState_,"commitState database is immutable","PostDB.commitState","Database.swift",371),c.CoreAssert.isTrue(t===this.mutableState_,"commitState mutableState != mutableState_ "+n,"PostDB.commitState","Database.swift",372),i=this.mutableState_){var r,a,s=i.guid,o=i.branch,h=i.basedOn,p=t===this.appliedState_;if(r=u.as(h,f.IDBMutableState))r.flattenFrom(t),this.branches_[o]=r,this.mutableState_=u.as(r,f.DBMutableState),u.removeKey(this.states_,s);else{var d=t.commit();this.branches_[o]=d,this.states_[s]=u.clone(l.WeakState.init_9ed3(d)),this.mutableState_=null}p&&((a=this.branches_[o])?(u.opt(this.host_,(function(t){return t.willApplyDatabaseState(a)})),u.opt(u.as(a,f.DBState),(function(t){return t.applyInternal(!1)})),this.appliedState_=a,u.opt(this.host_,(function(t){return t.didApplyDatabaseState(a)}))):(this.appliedState_=null,u.assert(!1)))}},commitAndMergeState:function(t){var e,i=this,n=(e=u.opt(u.last(this.transactions_),(function(t){return t.name})))||null!=e?e:"nil";if(c.CoreAssert.isTrue(null!=u.last(this.transactions_),"commitAndMergeState transaction stack underflow","PostDB.commitAndMergeState","Database.swift",410),c.CoreAssert.isTrue(null!=this.mutableState_,"commitAndMergeState database is immutable","PostDB.commitAndMergeState","Database.swift",411),c.CoreAssert.isTrue(t===this.mutableState_,"commitAndMergeState mutableState != mutableState_ "+n,"PostDB.commitAndMergeState","Database.swift",412),p=this.mutableState_){var r,a=p.branch,s=t===this.appliedState_,o=p.guid;if(r=u.as(p.basedOn,f.IDBMutableState)){if(r.flattenFrom(t),this.branches_[a]=r,this.mutableState_=u.as(r,f.DBMutableState),s){for(var h=u.iter(r.objectStates);!h.done;h.next()){var p;(p=h.value).apply(null)}this.appliedState_=this.mutableState_}u.removeKey(this.states_,p.guid)}else{var d,m,b,D={};if(d=p.basedOn){for(var y=u.iter(d.objectStates);!y.done;y.next()){var _=y.key,S=y.value;_!=this.hostObjectID_&&null==this.objects_[_]||(c.CoreAssert.isFalse(S instanceof f.DBObjectMutableState,"Immutable database states should not contain mutable object state","PostDB.commitAndMergeState","Database.swift",439),D[_]=S)}u.removeKey(this.states_,d.guid),o=d.guid}if(p.forEachInCommitList((function(t,e){var n,r;if(n=i.getObject(t))if(r=D[t]){var a,s;if(e!==r&&((a=u.as(r,f.IDBObjectAncestorState))&&(s=u.as(e,f.IDBObjectDerivedState))?c.CoreAssert.isTrue(a.isAncestorOf(s),"Merging descendant database states shouldn't merge non-descendant object states","PostDB.commitAndMergeState","Database.swift",454):c.CoreAssert.fail("Expected to merge a derived state into an ancestor state","PostDB.commitAndMergeState","Database.swift",457)),_=u.as(r,f.DBChildObjectState))for(var o=u.clone(_.diff(e)),l=u.iter(o);!l.done;l.next()){var h,p=l.key;(h=l.value[1])?_.setProperty(p,h):_.removeProperty(p)}else{var d,m={},b=[];u.append(b,u.keys(r.properties)),u.keys(e.properties).forEach((function(t){b.includes(t)||b.push(t)})),b.forEach((function(t){m[t]=e.getProperty(t)})),(d=u.as(u.opt(u.as(r,f.IDBObjectDerivedState),(function(t){return t.basedOn})),f.DBObjectState))?(D[t]=f.DBObjectState.init_9f95(d,u.clone(m)),n.state=D[t]):(D[t]=f.DBObjectState.init_2a9a(n,u.clone(m)),n.state=D[t])}}else{var y,_,S;(y=u.as(e,f.DBObjectMutableState))?D[t]=y.assign(n):(_=u.as(e,f.DBChildObjectState))?D[t]=_:(S=u.as(e,f.DBObjectState))&&(D[t]=S)}})),u.removeKey(this.states_,p.guid),(m=u.as(u.opt(p.basedOn,(function(t){return t.basedOn})),f.DBMutableState))?(this.mutableState_=f.DBMutableState.init_62ed(m,a,o,u.clone(D)),this.branches_[a]=this.mutableState_):(b=u.as(u.opt(p.basedOn,(function(t){return t.basedOn})),f.DBState))?(this.branches_[a]=f.DBState.init_62ed(b,a,o,u.clone(D)),this.mutableState_=null):(this.branches_[a]=f.DBState.init_40bf(this,a,o,u.clone(D)),this.mutableState_=null),this.states_[o]=u.clone(l.WeakState.init_9ed3(this.branches_[a])),u.opt(this.currentState,(function(t){return t.updateStateFromDatabase(i)})),s){for(var v=u.iter(this.branches_[a].objectStates);!v.done;v.next())(S=v.value).apply(null);this.appliedState_=this.branches_[a]}}}},abandonState:function(t){var e;if(e=this.mutableState_){u.assert(this.mutableState_===t);var i,n=t===this.appliedState_,r=e.branch,a=e.basedOn;t.abandon(),this.branches_[r]=a,this.mutableState_=u.as(a,f.DBMutableState),n&&(i=this.branches_[r])&&(u.opt(this.host_,(function(t){return t.willApplyDatabaseState(i)})),i.apply(),this.appliedState_=i,u.opt(this.host_,(function(t){return t.didApplyDatabaseState(i)})))}},stateChanged:function(t){for(var e=u.iter(this.listeners_);!e.done;e.next())e.value.onStateChanged(t)},objectStateChanged:function(t){for(var e=u.iter(this.listeners_);!e.done;e.next())e.value.onObjectStateChanged(t)},getBranch:function(t,e){var i,n=[];if(i=this.branches_[t]){var r=u.opt(e,(function(t){return t.guid}));n.splice(0,0,i);for(var a=n[0].basedOn;null!=a&&(n.splice(0,0,a),a.guid!=r);)a=n[0].basedOn}return n},getBranchHead:function(t){return this.branches_[t]},getObject:function(t){return t==this.hostObjectID_?this.host_:this.objects_[t]},createObject:function(t,e){var i=this.getObject(t);return null==i&&(this.instantiateObject(t,e),i=this.objects_[t]),i},setAddedObjectState:function(t,e){var i;(i=u.as(e,f.IDBObjectAncestorState))?u.opt(this.mutableState,(function(e){return e.addNewObject(t,f.DBObjectMutableState.init_226b(i))})):u.opt(this.mutableState,(function(i){return i.addNewObject(t,e)}))},addObject:function(t,e){var i,n,r;if(e instanceof h.DBHostObject?(c.CoreAssert.isTrue(null==this.hostObjectID_,"Host object already added","PostDB.addObject","Database.swift",613),this.hostObjectID_=t):this.objects_[t]=e,i=this.objectInitialStates_[t])if(u.removeKey(this.objectInitialStates_,t),u.removeKey(this.objectTypes_,t),r=u.as(i,f.DBObjectMutableState)){var a=r.assign(e);this.setAddedObjectState(e,a)}else this.setAddedObjectState(e,i);else if(n=u.as(e.state,f.DBChildObjectState)){var s;if(e.persisted||e.persistToDatabase(this,t),null!=(s=u.opt(this.mutableState,(function(t){return t.branch}))))for(var o=u.iter(this.getBranch(s,null));!o.done;o.next()){var l,p=o.value;(l=u.as(p,f.DBMutableState))&&l.addNewObject(e,n)}}else c.CoreAssert.isTrue(null!=this.mutableState,"Adding an object without a staged state to an immutable database","PostDB.addObject","Database.swift",642),e.initialized||(e.state=e.emptyState),this.setAddedObjectState(e,e.initialState)},stageObjectState:function(t,e,i){this.objectInitialStates_[t]=i,this.objectTypes_[t]=e},removeObject:function(t){u.removeKey(this.objects_,t),u.removeKey(this.objectInitialStates_,t),u.removeKey(this.objectTypes_,t),null!=this.mutableState_&&this.mutableState_.removeObject(t)},host:{get:function(){return this.host_},set:function(t){c.CoreAssert.isTrue(null==this.host_,"Host already set","PostDB","Database.swift",668),this.host_=t}},instantiateObject:function(t,e){var i,n,r,a;(i=this.objectInitialStates_[t])&&null!=(n=this.objectTypes_[t])&&null!=(r=h.DBHostObject.factory(n))&&(u.removeKey(this.objectInitialStates_,t),u.removeKey(this.objectTypes_,t),(a=u.as(r(t,this,i,e),h.DBObject))&&(a instanceof h.DBHostObject?(c.CoreAssert.isTrue(null==this.hostObjectID_,"Host object already added","PostDB.instantiateObject","Database.swift",683),this.hostObjectID_=t):null==this.objects_[t]&&(this.objects_[t]=a)))},stateFromDocumentState:function(t){var e=this;return c.CoreAssert.isTrue(null==t||null!=this.states_[t.stateGUID],"Document state removed from the database","PostDB.stateFromDocumentState","Database.swift",700),u.opt(t,(function(t){return t.updateStateFromDatabase(e)})),u.opt(t,(function(t){return t.state}))},resetStates:function(){var t;(t=this.branches_[o.undoBranchID])&&(this.rootState=new l.PostDocumentState(t),this.currentState=this.rootState)},getRootState:function(){return this.rootState},beginNewState:function(t){this.stateManagerTransactions.push(this.beginTransaction(t,this.mutableState||this.appliedState_||this.stateFromDocumentState(this.currentState)))},endNewState:function(){var t,e=this.stateManagerTransactions.pop(),i=e.name,n=(t=u.opt(u.last(this.transactions_),(function(t){return t.name})))||null!=t?t:"nil";return c.CoreAssert.isTrue(e===u.last(this.transactions_),"endNewState ending state manager transaction ["+i+"] that isn't the active transaction ["+n+"]","PostDB.endNewState","Database.swift",722),e.end(),null==this.mutableState&&(c.CoreAssert.isTrue(this.appliedState_===this.branches_[o.undoBranchID],"Current state is not the branch head after a transaction","PostDB.endNewState","Database.swift",726),this.currentState=new l.PostDocumentState(this.branches_[o.undoBranchID])),this.currentState},setCurrentState:function(t){var e,i;(e=u.as(t,l.PostDocumentState))&&u.opt(this.currentState,(function(t){return t.stateGUID!=e.stateGUID}))&&(i=this.stateFromDocumentState(e))&&(u.opt(this.host_,(function(t){return t.willApplyDatabaseState(i)})),this.currentState=e,i.apply(),this.appliedState_=i,u.opt(this.host_,(function(t){return t.didApplyDatabaseState(i)})))},getNewStateNestingDepth:function(){return this.stateManagerTransactions.length}}}),o)},O60Y:function(t,e,i){var n,r=e,a=i("oAGj");r.IDBLink=a.defineProtocol("IDBLink",{database:"IDatabase",referenceID:"String",backLink:"IDBLink",dereference:"() -> DBObject"}),r.DBLink=(n=function(){this.keepAlive_=null},a.defineClass({name:"DBLink",ctor:n,statics:{_implements:function(t){return"IDBLink"==t}},props:{init_8408:function(t,e,i){this.objID_=t,this.db_=e,this.backLinkID_=i},init_14fa:function(t,e){this.objID_=t.id,this.db_=t.persisted?t.database:null,this.backLinkID_=e,this.keepAlive_=t},database:{get:function(){return this.db_}},referenceID:{get:function(){return this.objID_}},backLink:{get:function(){return null!=this.backLinkID_?n.init_8408(this.backLinkID_,this.db_,this.objID_):null}},dereference:function(){var t;return(t=this.keepAlive_)?t:(this.keepAlive_=this.db_.createObject(this.objID_,this),this.keepAlive_)}}}),n)},QBb7:function(t,e,i){var n,r,a,s=e,o=i("oAGj"),l=i("90dd");s.ITransaction=o.defineProtocol("ITransaction",{name:"String",parent:"ITransaction",end:"() -> Void",mergeWithPrevious:"() -> Void",rollback:"() -> Void"}),s.TransactionMessage=(n=function(t,e,i){this.transaction=t,l.TheoMessage.call(this,e,i)},o.defineClass({name:"TransactionMessage",ctor:n,superName:"TheoMessage"}),n),s.TransactionBegunMessage=(r=function t(e,i){s.TransactionMessage.call(this,e,t.TYPE,i)},o.defineClass({name:"TransactionBegunMessage",ctor:r,superName:"TransactionMessage",statics:{TYPE:"DatabaseTransactionBegunMessage"}}),r),s.TransactionEndedMessage=(a=function t(e,i){s.TransactionMessage.call(this,e,t.TYPE,i)},o.defineClass({name:"TransactionEndedMessage",ctor:a,superName:"TransactionMessage",statics:{TYPE:"DatabaseTransactionEndedMessage"}}),a)},SmK9:function(t,e,i){var n,r,a,s,o,l,u,c,h,f,p,d,m,b,D,y,_,S,v,B,g,P,O,j=e,T=i("oAGj"),I=i("SpAV"),E=i("fVJ2"),C=i("dJuF"),V=i("13MC"),N=i("iCxV"),R=i("3hwA"),A=i("9YN4");j.DBSchemaType=T.defineEnum("DBSchemaType",{UnknownType:"unknown",BooleanType:"boolean",NumberType:"number",IntegerType:"integer",StringType:"string",ObjectType:"object",ArrayType:"array"}),j.DBSchemaValue=(n=function(){},T.defineClass({name:"DBSchemaValue",ctor:n,statics:{fromBool:function(t){return n.init_4199(j.DBSchemaType.BooleanType,t,null)},fromDouble:function(t){return n.init_4199(j.DBSchemaType.NumberType,t,null)},fromInt:function(t){return n.init_4199(j.DBSchemaType.IntegerType,t,null)},fromString:function(t){return n.init_4199(j.DBSchemaType.StringType,t,null)},fromClass:function(t,e){return n.init_4199(j.DBSchemaType.ObjectType,T.clone(e),t)},fromArray:function(t){return n.init_4199(j.DBSchemaType.ArrayType,T.clone(t),null)},fromDict:function(t){return n.init_4199(j.DBSchemaType.ObjectType,T.clone(t),null)},emptyValue:function(t){return n.init_4199(j.DBSchemaType.UnknownType,null,t)}},props:{init_4199:function(t,e,i){this.schemaType=t,this.value_=e,this.className_=i,this.isDefault_=!1},init_e1d9:function(t,e,i,n){this.schemaType=t,this.value_=e,this.className_=i,this.isDefault_=n},merge:function(t){if(null!=t&&t.schemaType!=j.DBSchemaType.UnknownType)if(I.CoreAssert.isTrue(this.schemaType==j.DBSchemaType.UnknownType||t.schemaType==this.schemaType,"Mismatched types in merge.","DBSchemaValue.merge","DBSchema.swift",54),(this.schemaType==j.DBSchemaType.UnknownType||this.isDefault_)&&(this.isDefault_=t.isDefault_),null==this.className_&&(this.className_=t.className_),this.schemaType==j.DBSchemaType.ArrayType){if(null==this.value_)this.value_=t.value_;else if(null!=t.value_){var e=t.value_.concat(this.value_);this.value_=T.clone(e)}}else if(this.schemaType==j.DBSchemaType.ObjectType){if(null==this.value_)this.value_=t.value_;else if(null!=t.value_){for(var i={},n=T.iter(t.value_);!n.done;n.next()){var r=n.key,a=n.value;i[r]=a}for(var s=T.iter(this.value_);!s.done;s.next())r=s.key,a=s.value,i[r]=a;this.value_=T.clone(i)}}else null!=t.value_&&(this.value_=t.value_),this.schemaType==j.DBSchemaType.UnknownType&&(this.schemaType=t.schemaType)},property:function(t,e,i){var r=null;if(this.schemaType==j.DBSchemaType.ObjectType){for(var a={},s=T.as(T.opt(T.opt(T.as(this.value_,["Dictionary","String",n]),(function(t){return t[j.DBSchema.PROPERTY_ID]})),(function(t){return t.value_})),"String"),o=T.iter(this.value_);!o.done;o.next()){var l=o.key,u=o.value;null!=u.value_&&(a[l]=u.property(l,e,s))}if(null==this.className_||null==a[j.DBSchema.PROPERTY_ID])r=C.DBProperty.dictEncoded(C.DBNamePath.init_b14a(t),T.clone(a),this.className_);else{for(var c=V.DBObjectMutableState.init_6f66(this.className_),h=a[j.DBSchema.PROPERTY_ID].stringValue,f=T.iter(a);!f.done;f.next()){var p=f.key,d=f.value;c.setProperty(p,d)}e.stageObjectState(h,this.className_,c),r=C.DBProperty.linkProperty(C.DBNamePath.init_b14a(t),h,e,this.className_,i)}}else switch(this.schemaType){case"boolean":r=C.DBProperty.boolEncoded(C.DBNamePath.init_b14a(t),this.value_,this.className_);break;case"integer":r=C.DBProperty.intEncoded(C.DBNamePath.init_b14a(t),this.value_,this.className_);break;case"number":r=C.DBProperty.doubleEncoded(C.DBNamePath.init_b14a(t),this.value_,this.className_);break;case"string":r=C.DBProperty.stringEncoded(C.DBNamePath.init_b14a(t),this.value_,this.className_);break;case"array":var m=T.toSequence(this.value_).map((function(t){return t.element.property(T.toString(t.offset),e,i)}),this);r=C.DBProperty.arrayEncoded(C.DBNamePath.init_b14a(t),T.clone(m),this.className_);break;default:r=null}return this.isDefault_&&T.opt(r,(function(t){return t.shouldWrite=!1})),r},valuesEqual:function(t){return this.schemaType==j.DBSchemaType.BooleanType?this.value_==t.value_:this.schemaType==j.DBSchemaType.IntegerType?this.value_==t.value_:this.schemaType==j.DBSchemaType.NumberType?this.value_==t.value_:this.schemaType==j.DBSchemaType.StringType&&this.value_==t.value_},isEqual:function(t){var e;return!!(e=T.as(t,n))&&e.schemaType==this.schemaType&&e.isDefault_==this.isDefault_&&e.className_==this.className_&&this.valuesEqual(e)}}}),n),j.IDBValidationResult=T.defineProtocol("IDBValidationResult",{value:"DBSchemaValue"}),j.DBValidationResult=(r=function(){},a={},T.defineClass({name:"DBValidationResult",ctor:r,statics:{empty:{get:function(){return void 0===a.empty&&(a.empty=r.init_d41d()),a.empty}},_implements:function(t){return"IDBValidationResult"==t}},props:{init_2063:function(t){this.value=t},init_d41d:function(){this.value=null}}}),r),j.DBValidationError=(s=function(){},T.defineClass({name:"DBValidationError",ctor:s,statics:{_implements:function(t){return"IDBValidationResult"==t}},props:{value:{get:function(){return null}},error:{get:function(){return"Validation failed"}}}}),s),j.DBValidationErrorNotImplemented=(o=function(){j.DBValidationError.call(this)},T.defineClass({name:"DBValidationErrorNotImplemented",ctor:o,superName:"DBValidationError",statics:{_implements:function(t){return"IDBValidationResult"==t}},props:{error:{get:function(){return"Not implemented"}}}}),o),j.DBValidationErrorNoHost=(l=function(){j.DBValidationError.call(this)},T.defineClass({name:"DBValidationErrorNoHost",ctor:l,superName:"DBValidationError",statics:{_implements:function(t){return"IDBValidationResult"==t}},props:{error:{get:function(){return"No host object or host object state"}}}}),l),j.DBValidationErrorType=(u=function(t,e){this.value_=t,this.type_=e},T.defineClass({name:"DBValidationErrorType",ctor:u,superName:"DBValidationError",statics:{_implements:function(t){return"IDBValidationResult"==t}},props:{error:{get:function(){return null!=this.value_?this.value_+" is not of type "+this.type_:"value is nil"}}}}),u),j.DBValidationErrorConstantIntMismatch=(c=function(t,e){this.value_=t,this.constant_=e},T.defineClass({name:"DBValidationErrorConstantIntMismatch",ctor:c,superName:"DBValidationError",statics:{_implements:function(t){return"IDBValidationResult"==t}},props:{error:{get:function(){return this.value_+" != "+this.constant_}}}}),c),j.DBValidationErrorConstantStringMismatch=(h=function(t,e){this.value_=t,this.constant_=e},T.defineClass({name:"DBValidationErrorConstantStringMismatch",ctor:h,superName:"DBValidationError",statics:{_implements:function(t){return"IDBValidationResult"==t}},props:{error:{get:function(){return this.value_+" != "+this.constant_}}}}),h),j.DBValidationErrorIntEnumMismatch=(f=function(t,e){this.value_=t,this.enumeration_=T.clone(e)},T.defineClass({name:"DBValidationErrorIntEnumMismatch",ctor:f,superName:"DBValidationError",statics:{_implements:function(t){return"IDBValidationResult"==t}},props:{error:{get:function(){return this.value_+" not in "+this.enumeration_}}}}),f),j.DBValidationErrorStringEnumMismatch=(p=function(t,e){this.value_=t,this.enumeration_=T.clone(e)},T.defineClass({name:"DBValidationErrorStringEnumMismatch",ctor:p,superName:"DBValidationError",statics:{_implements:function(t){return"IDBValidationResult"==t}},props:{error:{get:function(){return this.value_+" not in "+this.enumeration_}}}}),p),j.DBValidationErrorLimit=(d=function(t,e,i,n){this.value_=t,this.limit_=e,this.less_=i,this.exclusive_=n},T.defineClass({name:"DBValidationErrorLimit",ctor:d,superName:"DBValidationError",statics:{_implements:function(t){return"IDBValidationResult"==t}},props:{comparator:{get:function(){return this.less_?this.exclusive_?"<":"<=":this.exclusive_?">":">="}},error:{get:function(){return this.value_+" "+this.comparator+" "+this.limit_}}}}),d),j.DBValidationErrorMultiple=(m=function(t,e){this.value_=t,this.factor_=e},T.defineClass({name:"DBValidationErrorMultiple",ctor:m,superName:"DBValidationError",statics:{_implements:function(t){return"IDBValidationResult"==t}},props:{error:{get:function(){return this.value_+" is not a multiple of "+this.factor_}}}}),m),j.DBValidationErrorLimitStringLength=(b=function(t,e,i){this.length_=t,this.limit_=e,this.less_=i},T.defineClass({name:"DBValidationErrorLimitStringLength",ctor:b,superName:"DBValidationError",statics:{_implements:function(t){return"IDBValidationResult"==t}},props:{comparator:{get:function(){return this.less_?"<":">"}},error:{get:function(){return"String length "+this.length_+" "+this.comparator+" "+this.limit_}}}}),b),j.DBValidationErrorStringPattern=(D=function(t,e){this.value_=t,this.pattern_=e},T.defineClass({name:"DBValidationErrorStringPattern",ctor:D,superName:"DBValidationError",statics:{_implements:function(t){return"IDBValidationResult"==t}},props:{error:{get:function(){return this.value_+" does not match pattern "+this.pattern_}}}}),D),j.DBValidationErrorLimitItems=(y=function(t,e,i){this.count_=t,this.limit_=e,this.less_=i},T.defineClass({name:"DBValidationErrorLimitItems",ctor:y,superName:"DBValidationError",statics:{_implements:function(t){return"IDBValidationResult"==t}},props:{comparator:{get:function(){return this.less_?"<":">"}},error:{get:function(){return"Item count "+this.count_+" "+this.comparator+" "+this.limit_}}}}),y),j.DBValidationErrorUniqueItems=(_=function(t){this.arrayValue_=T.clone(t)},T.defineClass({name:"DBValidationErrorUniqueItems",ctor:_,superName:"DBValidationError",statics:{_implements:function(t){return"IDBValidationResult"==t}},props:{error:{get:function(){return"Items "+this.arrayValue_+" not unique"}}}}),_),j.DBValidationErrorRequiredItem=(S=function(t){this.arrayValue_=T.clone(t)},T.defineClass({name:"DBValidationErrorRequiredItem",ctor:S,superName:"DBValidationError",statics:{_implements:function(t){return"IDBValidationResult"==t}},props:{error:{get:function(){return"Required item not found in "+this.arrayValue_}}}}),S),j.DBValidationErrorLimitProperties=(v=function(t,e,i){this.count_=t,this.limit_=e,this.less_=i},T.defineClass({name:"DBValidationErrorLimitProperties",ctor:v,superName:"DBValidationError",statics:{_implements:function(t){return"IDBValidationResult"==t}},props:{comparator:{get:function(){return this.less_?"<":">"}},error:{get:function(){return"Property count "+this.count_+" "+this.comparator+" "+this.limit_}}}}),v),j.DBValidationErrorRequiredProperty=(B=function(t,e){this.value_=t,this.propertyName_=e},T.defineClass({name:"DBValidationErrorRequiredProperty",ctor:B,superName:"DBValidationError",statics:{_implements:function(t){return"IDBValidationResult"==t}},props:{error:{get:function(){return"Required property "+this.propertyName_+" not found in "+this.value_}}}}),B),j.DBValidationErrorCompound=(g=function(t){this.errors_=T.clone(t)},T.defineClass({name:"DBValidationErrorCompound",ctor:g,superName:"DBValidationError",statics:{_implements:function(t){return"IDBValidationResult"==t}},props:{error:{get:function(){return this.errors_.reduce((function(t,e){return t+".."+e.error+"\n"}),"Validation failed:\n")}}}}),g),j.DBValidationErrorMultipleMatches=(P=function(t,e){this.matches_=T.clone(t),this.errors_=T.clone(e)},T.defineClass({name:"DBValidationErrorMultipleMatches",ctor:P,superName:"DBValidationError",statics:{_implements:function(t){return"IDBValidationResult"==t}},props:{error:{get:function(){for(var t=this.matches_.length+" rules match:\n",e=T.iter(this.errors_);!e.done;e.next())t+=".."+e.value+"\n";return t}}}}),P),j.DBValidationErrorNegation=(O=function(){j.DBValidationError.call(this)},T.defineClass({name:"DBValidationErrorNegation",ctor:O,superName:"DBValidationError",statics:{_implements:function(t){return"IDBValidationResult"==t}},props:{error:{get:function(){return"Validation passed (negation failed)"}}}}),O),j.Rule=function(){var t=function t(e,i,n){var r=this;this.rawSchema_=T.clone(e),this.filename_=i,this.pathToObject_=n,this._ref=T.as(this.rawSchema_[t._REF],"String"),this._refsResolved=!1,this._schema=T.as(this.rawSchema_[t._SCHEMA],"String"),this._id=T.as(this.rawSchema_[t._ID],"String"),this._comment=T.as(this.rawSchema_[t._COMMENT],"String"),this.title=T.as(this.rawSchema_[t.TITLE],"String"),this.description=T.as(this.rawSchema_[t.DESCRIPTION],"String"),this.dependencies=t.fromJSON(T.clone(T.as(this.rawSchema_[t.DEPENDENCIES],["Dictionary","String","Any"])),i,n+"/"+t.DEPENDENCIES),this.definitions=T.clone(t.fromDefinitions(T.clone(T.as(this.rawSchema_[t.DEFINITIONS],["Dictionary","String",["Dictionary","String","Any"]])),i,n+"/"+t.DEFINITIONS)),this.typeArray=T.clone(t.typesFromSchema(T.clone(e))),this.defaultValue=this.rawSchema_[t.DEFAULT],this.readOnly=T.as(this.rawSchema_[t.READ_ONLY],"Bool"),this.examples=T.clone(T.as(this.rawSchema_[t.EXAMPLES],["Array","Any"])),this.multipleOf=T.as(this.rawSchema_[t.MULTIPLE_OF],"Double"),this.maximum=T.as(this.rawSchema_[t.MAXIMUM],"Double"),this.exclusiveMaximum=T.as(this.rawSchema_[t.EXCLUSIVE_MAXIMUM],"Double"),this.minimum=T.as(this.rawSchema_[t.MINIMUM],"Double"),this.exclusiveMinimum=T.as(this.rawSchema_[t.EXCLUSIVE_MINIMUM],"Double"),this.maxLength=T.as(this.rawSchema_[t.MAX_LENGTH],"Int"),this.minLength=T.as(this.rawSchema_[t.MIN_LENGTH],"Int"),this.pattern=T.as(this.rawSchema_[t.PATTERN],"String"),this.tupleItems=T.clone(T.opt(T.as(this.rawSchema_[t.ITEMS],["Array",["Dictionary","String","Any"]]),(function(e){return e.map((function(e){return t.fromJSON(T.clone(e),i,n+"/"+t.ITEMS)}),r)}))),this.items=null==this.tupleItems?t.fromJSON(T.clone(T.as(this.rawSchema_[t.ITEMS],["Dictionary","String","Any"])),i,n+"/"+t.ITEMS):null,this.additionalItems=t.fromJSON(T.clone(T.as(this.rawSchema_[t.ADDITIONAL_ITEMS],["Dictionary","String","Any"])),i,n+"/"+t.ADDITIONAL_ITEMS),this.maxItems=T.as(this.rawSchema_[t.MAX_ITEMS],"Int"),this.minItems=T.as(this.rawSchema_[t.MIN_ITEMS],"Int"),this.uniqueItems=T.as(this.rawSchema_[t.UNIQUE_ITEMS],"Bool"),this.contains=t.fromJSON(T.clone(T.as(this.rawSchema_[t.CONTAINS],["Dictionary","String","Any"])),i,n+"/"+t.CONTAINS),this.properties=T.clone(t.fromDefinitions(T.clone(T.as(this.rawSchema_[t.PROPERTIES],["Dictionary","String",["Dictionary","String","Any"]])),i,n+"/"+t.PROPERTIES)),this.maxProperties=T.as(this.rawSchema_[t.MAX_PROPERTIES],"Int"),this.minProperties=T.as(this.rawSchema_[t.MIN_PROPERTIES],"Int"),this.requiredProperties=T.clone(T.as(this.rawSchema_[t.REQUIRED],["Array","String"])),this.additionalProperties=t.fromJSON(T.clone(T.as(this.rawSchema_[t.ADDITIONAL_PROPERTIES],["Dictionary","String","Any"])),i,n+"/"+t.ADDITIONAL_PROPERTIES),this.patternProperties=T.clone(t.fromDefinitions(T.clone(T.as(this.rawSchema_[t.PATTERN_PROPERTIES],["Dictionary","String",["Dictionary","String","Any"]])),i,n+"/"+t.PATTERN_PROPERTIES)),this.propertyNames=t.fromJSON(T.clone(T.as(this.rawSchema_[t.PROPERTY_NAMES],["Dictionary","String","Any"])),i,n+"/"+t.PROPERTY_NAMES),this.constant=this.rawSchema_[t.CONST],this.enumeration=T.clone(T.as(this.rawSchema_[t.ENUM],["Array","Any"])),this.format=T.as(this.rawSchema_[t.FORMAT],"String"),this.contentMediaType=T.as(this.rawSchema_[t.CONTENT_MEDIA_TYPE],"String"),this.contentEncoding=T.as(this.rawSchema_[t.CONTENT_ENCODING],"String"),this.ifRule=t.fromJSON(T.clone(T.as(this.rawSchema_[t.IF],["Dictionary","String","Any"])),i,n+"/"+t.IF),this.thenRule=t.fromJSON(T.clone(T.as(this.rawSchema_[t.THEN],["Dictionary","String","Any"])),i,n+"/"+t.THEN),this.elseRule=t.fromJSON(T.clone(T.as(this.rawSchema_[t.ELSE],["Dictionary","String","Any"])),i,n+"/"+t.ELSE),this.allOf=T.clone(T.opt(T.as(this.rawSchema_[t.ALL_OF],["Array",["Dictionary","String","Any"]]),(function(e){return e.map((function(e){return t.fromJSON(T.clone(e),i,n+"/"+t.ALL_OF)}),r)}))),this.anyOf=T.clone(T.opt(T.as(this.rawSchema_[t.ANY_OF],["Array",["Dictionary","String","Any"]]),(function(e){return e.map((function(e){return t.fromJSON(T.clone(e),i,n+"/"+t.ANY_OF)}),r)}))),this.oneOf=T.clone(T.opt(T.as(this.rawSchema_[t.ONE_OF],["Array",["Dictionary","String","Any"]]),(function(e){return e.map((function(e){return t.fromJSON(T.clone(e),i,n+"/"+t.ONE_OF)}),r)}))),this.notRule=t.fromJSON(T.clone(T.as(this.rawSchema_[t.NOT],["Dictionary","String","Any"])),i,n+"/"+t.NOT),this.className=T.as(this.rawSchema_[t.CLASS_NAME],"String"),this.manifestProperties=T.clone(T.as(this.rawSchema_[t.MANINFEST_PROPERTIES],["Array","String"])),this.readData=T.as(this.rawSchema_[t.READ_DATA],"Bool"),this.reified_=!1,this.simplified_=!1},e={};return T.defineClass({name:"Rule",ctor:t,statics:{_SCHEMA:{get:function(){return void 0===e._SCHEMA&&(e._SCHEMA="$schema"),e._SCHEMA}},_ID:{get:function(){return void 0===e._ID&&(e._ID="$id"),e._ID}},_REF:{get:function(){return void 0===e._REF&&(e._REF="$ref"),e._REF}},_COMMENT:{get:function(){return void 0===e._COMMENT&&(e._COMMENT="$comment"),e._COMMENT}},TITLE:"title",DESCRIPTION:"description",DEFINITIONS:"definitions",DEPENDENCIES:"dependencies",TYPE:"type",DEFAULT:"default",READ_ONLY:"readOnly",EXAMPLES:"examples",MULTIPLE_OF:"multipleOf",MAXIMUM:"maximum",EXCLUSIVE_MAXIMUM:"exclusiveMaximum",MINIMUM:"minimum",EXCLUSIVE_MINIMUM:"exclusiveMinimum",MAX_LENGTH:"maxLength",MIN_LENGTH:"minLength",PATTERN:"pattern",ITEMS:"items",ADDITIONAL_ITEMS:"additionalItems",MAX_ITEMS:"maxItems",MIN_ITEMS:"minItems",UNIQUE_ITEMS:"uniqueItems",CONTAINS:"contains",PROPERTIES:"properties",MAX_PROPERTIES:"maxProperties",MIN_PROPERTIES:"minProperties",REQUIRED:"required",ADDITIONAL_PROPERTIES:"additionalProperties",PATTERN_PROPERTIES:"patternProperties",PROPERTY_NAMES:"propertyNames",CONST:"const",ENUM:"enum",FORMAT:"format",CONTENT_MEDIA_TYPE:"contentMediaType",CONTENT_ENCODING:"contentEncoding",IF:"if",THEN:"then",ELSE:"else",ALL_OF:"allOf",ANY_OF:"anyOf",ONE_OF:"oneOf",NOT:"not",CLASS_NAME:"className",MANINFEST_PROPERTIES:"manifest-properties",READ_DATA:"read-data",rulesFromSchemata:function(e){for(var i={},n=T.iter(e);!n.done;n.next()){var r=n.key,a=n.value;i[r]=new t(T.clone(a),r,r+"#")}return i},definitionsFromSchemata:function(e){var i=T.clone(t.rulesFromSchemata(T.clone(e))),n=T.clone(i),r=null,a=null;a=function(e,i){var r;if(r=i.definitions)for(var s=T.iter(r);!s.done;s.next()){var o=s.key,l=s.value,u=e+"/"+o;l.definedName=o,n[u]=l,a(u+"/"+t.DEFINITIONS,l)}};for(var s=T.iter(i);!s.done;s.next()){var o=s.key,l=s.value;a(o+"#/"+t.DEFINITIONS,l)}r=function(t){return null!=t?(T.opt(n[t],(function(t){return t.resolveRefs(r)})),n[t]):null};for(var u=T.iter(n);!u.done;u.next()){(l=u.value).resolveRefs(r)}for(var c=T.iter(n);!c.done;c.next()){(l=c.value).reify()}for(var h=T.iter(n);!h.done;h.next()){(l=h.value).simplify()}return n},fromJSON:function(e,i,n){return null!=e?new t(T.clone(e),i,n):null},fromDefinitions:function(e,i,n){if(null!=e){for(var r={},a=T.iter(e);!a.done;a.next()){var s=a.key,o=a.value;r[s]=new t(T.clone(o),i,n+"/"+s)}return r}return null},typesFromSchema:function(e){var i,n,r;if(null!=(n=T.as(e[t.TYPE],"String"))){var a=j.DBSchemaType.toCaseValue(n);return null!=a?[a]:null}return(r=T.as(e[t.TYPE],["Array","String"]))?r.map((function(t){return(i=j.DBSchemaType.toCaseValue(t))||null!=i?i:j.DBSchemaType.UnknownType}),this):null}},props:{getRequiredProperties:function(){return this.requiredProperties},getPropertyRule:function(t){return T.opt(this.properties,(function(e){return e[t]}))},schemaType:{get:function(){var t;return(t=this.type)||null!=t?t:j.DBSchemaType.UnknownType}},schemaTypeName:{get:function(){var t;return(t=this.className)||null!=t?t:this.definedName}},reify:function(){var t=this,e=this.reifiedRule;if(!e.reified_){if(e.reified_=!0,e.dependencies=T.opt(e.dependencies,(function(t){return t.reify()})),e.items=T.opt(e.items,(function(t){return t.reify()})),e.additionalItems=T.opt(e.additionalItems,(function(t){return t.reify()})),e.contains=T.opt(e.contains,(function(t){return t.reify()})),e.additionalProperties=T.opt(e.additionalProperties,(function(t){return t.reify()})),e.propertyNames=T.opt(e.propertyNames,(function(t){return t.reify()})),e.ifRule=T.opt(e.ifRule,(function(t){return t.reify()})),e.thenRule=T.opt(e.thenRule,(function(t){return t.reify()})),e.elseRule=T.opt(e.elseRule,(function(t){return t.reify()})),e.notRule=T.opt(e.notRule,(function(t){return t.reify()})),e.tupleItems=T.clone(T.opt(e.tupleItems,(function(e){return e.map((function(t){return t.reify()}),t)}))),e.allOf=T.clone(T.opt(e.allOf,(function(e){return e.map((function(t){return t.reify()}),t)}))),e.anyOf=T.clone(T.opt(e.anyOf,(function(e){return e.map((function(t){return t.reify()}),t)}))),e.oneOf=T.clone(T.opt(e.oneOf,(function(e){return e.map((function(t){return t.reify()}),t)}))),null!=e.definitions)for(var i=T.iter(e.definitions);!i.done;i.next()){var n=i.key,r=i.value;e.definitions[n]=r.reify()}if(null!=e.properties)for(var a=T.iter(e.properties);!a.done;a.next()){n=a.key,r=a.value;e.properties[n]=r.reify()}if(null!=e.patternProperties)for(var s=T.iter(e.patternProperties);!s.done;s.next()){n=s.key,r=s.value;e.patternProperties[n]=r.reify()}}return e},simplify:function(){if(!this.simplified_){if(this.simplified_=!0,null!=this.allOf){for(;0==!this.allOf.length;)this.merge(this.allOf.pop());this.allOf=null}if(null==this.constant&&null!=this.enumeration&&1==this.enumeration.length&&(this.constant=this.enumeration[0]),null==this.type&&null!=this.typeArray&&1==this.typeArray.length&&(this.type=this.typeArray[0]),this.stringConstant=T.as(this.constant,"String"),this.intConstant=T.as(this.constant,"Int"),this.stringEnumeration=T.clone(T.as(this.enumeration,["Array","String"])),this.intEnumeration=T.clone(T.as(this.enumeration,["Array","Int"])),T.opt(this.dependencies,(function(t){return t.simplify()})),T.opt(this.items,(function(t){return t.simplify()})),T.opt(this.additionalItems,(function(t){return t.simplify()})),T.opt(this.contains,(function(t){return t.simplify()})),T.opt(this.additionalProperties,(function(t){return t.simplify()})),T.opt(this.propertyNames,(function(t){return t.simplify()})),T.opt(this.ifRule,(function(t){return t.simplify()})),T.opt(this.thenRule,(function(t){return t.simplify()})),T.opt(this.elseRule,(function(t){return t.simplify()})),T.opt(this.notRule,(function(t){return t.simplify()})),T.opt(this.tupleItems,(function(t){return t.forEach((function(t){return t.simplify()}))})),T.opt(this.allOf,(function(t){return t.forEach((function(t){return t.simplify()}))})),T.opt(this.anyOf,(function(t){return t.forEach((function(t){return t.simplify()}))})),T.opt(this.oneOf,(function(t){return t.forEach((function(t){return t.simplify()}))})),null!=this.definitions)for(var t=T.iter(this.definitions);!t.done;t.next()){t.value.simplify()}if(null!=this.properties)for(var e=T.iter(this.properties);!e.done;e.next()){e.value.simplify()}if(null!=this.patternProperties)for(var i=T.iter(this.patternProperties);!i.done;i.next()){i.value.simplify()}}},merge:function(e){var i,n,r,a,s,o,l,u,c,h,f,p,d,m,b,D,y,_,S,v,B,g,P;if(this._id=(i=this._id)||null!=i?i:e._id,this._comment=(n=this._comment)||null!=n?n:e._comment,this.title=(r=this.title)||null!=r?r:e.title,this.description=(a=this.description)||null!=a?a:e.description,this.typeArray=T.clone(this.typeArray||e.typeArray),this.defaultValue=(s=this.defaultValue)||null!=s?s:e.defaultValue,this.readOnly=(o=this.readOnly)||null!=o?o:e.readOnly,this.examples=T.clone(this.examples||e.examples),this.multipleOf=(l=this.multipleOf)||null!=l?l:e.multipleOf,this.maximum=(u=this.maximum)||null!=u?u:e.maximum,this.exclusiveMaximum=(c=this.exclusiveMaximum)||null!=c?c:e.exclusiveMaximum,this.minimum=(h=this.minimum)||null!=h?h:e.minimum,this.exclusiveMinimum=(f=this.exclusiveMinimum)||null!=f?f:e.exclusiveMinimum,this.maxLength=(p=this.maxLength)||null!=p?p:e.maxLength,this.minLength=(d=this.minLength)||null!=d?d:e.minLength,this.pattern=(m=this.pattern)||null!=m?m:e.pattern,this.tupleItems=T.clone(this.tupleItems||e.tupleItems),this.maxItems=(b=this.maxItems)||null!=b?b:e.maxItems,this.minItems=(D=this.minItems)||null!=D?D:e.minItems,this.uniqueItems=(y=this.uniqueItems)||null!=y?y:e.uniqueItems,this.contains=this.contains||e.contains,this.maxProperties=(_=this.maxProperties)||null!=_?_:e.maxProperties,this.minProperties=(S=this.minProperties)||null!=S?S:e.minProperties,this.additionalProperties=this.additionalProperties||e.additionalProperties,this.propertyNames=this.propertyNames||e.propertyNames,this.constant=(v=this.constant)||null!=v?v:e.constant,this.enumeration=T.clone(this.enumeration||e.enumeration),this.format=(B=this.format)||null!=B?B:e.format,this.contentMediaType=T.as(this.rawSchema_[t.CONTENT_MEDIA_TYPE],"String"),this.contentEncoding=T.as(this.rawSchema_[t.CONTENT_ENCODING],"String"),this.ifRule=this.ifRule||e.ifRule,this.thenRule=this.thenRule||e.thenRule,this.elseRule=this.elseRule||e.elseRule,this.className=(g=this.className)||null!=g?g:e.className,this.readData=(P=this.readData)||null!=P?P:e.readData,null!=e.dependencies&&(null==this.dependencies?this.dependencies=e.dependencies:T.opt(this.dependencies,(function(t){return t.merge(e.dependencies)}))),null!=e.definitions)if(null==this.definitions)this.definitions=T.clone(e.definitions);else for(var O=T.iter(e.definitions);!O.done;O.next()){var j=O.key,I=O.value;null==this.definitions[j]&&(this.definitions[j]=I)}if(null!=e.items&&(null==this.items?this.items=e.items:T.opt(this.items,(function(t){return t.merge(e.items)}))),null!=e.additionalItems&&(null==this.additionalItems?this.additionalItems=e.additionalItems:T.opt(this.additionalItems,(function(t){return t.merge(e.additionalItems)}))),null!=e.properties)if(null==this.properties)this.properties=T.clone(e.properties);else for(var E=T.iter(e.properties);!E.done;E.next()){var C=E.key,V=E.value;null==this.properties[C]&&(this.properties[C]=V)}if(null!=e.patternProperties)if(null==this.patternProperties)this.patternProperties=T.clone(e.patternProperties);else for(var N=T.iter(e.patternProperties);!N.done;N.next()){var R=N.key;V=N.value;null==this.patternProperties[R]&&(this.patternProperties[R]=V)}null!=e.notRule&&(null==this.notRule?this.notRule=e.notRule:T.opt(this.notRule,(function(t){return t.merge(e.notRule)}))),null!=e.allOf&&(null==this.allOf?this.allOf=T.clone(e.allOf):this.allOf=T.clone(this.allOf.concat(T.clone(e.allOf)))),null!=e.anyOf&&(null==this.anyOf?this.anyOf=T.clone(e.anyOf):this.anyOf=T.clone(this.anyOf.concat(T.clone(e.anyOf)))),null!=e.oneOf&&(null==this.oneOf?this.oneOf=T.clone(e.oneOf):this.oneOf=T.clone(this.oneOf.concat(T.clone(e.oneOf)))),null!=e.manifestProperties&&(null==this.manifestProperties?this.manifestProperties=T.clone(e.manifestProperties):this.manifestProperties=T.clone(T.opt(this.manifestProperties,(function(t){return t.concat(T.clone(e.manifestProperties))})))),null!=e.requiredProperties&&(null==this.requiredProperties?this.requiredProperties=T.clone(e.requiredProperties):this.requiredProperties=T.clone(T.opt(this.requiredProperties,(function(t){return t.concat(T.clone(e.requiredProperties))}))))},resolveRefs:function(t){if(!this._refsResolved){if(this._refsResolved=!0,null!=this._ref){var e=this._ref.startsWith("#")?this.filename_+this._ref:this._ref;this._refRule=t(e)}if(T.opt(this.dependencies,(function(e){return e.resolveRefs(t)})),null!=this.definitions)for(var i=T.iter(this.definitions);!i.done;i.next()){i.value.resolveRefs(t)}if(T.opt(this.items,(function(e){return e.resolveRefs(t)})),T.opt(this.tupleItems,(function(e){return e.forEach((function(e){return e.resolveRefs(t)}))})),T.opt(this.additionalItems,(function(e){return e.resolveRefs(t)})),T.opt(this.contains,(function(e){return e.resolveRefs(t)})),null!=this.properties)for(var n=T.iter(this.properties);!n.done;n.next()){n.value.resolveRefs(t)}if(T.opt(this.additionalProperties,(function(e){return e.resolveRefs(t)})),null!=this.patternProperties)for(var r=T.iter(this.patternProperties);!r.done;r.next()){r.value.resolveRefs(t)}T.opt(this.propertyNames,(function(e){return e.resolveRefs(t)})),T.opt(this.ifRule,(function(e){return e.resolveRefs(t)})),T.opt(this.thenRule,(function(e){return e.resolveRefs(t)})),T.opt(this.elseRule,(function(e){return e.resolveRefs(t)})),T.opt(this.allOf,(function(e){return e.forEach((function(e){return e.resolveRefs(t)}))})),T.opt(this.anyOf,(function(e){return e.forEach((function(e){return e.resolveRefs(t)}))})),T.opt(this.oneOf,(function(e){return e.forEach((function(e){return e.resolveRefs(t)}))})),T.opt(this.notRule,(function(e){return e.resolveRefs(t)}))}},reifiedRule:{get:function(){return 1==T.count(this.rawSchema_)&&null!=this.rawSchema_[t._REF]&&this._refRule||this}},isValid:function(t){return null!=this.validate(t).value},validateProperty:function(t){if(t instanceof C.DBDeletedProperty)return j.DBValidationResult.empty;var e;if(e=T.as(t.objValue,E.DBObject)){var i=T.clone(e.state.allProperties);return i[j.DBSchema.PROPERTY_ID]=C.DBProperty.stringProperty(C.DBNamePath.init_b14a(j.DBSchema.PROPERTY_ID),e.id),this.validate(T.clone(i))}return this.validate(t.value)},validate:function(t){var e,i,n=this;if(i=T.as(t,C.DBProperty))return this.validateProperty(i);if(null!=this._refRule)return this._refRule.validate(t);var r=null;if(null!=this.className&&(null==r?r=this.emptyClass(t).value:T.opt(r,(function(e){return e.merge(n.emptyClass(t).value)}))),null!=this.constant){var a,s=this.validateConstant(t);if(a=T.as(s,j.DBValidationError))return a;null==r?r=s.value:T.opt(r,(function(t){return t.merge(s.value)}))}else if(null!=this.enumeration){var o,l=this.validateEnumeration(t);if(o=T.as(l,j.DBValidationError))return o;null==r?r=l.value:T.opt(r,(function(t){return t.merge(l.value)}))}if(null!=this.type){var u,c,h=null;switch(this.type){case"boolean":h=this.validateBoolean(t);break;case"integer":h=this.validateInteger(t);break;case"number":h=this.validateNumber(t);break;case"string":h=this.validateString(t);break;case"array":h=this.validateArray(t);break;case"object":h=this.validateObject(t);break;case"unknown":return this.fail(t)}if(u=T.as(h,j.DBValidationError))return u;(c=T.opt(h,(function(t){return t.value})))&&(null==r?r=c:T.opt(r,(function(t){return t.merge(c)})))}else if(null!=this.typeArray){var f,p=this.validateTypes(t);if(f=T.as(p,j.DBValidationError))return f;null==r?r=p.value:T.opt(r,(function(t){return t.merge(p.value)}))}if(null!=this.anyOf||null!=this.oneOf||null!=this.ifRule&&null!=this.thenRule||null!=this.notRule){var d,m=this.validateCompounds(t);if(d=T.as(m,j.DBValidationError))return d;null==r?r=m.value:T.opt(r,(function(t){return t.merge(m.value)}))}return null!=this.defaultValue&&(null==r?r=this.validateDefault(t).value:T.opt(r,(function(e){return e.merge(n.validateDefault(t).value)}))),(!(e=this.readData)&&null==e||e)&&null!=r?j.DBValidationResult.init_2063(r):j.DBValidationResult.empty},fail:function(t){return new j.DBValidationError},pass:function(t){return j.DBValidationResult.init_2063(j.DBSchemaValue.init_4199(j.DBSchemaType.UnknownType,t,this.className))},emptyClass:function(t){return j.DBValidationResult.init_2063(j.DBSchemaValue.emptyValue(this.className))},validateDefault:function(t){var e;return null==t?j.DBValidationResult.init_2063(j.DBSchemaValue.init_e1d9((e=this.type)||null!=e?e:j.DBSchemaType.UnknownType,this.defaultValue,this.className,!0)):j.DBValidationResult.init_2063(j.DBSchemaValue.emptyValue(this.className))},validateConstant:function(t){var e,i,n,r;return null!=(e=this.intConstant)?null!=t?null!=(n=T.as(t,"Int"))?n==e?j.DBValidationResult.init_2063(j.DBSchemaValue.fromInt(n)):new j.DBValidationErrorConstantIntMismatch(n,e):new j.DBValidationErrorType(t,j.DBSchemaType.IntegerType):j.DBValidationResult.init_2063(j.DBSchemaValue.init_4199(j.DBSchemaType.IntegerType,null,null)):null!=(i=this.stringConstant)?null!=t?null!=(r=T.as(t,"String"))?r==i?j.DBValidationResult.init_2063(j.DBSchemaValue.fromString(r)):new j.DBValidationErrorConstantStringMismatch(r,i):new j.DBValidationErrorType(t,j.DBSchemaType.StringType):j.DBValidationResult.init_2063(j.DBSchemaValue.init_4199(j.DBSchemaType.StringType,null,null)):new j.DBValidationErrorNotImplemented},validateEnumeration:function(t){var e,i,n,r;return(e=this.intEnumeration)?null!=(n=T.as(t,"Int"))?e.includes(n)?j.DBValidationResult.init_2063(j.DBSchemaValue.fromInt(n)):new j.DBValidationErrorIntEnumMismatch(n,T.clone(e)):new j.DBValidationErrorType(t,j.DBSchemaType.IntegerType):(i=this.stringEnumeration)?null!=t?null!=(r=T.as(t,"String"))?i.includes(r)?j.DBValidationResult.init_2063(j.DBSchemaValue.fromString(r)):new j.DBValidationErrorStringEnumMismatch(r,T.clone(i)):new j.DBValidationErrorType(t,j.DBSchemaType.StringType):j.DBValidationResult.init_2063(j.DBSchemaValue.init_4199(j.DBSchemaType.StringType,null,null)):new j.DBValidationErrorNotImplemented},validateTypes:function(t){for(var e=[],i=T.iter(this.typeArray);!i.done;i.next()){var n,r=null;switch(i.value){case"boolean":r=this.validateBoolean(t);break;case"integer":r=this.validateInteger(t);break;case"number":r=this.validateNumber(t);break;case"string":r=this.validateString(t);break;case"array":r=this.validateArray(t);break;case"object":r=this.validateObject(t);break;case"unknown":e.push(this.fail(t))}if(T.opt(r,(function(t){return null!=t.value})))return r;(n=T.as(r,j.DBValidationError))&&e.push(n)}return new j.DBValidationErrorCompound(T.clone(e))},validateBoolean:function(t){var e;return null!=t?null!=(e=T.as(t,"Bool"))?j.DBValidationResult.init_2063(j.DBSchemaValue.fromBool(e)):new j.DBValidationErrorType(t,j.DBSchemaType.BooleanType):j.DBValidationResult.init_2063(j.DBSchemaValue.init_4199(j.DBSchemaType.BooleanType,null,null))},validateInteger:function(t){if(null!=t){var e;if(null!=(e=T.as(t,"Int"))){if(null!=this.maximum&&T.toDouble(e)>this.maximum)return new j.DBValidationErrorLimit(e,this.maximum,!1,!1);if(null!=this.exclusiveMaximum&&T.toDouble(e)>=this.exclusiveMaximum)return new j.DBValidationErrorLimit(e,this.maximum,!1,!0);if(null!=this.minimum&&T.toDouble(e)<this.minimum)return new j.DBValidationErrorLimit(e,this.minimum,!0,!1);if(null!=this.exclusiveMinimum&&T.toDouble(e)<=this.exclusiveMinimum)return new j.DBValidationErrorLimit(e,this.minimum,!0,!0);var i;if(null!=(i=this.multipleOf)){var n=T.toDouble(e),r=n/i;if(r!=Math.floor(r))return new j.DBValidationErrorMultiple(n,i)}return j.DBValidationResult.init_2063(j.DBSchemaValue.fromInt(e))}return new j.DBValidationErrorType(t,j.DBSchemaType.IntegerType)}return j.DBValidationResult.init_2063(j.DBSchemaValue.init_4199(j.DBSchemaType.IntegerType,null,null))},validateNumber:function(t){if(null!=t){var e;if(null!=(e=T.as(t,"Double"))){if(null!=this.maximum&&e>this.maximum)return new j.DBValidationErrorLimit(e,this.maximum,!1,!1);if(null!=this.exclusiveMaximum&&e>=this.exclusiveMaximum)return new j.DBValidationErrorLimit(e,this.maximum,!1,!0);if(null!=this.minimum&&e<this.minimum)return new j.DBValidationErrorLimit(e,this.minimum,!0,!1);if(null!=this.exclusiveMinimum&&e<=this.exclusiveMinimum)return new j.DBValidationErrorLimit(e,this.minimum,!0,!0);var i;if(null!=(i=this.multipleOf)){var n=e/i;if(n!=Math.floor(n))return new j.DBValidationErrorMultiple(e,i)}return j.DBValidationResult.init_2063(j.DBSchemaValue.fromDouble(e))}return new j.DBValidationErrorType(t,j.DBSchemaType.NumberType)}return j.DBValidationResult.init_2063(j.DBSchemaValue.init_4199(j.DBSchemaType.NumberType,null,null))},validateString:function(t){var e,i=this;if(null!=t){var n;if(null!=(n=T.as(t,"String"))){if(null!=this.maxLength&&n.length>this.maxLength)return new j.DBValidationErrorLimitStringLength(n.length,this.maxLength,!1);if(null!=this.minLength&&n.length<this.minLength)return new j.DBValidationErrorLimitStringLength(n.length,this.minLength,!0);if(null!=this.pattern)if(!(!(e=T.opt(N.Host.schema,(function(t){return t.matches(n,i.pattern)})))&&null==e||e))return new j.DBValidationErrorStringPattern(n,this.pattern);return j.DBValidationResult.init_2063(j.DBSchemaValue.fromString(n))}return new j.DBValidationErrorType(t,j.DBSchemaType.StringType)}return j.DBValidationResult.init_2063(j.DBSchemaValue.init_4199(j.DBSchemaType.StringType,null,null))},validateArray:function(t){var e;if(null!=t){var i;if(i=T.as(t,["Array","Any"])){var n,r,a,s=[];if(null!=this.maxItems&&i.length>this.maxItems)return new j.DBValidationErrorLimitItems(i.length,this.maxItems,!1);if(null!=this.minItems&&i.length<this.minItems)return new j.DBValidationErrorLimitItems(i.length,this.minItems,!0);if(n=this.tupleItems)for(var o=T.iter(T.range(0,i.length,!1));!o.done;o.next()){var l=o.value;if(l>=n.length){var u;if(!(u=this.additionalItems))return new j.DBValidationErrorLimitItems(i.length,n.length,!1);var c=u.validate(i[l]);if(h=T.as(c,j.DBValidationError))return h;(m=c.value)&&s.push(m)}else{var h,f=n[l].validate(i[l]);if(h=T.as(f,j.DBValidationError))return h;(m=f.value)&&s.push(m)}}else if(r=this.items)for(var p=T.iter(i);!p.done;p.next()){var d,m,b=p.value,D=r.validate(b);if(d=T.as(D,j.DBValidationError))return d;(m=D.value)&&s.push(m)}if(((e=this.uniqueItems)||null!=e)&&e)for(var y=[],_=T.iter(s);!_.done;_.next()){t=_.value;if(y.filter((function(e){return t.isEqual(e)}),this).length>0)return new j.DBValidationErrorUniqueItems(T.clone(i));y.push(t)}if(a=this.contains){for(var S=!1,v=T.iter(i);!v.done;v.next()){b=v.value;if(a.isValid(b)){S=!0;break}}if(!S)return new j.DBValidationErrorRequiredItem(T.clone(i))}return j.DBValidationResult.init_2063(j.DBSchemaValue.fromArray(T.clone(s)))}return new j.DBValidationErrorType(t,j.DBSchemaType.ArrayType)}return j.DBValidationResult.init_2063(j.DBSchemaValue.init_4199(j.DBSchemaType.ArrayType,null,null))},validateObject:function(t){var e,i,n,r=this;if(null!=t){var a,s,o,l,u,c={};if(null!=this.maxProperties)if((a=T.as(t,["Dictionary","String","Any"]))&&T.count(a)>this.maxProperties)return new j.DBValidationErrorLimitProperties(T.count(a),this.maxProperties,!1);if(null!=this.minProperties)if((a=T.as(t,["Dictionary","String","Any"]))&&T.count(a)<this.minProperties)return new j.DBValidationErrorLimitProperties(T.count(a),this.minProperties,!0);if(E=this.requiredProperties)if(o=T.as(t,R.IImportDataObject))for(var h=T.iter(E);!h.done;h.next()){if((b=h.value)!=j.DBSchema.PROPERTY_ID&&b!=j.DBSchema.PROPERTY_TYPE&&b!=j.DBSchema.PROPERTY_NAME&&b!=j.DBSchema.PROPERTY_PATH&&null==o.property(b))return new j.DBValidationErrorRequiredProperty(o,b)}else if(T.is(t,R.IImportDataComponent))for(var f=T.iter(E);!f.done;f.next()){if((b=f.value)!=j.DBSchema.PROPERTY_ID&&b!=j.DBSchema.PROPERTY_NAME&&b!=j.DBSchema.PROPERTY_PATH&&b!=j.DBSchema.PROPERTY_MIME_TYPE&&b!=j.DBSchema.PROPERTY_ETAG&&b!=j.DBSchema.PROPERTY_URL)return new j.DBValidationErrorRequiredProperty(t,b)}else if(a=T.as(t,["Dictionary","String","Any"]))for(var p=T.iter(E);!p.done;p.next()){if(null==a[b=p.value])return new j.DBValidationErrorRequiredProperty(T.clone(a),b)}else if(null!=t)return new j.DBValidationErrorType(t,j.DBSchemaType.ObjectType);if((s=this.propertyNames)&&(u=T.as(t,["Dictionary","String","Any"])))for(var d=T.iter(T.keys(u));!d.done;d.next()){var m,b=d.value,D=s.validate(b);if(m=T.as(D,j.DBValidationError))return m}if(o=T.as(t,R.IImportDataObject)){if(null!=this.properties){var y=[];(E=this.requiredProperties)&&(y=T.clone(E)),T.append(y,T.keys(this.properties).filter((function(t){return!(((e=T.opt(r.requiredProperties,(function(e){return e.includes(t)})))||null!=e)&&e)}),this));for(var _=T.iter(y);!_.done;_.next()){var S=_.value,v=this.properties[S],B=null;if(S==j.DBSchema.PROPERTY_ID&&null!=o.id)B=v.validate(o.id);else if(S==j.DBSchema.PROPERTY_TYPE&&null!=o.type)B=v.validate(o.type);else if(S==j.DBSchema.PROPERTY_NAME&&null!=o.name)B=v.validate(o.name);else if(S==j.DBSchema.PROPERTY_PATH&&null!=o.path)B=v.validate(o.path);else if(S==j.DBSchema.PROPERTY_CHILDREN){var g=[];o.forEachChild((function(t,e){return g.splice(e,0,t)})),B=v.validate(T.clone(g))}else if(S==j.DBSchema.PROPERTY_COMPONENTS){var P=[];o.forEachComponent((function(t,e){return P.splice(e,0,t)})),B=v.validate(T.clone(P))}else if(null!=(t=o.property(S)))B=v.validate(t);else if(null!=v.defaultValue){null!=(A=v.validate(null)).value&&(B=A)}if(W=T.as(B,j.DBValidationError))return W;(I=T.opt(B,(function(t){return t.value})))&&(c[S]=I)}}}else if(l=T.as(t,R.IImportDataComponent)){if(null!=this.properties){y=[];(E=this.requiredProperties)&&(y=T.clone(E)),T.append(y,T.keys(this.properties).filter((function(t){return!(((i=T.opt(r.requiredProperties,(function(e){return e.includes(t)})))||null!=i)&&i)}),this));for(var O=T.iter(y);!O.done;O.next()){var I;S=O.value,v=this.properties[S],B=null;if(S==j.DBSchema.PROPERTY_ID&&null!=l.id?B=v.validate(l.id):S==j.DBSchema.PROPERTY_NAME&&null!=l.name?B=v.validate(l.name):S==j.DBSchema.PROPERTY_PATH&&null!=l.path?B=v.validate(l.path):S==j.DBSchema.PROPERTY_MIME_TYPE&&null!=l.mimeType?B=v.validate(l.mimeType):S==j.DBSchema.PROPERTY_ETAG&&null!=l.etag?B=v.validate(l.etag):S==j.DBSchema.PROPERTY_URL&&null!=l.url&&(B=v.validate(l.url)),W=T.as(B,j.DBValidationError))return W;(I=T.opt(B,(function(t){return t.value})))&&(c[S]=I)}}}else if(u=T.as(t,["Dictionary","String","Any"])){if(null!=this.properties){var E;if(E=this.requiredProperties)for(var C=T.iter(E);!C.done;C.next()){if(null==(t=u[b=C.value]))return new j.DBValidationErrorRequiredProperty(T.clone(u),b);B=this.properties[b].validate(t);if(W=T.as(B,j.DBValidationError))return W;(G=B.value)&&(c[b]=G)}for(var V=T.iter(this.properties);!V.done;V.next()){b=V.key,v=V.value;if(null==c[b])if(null!=(t=u[b])){B=v.validate(t);if(W=T.as(B,j.DBValidationError))return W;(G=B.value)&&(c[b]=G)}else if(null!=v.defaultValue){var A,M;(M=(A=v.validate(null)).value)&&(c[b]=M)}}}var w;if(w=this.patternProperties)for(var k=T.iter(w);!k.done;k.next())for(var x=k.key,L=(v=k.value,T.keys(u).filter((function(t){return null==c[t]&&!(!(n=T.opt(N.Host.schema,(function(e){return e.matches(t,x)})))&&null==n)&&n}),this)),U=T.iter(L);!U.done;U.next()){S=U.value,B=v.validate(u[S]);if(W=T.as(B,j.DBValidationError))return W;(G=B.value)&&(c[S]=G)}var F,Y=T.keys(u).filter((function(t){return null==c[t]}),this);if(F=this.additionalProperties)for(var q=T.iter(Y);!q.done;q.next()){var W,G;S=q.value,B=F.validate(u[S]);if(W=T.as(B,j.DBValidationError))return W;(G=B.value)&&(c[S]=G)}}return j.DBValidationResult.init_2063(j.DBSchemaValue.fromDict(T.clone(c)))}return j.DBValidationResult.init_2063(j.DBSchemaValue.init_4199(j.DBSchemaType.ObjectType,null,null))},validateAnyOf:function(t,e){var i;if(i=e){for(var n=[],r=T.iter(i);!r.done;r.next()){var a,s=r.value.validate(t);if(!(a=T.as(s,j.DBValidationError)))return s;n.push(a)}return new j.DBValidationErrorCompound(T.clone(n))}return new j.DBValidationError},validateOneOf:function(t,e){var i;if(i=e){for(var n=[],r=[],a=0,s=null,o=T.iter(i);!o.done;o.next()){var l,u=o.value,c=u.validate(t);if((l=T.as(c,j.DBValidationError))?n.push(l):(s=c,a+=1,r.push(u.pathToObject_)),a>1)break}return 1==a?s:new j.DBValidationErrorMultipleMatches(T.clone(r),T.clone(n))}return new j.DBValidationError},validateCompounds:function(t){var e,i;if(I.CoreAssert.isTrue(null==this.allOf,"Rules should be simplified before validation","Rule.validateCompounds","DBSchema.swift",1634),e=this.anyOf)return this.validateAnyOf(t,T.clone(e));if(i=this.oneOf)return this.validateAnyOf(t,T.clone(i));if(null!=this.notRule){var n=!0;return this.notRule.validate(t)instanceof j.DBValidationError&&(n=!1),n?new j.DBValidationErrorNegation:j.DBValidationResult.init_2063(j.DBSchemaValue.emptyValue(this.className))}if(null!=this.ifRule&&null!=this.thenRule){if(!(this.ifRule.validate(t)instanceof j.DBValidationError))return this.thenRule.validate(t);if(null!=this.elseRule)return this.elseRule.validate(t)}return j.DBValidationResult.init_2063(j.DBSchemaValue.emptyValue(this.className))},codec:{get:function(){var t=null!=this.definedName?C.DBPropertyCodec.typeCodec(this.definedName):null;if(null==t){if(this.schemaType==j.DBSchemaType.BooleanType)t=C.DBPropertyCodec.boolCodec();else if(this.schemaType==j.DBSchemaType.IntegerType||null!=this.intConstant||null!=this.intEnumeration)t=C.DBPropertyCodec.intCodec();else if(this.schemaType==j.DBSchemaType.NumberType)t=C.DBPropertyCodec.doubleCodec();else if(this.schemaType==j.DBSchemaType.StringType||null!=this.stringConstant||null!=this.stringEnumeration)t=C.DBPropertyCodec.stringCodec();else if(this.schemaType==j.DBSchemaType.ArrayType){if(null!=this.tupleItems){var e=this.tupleItems.map((function(t){return t.codec}),this);null!=this.additionalItems&&e.push(this.additionalItems.codec),t=C.DBPropertyCodec.tupleCodec(T.clone(e))}else if(null!=this.items){var i=this.items.codec;t=C.DBPropertyCodec.arrayCodec(i)}}else if(this.schemaType==j.DBSchemaType.ObjectType)if(null!=this.definedName&&T.opt(this.properties,(function(t){return null!=t.id})))t=C.DBPropertyCodec.objectCodec(this.definedName);else{var n={};if(null!=this.properties)for(var r=T.iter(this.properties);!r.done;r.next()){var a=r.key,s=r.value;n[a]=s.codec}t=C.DBPropertyCodec.dictionaryCodec(T.clone(n))}I.CoreAssert.isTrue(null!=t,"Failed to generate a codec for "+this+".","Rule","DBSchema.swift",1703)}return t}},propertyCodecs:{get:function(){var t={};if(null!=this.properties)for(var e=T.iter(this.properties);!e.done;e.next()){var i=e.key,n=e.value;i==j.DBSchema.PROPERTY_CHILDREN?t[i]=C.DBPropertyCodec.arrayCodec(C.DBPropertyCodec.objectCodec()):t[i]=n.codec}return t}},propertyRules:{get:function(){return this.properties||{}}},getCodecChain:function(t,e){var i,n=[],r=T.clone(t),a=r.shift(),s=e.getProperty(a);if(a==j.DBSchema.PROPERTY_CHILDREN){var o=C.DBPropertyCodec.arrayCodec(C.DBPropertyCodec.objectCodec());null==s&&(s=C.DBProperty.arrayProperty(C.DBNamePath.init_b14a(a),[])),n.push([o,s]),I.CoreAssert.isTrue(0==r.length,"Need to figure out property chains for database links; objects with child-states should be direct objects","Rule.getCodecChain","DBSchema.swift",1743)}else{var l;if(l=T.opt(this.properties,(function(t){return t[a]}))){var u=l,c=function(t,e,i){var r=t.codec,a=t.schemaType;null==(s=i())&&(s=a==j.DBSchemaType.ArrayType?C.DBProperty.arrayProperty(C.DBNamePath.init_b14a(e),[]):C.DBProperty.dictProperty(C.DBNamePath.init_b14a(e),{})),n.push([r,s]),u=t},h=function(t,e){var i=T.toInt(e);return null!=t&&t.isArray&&i<t.arrayPropertyCount?t.getArrayProperty(i):null};for(c(l,a,(function(){return s}));0==!r.length;){var f,p,d,m,b,D=u.schemaType,y=r.shift(),_=null;if(null!=(f=T.last(n))&&(_=f[1]),D==j.DBSchemaType.ArrayType)if(p=u.tupleItems){if(null!=(m=T.toInt(y)))m<p.length?c(p[m],y,(function(){return h(_,y)})):(b=u.additionalItems)&&c(b,y,(function(){return h(_,y)}))}else(d=u.items)&&c(d,y,(function(){return h(_,y)}));else if(D==j.DBSchemaType.ObjectType){var S,v;if(S=T.opt(u.properties,(function(t){return t[y]})))c(S,y,(function(){return T.opt(_,(function(t){return t.getDictionaryProperty(y)}))}));else if(v=u.patternProperties)for(var B=T.iter(v);!B.done;B.next()){var g=B.key,P=B.value;((i=T.opt(N.Host.schema,(function(t){return t.matches(y,g)})))||null!=i)&&i&&c(P,y,(function(){return T.opt(_,(function(t){return t.getDictionaryProperty(y)}))}))}}else I.CoreAssert.fail("Childless "+D+" in codec chain","Rule.getCodecChain","DBSchema.swift",1805)}}}return n}}}),t}(),j.DBSchema=function(){var t=function(){this.propertyCodecs={}},e={};return T.defineClass({name:"DBSchema",ctor:t,statics:{schemaVersion:"http://json-schema.org/draft-04/schema",PROPERTY_ID:"id",PROPERTY_TYPE:"type",PROPERTY_NAME:"name",PROPERTY_PATH:"path",PROPERTY_CHILDREN:"children",PROPERTY_COMPONENTS:"components",PROPERTY_MIME_TYPE:"mimeType",PROPERTY_ETAG:"etag",PROPERTY_URL:"url",PROPERTY_REF:{get:function(){return void 0===e.PROPERTY_REF&&(e.PROPERTY_REF="$ref"),e.PROPERTY_REF}},currentSchema:{get:function(){return void 0===e.currentSchema&&(e.currentSchema=t.init_2af7(A.TheoDocument.CURRENT_VERSION)),e.currentSchema},set:function(t){e.currentSchema=t}},getPropertyCodec:function(e,i){return null!=t.currentSchema.propertyCodecs[i]?t.currentSchema.propertyCodecs[i][e]:t.getPropertyCodecs(i)[e]},getPropertyCodecs:function(e){var i,n=T.clone(t.currentSchema.propertyCodecs[e]);null==n&&(n={},(i=t.currentSchema.rulesByName[e])&&(n=T.clone(i.propertyCodecs)),t.currentSchema.propertyCodecs[e]=T.clone(n));return n},getPropertyRules:function(e){var i;return(i=t.currentSchema.rulesByName[e])?i.propertyRules:{}},getCodecChain:function(e,i){var n,r=[];return(n=t.currentSchema.rulesByName[i.className])&&(r=T.clone(n.getCodecChain(T.clone(e),i))),r},getManifestProperties:function(e){return T.opt(t.currentSchema.rulesByName[e],(function(t){return t.manifestProperties}))},getValidator:function(e){var i=T.clone(t.getPropertyRules(e));return function(t){for(var e={},n=T.iter(i);!n.done;n.next()){var r,a=n.key,s=n.value;if((r=t.getProperty(a))&&r.shouldWrite){var o,l=s.validateProperty(r);if(o=T.as(l,j.DBValidationError))return o;e[a]=l.value}}return j.DBValidationResult.init_2063(j.DBSchemaValue.fromDict(T.clone(e)))}},getSerializer:function(e){var i=T.clone(t.getPropertyRules(e)),n=T.clone(t.getManifestProperties(e));return function(t,e){for(var r=T.iter(T.keys(i));!r.done;r.next()){var a=r.value;(o=t.getProperty(a))&&o.shouldWrite&&e(a,o,!1)}if(null!=n&&0==!n.length)for(var s=T.iter(n);!s.done;s.next()){var o;a=s.value;(o=t.getProperty(a))&&e(a,o,!0)}}},getArrayWriter:function(e,i,n){return function(r,a,s){var o,l;if(a.shouldWrite)if(null!=(o=a.className)&&(l=i.getObjectStateByID(a.linkID))){var u=t.getDictionaryWriter(m={},i,n);t.getSerializer(o)(l,u),e.push(m)}else switch(a.schemaType){case"boolean":var c;null!=(c=a.boolValue)&&e.push(c);break;case"integer":var h;null!=(h=a.intValue)&&e.push(h);break;case"number":var f;null!=(f=a.doubleValue)&&e.push(f);break;case"string":var p;null!=(p=a.stringValue)&&e.push(p);break;case"array":if(a.isArray){var d=[];u=t.getArrayWriter(d,i,n);a.forEachArrayProperty((function(t,e){return u("",e,!1)})),e.push(d)}break;case"object":if(a.isDictionary){var m;u=t.getDictionaryWriter(m={},i,n);a.forEachDictionaryProperty((function(t,e){return u(t,e,!1)})),e.push(m)}break;case"unknown":I.CoreAssert.fail("Cannot write a property of unknown type","DBSchema.getArrayWriter","DBSchema.swift",1988)}}},getDictionaryWriter:function(e,i,n){return function(r,a,s){var o,l;if(a.shouldWrite)if(null!=(o=a.className)&&(l=i.getObjectStateByID(a.linkID))){var u=t.getDictionaryWriter(h={},i,n);t.getSerializer(o)(l,u),e[r]=h}else switch(a.schemaType){case"boolean":e[r]=a.boolValue;break;case"integer":e[r]=a.intValue;break;case"number":e[r]=a.doubleValue;break;case"string":e[r]=a.stringValue;break;case"array":if(a.isArray){var c=[];u=t.getArrayWriter(c,i,n);a.forEachArrayProperty((function(t,e){return u("",e,!1)})),e[r]=c}break;case"object":if(a.isDictionary){var h;u=t.getDictionaryWriter(h={},i,n);a.forEachDictionaryProperty((function(t,e){return u(t,e,!1)})),e[r]=h}break;case"unknown":I.CoreAssert.fail("Cannot write a property of unknown type","DBSchema.getDictionaryWriter","DBSchema.swift",2040)}}},getDataObjectWriter:function(e,i,n,r){return function(a,s,o){if(s.shouldWrite)if(a==t.PROPERTY_ID){var l=T.opt(T.opt(n.getObjectStateByID(i),(function(e){return e.getProperty(t.PROPERTY_PATH)})),(function(t){return t.stringValue}));I.CoreAssert.isTrue(s.stringValue==i||i==l,"Saving object "+i+" with ID property "+s.stringValue,"DBSchema.getDataObjectWriter","DBSchema.swift",2059)}else if(a!=t.PROPERTY_PATH||o)if(a!=t.PROPERTY_NAME||o)if(a!=t.PROPERTY_TYPE||o)if(a!=t.PROPERTY_COMPONENTS||o)if(a!=t.PROPERTY_CHILDREN||o){var u=s.className,c=s.objValue;if(null!=u&&null!=c){var h=t.getDictionaryWriter(m={},n,r);t.getSerializer(u)(n.getObjectStateByID(s.linkID),h),o?e.setManifestProperty(a,m):e.setProperty(a,m)}else switch(s.schemaType){case"boolean":var f;null!=(f=s.boolValue)?o?e.setManifestProperty(a,T.as(f,"AnyObject")):e.setBooleanProperty(a,f):e.setOptionalBooleanProperty(a,null);break;case"integer":o?e.setManifestProperty(a,T.as(s.intValue,"AnyObject")):e.setIntProperty(a,s.intValue);break;case"number":o?e.setManifestProperty(a,T.as(s.doubleValue,"AnyObject")):e.setNumberProperty(a,s.doubleValue);break;case"string":var p;null!=(p=s.stringValue)?o?e.setManifestProperty(a,T.as(p,"AnyObject")):e.setStringProperty(a,p):e.setOptionalStringProperty(a,null);break;case"array":if(s.isArray){var d=[];h=t.getArrayWriter(d,n,r);s.forEachArrayProperty((function(t,e){return h("",e,!1)})),o?e.setManifestProperty(a,d):e.setProperty(a,d)}break;case"object":if(s.isDictionary){var m;h=t.getDictionaryWriter(m={},n,r);s.forEachDictionaryProperty((function(t,e){return h(t,e,!1)})),o?e.setManifestProperty(a,m):e.setProperty(a,m)}break;case"unknown":I.CoreAssert.fail("Cannot write a property of unknown type","DBSchema.getDataObjectWriter","DBSchema.swift",2177)}}else s.isArray&&s.forEachArrayProperty((function(i,a){var s=T.as(a.objValue,E.DBObject);if(null!=s){var o=n.getObjectState(s);t.getSerializer(s.className)(o,t.getDataObjectWriter(e.appendChild(s.id),s.id,n,r))}}));else s.isArray&&s.forEachArrayProperty((function(i,n){if(n.isDictionary){var r=T.opt(n.getDictionaryProperty(t.PROPERTY_ID),(function(t){return t.stringValue})),a=T.opt(n.getDictionaryProperty(t.PROPERTY_URL),(function(t){return t.stringValue})),s=T.opt(n.getDictionaryProperty(t.PROPERTY_MIME_TYPE),(function(t){return t.stringValue}));null!=r&&null!=a&&null!=s&&e.appendComponent(r,a,s)}}));else{var b;null!=(b=s.stringValue)&&e.setType(b)}else{var D;null!=(D=s.stringValue)&&e.setName(D)}else e.setPath(s.stringValue);else o&&e.setManifestProperty(a,null)}}},props:{init_2af7:function(t){this.init_f987(t,T.clone(N.Host.schema.getRoot(t)),N.Host.schema.rootFile,T.clone(N.Host.schema.getFiles(t)))},init_f987:function(t,e,i,n){for(var r=T.clone(j.Rule.definitionsFromSchemata(T.clone(n))),a={},s=T.iter(r);!s.done;s.next()){var o,l=s.key,u=s.value;if(l.includes("#"))null!=(o=u.definedName)&&(a[o]=u)}this.rules=T.clone(r),this.rulesByName=T.clone(a),this.rootFile=i,this.formatVersion=t,this.rootSchema=T.clone(e),this.rootSchemaFile=i,this.auxiliarySchemata=T.clone(n),this.description=T.as(this.rootSchema.description,"String")},schemaForReference:function(t){var e,i=t.split("#"),n=i[0],r=null;if(e=T.isEmpty(n)?this.rootSchema:this.auxiliarySchemata[n]){r=T.clone(e);for(var a=i[1].split("/"),s=T.iter(a.filter((function(t){return!T.isEmpty(t)}),this));!s.done;s.next()){var o,l=s.value;r=(o=T.as(T.opt(r,(function(t){return t[l]})),["Dictionary","String","Any"]))?T.clone(o):null}}return r},validateAndRead:function(t,e,i){var n,r,a=this.rules[this.rootFile],s=T.opt(a,(function(e){return e.validate(t)})),o=T.opt(s,(function(t){return t.value}));return(r=T.as(s,j.DBValidationError))&&(I.CoreAssert.warning("Validation encountered errors: "+r.error),i([r])),(n=T.opt(T.opt(o,(function(t){return t.property("",e,null)})),(function(t){return t.linkID})))||null!=n?n:""},referenceSchema:function(e,i){return t.init_f987(this.formatVersion,T.clone(e),i,T.clone(this.auxiliarySchemata))},type:function(e){var i,n,r,a,s,o=j.DBSchemaType.UnknownType,l=T.as(e.className,"String"),u=null;(null!=(i=T.as(e.type,"String"))&&null!=(n=j.DBSchemaType.toCaseValue(i))&&(o=n,u=this),o==j.DBSchemaType.UnknownType&&null!=e.enum)&&((r=T.as(e.enum,["Array","Any"]))&&(r.length>0&&T.is(r[0],"String")?o=j.DBSchemaType.StringType:r.length>0&&T.is(r[0],"Int")&&(o=j.DBSchemaType.IntegerType)));if(o==j.DBSchemaType.UnknownType||o==j.DBSchemaType.ObjectType&&null==l)if(null!=(a=T.as(e[t.PROPERTY_REF],"String"))){var c,h=j.DBSchemaType.UnknownType,f=null,p=null,d=a.startsWith("#")?this.rootSchemaFile+a:a;if(c=this.schemaForReference(d)){var m=d.split("#")[0],b=d.split("/");if(l=T.last(b),m==this.rootSchemaFile){var D=this.type(T.clone(c));h=D[0],f=D[1],p=D[2]}else{var y=this.referenceSchema(T.clone(c),m).type(T.clone(c));h=y[0],f=y[1],p=y[2]}}o==j.DBSchemaType.UnknownType&&(o=h),null==l&&(l=f),null==u&&(u=p)}else if(s=T.as(e.allOf,["Array",["Dictionary","String","Any"]]))for(var _=T.iter(s);!_.done;_.next()){var S=_.value,v=this.type(T.clone(S)),B=v[0],g=v[1],P=v[2];o==j.DBSchemaType.UnknownType&&(o=B),null==l&&(l=g),null==u&&(u=P)}return[o,l,u]},findValue:function(e,i){var n,r=i[e];if(null==r&&null!=(n=T.as(i[t.PROPERTY_REF],"String"))){var a,s=n.startsWith("#")?this.rootSchemaFile+n:n;(a=this.schemaForReference(s))&&(r=this.findValue(e,T.clone(a)))}return r},allProperties:function(e){I.CoreAssert.isTrue(null==e.anyOf&&null==e.oneOf,"Specific type should be known by this point or a custom codec is needed.","DBSchema.allProperties","DBSchema.swift",2353);var i,n,r,a={};if((i=T.as(e.properties,["Dictionary","String",["Dictionary","String","Any"]]))&&(a=T.clone(i)),n=T.as(e.allOf,["Array",["Dictionary","String","Any"]]))for(var s=T.iter(n);!s.done;s.next())for(var o=s.value,l=T.iter(this.allProperties(T.clone(o)));!l.done;l.next()){var u=l.key,c=l.value;a[u]=T.clone(c)}if(null!=(r=T.as(e[t.PROPERTY_REF],"String"))){var h,f=r.startsWith("#")?this.rootSchemaFile+r:r;if(h=this.schemaForReference(f))for(var p=T.iter(this.allProperties(T.clone(h)));!p.done;p.next()){u=p.key;var d=p.value;null==a[u]&&(a[u]=T.clone(d))}}return a},schemaAttribute:function(e,i){I.CoreAssert.isTrue(null==i.anyOf&&null==i.oneOf,"Specific type should be known by this point or a custom codec is needed.","DBSchema.schemaAttribute","DBSchema.swift",2385);var n,r,a=i[e];if(null==a&&(n=T.as(i.allOf,["Array",["Dictionary","String","Any"]])))for(var s=T.iter(n);!s.done;s.next()){var o,l=s.value;if(null!=(o=this.schemaAttribute(e,T.clone(l)))){a=o;break}}if(null==a&&null!=(r=T.as(i[t.PROPERTY_REF],"String"))){var u,c,h=r.startsWith("#")?this.rootSchemaFile+r:r;if(u=this.schemaForReference(h))null!=(c=this.schemaAttribute(e,T.clone(u)))&&(a=c)}return a}}}),t}()},dJuF:function(t,e,i){var n,r,a,s,o,l=e,u=i("oAGj"),c=i("SpAV"),h=i("O60Y"),f=i("fVJ2"),p=i("SmK9"),d=i("13MC");l.DBNamePath=(n=function(){},u.defineClass({name:"DBNamePath",ctor:n,props:{init_1346:function(t,e){this.name=t,this.parent=e},init_b14a:function(t){this.name=t,this.parent=null},prepend:function(t){return n.init_b14a(t).appendPath(this)},append:function(t){return n.init_1346(t,this)},appendPath:function(t){var e=this;return t.forEach((function(t){e=e.append(t.name)})),e},forEach:function(t){u.opt(this.parent,(function(e){return e.forEach(t)})),t(this)},path:{get:function(){var t=[];return this.forEach((function(e){return t.push(e.name)})),t}}}}),n),l.DBProperty=(r=function t(e,i,n,r){this.shouldWrite=!0,this.schemaType=e,this.className=r,this.name_=i.name,this.value_=n,this.namePath_=i,e==p.DBSchemaType.ArrayType?this.arrayValue_=u.clone(u.as(n,["Array",t])):this.arrayValue_=null,e==p.DBSchemaType.ObjectType?this.dictionaryValue_=u.clone(u.as(n,["Dictionary","String",t])):this.dictionaryValue_=null,this.reroot(i)},u.defineClass({name:"DBProperty",ctor:r,statics:{deleted:function(t){return new l.DBDeletedProperty(t)},boolEncoded:function(t,e,i){return new r(p.DBSchemaType.BooleanType,t,e,i)},doubleEncoded:function(t,e,i){return new r(p.DBSchemaType.NumberType,t,e,i)},intEncoded:function(t,e,i){return new r(p.DBSchemaType.IntegerType,t,e,i)},stringEncoded:function(t,e,i){return new r(p.DBSchemaType.StringType,t,e,i)},arrayEncoded:function(t,e,i){return new r(p.DBSchemaType.ArrayType,t,u.clone(e),i)},dictEncoded:function(t,e,i){return new r(p.DBSchemaType.ObjectType,t,u.clone(e),i)},objProperty:function(t,e,i,n){return new r(p.DBSchemaType.ObjectType,t,h.DBLink.init_14fa(e,n),i)},linkProperty:function(t,e,i,n,a){return new r(p.DBSchemaType.ObjectType,t,h.DBLink.init_8408(e,i,a),n)},boolProperty:function(t,e,i){void 0===i&&(i=!1);var n=new r(p.DBSchemaType.BooleanType,t,e,null);return n.shouldWrite=!i,n},doubleProperty:function(t,e,i){void 0===i&&(i=!1);var n=new r(p.DBSchemaType.NumberType,t,e,null);return n.shouldWrite=!i,n},intProperty:function(t,e,i){void 0===i&&(i=!1);var n=new r(p.DBSchemaType.IntegerType,t,e,null);return n.shouldWrite=!i,n},stringProperty:function(t,e,i){void 0===i&&(i=!1);var n=new r(p.DBSchemaType.StringType,t,e,null);return n.shouldWrite=!i,n},arrayProperty:function(t,e){return new r(p.DBSchemaType.ArrayType,t,u.clone(e),null)},dictProperty:function(t,e){return new r(p.DBSchemaType.ObjectType,t,u.clone(e),null)},arraysEqual:function(t,e){var i=t.arrayPropertyCount;if(e.arrayPropertyCount!=i)return!1;for(var n=u.iter(u.range(0,i,!1));!n.done;n.next()){var r=n.value;if(!t.arrayValue_[r].isEqual(e.arrayValue_[r]))return!1}return!0},dictsEqual:function(t,e){if(u.keys(t.dictionaryValue_).length==u.keys(e.dictionaryValue_).length){for(var i=u.iter(u.keys(t.dictionaryValue_));!i.done;i.next()){var n=i.value,r=t.dictionaryValue_[n],a=e.dictionaryValue_[n];if(null==a||!r.isEqual(a))return!1}return!0}return!1}},props:{name:{get:function(){return this.name_}},namePath:{get:function(){return this.namePath_}},index:{get:function(){return u.toInt(this.name_)}},copy:function(){var t,e;if(t=this.arrayValue)return new r(this.schemaType,this.namePath_,t.map((function(t){return t.copy()}),this),this.className);if(e=this.dictionaryValue){for(var i={},n=u.iter(e);!n.done;n.next()){var a=n.key,s=n.value;i[a]=s.copy()}return new r(this.schemaType,this.namePath_,u.clone(i),this.className)}return new r(this.schemaType,this.namePath_,this.value_,this.className)},reroot:function(t){if(this.namePath_=t,this.isArray)for(var e=u.iter(u.toSequence(this.arrayValue_));!e.done;e.next()){var i=e.value,n=i.offset,r=i.element,a=t.append(u.toString(n));r.reroot(a)}else if(this.isDictionary&&null==this.className)for(var s=u.iter(this.dictionaryValue_);!s.done;s.next()){var o=s.key;r=s.value,a=t.append(o),r.reroot(a)}},prependNameToPath:function(t){this.namePath_=this.namePath_.prepend(t),null==this.className&&this.prependNameToChildPaths(t)},prependNameToChildPaths:function(t){if(null!=this.arrayValue_)for(var e=u.iter(this.arrayValue_);!e.done;e.next())e.value.prependNameToPath(t);else if(null!=this.dictionaryValue_)for(var i=u.iter(this.dictionaryValue_);!i.done;i.next())i.value.prependNameToPath(t)},value:{get:function(){return this.value_}},boolValue:{get:function(){return u.as(this.value_,"Bool")}},doubleValue:{get:function(){return u.as(this.value_,"Double")}},intValue:{get:function(){return u.as(this.value_,"Int")}},stringValue:{get:function(){return u.as(this.value_,"String")}},linkID:{get:function(){var t;return(t=u.as(this.value_,h.IDBLink))?t.referenceID:null}},objValue:{get:function(){var t;return(t=u.as(this.value_,h.IDBLink))?t.dereference():null}},isArray:{get:function(){return this.schemaType==p.DBSchemaType.ArrayType}},getArrayProperty:function(t){return this.arrayValue_[t]},arrayPropertyCount:{get:function(){var t;return(t=u.opt(this.arrayValue_,(function(t){return t.length})))||null!=t?t:0}},forEachArrayProperty:function(t){if(this.isArray)for(var e=u.iter(u.toSequence(this.arrayValue_));!e.done;e.next()){var i=e.value;t(i.offset,i.element)}},arrayValue:{get:function(){return this.isArray?this.arrayValue_:null}},isDictionary:{get:function(){return this.schemaType==p.DBSchemaType.ObjectType&&null!=this.dictionaryValue_}},getDictionaryProperty:function(t){return this.isDictionary?this.dictionaryValue_[t]:null},setDictionaryProperty:function(t,e){this.isDictionary&&(null!=e?this.dictionaryValue_[t]=e:u.removeKey(this.dictionaryValue_,t),this.value_=u.clone(this.dictionaryValue_))},forEachDictionaryProperty:function(t){if(this.isDictionary)for(var e=u.iter(this.dictionaryValue_);!e.done;e.next())t(e.key,e.value)},dictionaryValue:{get:function(){return this.isDictionary?this.dictionaryValue_:null}},isEqual:function(t){var e;if(e=u.as(t,r)){if(e===this)return!0;if(this.schemaType!=e.schemaType)return!1;switch(this.schemaType){case"string":return null!=this.stringValue&&null!=e.stringValue&&this.stringValue==e.stringValue;case"boolean":return null!=this.boolValue&&null!=e.boolValue&&this.boolValue==e.boolValue;case"integer":return null!=this.intValue&&null!=e.intValue&&this.intValue==e.intValue;case"number":return null!=this.doubleValue&&null!=e.doubleValue&&this.doubleValue==e.doubleValue;case"object":if(null!=this.objValue)return this.objValue===e.objValue;if(this.isDictionary&&e.isDictionary)return r.dictsEqual(this,e);break;case"array":return this.isArray&&e.isArray&&r.arraysEqual(this,e);case"unknown":return!1}}return!1}}}),r),l.DBDeletedProperty=(a=function(t){l.DBProperty.call(this,p.DBSchemaType.UnknownType,t,0,null)},u.defineClass({name:"DBDeletedProperty",ctor:a,superName:"DBProperty",props:{shouldWrite:{get:function(){return!1},set:function(t){}},copy:function(){return new a(this.namePath_)},boolValue:{get:function(){return null}},doubleValue:{get:function(){return null}},intValue:{get:function(){return null}},stringValue:{get:function(){return null}},objValue:{get:function(){return null}},arrayValue:{get:function(){return null}},dictionaryValue:{get:function(){return null}},isEqual:function(t){return t instanceof a}}}),a),l.DBPropertyCodec=(s=function(){},o={},u.defineClass({name:"DBPropertyCodec",ctor:s,statics:{registeredCodecs_:{},primitiveUpdater_:{get:function(){return void 0===o.primitiveUpdater_&&(o.primitiveUpdater_=function(t,e){return t.value_=e,t}),o.primitiveUpdater_}},codec:function(t,e,i){return s.init_a58a(t,e,i)},updatingCodec:function(t,e,i,n){return s.init_e208(t,e,i,n)},boolCodec:function(){var t;return s.init_e208((function(t,e,i){return l.DBProperty.boolProperty(t,e)}),(function(e,i){return!(!(t=u.opt(e,(function(t){return t.boolValue})))&&null==t)&&t}),s.primitiveUpdater_,"Bool")},intCodec:function(){var t;return s.init_e208((function(t,e,i){return l.DBProperty.intProperty(t,e)}),(function(e,i){return(t=u.opt(e,(function(t){return t.intValue})))||null!=t?t:0}),s.primitiveUpdater_,"Int")},doubleCodec:function(){var t;return s.init_e208((function(t,e,i){return l.DBProperty.doubleProperty(t,e)}),(function(e,i){return(t=u.opt(e,(function(t){return t.doubleValue})))||null!=t?t:NaN}),s.primitiveUpdater_,"Double")},stringCodec:function(){return s.init_e208((function(t,e,i){return l.DBProperty.stringProperty(t,e)}),(function(t,e){return u.opt(t,(function(t){return t.stringValue}))}),s.primitiveUpdater_,"String")},objectCodec:function(t){return void 0===t&&(t=null),s.init_a58a((function(e,i,n){return l.DBProperty.objProperty(e,i,t,u.opt(n,(function(t){return t.id})))}),(function(t,e){return u.opt(t,(function(t){return t.objValue}))}),"Link")},directObjectCodec:function(t){return s.init_a58a((function(t,e,i){var n,r=l.DBProperty.deleted(t);if(n=u.as(e,f.DBObject)){var a,s,o=u.clone(n.state.allProperties);if((a=p.DBSchema.currentSchema.rulesByName[n.state.className])&&(s=a.getRequiredProperties()))for(var h=u.iter(s);!h.done;h.next()){var m=h.value;c.CoreAssert.isTrue(u.keys(o).includes(m),"error: missing property "+m+" when encoding "+n.state.className,"DBPropertyCodec.directObjectCodec","DBProperty.swift",454)}r=l.DBProperty.dictEncoded(t,u.clone(o),n.className),null!=i&&(n.isChildObject?c.CoreAssert.isFalse(n.state instanceof d.DBChildObjectState&&n.state.parentObject!==i,"Cannot reparent child objects. Clone the object before assigning to a new parent","DBPropertyCodec.directObjectCodec","DBProperty.swift",464):i.addChildObject(n,t))}else c.CoreAssert.fail("Expected DBObject: "+e,"DBPropertyCodec.directObjectCodec","DBProperty.swift",470);return r}),(function(t,e){var i,n,r,a=null;return null!=(i=u.opt(t,(function(t){return t.className})))&&(n=u.as(e,f.DBObject))&&(r=u.opt(t,(function(t){return t.namePath})))&&(a=n.createChildObject(i,r)),a}),"Direct object")},arrayCodec:function(t){var e=this;return s.init_a58a((function(i,n,r){var a,s=l.DBProperty.deleted(i);if(a=u.as(n,["Array","Any"])){var o=u.toSequence(a).map((function(e){return t.encode(i.append(u.toString(e.offset)),e.element,r)}),e);s=l.DBProperty.arrayProperty(i,u.clone(o))}else c.CoreAssert.fail("Expected an array: "+n,"DBPropertyCodec.arrayCodec","DBProperty.swift",495);return s}),(function(i,n){var r,a=null;return(r=u.opt(i,(function(t){return t.arrayValue})))&&(a=r.map((function(e){return t.decode(e,n)}),e).filter((function(t){return null!=t}),e).map((function(t){return t}),e)),a}),"Array")},tupleCodec:function(t){return s.init_a58a((function(e,i,n){var r,a=l.DBProperty.deleted(e);if(r=u.as(i,["Array","Any"])){for(var s=[],o=u.iter(u.range(0,r.length,!1));!o.done;o.next()){var h=o.value;h<t.length?s.push(t[h].encode(e.append(u.toString(h)),r[h],n)):s.push(u.last(t).encode(e.append(u.toString(h)),r[h],n))}a=l.DBProperty.arrayProperty(e,u.clone(s))}else c.CoreAssert.fail("Expected an array: "+i,"DBPropertyCodec.tupleCodec","DBProperty.swift",527);return a}),(function(e,i){var n=null;return null!=e&&e.isArray&&(n=[],e.forEachArrayProperty((function(r,a){var s;r<t.length?null!=(s=t[r].decode(a,i))?n.push(s):c.CoreAssert.fail("Failed to decode array property "+e+" item "+r,"DBPropertyCodec.tupleCodec","DBProperty.swift",541):null!=(s=u.last(t).decode(a,i))?n.push(s):c.CoreAssert.fail("Failed to decode array property "+e+" item "+r,"DBPropertyCodec.tupleCodec","DBProperty.swift",547)}))),n}),"Tuple")},dictionaryCodec:function(t){var e=function(t,e,i){var n,r,a,s,o=l.DBProperty.deleted(t);return null!=(n=u.as(e,"Bool"))?o=l.DBProperty.boolProperty(t,n):null!=(r=u.as(e,"Int"))?o=l.DBProperty.intProperty(t,r):null!=(a=u.as(e,"Double"))?o=l.DBProperty.doubleProperty(t,a):null!=(s=u.as(e,"String"))&&(o=l.DBProperty.stringProperty(t,s)),o};return s.init_a58a((function(i,n,r){var a,s=l.DBProperty.deleted(i);if(a=u.as(n,["Dictionary","String","Any"])){for(var o={},h=u.iter(a);!h.done;h.next()){var f,p=h.key,d=h.value;(f=t[p])?o[p]=f.encode(i.append(p),d,r):o[p]=e(i.append(p),d)}s=l.DBProperty.dictProperty(i,u.clone(o))}else c.CoreAssert.fail("Expected a dictionary: "+n,"DBPropertyCodec.dictionaryCodec","DBProperty.swift",586);return s}),(function(e,i){var n=null;return null!=e&&e.isDictionary&&(n={},e.forEachDictionaryProperty((function(e,r){var a;(a=t[e])?n[e]=a.decode(r,i):n[e]=function(t,e){var i;if(null!=(i=u.opt(t,(function(t){return t.schemaType}))))switch(i){case"boolean":return t.boolValue;case"integer":return t.intValue;case"number":return t.doubleValue;case"string":return t.stringValue;default:return null}return null}(r)}))),n}),"Dictionary")},registerCodec:function(t,e){return c.CoreAssert.isTrue(null==s.registeredCodecs_[t],"Duplicate codec registered for "+t,"DBPropertyCodec.registerCodec","DBProperty.swift",627),s.registeredCodecs_[t]=e,s.registeredCodecs_[t]},typeCodec:function(t){return s.registeredCodecs_[t]}},props:{init_a58a:function(t,e,i){this.encode=t,this.decode=e,this.update=null,this.tag=i},init_e208:function(t,e,i,n){this.encode=t,this.decode=e,this.update=i,this.tag=n}}}),s)},fVJ2:function(t,e,i){var n,r,a,s=e,o=i("oAGj"),l=i("SpAV"),u=i("gXiO"),c=i("N5RB"),h=i("O60Y"),f=i("dJuF"),p=i("SmK9"),d=i("13MC"),m=i("ZhwN");s.IDBObject=o.defineProtocol("IDBObject",{database:"IDatabase",state:"IDBObjectState",persisted:"Boolean",className:"String",getProperty:"(String) -> DBProperty",setProperty:"(String, DBProperty) -> Void",removeProperty:"(String) -> Void",abandonChanges:"() -> Void"}),s.DBDeletedObject=(n=function(t){this.db_=t,u.CoreObject.call(this),this.state_=new d.DBObjectDeletedState(this)},o.defineClass({name:"DBDeletedObject",ctor:n,superName:"CoreObject",statics:{_implements:function(t){return"IDBObject"==t}},props:{database:{get:function(){return this.db_}},state:{get:function(){return this.state_},set:function(t){l.CoreAssert.fail("Cannot set the state of a deleted object","DBDeletedObject","DBObject.swift",58)}},persisted:{get:function(){return!1}},getProperty:function(t){return null},setProperty:function(t,e){l.CoreAssert.fail("Cannot set a proeprty on a deleted object","DBDeletedObject.setProperty","DBObject.swift",63)},removeProperty:function(t){l.CoreAssert.fail("Cannot remove a property from a deleted object","DBDeletedObject.removeProperty","DBObject.swift",64)},className:{get:function(){return""}},abandonChanges:function(){}}}),n),s.DBObject=(r=function(){this.initialState_=null,this.childObjects_=[],this.childObjectProperties_={},this.noOpSetter=function(t){},this.cachedValues_={},this.decodedObjects_={},this.validateOnSet=!1},o.defineClass({name:"DBObject",ctor:r,superName:"CoreObject",statics:{instantiateItemDescendants:function(t,e){var i,n,a;if(i=o.as(t,r))i.instantiateDescendants();else if(n=o.as(t,["Array","Any"])){var s;if(s=e.arrayValue)for(var l=o.iter(o.toSequence(s));!l.done;l.next()){var u=l.value,c=u.offset,h=u.element;r.instantiateItemDescendants(n[c],h)}}else(a=o.as(t,["Dictionary","String","Any"]))&&e.isDictionary&&e.forEachDictionaryProperty((function(t,e){var i;null!=(i=a[t])&&r.instantiateItemDescendants(i,e)}))},_implements:function(t){return"IDBObject"==t}},props:{database:{get:function(){return l.CoreAssert.isTrue(null!=this.db_,"Constant objects are not bound to a database","DBObject","DBObject.swift",100),this.db_}},state:{get:function(){return this.state_||this.initialState},set:function(t){var e;if(l.CoreAssert.isTrue(null!=this.db_,"Cannot change the state of a constant object","DBObject","DBObject.swift",107),l.CoreAssert.isTrue(!(this.initialState_ instanceof d.DBChildObjectState)||t===this.initialState_,"Child objects should have their states changed via a parent object.","DBObject","DBObject.swift",108),e=o.as(t,d.DBChildObjectState))this.state_=e,this.initialState_=e;else if(null==this.state_&&null==this.initialState_&&(this.initialState_=t,this.state_=t),t!==this.state_){var i=o.clone(o.opt(this.state_,(function(e){return e.diff(t)})));null!=i&&o.count(i)>0&&this.willChangeState(o.clone(i)),this.state_=t,this.db_.objectStateChanged(t),null!=i&&o.count(i)>0&&(o.removeAll(this.cachedValues_),this.didChangeState(o.clone(i)))}}},removeChildObject:function(t){var e;null!=(e=o.indexOf(this.childObjects_,t))&&(t.removeAllChildren(),this.childObjects_.splice(e,1))},removeAllChildren:function(){for(var t=o.iter(this.childObjects_);!t.done;t.next()){var e=t.value;e.removeAllChildren(),e.persisted&&o.opt(o.as(this.db_.mutableState,d.DBMutableState),(function(t){return t.removeObject(e.id)}))}this.childObjects_.splice(0),o.removeAll(this.childObjectProperties_)},persistToDatabase:function(t,e){this.db_=t,this.guid_=e;for(var i=o.iter(this.childObjects_);!i.done;i.next()){var n=i.value;l.CoreAssert.isFalse(n.persisted,"Child object already persisted when its parent wasn't","DBObject.persistToDatabase","DBObject.swift",160),t.addObject(m.GUIDUtils.makeGUID(),n)}},addChildObject:function(t,e){var i;t.convertToChildObject(this,e),this.persisted&&!t.persisted&&this.database.addObject(m.GUIDUtils.makeGUID(),t),null==e.parent&&((i=this.childObjectProperties_[e.name])&&this.removeChildObject(i),this.childObjectProperties_[e.name]=t),this.childObjects_.push(t)},createChildObject:function(t,e){var i,n=null;if(null!=(i=s.DBHostObject.factory(t))){var a,l=d.DBChildObjectState.init_94ed(this,e),u=m.GUIDUtils.makeGUID();if(null!=(n=o.as(i(u,this.db_,l,null),r)))l.object=n,o.opt(this.db_,(function(t){return t.addObject(u,n)})),null==e.parent&&((a=this.childObjectProperties_[e.name])&&this.removeChildObject(a),this.childObjectProperties_[e.name]=n),this.childObjects_.push(n)}return n},childObjects:{get:function(){return this.childObjects_.concat()}},descendantObjectsMA:{get:function(){for(var t=this.childObjects_.slice(0,this.childObjects_.length),e=o.iter(this.childObjects_);!e.done;e.next()){var i=e.value;o.append(t,i.descendantObjectsMA)}return t}},descendantObjects:{get:function(){return this.descendantObjectsMA.concat()}},convertToChildObject:function(t,e){if(!this.isChildObject){var i=o.clone(this.state.allProperties),n=d.DBChildObjectState.init_7008(this,t,e);this.initialState_=n,this.state_=n,n.setProperties(o.clone(i)),n.savePendingProperties()}return this.state},isChildObject:{get:function(){return this.initialState_ instanceof d.DBChildObjectState}},persisted:{get:function(){return null!=this.db_}},initialized:{get:function(){return null!=this.initialState_}},willChangeState:function(t){},didChangeState:function(t){},className:{get:function(){return l.CoreAssert.fail("Object class name not provided","DBObject","DBObject.swift",239),""}},init_3f7c:function(t){var e,i=t instanceof d.DBChildObjectState;this.guid_=i?m.GUIDUtils.makeGUID():"",u.CoreObject.call(this),!i&&o.is(t,d.IDBObjectMutableState)?(this.initialState_=d.DBObjectState.init_2a9a(this,o.clone(t.allProperties)),this.state_=d.DBObjectMutableState.init_226b(this.initialState_)):(this.initialState_=t,this.state_=t,(e=o.as(t,d.DBChildObjectState))&&(e.object=this))},init_dd5d:function(t,e){this.guid_="",u.CoreObject.call(this),this.initialState_=d.DBObjectMutableState.init_2a9a(this,o.clone(t)),this.state_=this.initialState_;for(var i=o.clone(t),n=o.iter(e);!n.done;n.next()){var r,a=n.key,s=n.value;(r=p.DBSchema.getPropertyCodec(a,this.className))&&(i[a]=r.encode(f.DBNamePath.init_b14a(a),s,this))}this.initialState_=d.DBObjectState.init_2a9a(this,o.clone(i)),this.state_=d.DBObjectMutableState.init_226b(this.initialState_)},init_866e:function(t,e){var i,n=t instanceof d.DBChildObjectState;this.guid_=e,u.CoreObject.call(this),!n&&o.is(t,d.IDBObjectMutableState)?(this.initialState_=d.DBObjectState.init_2a9a(this,o.clone(t.allProperties)),this.state_=d.DBObjectMutableState.init_226b(this.initialState_)):(this.initialState_=t,this.state_=t,(i=o.as(t,d.DBChildObjectState))&&(i.object=this))},init_11e0:function(t){this.db_=t,this.guid_=m.GUIDUtils.makeGUID(),u.CoreObject.call(this),this.db_.addObject(this.guid_,this)},init_5079:function(t,e,i,n){this.db_=t,this.guid_=o.isEmpty(n)?m.GUIDUtils.makeGUID():n,u.CoreObject.call(this),this.initialState_=d.DBObjectMutableState.init_2a9a(this,o.clone(e)),this.state_=this.initialState_;for(var r=o.clone(e),a=o.iter(i);!a.done;a.next()){var s,l=a.key,c=a.value;(s=p.DBSchema.getPropertyCodec(l,this.className))&&(r[l]=s.encode(f.DBNamePath.init_b14a(l),c,this))}this.initialState_=d.DBObjectState.init_2a9a(this,o.clone(r)),this.state_=null,this.db_.addObject(this.guid_,this)},init_3181:function(t,e,i){var n;this.db_=t,this.guid_=i,u.CoreObject.call(this),(n=o.as(e,d.IDBObjectMutableState))?this.initialState_=n.assign(this):this.initialState_=e,this.state_=o.as(this.initialState_,d.DBChildObjectState),this.db_.addObject(this.guid_,this)},init_67b3:function(t){this.db_=t.database,this.guid_=m.GUIDUtils.makeGUID(),u.CoreObject.call(this),this.db_.addObject(this.guid_,this)},id:{get:function(){return this.guid_}},fork:function(t){return this.forkWithLink(t,null)},forkWithLink:function(t,e){return this.forkToDatabase(t,!0,o.opt(e,(function(t){return t.database}))||this.db_,e)},forkPropertyToDatabase:function(t,e,i,n,a){var s,l=this,u=null;if(null!=i.linkID){if(e){var c=o.as(i.objValue,r);if(null!=c){var p,d=m.GUIDUtils.makeGUID(),b=null!=a?h.DBLink.init_8408(d,a,n):null;(p=o.opt(c,(function(t){return t.forkToDatabase(d,!0,a,b)})))&&(u=f.DBProperty.objProperty(f.DBNamePath.init_b14a(t),p,this.className,n))}}}else if(s=i.arrayValue){for(var D=[],y=o.iter(o.toSequence(s));!y.done;y.next()){var _,S=y.value,v=S.offset,B=S.element;(_=this.forkPropertyToDatabase(o.toString(v),e,B,n,a))&&D.push(_)}u=null!=i.className?f.DBProperty.arrayEncoded(f.DBNamePath.init_b14a(t),o.clone(D),i.className):f.DBProperty.arrayProperty(f.DBNamePath.init_b14a(t),o.clone(D))}else if(i.isDictionary){var g={};i.forEachDictionaryProperty((function(t,i){var r;(r=l.forkPropertyToDatabase(t,e,i,n,a))&&(g[t]=r)})),u=null!=i.className?f.DBProperty.dictEncoded(f.DBNamePath.init_b14a(t),o.clone(g),i.className):f.DBProperty.dictProperty(f.DBNamePath.init_b14a(t),o.clone(g))}else u=i.copy();return u},forkToDatabase:function(t,e,i,n){var a,l=null;if(null!=(a=s.DBHostObject.factory(this.className))){for(var u=o.clone(this.state.allProperties),c={},h=o.iter(u);!h.done;h.next()){var f,p=h.key,m=h.value;(f=this.forkPropertyToDatabase(p,e,m,t,i))&&(c[p]=f)}var b=d.DBObjectMutableState.init_6271(this.className,o.clone(c));l=o.as(a(t,i,b,n),r)}return l},getCodec:function(t){return p.DBSchema.getPropertyCodec(t,this.className)},clearCache:function(){o.removeAll(this.cachedValues_)},abandonChanges:function(){this.clearCache()},get:function(t){var e,i,n,a,s,u,c,h,d,m,b=this.getProperty(t);if(null==b||b instanceof f.DBDeletedProperty)return null;if(null!=(s=this.cachedValues_[t]))return s;if(u=this.childObjectProperties_[t]){if(o.opt(b,(function(t){return t.className==u.className})))return u;l.CoreAssert.isTrue(o.opt(b,(function(t){return"AlphaBlendFilter"==t.className||o.opt(b,(function(t){return"CompositeFilter"==t.className}))})),"Unexpected className "+((e=o.opt(b,(function(t){return t.className})))||null!=e?e:"nil")+" childObject ClassName is "+u.className,"DBObject.get","DBObject.swift",467),l.CoreAssert.info("ClassName is "+((i=o.opt(b,(function(t){return t.className})))||null!=i?i:"nil")+" childObject ClassName is "+u.className)}if(null!=(c=this.decodedObjects_[t])&&(h=this.database.getObject(c))){if(o.opt(b,(function(t){return t.className==h.className})))return h;l.CoreAssert.isTrue(o.opt(b,(function(t){return"AlphaBlendFilter"==t.className||o.opt(b,(function(t){return"CompositeFilter"==t.className}))})),"Unexpected className "+((n=o.opt(b,(function(t){return t.className})))||null!=n?n:"nil")+" database obj ClassName is "+h.className,"DBObject.get","DBObject.swift",479),l.CoreAssert.info("ClassName is "+((a=o.opt(b,(function(t){return t.className})))||null!=a?a:"nil")+" database obj ClassName is "+h.className)}if((d=b)&&(m=p.DBSchema.getPropertyCodec(t,this.className))){var D,y=m.decode(d,this);return(D=o.as(y,r))?D.persisted&&(this.decodedObjects_[t]=D.id):null!=y&&(this.cachedValues_[t]=y),y}return this.cachedValues_[t]},set:function(t,e){var i;o.removeKey(this.decodedObjects_,t),null==e?(o.removeKey(this.cachedValues_,t),this.removeProperty(t)):(i=p.DBSchema.getPropertyCodec(t,this.className))&&(this.cachedValues_[t]=e,this.updateProperty(t,e)||this.setProperty(t,i.encode(f.DBNamePath.init_b14a(t),e,this)))},mutable:{get:function(){return null!=this.db_&&(o.is(this.state_,d.IDBObjectMutableState)||null!=this.db_.mutableState)}},schemaRule:{get:function(){return p.DBSchema.currentSchema.rulesByName[this.className]}},getProperty:function(t){return this.state.getProperty(t)},setProperty:function(t,e){var i=this;if(!e.isEqual(this.getProperty(t))){l.CoreAssert.isTrue(!this.persisted||null!=this.db_.mutableState,"Cannot change the state of a persisted "+this.className+" object when the database is immutable","DBObject.setProperty","DBObject.swift",523);var n,r=o.is(this.state_,d.IDBObjectMutableState)?o.as(this.state_,d.IDBObjectMutableState):o.opt(o.opt(this.db_,(function(t){return t.mutableState})),(function(t){return t.newObjectState(i)}));if(n=r){var a;if(this.isChildObject&&o.opt(o.opt(this.db_,(function(t){return t.mutableState})),(function(t){return t.setObjectState(i,n)})),this.validateOnSet&&(a=o.opt(this.schemaRule,(function(e){return e.getPropertyRule(t)})))){var s,u=a.validateProperty(e);if(s=o.as(u,p.DBValidationError))return void l.CoreAssert.fail("Failed to write property "+t+": "+s.error,"DBObject.setProperty","DBObject.swift",538)}n.setProperty(t,e)}}},updateProperty:function(t,e){var i,n;return!(!(i=o.as(this.state_,d.IDBObjectMutableState))||!(n=p.DBSchema.getPropertyCodec(t,this.className)))&&i.updateProperty(t,e,n)},removeProperty:function(t){var e=this.getProperty(t);if(null!=e&&!(e instanceof f.DBDeletedProperty)){l.CoreAssert.isTrue(!this.persisted||null!=this.db_.mutableState,"Cannot remove a property from a persisted "+this.className+" object when the database is immutable","DBObject.removeProperty","DBObject.swift",558);var i,n,r=o.is(this.state_,d.IDBObjectMutableState)?this.state_:this.db_.mutableState.newObjectState(this);if(this.validateOnSet&&(i=o.opt(this.schemaRule,(function(t){return t.getRequiredProperties()})))&&i.includes(t))return void l.CoreAssert.fail("Cannot remove required property "+t,"DBObject.removeProperty","DBObject.swift",567);r.removeProperty(t),(n=this.childObjectProperties_[t])&&(this.removeChildObject(n),o.removeKey(this.childObjectProperties_,t),this.persisted&&o.opt(o.as(this.db_.mutableState,d.DBMutableState),(function(t){return t.removeObject(n.id)})))}},matchProperties:function(t){l.CoreAssert.isTrue(!this.persisted||null!=this.db_.mutableState,"Cannot change the state of a persisted object when the database is immutable","DBObject.matchProperties","DBObject.swift",586);var e=o.is(this.state_,d.IDBObjectMutableState)?this.state_:this.db_.mutableState.newObjectState(this);e.clear();for(var i=o.iter(t);!i.done;i.next()){var n=i.key,r=i.value;e.setProperty(n,r)}for(var a=o.iter(this.childObjects);!a.done;a.next()){var s=a.value;s.clearCache(),o.opt(o.as(s.state,d.DBChildObjectState),(function(t){return t.abandonPendingProperties()}))}this.clearCache()},makeMutable:function(){o.opt(this.db_,(function(t){return null!=t.mutableState}))&&this.db_.mutableState.makeObjectMutable(this)},emptyState:{get:function(){return null==this.emptyState_&&(this.emptyState_=d.DBObjectState.init_be8f(this)),this.emptyState_}},initialState:{get:function(){return this.initialState_||this.emptyState}},mutableState:{get:function(){return o.is(this.state_,d.IDBObjectMutableState)?this.state_:this.db_.mutableState.newObjectState(this)}},instantiateDescendants:function(){for(var t=o.iter(this.state.allProperties);!t.done;t.next()){var e,i,n=t.key,a=t.value;a.schemaType!=p.DBSchemaType.ArrayType&&a.schemaType!=p.DBSchemaType.ObjectType||null!=(e=this.get(n))&&(i=this.getProperty(n))&&r.instantiateItemDescendants(e,i)}},willCommitState:function(){},didCommitState:function(){}}}),r),s.DBHostObject=(a=function(){this.hostDB_=new c.PostDB},o.defineClass({name:"DBHostObject",ctor:a,superName:"DBObject",statics:{factories_:{},registerFactory:function(t,e){return null==a.factories_[t]&&(a.factories_[t]=e),a.factories_[t]},factory:function(t){return a.factories_[t]},_implements:function(t){return"IDBObject"==t}},props:{init_1be9:function(t,e,i){this.schema_=p.DBSchema.init_2af7(t);var n=this.hostDB_.beginTransaction("decode",null);this.initialStateID_=this.schema_.validateAndRead(e,this.hostDB_,(function(t){for(var e="Errors: ",n=o.iter(t);!n.done;n.next())e=e+"\n"+n.value.error;i(e)})),o.super_init(this,s.DBObject,s.DBObject.prototype.init_5079,this.hostDB_,{},{},this.initialStateID_),n.end(),this.hostDB_.host=this},init_7341:function(t,e){var i;void 0===e&&(e=null),this.schema_=p.DBSchema.init_2af7(t);var n=this.hostDB_.beginTransaction("decode",null);this.initialStateID_="",o.super_init(this,s.DBObject,s.DBObject.prototype.init_5079,this.hostDB_,{},{},(i=e)||null!=i?i:m.GUIDUtils.makeGUID()),n.end(),this.hostDB_.host=this},init_b80b:function(t){var e;void 0===t&&(t=null),this.schema_=null;var i=this.hostDB_.beginTransaction("decode",null);this.initialStateID_="",o.super_init(this,s.DBObject,s.DBObject.prototype.init_5079,this.hostDB_,{},{},(e=t)||null!=e?e:m.GUIDUtils.makeGUID()),i.end(),this.hostDB_.host=this},willApplyDatabaseState:function(t){},didApplyDatabaseState:function(t){}}}),a)}}]);
//# sourceMappingURL=vendors_npm_spark_4dd644c3-632ceee7.js.map