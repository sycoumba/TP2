(window.webpackJsonptheoWebApp=window.webpackJsonptheoWebApp||[]).push([[34],{"6ZWm":function(e,t,r){var o,n=t,i=r("oAGj"),a=r("0wFF"),l=r("KSe6"),s=r("SpAV"),u=r("CWW7"),c=r("yGNn"),d=r("AVHO"),m=r("Ohrj"),h=r("ascj"),f=r("O60Y"),g=r("wNKJ"),p=r("FNB+"),v=r("yHU1"),C=r("Pil/"),F=r("cmoc"),y=r("16hp"),b=r("OYRJ"),I=r("OdB2"),S=r("QbzR"),D=r("JEzR"),T=r("P83h"),M=r("9Lk3"),P=r("ZK0l"),x=r("x35w"),_=r("X0GW"),G=r("ZhwN"),k=r("iCxV"),R=r("Qlvz"),w=r("NkBu"),A=r("U010"),E=r("fdtz"),B=r("lmwz"),N=r("hywZ"),L=r("tGKA"),Y=r("3DEm"),U=r("K0Rh"),O=r("7Ta2"),z=r("JO5d"),X=r("Zifs"),H=r("djAF"),W=r("35Q0"),q=r("T6jX"),K=r("fAXt"),V=r("MnRR"),j=r("oKlP"),Z=r("sIWg"),J=r("1NAc"),Q=r("zjod");n.FitType=i.defineEnum("FitType",{None:0,ProportionalFit:1,ProportionalFill:2,Stretch:3}),n.CropType=i.defineEnum("CropType",{ScaleCrop:0,FitBorder:1,FillFocus:2,ExtremeCloseup:3,AbstractCloseup:4,PreserveFocus:5,PreserveFocusAndScale:6}),n.FrameController=(o=function(e,t,r){this.fitting_=n.FitType.None,this.cropType_=null,this.preCropModeLayerIndex_=null,P.GroupController.call(this,e,t,r)},i.defineClass({name:"FrameController",ctor:o,superName:"GroupController",statics:{IMAGE_FITTING_PROPERTY:"image-fitting",CROP_MODE_LAYER:"crop-mode-layer",KIND:{get:function(){return"frame"}},resizeBoundsWithPin:function(e,t,r){var o=e;return 0==r.x?o=new Z.TheoRect(o.minX,o.minY,o.minX+t.width,o.maxY):1==r.x&&(o=new Z.TheoRect(o.maxX-t.width,o.minY,o.maxX,o.maxY)),0==r.y?o=new Z.TheoRect(o.minX,o.minY,o.maxX,o.minY+t.height):1==r.y&&(o=new Z.TheoRect(o.minX,o.maxY-t.height,o.maxX,o.maxY)),o}},props:{moveable:{get:function(){var e;return!((e=i.opt(i.opt(i.opt(this.forma,(function(e){return e.page.document})),(function(e){return e.controller})),(function(e){return e.selection})))&&e.isSelected(this.forma)&&e.inCropMode)&&this.floating}},floating:{get:function(){var e,t;return null!=(e=i.opt(this.forma,(function(e){return e.allowUserMove})))?e:!!(t=this.forma)&&(t.isLogo()||t.isSticker()||i.opt(i.as(t,F.FrameForma),(function(e){return 1==e.hasAlpha()})))}},selectable:{get:function(){return!0}},duplicatable:{get:function(){return this.floating}},rotateable:{get:function(){return!0}},flippable:{get:function(){return!i.opt(this.forma,(function(e){return 1==e.isLogo()}))}},nudgeable:{get:function(){return!0}},image:{get:function(){return B.ImageFacade.getImageFormaForForma(this.forma)}},mask:{get:function(){return B.ImageFacade.getMaskFormaForForma(this.forma)}},cutoutMode:{get:function(){return B.ImageFacade.getCutoutModeForForma(this.forma)}},cutout:{get:function(){if(this.cutoutMode==A.CutoutMode.Off)return null;var e=B.ImageFacade.getCutoutMaskFormaForForma(this.forma);return s.CoreAssert.isTrue(null!=e,"Could not find cutout mask forma.","FrameController","FrameController.swift",125),e}},hasCutout:{get:function(){return B.ImageFacade.getCutoutModeForForma(this.forma)!=A.CutoutMode.Off}},hasBackgroundColor:{get:function(){return this.hasCutout&&i.opt(this.forma,(function(e){return null!=e.style.colors.fieldPrimary}))}},fitting:{get:function(){var e;if(null!=(e=i.as(this.controllerMetadata.get(o.IMAGE_FITTING_PROPERTY),"String")))switch(e){case"cover":return n.FitType.ProportionalFill;case"contain":return n.FitType.ProportionalFit;case"stretch":return n.FitType.Stretch}return n.FitType.None},set:function(e){var t;switch(e){case 2:t="cover";break;case 1:t="contain";break;case 3:t="stretch";break;default:t="none"}this.controllerMetadata.set(o.IMAGE_FITTING_PROPERTY,t)}},copyTo:function(e){var t,r,o;if(void 0===e&&(e=null),s.CoreAssert.isTrue(null==e||e==i.opt(i.opt(this.owner,(function(e){return e.document})),(function(e){return e.firstPage})),"FrameController does not currently support copying across pages","FrameController.copyTo","FrameController.swift",180),(t=i.opt(i.opt(this.owner,(function(e){return e.document})),(function(e){return e.firstPage})))&&(r=i.as(this.forma,F.FrameForma))&&(o=B.ImageFacade.getImageFormaForForma(r))){var n,d,m=o.contentNode,h=null;if((n=i.as(o,Q.VideoForma))&&(m=n.videoContentNode,h=n.contentNode),d=m){var f=this.moveable?u.FloatingImageStrategy.Always:u.FloatingImageStrategy.IfHasAlphaOrIsLogo,g=new u.AddFormaParams(void 0,void 0,void 0,f);return u.CreationFacade.addContent(t,d,h,void 0,g).then((function(e){var n,s,u,d;return(n=i.as(e,p.Forma))?(n.match(r),(s=i.as(n,F.FrameForma))&&(u=B.ImageFacade.getImageFormaForForma(s))&&u.match(o),(d=t.document)&&l.AnimationLibrary.updateCurrentStyle(d,n.isVideo()),i.opt(k.Host.logging,(function(e){return e.logToAnalytics(a.AnalyticsConstants.kAnalyticsDataImageDuplicated,{})})),n):c.CorePromise.reject("Failed to get forma from addContent")}))}}return c.CorePromise.resolve(null)},flip:function(e){var t;void 0===e&&(e=!1),this.floating?K.TransformFacade.flipForma(this.forma,e):(t=B.ImageFacade.getImageFormaForForma(this.forma))&&(K.TransformFacade.flipForma(t,e),this.updateParentGroup())},rotate:function(e){var t;void 0===e&&(e=Math.PI/180),this.floating&&!B.ImageFacade.inCropMode(this.forma)?K.TransformFacade.rotateForma(this.forma,e):(t=B.ImageFacade.getImageFormaForForma(this.forma))&&(K.TransformFacade.rotateForma(t,e),this.updateParentGroup())},rotation:function(){return this.floating?this.forma.rotation():(e=B.ImageFacade.getImageFormaForForma(this.forma))?e.rotation():0;var e},nudge:function(e){var t;this.floating?K.TransformFacade.translateForma(this.forma,e):(t=B.ImageFacade.getImageFormaForForma(this.forma))&&(K.TransformFacade.translateForma(t,e),this.updateParentGroup())},selectionHandlePositions:{get:function(){var e,t=!this.moveable;B.ImageFacade.inCropMode(this.forma)&&(t=!this.maintainAspectRatio,(e=i.opt(this.mask,(function(e){return e.controller})))&&e.maintainAspectRatio&&(t=!1));var r=[new j.TheoPoint(.5,0),new j.TheoPoint(.5,1),new j.TheoPoint(1,.5),new j.TheoPoint(0,.5)];return!this.floating&&this.forma.isGridCell()?r:t?r.concat(i.clone(P.GroupController._getters.selectionHandlePositions.call(this))):P.GroupController._getters.selectionHandlePositions.call(this)}},processEvent:function(e){var t;return(t=i.as(e,C.BeginPointerTrackingEvent))?(t.trackingResponse=this.moveable?v.BeginPointerTrackingResponseEnum.TrackAsGroup:v.BeginPointerTrackingResponseEnum.TrackWithinGroup,!1):P.GroupController.prototype.processEvent.call(this,e)},processFormaDoubleClick:function(e){if(!B.ImageFacade.inCropMode(this.forma)&&(this.owner.selection.replaceSelection(e.forma),this.owner.selection.isSelected(e.forma)))for(var t=i.iter(e.forma.visitAsArray(p.FormaTraversal.JustChildren));!t.done;t.next()){var r,o=t.value;(r=i.as(o.controller,w.ImageController))&&(this.owner.controllerSettingsState.settings=new d.ImageControllerSettings(r))}},processEndFormaDrag:function(e){var t,r=this.owner.document.firstPage;r.publish(new I.EndFormaDragMessage(r)),this.fitChildrenToFrame(),(t=i.as(i.opt(this.forma.parent,(function(e){return e.controller})),M.GridController))&&t.processChildEndFormaDrag(e)},processBeginFormaDrag:function(e){var t;P.GroupController.prototype.processBeginFormaDrag.call(this,e),(t=i.as(i.opt(this.forma.parent,(function(e){return e.controller})),M.GridController))&&t.processChildBeginFormaDrag(this.forma,e)},afterProcessBeginFormaDrag:function(e){var t;(t=i.as(i.opt(this.forma.parent,(function(e){return e.controller})),M.GridController))&&t.processChildBeginFormaDrag(this.forma,e)},clipLineToRectWithTransform:function(e,t,r){var o=r,n=r.transformValues,a=Math.atan2(n.rotSine,n.rotCosine);Math.abs(a)<.01&&(o=L.Matrix2D.scalingXY(n.xscale,n.yscale).skewTo(n.skew).translateXY(n.tx,n.ty));for(var l=[t.horizontalLine(0).transform(o),t.horizontalLine(1).transform(o),t.verticalLine(0).transform(o),t.verticalLine(1).transform(o)],s=i.iter(l);!s.done;s.next()){var u,c=s.value;if(u=c.intersection(e)){var d=e.locate(u),m=c.locate(u);if(d>=.01&&d<=1&&m>=0&&m<=1)return new V.TheoLine(e.p1,u)}}return e},constrainFrameSizeToImage:function(e,t,r){var n,a,l=this,s=t;if((n=i.opt(this.forma_,(function(e){return e.bounds})))&&(a=e.bounds)){var u=o.resizeBoundsWithPin(n,t,r),c=u.horizontalLine(0),d=u.horizontalLine(1),m=u.verticalLine(0),h=u.verticalLine(1),f=[],g=!1,p=!1;if(.5==r.x)g=!0,f=i.clone(0==r.y?[m,h]:[m.reverse(),h.reverse()]);else if(.5==r.y)p=!0,f=i.clone(0==r.x?[c,d]:[c.reverse(),d.reverse()]);else if(r.x==r.y){var v=new V.TheoLine(new j.TheoPoint(u.minX,u.minY),new j.TheoPoint(u.maxX,u.maxY));f=0==r.x?[v,c,m]:[v.reverse(),d.reverse(),h.reverse()]}else v=new V.TheoLine(new j.TheoPoint(u.minX,u.maxY),new j.TheoPoint(u.maxX,u.minY)),f=0==r.x?[v,d,m.reverse()]:[v.reverse(),c.reverse(),h];var C=f.map((function(t){return l.clipLineToRectWithTransform(t,a,e.placement)}),this),F=u.height,y=u.width;if(g)F=C.reduce((function(e,t){return Math.min(e,t.length)}),1e5);else if(p)y=C.reduce((function(e,t){return Math.min(e,t.length)}),1e5);else{for(var b=1e5,I=i.iter(i.toSequence(f));!I.done;I.next()){var S=I.value,D=S.offset,T=S.element,M=i.as(C[D],V.TheoLine).length/T.length;M<b&&(b=M)}y*=b,F*=b}s=new J.TheoSize(y,F)}return s},processFormaResize:function(e){var t,r,n,a,l,s;if((t=i.as(this.forma,F.FrameForma))&&(r=B.ImageFacade.getImageFormaForForma(t))&&(n=t.bounds)&&(a=i.opt(i.opt(t.page.document,(function(e){return e.controller})),(function(e){return e.selection})))&&(l=e.pin)&&(s=e.newSize)){var u=new T.FormaAnimationTransactionEvent(t);u.duration=0,t.beginUpdate(u);var c=[],d=this.maintainAspectRatio||.5!=l.x&&.5!=l.y;if(a.inCropMode){if(s=d?n.size.myAspectRatioClosestCorner(s):s,r.hasAlpha()){var m=o.resizeBoundsWithPin(n,s,l).insetXY(15,15);if(!Z.TheoRect.PointInCommon(r.bounds,L._asterisk_Matrix2D_Matrix2D(r.totalPlacement,t.totalPlacement.inverse),m))return void t.endUpdate(u);e.newSize=s}else e.newSize=this.constrainFrameSizeToImage(r,s,l);for(var h=i.iter(t.visitAsArray(p.FormaTraversal.JustChildren));!h.done;h.next()){var f=h.value;c.push(f),t.root.appendChild(f,!0)}}P.GroupController.prototype.processFormaResize.call(this,e);for(var g=i.iter(c);!g.done;g.next())f=g.value,t.appendChild(f,!0);this.fitChildrenToFrame(),a.inCropMode&&this.updateCropModeImage(),t.endUpdate(u)}},processEndFormaResize:function(e){var t;if(P.GroupController.prototype.processEndFormaResize.call(this,e),this.updateParentGroup(),t=B.ImageFacade.getImageFormaForForma(this.forma)){var r=new T.FormaForceRerenderPseudoChangeEvent(t);t.beginUpdate(r),t.endUpdate(r)}},processFormaDrag:function(e){var t;P.GroupController.prototype.processFormaDrag.call(this,e),(t=i.as(i.opt(this.forma.parent,(function(e){return e.controller})),M.GridController))&&t.processChildFormaDrag(this.forma,e)},afterProcessFormaDrag:function(e){var t;(t=i.as(i.opt(this.forma.parent,(function(e){return e.controller})),M.GridController))&&t.processChildFormaDrag(this.forma,e)},childUpdate:function(e){void 0===e&&(e=null),P.GroupController.prototype.childUpdate.call(this,e),this.blockUpdate||(this.fitChildrenToFrame(),this.updateCropModeImage())},shuffleColorAssignment:function(){var e,t,r,n;if((t=i.as(this.forma,F.FrameForma))&&(r=i.opt(this.forma,(function(e){return e.style})))&&(n=i.as(t.controller,o))){if(t.isLogo())return;var a=this.getCurrentColors(r).length,l=r.colors.color(h.ColorRole.FieldPrimary),s=!(e=i.opt(l,(function(e){return e.isEqual(X.SolidColor.ZERO)})))&&null==e||e,u=a>0&&n.hasCutout&&!s,c=t.page.colorLibraryController;if(u){var d=[],f=null;if(q.TheoDocumentUtils.enableFastHeuristicsForComplexPage(this.forma.page)){var g=n.floating?O.InferredRoleType.GraphicContent:O.InferredRoleType.Background;f=i.clone(O.InferredRole.init_84d1(g,1,O.InferredRoleType.Background,0))}var p,v=new m.ProfilingPrimaryColorSelector(t,!1).selectColorForGlobalRecolor(void 0,void 0,void 0,i.clone(f));if((p=c.getTheoColorForKey(v))&&d.push(p),a>1){var C,y=new m.ProfilingBackgroundColorSelector(t,!0).selectColorForGlobalRecolor(void 0,void 0,void 0,i.clone(f));(C=c.getTheoColorForKey(y))&&d.push(C)}this.applyColors(i.clone(d))}}},updateCropModeImage:function(){var e,t,r,o,n;B.ImageFacade.inCropMode(this.forma)&&(t=B.ImageFacade.getImageFormaForForma(this.forma))&&(r=B.ImageFacade.getTempCropImageForForma(this.forma))&&(k.Host.platform.isWeb&&!r.bounds.equal(t.bounds)?(this.cleanupCropVisualization(),this.enterCropMode()):((e=i.opt(r.controller,(function(e){return e.userGroupChild})))||null!=e)&&e?(o=r.parent)&&null!=(n=o.indexOfChild(r))&&(i.opt(r.root,(function(e){return e.appendChild(r,!0)})),r.placement=t.totalPlacement,o.insertChildAt(r,n,!0)):r.placement=t.totalPlacement)},updateAfterChildTransform:function(){this.updateParentGroup(),this.fitChildrenToFrame(),this.updateCropModeImage()},enterCropMode:function(){if(B.ImageFacade.inCropMode(this.forma)){if(null!=B.ImageFacade.getTempCropImageForForma(this.forma))return;this.preCropModeLayerIndex_=this.createCropVisualization()}},createCropVisualization:function(){var e,t=new T.FormaAnimationTransactionEvent(this.forma);t.duration=0,this.forma.beginUpdate(t);var r,o,n,a,l,s=null,u=G.GUIDUtils.makeGUID(),c=G.GUIDUtils.makeGUID();if((r=this.forma.parent)&&null!=(o=r.indexOfChild(this.forma))&&(e=o,r.removeChild(this.forma),r.appendChild(this.forma),s=f.DBLink.init_8408(u,this.forma.database,r.parent.id)),(n=B.ImageFacade.getImageFormaForForma(this.forma))&&(a=i.as(this.forma.forkToDatabase(u,!1,this.forma.database,s),F.FrameForma))&&(l=i.as(n.forkToDatabase(c,!1,this.forma.database,f.DBLink.init_8408(c,this.forma.database,a.id)),E.ImageForma))){l.setParent(a),a.setParent(null),a.appendChild(l,!0);var d,m,h,g,v=G.GUIDUtils.makeGUID();(d=this.forma)&&(m=B.ImageFacade.getCutoutMaskFormaForForma(d))&&(h=i.as(m.forkToDatabase(v,!1,this.forma.database,f.DBLink.init_8408(v,this.forma.database,a.id)),E.ImageForma))&&(B.ImageFacade.setCutoutForForma(a,h),B.ImageFacade.setCutoutModeForForma(a,B.ImageFacade.getCutoutModeForForma(d))),(g=i.as(l,Q.VideoForma))&&(g.mode=Q.VideoMode.stillImage),a.intent=p.Forma.INTENT_TEMP_IMAGE_CROP,a.bounds=l.bounds,a.placement=n.totalPlacement,a.isModel=!1,B.ImageFacade.setMaskForForma(a,null),l.placement=L.Matrix2D.Identity,l.style.opacity=.4*l.style.opacity,this.forma.parent.insertBefore(a,this.forma,!0);var C=[];C.push(l);var y,b=new T.FormaInsertedChildrenEvent(a,C,0);a.beginUpdate(b),a.endUpdate(b),(y=i.as(this.forma.page.createFormaWithController(H.ShapeForma.KIND,z.ShapeController.KIND),H.ShapeForma))&&(W.ShapeLibrary.applyToShapeForma(y,W.ShapeLibrary.Square),y.bounds=i.opt(this.forma.root,(function(e){return e.bounds})),y.style.opacity=.5,y.style.colors.fieldPrimary=X.SolidColor.BLACK,y.intent=p.Forma.INTENT_TEMP_IMAGE_CROP,y.allowUserMove=!1,this.forma.parent.insertBefore(y,a,!0))}return this.forma.endUpdate(t),e},cleanupCropVisualization:function(){var e,t=[];if(s=i.opt(this.forma,(function(e){return e.parent})))for(var r=i.iter(s.visitAsArray(p.FormaTraversal.JustChildren));!r.done;r.next())(l=r.value).hasIntent(p.Forma.INTENT_TEMP_IMAGE_CROP)&&t.push(l);if(null!=this.preCropModeLayerIndex_||0!=t.length){var o,n=new T.FormaAnimationTransactionEvent(this.forma);n.duration=0,this.forma.beginUpdate(n);for(var a=i.iter(t);!a.done;a.next()){var l;(l=a.value).removeFromParent(),l.destroy()}if((s=i.opt(this.forma,(function(e){return e.parent})))&&null!=(o=this.preCropModeLayerIndex_)&&(s.removeChild(this.forma),s.insertChildAt(this.forma,o)),this.preCropModeLayerIndex_=null,this.forma.endUpdate(n),this.userGroupChild)for(var s=i.opt(this.forma,(function(e){return e.parent}));((e=i.opt(i.opt(s,(function(e){return e.controller})),(function(e){return e.userGroup})))||null!=e)&&e;)_.GroupFacade.updateUserGroupBounds(s),s=i.opt(s,(function(e){return e.parent}))}},match:function(e){P.GroupController.prototype.match.call(this,e),this.cleanupCropVisualization()},setBoundsWithCropType:function(e,t){this.cropType_=t,i.opt(this.forma,(function(t){return t.bounds=Z.TheoRect.fromSize(e.size)})),this.cropType_=null},fit:function(e){this.fitWithCrop(e)},fitWithCrop:function(e,t){var r,o;void 0===t&&(t=null),this.cropType_=t,(r=this.forma)&&(o=r.bounds)&&(r.placement=L.Matrix2D.Identity,r.bounds=Z.TheoRect.fromSize(this.maintainAspectRatio?e.fitAspectRatioWithin(o.aspectRatio):e.size),r.moveCenterToPoint(e.center)),this.cropType_=null},getCurrentCropType:function(e,t){var r,o,i;if(null!=(r=this.cropType_))return r;if(this.forma.isSticker())return n.CropType.FitBorder;if((o=e)&&(i=t)){var a=Math.abs(o.aspectRatio-i.aspectRatio)<1e-4;return this.maintainAspectRatio&&a?n.CropType.ScaleCrop:this.forma.isGridCell()||this.userGroupChild?n.CropType.PreserveFocus:n.CropType.PreserveFocusAndScale}return n.CropType.PreserveFocus},setChildrenCropping:function(e,t){var r=this;this.forma.visitAll(p.FormaTraversal.JustChildren,(function(o){var n;(n=i.as(o.controller,w.ImageController))&&null!=o.bounds&&n.setCrop(r.forma.bounds,t,e)})),this.fitChildrenToFrame()},isBackgroundImageWithAlpha:function(){var e,t,r=!1;return(e=this.forma)&&(t=this.image)&&(r=e.isBackgroundImage()&&(t.hasAlpha()||this.hasCutout)),r},canHaveNoneFillColor:function(){return this.floating&&this.hasCutout},fitChildrenToFrame:function(e){void 0===e&&(e=!1);var t,r,o=this;if(this.forma.visitAll(p.FormaTraversal.JustChildrenAndAuxiliaries,(function(t){var r,n;if(null!=t.bounds&&null!=o.forma.bounds)if(r=i.as(t,E.ImageForma)){if(!r.hasIntent(p.Forma.INTENT_IMAGE_MASK))if(i.opt(r.animation,(function(e){return e.invalidate()})),e||!r.hasAlpha()||r.hasIntent(p.Forma.INTENT_PATTERN))o.ensureFormaFillsFrame(r,e);else{var a,l=1;(a=i.opt(r.page.view,(function(e){return e.getViewportTransform()})))&&(l=Math.sqrt(Math.abs(a.determinant))),o.beginBlockedUpdate(),g.DragFacade.rescueToArbitraryBounds(r,o.forma.bounds,o.forma.totalPlacement,36/l,30/l),o.endBlockedUpdate()}}else if(n=i.as(t,H.ShapeForma)){var s=o.forma.bounds;n.size=s.size,n.placement=L.Matrix2D.Identity}})),(t=B.ImageFacade.getImageFormaForForma(this.forma))&&(r=t.bounds)){var n,a,l;if((n=i.as(B.ImageFacade.getMaskFormaForForma(this.forma),E.ImageForma))&&(a=n.bounds)){var s=r.transform(t.placement);n.placement=L.Matrix2D.Identity.scaleXY(s.width/a.width,s.height/a.height).translateXY(t.placement.tx,t.placement.ty)}(l=B.ImageFacade.getCutoutMaskFormaForForma(this.forma))&&B.ImageFacade.updateCutoutMaskPlacement(this.forma,l)}},ensureFormaFillsFrame:function(e,t){void 0===t&&(t=!1);var r=this.forma.bounds.transform(e.placement.inverse),o=r.height/e.bounds.height,n=r.width/e.bounds.width,i=Y.MathUtils.maxDouble(n,o);(i>1||t)&&(e.move(L.Matrix2D.uniformScaling(i)),r=this.forma.bounds.transform(e.placement.inverse)),r.minX<e.bounds.minX&&(e.placement=e.placement.precat(L.Matrix2D.translationXY(r.minX-e.bounds.minX,0)),r=this.forma.bounds.transform(e.placement.inverse)),r.maxX>e.bounds.maxX&&(e.placement=e.placement.precat(L.Matrix2D.translationXY(r.maxX-e.bounds.maxX,0)),r=this.forma.bounds.transform(e.placement.inverse)),r.minY<e.bounds.minY&&(e.placement=e.placement.precat(L.Matrix2D.translationXY(0,r.minY-e.bounds.minY)),r=this.forma.bounds.transform(e.placement.inverse)),r.maxY>e.bounds.maxY&&(e.placement=e.placement.precat(L.Matrix2D.translationXY(0,r.maxY-e.bounds.maxY)),r=this.forma.bounds.transform(e.placement.inverse))},isImageCropped:function(){var e,t,r;return!!((e=i.opt(this.forma,(function(e){return e.bounds})))&&(t=B.ImageFacade.getImageFormaForForma(this.forma))&&(r=t.bounds))&&!r.transform(t.placement).equalWithAccuracy(e,.001)},getAverageEdgeGrid:function(e,t){void 0===t&&(t=!0);var r,o=[];if(r=this.forma.frame)for(var n=new J.TheoSize(r.width/e.width,r.height/e.height),a=i.iter(i.range(0,i.toInt(e.width),!1));!a.done;a.next())for(var l=a.value,s=i.iter(i.range(0,i.toInt(e.height),!1));!s.done;s.next()){var u=s.value,c=Z.TheoRect.fromXYWH(i.toDouble(l)*n.width+r.origin.x,i.toDouble(u)*n.height+r.origin.y,n.width,n.height),d=this.getAverageEdge(c);o.push(d)}if(t){for(var m=[],h=1e-5,f=i.iter(o);!f.done;f.next())h+=d=f.value;for(var g=i.iter(o);!g.done;g.next())d=g.value,m.push(d/h);return m}return o},getAverageEdge:function(e){var t,r=0;if(t=this.forma){var o=e.transform(t.placement.inverse);t.visitAll(p.FormaTraversal.JustChildren,(function(e){var t;(t=i.as(e,E.ImageForma))&&(r+=t.getAverageEdge(o))}))}return r},getFaceIntersections:function(e){var t,r=0;if(t=this.forma){var o=e.transform(t.placement.inverse);t.visitAll(p.FormaTraversal.JustChildren,(function(e){var t;(t=i.as(e,E.ImageForma))&&(r+=t.getFaceIntersections(o))}))}return r},getAverageColor:function(e){var t,r=null;if(t=this.forma){var o=e.transform(t.placement.inverse);t.visitAll(p.FormaTraversal.JustChildren,(function(e){var t;(t=i.as(e,E.ImageForma))&&(r=t.getAverageColor(o))}))}return r},maintainAspectRatio:{get:function(){var e,t=B.ImageFacade.inCropMode(this.forma);return t&&(e=i.opt(this.mask,(function(e){return e.controller})))?e.maintainAspectRatio:this.floating&&!(t&&B.ImageFacade.usesFreeformCropPreset(this.forma))}},clip:{get:function(){return!0}},placeAsLogo:function(){var e,t,r,o;if((e=i.as(this.forma,F.FrameForma))&&(t=e.root)&&(r=B.ImageFacade.getImageFormaForForma(e))&&(o=r.bounds)&&r.isLogo()){var a,l=.12*Math.max(t.finalFrame.height,t.finalFrame.width);if(o.aspectRatio>1?this.fitWithCrop(new Z.TheoRect(0,0,l,l/o.aspectRatio),n.CropType.FitBorder):this.fitWithCrop(new Z.TheoRect(0,0,l*o.aspectRatio,l),n.CropType.FitBorder),a=new N.LogoPlacementSuggester(e,t).fastPlacement()){var s=new T.FormaTransformChangedEvent(e);s.duration=0,e.beginUpdate(s),a.apply(),e.endUpdate(s)}this.bringToForeground()}},bringToForeground:function(){var e,t;(e=i.as(this.forma,F.FrameForma))&&(t=e.parent)&&(t.removeChild(e),t.appendChild(e))},addForma:function(e,t,r){var l,s,d,m;if((l=i.as(e.root,U.RootForma))&&(s=i.as(t,F.FrameForma))&&(d=B.ImageFacade.getImageFormaForForma(s))&&(m=x.GridFacade.getPageGrid(t.page,!0))){if(null==d.frame||r.parentingHint==u.AddFormaParentingHint.addToRoot)return l.appendChild(t),c.CorePromise.resolve(null);var h=!1;if(r.floatingImageStrategy==u.FloatingImageStrategy.Always?(h=!0,d.isLogo()||(d.intent=p.Forma.INTENT_FLOATING_IMAGE)):r.floatingImageStrategy==u.FloatingImageStrategy.IfHasAlphaOrIsLogo&&(d.isLogo()||d.hasAlpha())&&(h=!0),s.allowUserMove=h,h)m.forma.appendChild(s);else{for(var f=i.clone(l.filterWithCallback((function(e){return e.isBackgroundImage()}))),g=i.iter(f);!g.done;g.next()){var v,C=g.value;if(v=B.ImageFacade.getImageStyleForForma(C)){var I=v.clone();I.adjustments=R.ImageAdjustments.createDefault(),B.ImageFacade.applyImageStyle(I,[d])}}m.addFormaToGroup(s)}i.opt(k.Host.logging,(function(e){return e.logToAnalytics(a.AnalyticsConstants.kAnalyticsImageAddedToFrame,{hasAlpha:d.hasAlpha()?"true":"false",isLogo:d.isLogo()?"true":"false",isBackground:h?"false":"true"})}));var S=1==l.filterWithCallback((function(e){return B.ImageFacade.isPotentialBackgroundImage(e)})).length;if(h){if(!d.isLogo())return new c.CorePromise((function(e,a){var u;(u=i.opt(d.contentNode,(function(e){return e.image})))?u.whenLoaded((function(){if(r.suggestPlacement){var a,u,c=new y.FormaPlacementSuggester(t,l);(a=i.as(c.fastPlacement(),b.FormaPlacementSuggestion))&&(u=i.as(s.controller,o))&&u.fitWithCrop(a.location,n.CropType.FitBorder)}else i.opt(t.controller,(function(e){return e.fit(l.frame.insetRel(.25,.25,.25,.25))}));return S&&l.page.colorLibraryController.extractImageColors(),e(null)})):e(null)}));i.as(s.controller,o).placeAsLogo()}else if(S)return new c.CorePromise((function(e,t){var r;if(!(r=i.opt(d.contentNode,(function(e){return e.image}))))return e(null);r.whenLoaded((function(){return l.page.colorLibraryController.extractImageColors(),e(null)}))}));return c.CorePromise.resolve(null)}return c.CorePromise.reject("couldn't get critical references")},getCurrentColors:function(e){var t;if(t=this.forma)for(var r=i.iter(t.visitAsArray(p.FormaTraversal.JustChildren));!r.done;r.next()){var o=r.value;if(o.kind==E.ImageForma.KIND)return o.controller.getCurrentColors(e)}return[]},replaceWithColoredShape:function(){var e,t,r;return(e=this.forma)&&(t=i.as(e.page.createFormaWithController(H.ShapeForma.KIND,z.ShapeController.KIND),H.ShapeForma))&&(W.ShapeLibrary.applyToShapeForma(t,W.ShapeLibrary.Square),t.contentID=null,t.preScale=null,t.allowUserMove=!1,(r=e.parent)&&(r.controller.replaceChildWithForma(e,t),null!=r.indexOfChild(t)&&null==e.parent))?t:null},replaceable:{get:function(){return!0}},cropSizeCheck:function(){var e,t;(e=this.forma)&&(t=e.finalFrame)&&(e.visitAll(p.FormaTraversal.JustChildren,(function(r){var o,a;(o=i.as(r.controller,w.ImageController))&&(a=r.finalFrame)&&t.area<.4*a.area&&o.setCrop(e.bounds,null,n.CropType.FitBorder)})),this.fitChildrenToFrame())},postDecode:function(){var e;(e=i.opt(this.forma,(function(e){return e.style})))&&e.kind==S.FormaStyle.KIND&&i.opt(this.forma,(function(t){return t.applyStyle(D.FrameStyle.init_6c45(e.opacity,e.colors.clone()))}))},containsPoint:function(e,t){return void 0===t&&(t=0),!!P.GroupController.prototype.containsPoint.call(this,e,t)&&(!(r=i.as(this.mask,H.ShapeForma))||r.containsPoint(e));var r},applyOpacity:function(e){for(var t=i.iter(this.forma.visitAsArray(p.FormaTraversal.JustChildren));!t.done;t.next()){var r=t.value;i.opt(r.controller,(function(t){return t.applyOpacity(e)}))}}}}),o)},"9Lk3":function(e,t,r){var o,n,i=t,a=r("oAGj"),l=r("SpAV"),s=r("yhkb"),u=r("C42b"),c=r("HWAX"),d=r("ascj"),m=r("quOg"),h=r("FNB+"),f=r("6ZWm"),g=r("waL6"),p=r("cmoc"),v=r("P83h"),C=r("ZK0l"),F=r("tQF8"),y=r("/afT"),b=r("pnSN"),I=r("v/sv"),S=r("4mVB"),D=r("iCxV"),T=r("fdtz"),M=r("lmwz"),P=r("c+uM"),x=r("tGKA"),_=r("3DEm"),G=r("jcfx"),k=r("JFv5"),R=r("JO5d"),w=r("djAF"),A=r("35Q0"),E=r("T6jX"),B=r("8t9B"),N=r("oKlP"),L=r("sIWg"),Y=r("1NAc");i.ResizeCellInfo=(o=function(){},a.defineClass({name:"ResizeCellInfo",ctor:o,props:{init_d41d:function(){this.handle=null,this.newRect=L.TheoRect.Zero},init_implicit:function(e,t){this.handle=e,this.newRect=t},clone:function(){return o.init_implicit(this.handle,this.newRect)}}}),o),i.PROPERTY_FORMA_MAPPING="forma-mapping",i.GridController=(n=function(e,t,r){this.imageInitState_={},this.moveableInitState_={},this.checkFramesForCropping_=[],this.gridBounds_=new L.TheoRect(0,0,1,1),C.GroupController.call(this,e,t,r)},a.defineClass({name:"GridController",ctor:n,superName:"GroupController",statics:{KIND:{get:function(){return"grid"}},MAX_IMAGE_COUNT:{get:function(){return 16}},MAX_CELL_COUNT:{get:function(){return 16}},MIN_CELL_DIM:{get:function(){return 75}},isBackgroundColoredCell:function(e){return e.isGridCell()&&e instanceof w.ShapeForma&&null!=e.controller&&!e.controller.floating},hasLayoutPadding:function(e){var t,r=!1;return(t=a.as(a.opt(e.parent,(function(e){return e.controller})),n))&&(r=t.margin>0||t.spacing>0),r}},props:{gridForma:{get:function(){return this.forma}},gridStyle:{get:function(){return a.as(a.opt(this.forma,(function(e){return e.style})),S.GridStyle)},set:function(e){var t=this;a.opt(e,(function(e){return e.forma=t.forma})),a.opt(this.forma,(function(t){return t.protectedSetStyle(e)}))}},gridCells:{get:function(){return this.gridStyle.gridCells}},backgroundGridCells:{get:function(){return this.gridStyle.nonOverlappingCells()}},foregroundGridCells:{get:function(){return this.gridStyle.overlappingCells()}},formaMapping:{get:function(){return this.gridStyle.formaMapping}},formaMappingSwiftDict:{get:function(){return this.formaMapping}},formaMappingDeepCopy:{get:function(){for(var e={},t=a.iter(a.keys(this.formaMapping));!t.done;t.next()){var r=t.value,o=this.formaMapping[r];e[r]=o.clone()}return e}},selectable:{get:function(){return!0}},moveable:{get:function(){return!1}},rotateable:{get:function(){return!1}},flippable:{get:function(){return!1}},nudgeable:{get:function(){return!1}},canDeleteCellForForma:function(e){if(e.controller.moveable)return!0;if(e.controller.floating)return!0;var t;if(this.gridStyle.numBackgroundCells>1&&(t=this.formaMapping[e.formaID])){if(null!=this.getMergeCell(t))return!0;if(null!=this.getResizeCellToZeroInfo(t))return!0}return!1},getMergeCell:function(e){for(var t=null,r=a.iter(this.gridCells);!r.done;r.next()){var o=r.value;!a.eq(F._equality_GridCell_GridCell,o,e)&&o.mergeableWith(e)&&(null!=t&&0!=this.backgroundImagesForCell(t).length||(t=o))}return t},getResizeCellToZeroInfo:function(e){var t=null;if(this.gridStyle.numBackgroundCells>1){var r=this.getCellRegion(e),o=this.gridForma.frame,n=e.bounds;if(r.minX>o.minX+this.margin+1&&this.canRemoveFromHandleDirection(e,F.GridCellHandle.Left)?(t=F.GridCellHandle.Left,n=new L.TheoRect(n.maxX,n.minY,n.maxX,n.maxY)):r.maxX<o.maxX-this.margin-1&&this.canRemoveFromHandleDirection(e,F.GridCellHandle.Right)?(t=F.GridCellHandle.Right,n=new L.TheoRect(n.minX,n.minY,n.minX,n.maxY)):r.minY>o.minY+this.margin+1&&this.canRemoveFromHandleDirection(e,F.GridCellHandle.Top)?(t=F.GridCellHandle.Top,n=new L.TheoRect(n.minX,n.maxY,n.maxX,n.maxY)):r.maxY<o.maxY-this.margin-1&&this.canRemoveFromHandleDirection(e,F.GridCellHandle.Bottom)&&(t=F.GridCellHandle.Bottom,n=new L.TheoRect(n.minX,n.minY,n.maxX,n.minY)),null!=t){var l=a.clone(i.ResizeCellInfo.init_d41d());return l.handle=t,l.newRect=n,l}}return null},maxMargin:{get:function(){for(var e,t=this.forma.bounds,r=this.forma.finalFrame,o=null,n=a.iter(this.backgroundGridCells);!n.done;n.next()){var i=n.value,l=t.evalRect(i.bounds).transform(this.forma.totalPlacement);o=null==o?l:a.opt(o,(function(e){return e.unionWith(l)}))}return(e=o)?Math.max(_.MathUtils.absDouble(r.minX-e.minX),_.MathUtils.absDouble(r.maxX-e.maxX),_.MathUtils.absDouble(r.minY-e.minY),_.MathUtils.absDouble(r.maxY-e.maxY)):0}},margin:{get:function(){for(var e=this.forma.bounds,t=this.forma.finalFrame,r=Math.max(t.width,t.height),o=a.iter(this.backgroundGridCells);!o.done;o.next()){var n=o.value,i=e.evalRect(n.bounds).transform(this.forma.totalPlacement),l=Math.min(_.MathUtils.absDouble(t.minX-i.minX),_.MathUtils.absDouble(t.maxX-i.maxX),_.MathUtils.absDouble(t.minY-i.minY),_.MathUtils.absDouble(t.maxY-i.maxY));r=Math.min(r,l)}return r},set:function(e){this.setMargin(e)}},setMargin:function(e,t){void 0===t&&(t=!0);var r=this.margin;if(e!=r){var o=this.forma.bounds.transform(this.forma.totalPlacement),i=this.gridStyle.clone();0==r&&!this.isBackgroundVisible()&&t&&this.setContrastingGridBackgroundColor();for(var l=!0,s=(o.width-2*e)/o.width,u=(o.height-2*e)/o.height,c=e/o.width,d=e/o.height,m=(o.width-2*r)/o.width,h=(o.height-2*r)/o.height,f=r/o.width,g=r/o.height,p=a.iter(this.backgroundGridCells);!p.done;p.next()){var v=(F=p.value).bounds.offsetXY(-f,-g).multiplyXY(1/m,1/h);a.opt(this.gridStyle,(function(e){return e.updateCell(F,v.multiplyXY(s,u).offsetXY(c,d))}))}for(var C=a.iter(this.backgroundGridCells);!C.done;C.next()){var F=C.value,y=this.getCellRegion(F);Math.min(y.width,y.height)<n.MIN_CELL_DIM&&(l=!1)}l?(this.resetMoveableFormaToInitialSizes(),this.layoutGrid(this.gridStyle.moveableShift,null,a.clone(this.preUpdateMapping_),this.preUpdateSpacing_)):this.gridStyle=a.as(i,S.GridStyle)}},getLogos:function(){return this.moveableFormae().filter((function(e){return e.isLogo()}),this)},getBackgroundShapes:function(){return this.forma.filterWithCallback((function(e){return n.isBackgroundColoredCell(e)}),h.FormaTraversal.JustChildren)},setMarginAndSpacing:function(e,t){t>=0&&(this.margin=t),e>=0&&(this.spacing=e)},linkedFormaForChild:function(e,t){var r=a.clone(this.forma.visitAsArray(h.FormaTraversal.JustChildren));if(a.remove(r,e),this.owner.interactionMode==m.InteractionMode.AutomaticGrid){if(e.isShape()||e.isBackgroundImage())return r}else if(e.isShape()||e.isImage())return e.controller.moveable?this.moveableFormae():this.forma.filterWithCallback((function(t){return(t.isBackgroundImage()||t.isShape())&&null!=t.controller&&!a.eq(h._equality_Forma_Forma,t,e)}));return[]},isBackgroundVisible:function(){if(this.gridStyle.spacing>0)return!0;for(var e=1,t=0,r=1,o=0,n=a.clone(this.backgroundGridCells),i=a.iter(n);!i.done;i.next()){var l=i.value;e=Math.min(e,l.bounds.minX),t=Math.max(t,l.bounds.maxX),r=Math.min(r,l.bounds.minY),o=Math.max(o,l.bounds.maxY)}return e>0||r>0||t<1||o<1},styleChanged:function(){var e=this;a.opt(this.gridStyle,(function(t){return t.forma=e.forma}))},getBoundaryCells:function(e){return this.filterBoundaryCells(a.clone(this.backgroundGridCells),e)},filterBoundaryCells:function(e,t){for(var r=[],o=a.iter(e);!o.done;o.next()){for(var n=o.value,i=!0,l=a.iter(e);!l.done;l.next()){var s=l.value;a.eq(F._equality_GridCell_GridCell,n,s)||(t==F.GridCellHandle.Left&&s.bounds.maxX-.01<=n.bounds.minX&&(i=!1),t==F.GridCellHandle.Right&&s.bounds.minX+.01>=n.bounds.maxX&&(i=!1),t==F.GridCellHandle.Top&&s.bounds.maxY-.01<=n.bounds.minY&&(i=!1),t==F.GridCellHandle.Bottom&&s.bounds.minY+.01>=n.bounds.maxY&&(i=!1))}i&&r.push(n)}return r},filterCellsByDirection:function(e,t,r){l.CoreAssert.isTrue(["vertical","horizontal"].includes(r),void 0,"GridController.filterCellsByDirection","GridController.swift",442);for(var o=[],n=a.iter(t);!n.done;n.next()){var i=n.value;"horizontal"==r?a.toDouble(Math.round(1e3*Math.max(e.bounds.minY,i.bounds.minY))/1e3)<a.toDouble(Math.round(1e3*Math.min(e.bounds.maxY,i.bounds.maxY))/1e3)&&o.push(i):"vertical"==r&&a.toDouble(Math.round(1e3*Math.max(e.bounds.minX,i.bounds.minX))/1e3)<a.toDouble(Math.round(1e3*Math.min(e.bounds.maxX,i.bounds.maxX))/1e3)&&o.push(i)}return o},spacing:{get:function(){return this.gridStyle.spacing},set:function(e){var t=this.gridStyle.spacing;if(t!=e){0!=t||this.isBackgroundVisible()||this.setContrastingGridBackgroundColor(),this.gridStyle.spacing=e;for(var r=a.iter(this.gridCells);!r.done;r.next()){var o=r.value,i=this.getCellRegion(o);if(Math.min(i.width,i.height)<n.MIN_CELL_DIM)return void(this.gridStyle.spacing=t)}this.resetMoveableFormaToInitialSizes(),this.layoutGrid(this.gridStyle.moveableShift,null,a.clone(this.preUpdateMapping_),this.preUpdateSpacing_)}}},setContrastingGridBackgroundColor:function(){for(var e=this.forma.page.colorLibraryController,t=e.getThemeColorKeys().concat(s.ColorLibraryController.THEME_DERIVED_BW_KEYS),r=[],o=a.iter(this.gridCells);!o.done;o.next()){var n,i=o.value;null!=this.backgroundShapeFormaForCell(i)&&null!=i.colorID&&(t.includes(i.colorID)&&a.remove(t,i.colorID),(n=e.getSolidColorForKey(i.colorID))&&r.push(n),l.CoreAssert.isTrue(null!=e.getSolidColorForKey(i.colorID),"why is the grid color nil??","GridController.setContrastingGridBackgroundColor","GridController.swift",523))}0==(t=t.filter((function(t){var o=e.getSolidColorForKey(t);if(null==o)return!1;for(var n=o,i=a.iter(r);!i.done;i.next()){var l=i.value;if(!n.contrasts(l,!1))return!1}return!0}),this)).length&&(t=this.forma.page.colorLibraryController.getThemeColorKeys().concat(s.ColorLibraryController.THEME_DERIVED_BW_KEYS));var c=this.forma.root.style.colors.colorID(d.ColorRole.FieldPrimary);if(null==c||!t.includes(c)){var m=t[u.CoreRandom.nextIntUniform(t.length)];this.forma.root.style.colors.setColorId(d.ColorRole.FieldPrimary,m)}},showHandle:function(e){for(var t=0,r=a.iter(this.gridCells);!r.done;r.next())t+=r.value.bounds.area;return t<.99||C.GroupController.prototype.showHandle.call(this,e)},selectionHandlePositions:{get:function(){for(var e=[],t=a.iter(this.gridCells);!t.done;t.next())for(var r=t.value,o=a.iter(F.GridCell.handles());!o.done;o.next()){var n=o.value,i=r.handlePosition(n);if(this.shouldShowHandle(i,r,n)){for(var l=!1,s=a.iter(e);!s.done;s.next())s.value.distanceTo(i)<.001&&(l=!0);l||e.push(i)}}for(var u=[],c=[],d=a.iter(e);!d.done;d.next()){var m=d.value;if(!c.includes(m)){var h=[];h.push(m);for(var f=a.iter(e);!f.done;f.next()){var g=f.value;m==g||c.includes(g)||this.mergeableHandlePoints(m,g)&&h.push(g)}u.push(this.mergeHandlePoints(a.clone(h)));for(var p=a.iter(h);!p.done;p.next()){var v=p.value;c.push(v)}}}return u}},mergeableHandlePoints:function(e,t){if(e.x==t.x||e.y==t.y){for(var r=new L.TheoRect(e.x,e.y,t.x,t.y).outsetXY(.001,.001),o=a.iter(this.gridCells);!o.done;o.next())if(o.value.bounds.insetRel(.01,.01,.01,.01).intersects(r))return!1;for(var n=a.iter(this.gridCells);!n.done;n.next())if(n.value.bounds.insetRel(.01,.01,.01,.01).intersects(r))return!1;return!0}return!1},mergeHandlePoints:function(e){if(e.length>0){for(var t=e[0].x,r=e[0].x,o=e[0].y,n=e[0].y,i=a.iter(e);!i.done;i.next()){var s=i.value;t=Math.min(t,s.x),r=Math.max(r,s.x),o=Math.min(o,s.y),n=Math.max(n,s.y)}var u=new N.TheoPoint(.5,.5);return a.sort(e,(function(e,t){return e.distanceTo(u)<t.distanceTo(u)}))[0]}return l.CoreAssert.fail("not enough points","GridController.mergeHandlePoints","GridController.swift",694),N.TheoPoint.ZERO},shouldShowHandle:function(e,t,r){for(var o=_.MathUtils.absDouble(e.x)>.01&&_.MathUtils.absDouble(e.y)>.01&&_.MathUtils.absDouble(1-e.x)>.01&&_.MathUtils.absDouble(1-e.y)>.01,n=0,i=a.iter(this.gridCells);!i.done;i.next()){var l=i.value;!a.eq(F._equality_GridCell_GridCell,t,l)&&this.adjacentCellForHandle(t,l,r)&&(n+=1)}return n<=1&&o},adjacentCellForHandle:function(e,t,r){if(e.bounds.L1Distance(t.bounds)>.01)return!1;var o=t.bounds.center.y>=e.bounds.minY&&t.bounds.center.y<=e.bounds.maxY&&e.bounds.height>t.bounds.height+.05,n=t.bounds.center.x>=e.bounds.minX&&t.bounds.center.x<=e.bounds.maxX&&e.bounds.width>t.bounds.width+.05;return!!(r==F.GridCellHandle.Left&&o&&t.bounds.center.x<e.bounds.center.x||r==F.GridCellHandle.Right&&o&&t.bounds.center.x>e.bounds.center.x||r==F.GridCellHandle.Top&&n&&t.bounds.center.y<e.bounds.center.y||r==F.GridCellHandle.Bottom&&n&&t.bounds.center.y>e.bounds.center.y)},getCellBackgroundShape:function(e){var t=this.cellForForma(e);if(null!=t)for(var r=a.iter(this.formaeForCell(t));!r.done;r.next()){var o=r.value;if(o instanceof w.ShapeForma&&n.isBackgroundColoredCell(o))return a.as(o,w.ShapeForma)}return null},getCellBackgroundImage:function(e){if(null!=e.controller&&e.controller.floating)return null;var t=this.cellForForma(e);if(null!=t)for(var r=a.iter(this.formaeForCell(t));!r.done;r.next()){var o,n=r.value;if(n.isBackgroundImage()&&(o=a.as(n,p.FrameForma)))return M.ImageFacade.getImageFormaForForma(o)}return null},childToSelect:function(){var e=a.clone(this.foregroundGridCells);if(0==e.length){var t=new N.TheoPoint(.5,.5);e=a.sort(this.backgroundGridCells,(function(e,r){return e.bounds.center.distanceTo(t)<r.bounds.center.distanceTo(t)}))}for(var r=a.clone(this.moveableFormae()),o=a.iter(e);!o.done;o.next())for(var n=o.value,i=a.iter(this.formaeForCell(n));!i.done;i.next()){var l=i.value;if(!a.containsEq(r,l,h._equality_Forma_Forma))return l}return this.forma},findCellHandle:function(e){for(var t=a.iter(this.gridCells);!t.done;t.next())for(var r=t.value,o=a.clone(F.GridCell.handlePositions()),n=a.iter(o);!n.done;n.next()){var i=n.value;if(r.bounds.eval(i).distanceTo(e)<.01)return[r,F.GridCell.handleForPosition(i)]}return[null,null]},containsPoint:function(e,t){void 0===t&&(t=0);for(var r=a.iter(this.gridCells);!r.done;r.next()){var o=r.value,n=this.getCellRegion(o);if(0!=t&&(n=n.outsetXY(t,t)),n.containsPoint(e))return!0}return!1},processFormaClick:function(e){a.eq(h._equality_Forma_Forma,e.forma,this.forma)||C.GroupController.prototype.processFormaClick.call(this,e)},beforeProcessFormaDrag:function(e){var t;(t=this.cellForForma(a.first(e.dragDelegate.draggedFormae)))&&(this.dragShapeInitBounds_=t.bounds),this.geomEventAroundChildDrag=new v.FormaGeometryChangedEvent(this.forma),this.forma.beginUpdate(this.geomEventAroundChildDrag)},processFormaDrag:function(e){this.beforeProcessFormaDrag(e),C.GroupController.prototype.processFormaDrag.call(this,e),this.afterProcessFormaDrag(e)},afterProcessFormaDrag:function(e){this.processChildFormaDrag(a.first(e.dragDelegate.draggedFormae),e),this.forma.endUpdate(this.geomEventAroundChildDrag),this.geomEventAroundChildDrag=null},processChildFormaDrag:function(e,t){if(e.controller.kind!=n.KIND){var r=this.cellForForma(e);if(null!=r&&e.kind==w.ShapeForma.KIND&&n.isBackgroundColoredCell(e)&&a.containsEq(this.foregroundGridCells,r,F._equality_GridCell_GridCell)&&null!=this.dragShapeInitBounds_){var o=this.forma.finalFrame,i=e.finalFrame,l=-1*Math.min(0,i.minX-o.minX),s=-1*Math.min(0,i.minY-o.minY);i.maxX>o.maxX&&(l=o.maxX-i.maxX),i.maxY>o.maxY&&(s=o.maxY-i.maxY),e.move(x.Matrix2D.translationXY(l,s)),i=e.finalFrame;for(var u=this.gridStyle.updateCell(r,L.TheoRect.fromXXYY((i.minX-o.minX)/o.width,(i.maxX-o.minX)/o.width,(i.minY-o.minY)/o.height,(i.maxY-o.minY)/o.height)),c=u.bounds.origin.subtract(this.dragShapeInitBounds_.origin),d=a.clone(this.moveableFormae()),m=a.iter(this.formaeForCell(u));!m.done;m.next()){var f=m.value;a.containsEq(d,f,h._equality_Forma_Forma)&&f.move(x.Matrix2D.translationXY(c.x*o.width,c.y*o.height))}}}},processChildBeginFormaDrag:function(e,t){this.inferGridCellAssignment()},processEndFormaDrag:function(e){C.GroupController.prototype.processEndFormaDrag.call(this,e),this.processChildEndFormaDrag(e)},afterProcessEndFormaDrag:function(e){this.processChildEndFormaDrag(e)},processChildEndFormaDrag:function(e){this.dragShapeInitBounds_=null,this.inferGridCellAssignment(),a.first(e.dragDelegate.draggedFormae).isTypeLockup()&&this.owner.interactionMode==m.InteractionMode.AutomaticGrid&&this.setInitialFormaSizes()},updateInitStateForForma:function(e){var t={bounds:e.bounds,placement:e.placement};if(this.moveableInitState_[e.id]=t,null!=this.preUpdateMapping_){for(var r=[],o=a.iter(a.keys(this.preUpdateMapping_));!o.done;o.next()){var n=o.value;(u=this.preUpdateMapping_[n])&&r.push(u)}for(var i=null,l=a.iter(r);!l.done;l.next()){var s,u=l.value,c=this.getCellRegion(u,this.forma.bounds),d=e.finalFrame;(s=c.intersectionWith(d))&&s.area/d.area>.8&&(i=u,this.preUpdateMapping_[e.formaID]=u)}null==i?null!=this.preUpdateMapping_[e.formaID]&&a.removeKey(this.preUpdateMapping_,e.formaID):this.preUpdateMapping_[e.formaID]=i}},isChildSwappable:function(e){var t;return(t=a.as(e,T.ImageForma))?this.isChildSwappable(t.parent):null!=e.controller&&!e.controller.moveable},swapGridChildren:function(e,t){var r,o;this.isChildSwappable(e)&&this.isChildSwappable(t)&&(r=this.cellForForma(e))&&(o=this.cellForForma(t))&&this.swapCells(r,o)},swapCells:function(e,t){var r=e,o=t,n=t.colorID;o=this.gridStyle.updateCell(o,null,e.colorID,null),r=this.gridStyle.updateCell(r,null,n,null);for(var i=[],l=[],s=a.iter(this.formaMappingSwiftDict);!s.done;s.next()){var u=s.key,c=s.value;a.eq(F._equality_GridCell_GridCell,c,r)&&i.push(u),a.eq(F._equality_GridCell_GridCell,c,o)&&l.push(u)}for(var d=a.iter(i);!d.done;d.next())u=d.value,this.gridStyle.mapCellToFormaID(u,o);for(var h=a.iter(l);!h.done;h.next())u=h.value,this.gridStyle.mapCellToFormaID(u,r);var g=null;this.owner.interactionMode==m.InteractionMode.AutomaticGrid&&(this.resetMoveableFormaToInitialSizes(),g=a.clone(this.preUpdateMapping_)),this.layoutGrid(this.owner.interactionMode==m.InteractionMode.AutomaticGrid&&this.gridStyle.moveableShift,null,a.clone(g));for(var p=a.iter(i);!p.done;p.next())u=p.value,o.bounds.area<r.bounds.area/2&&(C=a.as(a.opt(this.forma.formaByID(u),(function(e){return e.controller})),f.FrameController))&&C.cropSizeCheck();for(var v=a.iter(l);!v.done;v.next()){var C;u=v.value,r.bounds.area<o.bounds.area/2&&(C=a.as(a.opt(this.forma.formaByID(u),(function(e){return e.controller})),f.FrameController))&&C.cropSizeCheck()}},spacingChangesVisible:{get:function(){return this.gridStyle.numBackgroundCells>1}},enterLayoutMode:function(){this.setInitialFormaSizes(),this.inferGridCellAssignment(),this.updateGridColors()},setInitialFormaSizes:function(){l.CoreAssert.isTrue(null!=this.gridStyle.forma,void 0,"GridController.setInitialFormaSizes","GridController.swift",1088),this.preUpdateMapping_=a.clone(this.formaMappingDeepCopy),this.preUpdateSpacing_=this.gridStyle.spacing,a.removeAll(this.moveableInitState_);for(var e=a.iter(this.moveableFormae());!e.done;e.next()){var t,r=e.value;(t=a.as(r.controller,B.TypeLockupController))&&t.centerAlignmentIfSingleLine();var o={bounds:r.bounds,placement:r.placement};this.moveableInitState_[r.id]=o}},onFormaeDeleted:function(e){for(var t=a.iter(e);!t.done;t.next()){var r=t.value;a.removeKey(this.moveableInitState_,r.id)}},beginChildResizeEvent:function(e){this.setImageInitialSizes()},setImageInitialSizes:function(){this.imageInitState_={};for(var e=a.iter(this.forma.visitAsArray(h.FormaTraversal.PreOrder));!e.done;e.next()){var t=e.value;null!=t.controller&&t.controller.moveable&&t.kind==T.ImageForma.KIND&&(this.imageInitState_[t.formaID]=t.placement)}},resetMoveableFormaToInitialSizes:function(){if(!this.blockUpdate)for(var e=a.iter(this.moveableInitState_);!e.done;e.next()){var t,r=e.key,o=e.value;(t=a.as(a.opt(this.forma,(function(e){return e.database.getObject(r)})),h.Forma))&&(t.bounds=o.bounds,t.placement=o.placement)}},resetImageFormaToInitialPlacement:function(){for(var e=a.iter(this.forma.visitAsArray(h.FormaTraversal.PreOrder));!e.done;e.next()){var t,r=e.value;(t=this.imageInitState_[r.formaID])&&(r.placement=t)}},currentResizeCellHandlePosition:function(){return null!=this.resizeCell_?this.resizeCell_.handlePosition(this.resizeCellHandle_):null},clone:function(e){return new g.FormaControllerFactory(this.owner).createController(this.kind,e)},postClone:function(e){var t,r;(t=a.as(e.controller,n))&&(r=t.gridStyle)&&(e.style.forma=e,a.opt(this.gridStyle,(function(e){return e.postCloneMatch(r)})))},contentID:{get:function(){return"grid"}},mappedFormaIDs:function(){l.CoreAssert.isFalse(a.keys(this.formaMapping).includes(this.forma.formaID),"should be returning the grid id","GridController.mappedFormaIDs","GridController.swift",1208);for(var e=[],t=a.iter(this.formaMapping);!t.done;t.next()){var r=t.key;e.push(r)}return e},matchImageStyles:function(e){for(var t=a.clone(this.forma.filterWithCallback((function(e){return e.kind==T.ImageForma.KIND&&M.ImageFacade.isPotentialBackgroundImage(e.parent)}))),r=a.clone(e.forma.filterWithCallback((function(e){return e.kind==T.ImageForma.KIND&&M.ImageFacade.isPotentialBackgroundImage(e.parent)}))),o=a.iter(a.range(0,t.length,!1));!o.done;o.next()){var n=o.value;t[n].match(r[n%r.length])}},match:function(e){this.beginBlockedUpdate(),this.forma.bounds=e.forma.bounds,this.endBlockedUpdate();for(var t=e.forma.filterWithCallback((function(e){return e.isBackgroundImage()})).length,r=e.forma.filterWithCallback((function(e){return e.kind==p.FrameForma.KIND&&e.controller.floating&&!e.hasAlpha()})).length,o=a.clone(this.forma.filterWithCallback(M.ImageFacade.isPotentialBackgroundImage)),i=Math.max(0,o.length-r),l=a.iter(a.range(0,i,!1));!l.done;l.next()){var s=o[l.value];M.ImageFacade.canSetBackgroundImage(s)&&M.ImageFacade.setBackgroundImage(s)}o=a.clone(o.slice(i,o.length));for(var u=a.iter(a.range(0,Math.min(r,o.length),!1));!u.done;u.next())s=o[u.value],M.ImageFacade.canSetFloatingImage(s)&&M.ImageFacade.setFloatingImage(s);this.gridStyle.match(e.forma.style);var c,d=this.forma.filterWithCallback((function(e){return e.isBackgroundImage()})).length,m=this.forma.filterWithCallback((function(e){return n.isBackgroundColoredCell(e)})).length,h=e.forma.filterWithCallback((function(e){return n.isBackgroundColoredCell(e)})).length;if(c=a.as(e,n)){d>0&&t>0&&this.matchImageStyles(e);var f=this.gridStyle;if(t<=d){this.splitCellsWithMultipleBackgroundImages(null);var g=0==h&&1==t&&c.maxMargin<10,v=1==h&&0==t&&c.maxMargin<10;(m>0&&(g||v)&&0==f.overlappingCells().length||d+t==0&&h<=1)&&(0==t&&0==d&&1==c.gridStyle.numCells?this.gridStyle.updateCell(this.gridCells[0],null,c.gridCells[0].colorID,null):this.recreateGrid(!1,Math.max(d,1),!1)),Math.abs(c.margin-c.maxMargin)<1&&(this.margin=c.margin)}else if(d<t){for(var C=a.clone(a.shuffle(this.forma.page.colorLibraryController.getThemeColorKeys())),F=[],y=a.iter(this.gridCells);!y.done;y.next())null==(T=y.value).colorID||F.includes(T.colorID)||F.push(T.colorID);if(t-d<C.length-F.length)for(var b=a.iter(F);!b.done;b.next()){var I=b.value;C.includes(I)&&a.remove(C,I)}for(var S=0,D=a.iter(this.gridCells);!D.done;D.next()){var T=D.value;null!=this.backgroundShapeFormaForCell(T)&&null==T.colorID&&(this.gridStyle.updateCell(T,null,C[S%C.length],null),S+=1)}}this.layoutGrid(!1),this.cropCheck()}},postMatch:function(e){this.inferBackgroundCellAssignment()},showChildHandle:function(e,t){var r,o,n=this.forma.bounds,i=this.forma.finalFrame;if(((r=a.opt(e.controller,(function(e){return e.userGroupChild})))||null!=r)&&r)return!1;if(e.controller.floating)return!0;if((o=this.cellForForma(e))&&this.gridStyle.overlappingCells().filter((function(e){return a.eq(F._equality_GridCell_GridCell,e,o)}),this).length>0&&i.equalWithAccuracy(e.finalFrame,10))return!0;for(var l=0,s=a.iter(this.backgroundGridCells);!s.done;s.next()){var u=s.value,c=n.evalRect(u.bounds).transform(this.forma.totalPlacement),d=Math.min(_.MathUtils.absDouble(i.minX-c.minX),_.MathUtils.absDouble(i.maxX-c.maxX),_.MathUtils.absDouble(i.minY-c.minY),_.MathUtils.absDouble(i.maxY-c.maxY));l=Math.max(l,d)}var m=e.finalFrame.eval(t);return!(l<.001&&(m.x<5||m.y<5||m.x>e.root.finalFrame.maxX-5||m.y>e.root.finalFrame.maxY-5))},applyGridStyleWithMapping:function(e,t){var r=this.gridStyle,o=a.clone(this.gridCells),n=a.clone(this.formaMappingSwiftDict),i=this.margin;r.match(e),this.updateHierarchy(),this.colorGrid(a.clone(o),a.clone(n)),this.layoutGrid(e.moveableShift),this.setInitialFormaSizes(),r.cropType=f.CropType.PreserveFocus,t&&this.setMargin(i,!1)},applyStyle:function(e,t){var r;if(r=a.as(e,S.GridStyle)){var o;if(this.gridStyle.forma=this.forma,0!=a.count(r.formaMapping)&&0==t)r.spacing=this.gridStyle.spacing,this.applyGridStyleWithMapping(r,!0),o=r;else{var n=null!=this.gridForma.parent&&null!=this.gridForma.root;if(l.CoreAssert.isTrue(n,"bad things are happening. we're apply a style to a forma which is no longer attached","GridController.applyStyle","GridController.swift",1447),!n)return;var i=a.clone(r.numCells==this.gridStyle.numCells?this.formaMappingSwiftDict:null),s=a.clone(new I.GridSuggester(this.gridForma,r,a.clone(i)).createSuggestions());if(s.length>0){var u=s[t%s.length];u.gridStyle.spacing=this.gridStyle.spacing,this.applyGridStyleWithMapping(u.gridStyle,!0),o=u.gridStyle}}null!=o&&o.moveableShift&&this.owner.interactionMode!=m.InteractionMode.DefaultInteraction&&this.adjustLogos(a.clone(this.getLogos())),r.name==this.owner.document.gridLibrary.basicFullDesignGridStyle().name||E.TheoDocumentUtils.enableFastHeuristicsForComplexPage(this.forma.page)||(this.contrastCheck(),this.cropCheck()),l.CoreAssert.isTrue(null!=this.gridStyle.forma,void 0,"GridController.applyStyle","GridController.swift",1474)}},adjustLogos:function(e){for(var t=a.iter(e);!t.done;t.next()){var r,o=t.value;(r=a.as(o.controller,f.FrameController))&&r.placeAsLogo()}},numCells:{get:function(){return this.gridCells.length}},contrastCheck:function(){for(var e=a.iter(this.moveableFormae());!e.done;e.next()){var t,r=e.value;null!=this.formaMapping[r.formaID]&&(t=this.cellForForma(r))&&this.backgroundShapeFormaForCell(t)&&a.opt(r.controller,(function(e){return e.contrastCheck(!1)}))}},cropCheck:function(){for(var e=a.iter(this.checkFramesForCropping_);!e.done;e.next()){var t,r=e.value;(t=a.as(r.controller,f.FrameController))&&t.cropSizeCheck()}},replaceChildWithForma:function(e,t,r){void 0===r&&(r=!1);var o,n,i=this.isReplacedWithSameImage(e,t);if(C.GroupController.prototype.replaceChildWithForma.call(this,e,t,r),e.controller.floating){var l,s,u=e.placement.transformValues,c=t.finalFrame.center;t.placement=t.placement.rotateTo(u.rotCosine,u.rotSine),t.moveCenterToPoint(c),(l=M.ImageFacade.getImageFormaForForma(e))&&(s=M.ImageFacade.getImageFormaForForma(t))&&(s.intent=l.intent)}if((o=this.cellForForma(e))&&(this.gridStyle.replaceMappedForma(e,t),t.isShape())){var d,m,h=this.forma.page.colorLibraryController;(d=this.getContrastingColorForCell(t))&&null!=(m=h.getKeyOfColorInTheme(d))&&this.gridStyle.updateCell(o,null,m,null)}(n=a.as(t.controller,f.FrameController))&&(i||e.controller.floating||n.fitWithCrop(t.frame,f.CropType.FitBorder)),i||e.controller.floating||this.layoutGrid(!1)},isReplacedWithSameImage:function(e,t){var r=a.clone(t.filterByKind(T.ImageForma.KIND)),o=a.clone(e.filterByKind(T.ImageForma.KIND));if(r.length>0&&o.length>0)for(var n=a.iter(r);!n.done;n.next()){var i,l,s=n.value,u=o[0];if((i=a.opt(s.contentNode,(function(e){return e.mediaMetadata})))&&(l=a.opt(u.contentNode,(function(e){return e.mediaMetadata}))))return null!=i.assetID&&null!=l.assetID&&i.assetID==l.assetID}return!1},removeFormaWithoutGridModification:function(e){if(e.isGridCell()){var t=this.cellForForma(e);if(a.opt(t,(function(e){return null==e.colorID}))){var r,o,n=this.forma.page.colorLibraryController;(r=this.getContrastingColorForCell(e))&&null!=(o=n.getKeyOfColorInTheme(r))&&a.opt(t,(function(e){return e.colorID=o}))}}C.GroupController.prototype.removeFormaFromGroup.call(this,e),a.opt(this.gridStyle,(function(t){return t.removeMappingToForma(e)}))},removeFormaFromGroup:function(e){var t;if(C.GroupController.prototype.removeFormaFromGroup.call(this,e),this.forma instanceof b.GroupForma&&(t=this.formaMapping[e.formaID])){if(this.gridStyle.removeMappingToForma(e),e.controller.floating)return;if(e.controller.moveable){for(var r=a.iter(this.formaeForCell(t));!r.done;r.next())s=r.value,this.gridStyle.removeMappingToForma(s);a.opt(this.gridStyle,(function(e){return e.removeCell(t)}))}else{var o,n=this.getMergeCell(t);if(o=n){this.gridStyle.mergeCell(o,t),this.gridStyle.name=S.GridStyle.CUSTOM_LAYOUT_NAME;for(var i=a.iter(this.formaeForCell(t));!i.done;i.next()){var s=i.value;this.gridStyle.removeMappingToForma(s)}this.gridStyle.removeCell(t)}if(null==n){var u,c=this.gridStyle.numBackgroundCells;if(u=this.getResizeCellToZeroInfo(t)){var m=u.newRect,h=u.handle;l.CoreAssert.isTrue(null!=h,void 0,"GridController.removeFormaFromGroup","GridController.swift",1649),l.CoreAssert.isTrue(m!=L.TheoRect.Zero,void 0,"GridController.removeFormaFromGroup","GridController.swift",1650);var f=this.gridStyle.cellIndex(t);if(this.updateCellRegion(t,m,h,!1),l.CoreAssert.isTrue(null!=f,void 0,"GridController.removeFormaFromGroup","GridController.swift",1656),null!=f){for(var g=this.gridStyle.gridCells[f],p=a.iter(this.formaeForCell(g));!p.done;p.next()){var s=p.value;a.opt(this.gridStyle,(function(e){return e.removeMappingToForma(s)}))}this.gridStyle.removeCell(g)}this.gridStyle.removeCell(t),this.gridStyle.name=S.GridStyle.CUSTOM_LAYOUT_NAME}else if(1==c){var v;null!=(v=a.opt(a.opt(this.forma,(function(e){return e.root})),(function(e){return e.style.colors.colorID(d.ColorRole.FieldPrimary)})))&&(this.gridStyle.updateCellByIndex(0,null,v,null),this.margin=0)}else l.CoreAssert.fail("Should have at least one background cell. Something is wrong.","GridController.removeFormaFromGroup","GridController.swift",1675)}this.layoutGrid(!1)}this.preUpdateMapping_=a.clone(this.formaMappingDeepCopy)}1==this.gridStyle.gridCells.length&&this.gridStyle.gridCells[0].bounds.equalWithAccuracy(L.TheoRect.ONE_BY_ONE,.01)&&(this.gridStyle.name=S.GridStyle.SINGLE_LAYOUT_NAME)},canRemoveFromHandleDirection:function(e,t){for(var r=a.iter(this.gridCells);!r.done;r.next()){var o=r.value;if(!a.eq(F._equality_GridCell_GridCell,o,e)&&0==e.bounds.L1Distance(o.bounds)){var n=e.bounds.unionWith(o.bounds);if(t==F.GridCellHandle.Left&&e.bounds.minX==o.bounds.maxX&&n.height!=e.bounds.height)return!1;if(t==F.GridCellHandle.Right&&e.bounds.maxX==o.bounds.minX&&n.height!=e.bounds.height)return!1;if(t==F.GridCellHandle.Bottom&&e.bounds.minY==o.bounds.maxY&&n.width!=e.bounds.width)return!1;if(t==F.GridCellHandle.Top&&e.bounds.maxY==o.bounds.minY&&n.width!=e.bounds.width)return!1}}return!0},setupWithFormae:function(e){var t;if(t=a.as(this.forma,b.GroupForma)){t.removeAllChildren();for(var r=a.iter(e);!r.done;r.next()){var o=r.value;t.appendChild(o)}this.recreateGrid()}},inferGridCellAssignment:function(e){void 0===e&&(e=null);var t,r=null!=e?e:a.opt(this.forma,(function(e){return e.bounds}));if(t=r)for(var o=a.iter(this.moveableFormae());!o.done;o.next()){for(var n=o.value,i=null,l=a.iter(this.gridCells);!l.done;l.next()){var s,u,c=l.value,d=this.getCellRegion(c,t);(s=a.opt(n.frame,(function(e){return e.intersectionWith(r)})))&&(u=d.intersectionWith(s))&&u.area/s.area>.85&&(i=c,this.gridStyle.mapCellToForma(n,c))}null==i&&null!=this.formaMapping[n.formaID]&&this.gridStyle.removeMappingToForma(n)}},backgroundImagesForCell:function(e){for(var t=a.clone(this.forma.visitAsArray(h.FormaTraversal.JustChildren)),r=[],o=a.iter(t);!o.done;o.next()){var n=o.value;a.eq(F._equality_GridCell_GridCell,this.formaMapping[n.formaID],e)&&n.isBackgroundImage()&&r.push(n)}return r},addFormaToGroupWithCurrentImage:function(e){var t,r;if(l.CoreAssert.isTrue(null!=this.gridStyle.forma,void 0,"GridController.addFormaToGroupWithCurrentImage","GridController.swift",1801),(t=a.as(this.forma,b.GroupForma))&&(r=e.finalFrame)){t.appendChild(e);var o=a.clone(this.backgroundGridCells);if(0==o.length)return void l.CoreAssert.fail("ERROR: no background cells!","GridController.addFormaToGroupWithCurrentImage","GridController.swift",1811);for(var n=o[0],i=a.iter(o);!i.done;i.next()){var s,u=i.value;if(s=this.getCellRegion(u).intersectionWith(r)){var c=this.getCellRegion(n).intersectionWith(r);(null==c||c.area<s.area)&&(n=u)}}this.gridStyle.mapCellToForma(e,n),this.splitCellsWithMultipleBackgroundImages(e),this.layoutGrid(!1)}},addFormaToGroup:function(e){var t,r,o=this;if(l.CoreAssert.isTrue(null!=this.gridStyle.forma,void 0,"GridController.addFormaToGroup","GridController.swift",1843),(t=a.as(this.forma,b.GroupForma))&&(r=e.finalFrame)){t.appendChild(e);var i=e.isImage()&&!e.controller.floating,s=null,u=null;if(this.owner.selection.forEachSelected((function(e){n.isBackgroundColoredCell(e)&&e.parent==o.forma&&(s=o.cellForForma(e),u=e)})),null!=u&&this.owner.selection.deselectForma(u),null==s)for(var c=!1,d=a.iter(this.backgroundGridCells);!d.done;d.next()){for(var m,f=d.value,g=0!=this.backgroundImagesForCell(f).length,p=a.clone(this.forma.visitAsArray(h.FormaTraversal.JustChildren)),v=a.iter(p);!v.done;v.next()){var C=v.value;a.eq(F._equality_GridCell_GridCell,this.formaMapping[C.formaID],f)&&C.isBackgroundImage()&&(g=!0)}if(g)g==i&&(null==s||s.bounds.area<f.bounds.area&&!c)&&(s=f);else if(null!=s&&c){if(m=this.getCellRegion(f).intersectionWith(r)){var y=this.getCellRegion(s).intersectionWith(r);(null==y||y.area<m.area)&&(s=f)}}else c=!0,s=f}this.gridStyle.mapCellToForma(e,null!=s?s:this.gridCells[0]),this.splitCellsWithMultipleBackgroundImages(e),this.layoutGrid(!1)}},createBasicGrid:function(){var e=this.gridCells[0].colorID,t=[new F.GridCell(new L.TheoRect(0,0,1,1),e)];this.gridStyle.setGridCells(a.clone(t));for(var r=a.iter(this.forma.visitAsArray(h.FormaTraversal.JustChildren));!r.done;r.next()){var o=r.value;o.isBackgroundImage()&&this.gridStyle.mapCellToForma(o,this.gridCells[0])}this.splitCellsWithMultipleBackgroundImages(null)},splitCellsWithMultipleBackgroundImages:function(e){var t;if((t=a.as(this.forma,b.GroupForma))&&t.bounds){for(var r=a.clone(t.visitAsArray(h.FormaTraversal.JustChildren)),o=[],n=a.iter(this.backgroundGridCells);!n.done;n.next()){for(var i=n.value,l=[],s=0,u=a.iter(r);!u.done;u.next()){var c=u.value;a.eq(F._equality_GridCell_GridCell,this.formaMapping[c.formaID],i)&&c.isBackgroundImage()&&(s+=1,l.push(c))}if(a.sortInPlace(l,(function(e,t){return e.finalFrame.center.distanceTo(N.TheoPoint.ZERO)<t.finalFrame.center.distanceTo(N.TheoPoint.ZERO)})),s>1){a.opt(this.gridStyle,(function(e){return e.name=S.GridStyle.CUSTOM_LAYOUT_NAME}));var d=a.indexOfEq(this.gridCells,i,F._equality_GridCell_GridCell),m=this.getCellRegion(i),f=m.width,g=m.height,v=i.bounds,C=f/g>=1;C?f/=a.toDouble(s):g/=a.toDouble(s);var y=s%2==0&&s>2;if(y){var I=Math.max(f/g,g/f),D=f,T=g;C?(D=m.width/a.toDouble(a.toInt(s/2)),T=m.height/2):(D=m.width/2,T=m.height/a.toDouble(a.toInt(s/2))),Math.max(D/T,T/D)<I?(f=D,g=T):y=!1}for(var P=a.toInt(m.width/f),x=a.toInt(m.height/g),_=0,G=a.repeat(a.repeat(1,x),P),k=a.iter(a.range(0,P,!1));!k.done;k.next())for(var R=k.value,w=a.iter(a.range(0,x,!1));!w.done;w.next()){var A,E,B,Y=w.value,U=m.aspectRatio;a.eq(h._equality_Forma_Forma,l[_],e)&&(A=a.as(l[_],p.FrameForma))&&(E=M.ImageFacade.getImageFormaForForma(A))&&(B=E.bounds)&&(U=B.aspectRatio),G[R][Y]=C?U:1/U,_+=1}if(_=0,y)for(var O=a.toDouble(i.bounds.width)/a.toDouble(P),z=a.toDouble(i.bounds.height)/a.toDouble(x),X=a.iter(a.range(0,P,!1));!X.done;X.next()){R=X.value;for(var H=a.iter(a.range(0,x,!1));!H.done;H.next()){Y=H.value;var W=new L.TheoRect(v.minX+a.toDouble(R)*O,v.minY+a.toDouble(Y)*z,v.minX+a.toDouble(R+1)*O,v.minY+a.toDouble(Y+1)*z),q=new F.GridCell(W,i.colorID);this.gridStyle.insertCell(q,d),this.gridStyle.mapCellToForma(l[_],q),_+=1}}else for(var K=[],V=[],j=[],Z=[],J=a.iter(a.range(0,P,!1));!J.done;J.next()){R=J.value,K=a.clone(G[R]),Z=a.clone(m.split(G[R].length,C,a.clone(K)));for(var Q=a.iter(a.range(0,x,!1));!Q.done;Q.next()){if(Y=Q.value,P>0&&0==Y){V.splice(0);for(var $=a.iter(a.range(0,P,!1));!$.done;$.next()){var ee=$.value;V.push(G[ee][Y])}j=a.clone(m.split(V.length,C,a.clone(V)))}if(Z.length>1){var te=m.locatePoint(Z[Y].evalXY(0,0)),re=m.locatePoint(Z[Y].evalXY(1,1));W=v.evalUUVV(te.x,re.x,te.y,re.y),q=new F.GridCell(W,i.colorID),this.gridStyle.insertCell(q,d),this.gridStyle.mapCellToForma(l[_],q),_+=1}}j.length>1&&(te=m.locatePoint(j[R].evalXY(0,0)),re=m.locatePoint(j[R].evalXY(1,1)),W=v.evalUUVV(te.x,re.x,te.y,re.y),q=new F.GridCell(W,i.colorID),this.gridStyle.insertCell(q,d),this.gridStyle.mapCellToForma(l[_],q),_+=1)}o.push(i)}}for(var oe=a.iter(o);!oe.done;oe.next())i=oe.value,this.gridStyle.removeCell(i)}},shouldRecreateGrid:function(e){var t;if((t=a.opt(this.forma,(function(e){return e.root})))&&t.isModel)return!1;if(this.gridStyle.anyOverlap)return!1;var r,o,n=this.gridCells.length;if(1==n)return!1;if(n>4)return!1;if((r=a.as(this.forma,b.GroupForma))&&(o=r.bounds)){if(o.similarity(e)<.1)return!1;var i=!1,l=o.aspectRatio>1?o.width/a.toDouble(n)/o.height:o.height/a.toDouble(n)/o.width;if(l=Math.max(l,1/l),n%2==0){var s=0,u=0;o.aspectRatio>1?(s=o.width/a.toDouble(a.toInt(n/2)),u=o.height/2):(s=o.width/2,u=o.height/a.toDouble(a.toInt(n/2)));var c=Math.max(s/u,u/s);c<l&&(l=c)}for(var d=a.iter(this.gridCells);!d.done;d.next()){var m=d.value,h=e.evalRect(m.bounds).aspectRatio;h=Math.max(h,1/h);var f=o.evalRect(m.bounds).aspectRatio;(f=Math.max(f,1/f))-h>=2&&f-l>=1&&(i=!0)}return i}return!1},recreateGrid:function(e,t,r){void 0===e&&(e=!0),void 0===t&&(t=null),void 0===r&&(r=!0),this.assertCorrectLayout();var o=this.forma.filterWithCallback((function(e){return e.kind==T.ImageForma.KIND&&e.parent.isBackgroundImage()})).length,n=null!=t?t:Math.max(o,this.gridCells.length),i=a.clone(this.owner.document.gridLibrary.getGridsByCellNumber(n,!1));if(n==this.gridCells.length){var s=a.opt(this.gridStyle,(function(e){return e.clone()}));i.push(s.flipRegion())}for(var u=this.spacing,c=[],d=a.iter(i);!d.done;d.next()){var m=d.value;m.moveableShift=e;var h=a.clone(r?this.formaMappingSwiftDict:null);a.append(c,new I.GridSuggester(this.forma,m,a.clone(h)).createSuggestions())}if(c.length>0){a.sortInPlace(c,(function(e,t){return e.score>t.score}));var f=c[0];l.CoreAssert.isTrue(f.gridStyle.moveableShift==e,"moveable shift failing","GridController.recreateGrid","GridController.swift",2275),f.gridStyle.spacing=u,this.applyGridStyleWithMapping(f.gridStyle,!0)}else this.createBasicGrid()},childUpdate:function(e){var t;if(void 0===e&&(e=null),this.updatedChild=e,null!=e&&null==this.dragShapeInitBounds_&&this.isGridCell(e)&&(t=e)){this.owner.interactionMode!=m.InteractionMode.AutomaticGrid&&this.updateGridAssignments(),this.updateGridColors();var r=this.cellForForma(t);if(null==r)return void l.CoreAssert.warning("Couldn't match cell");var o=this.updatedCellBounds(t,r,!1),n=null;if(_.MathUtils.absDouble(r.bounds.minX-o.minX)>.001?n=F.GridCellHandle.Left:_.MathUtils.absDouble(r.bounds.maxX-o.maxX)>.001?n=F.GridCellHandle.Right:_.MathUtils.absDouble(r.bounds.minY-o.minY)>.001?n=F.GridCellHandle.Top:_.MathUtils.absDouble(r.bounds.maxY-o.maxY)>.001&&(n=F.GridCellHandle.Bottom),null!=n){o=this.updatedCellBounds(t,r,!0),this.updateCellRegion(r,o,n,!0);var i=null;this.owner.interactionMode==m.InteractionMode.AutomaticGrid&&(0==a.count(this.moveableInitState_)&&this.setInitialFormaSizes(),this.resetMoveableFormaToInitialSizes(),i=a.clone(this.preUpdateMapping_)),this.resetImageFormaToInitialPlacement(),this.layoutGrid(this.owner.interactionMode==m.InteractionMode.AutomaticGrid,null,a.clone(i))}}},getAdjustedSpacingsForCell:function(e,t){var r=a.clone(this.backgroundGridCells),o=a.clone(this.filterCellsByDirection(e,a.clone(r),"horizontal")),n=a.clone(this.filterCellsByDirection(e,a.clone(r),"vertical"));o=a.sort(o,(function(e,t){return e.bounds.minX<t.bounds.minX})),n=a.sort(n,(function(e,t){return e.bounds.minY<t.bounds.minY})),o=a.clone(this.removeOverlapCells(a.clone(o),"horizontal")),n=a.clone(this.removeOverlapCells(a.clone(n),"vertical"));for(var i=-1,l=-1,s=a.iter(a.range(0,o.length,!1));!s.done;s.next())if(o[c=s.value].bounds.equalWithAccuracy(e.bounds,F.GridCell.BOUNDS_ACCURACY)){i=c;break}for(var u=a.iter(a.range(0,n.length,!1));!u.done;u.next()){var c;if(n[c=u.value].bounds.equalWithAccuracy(e.bounds,F.GridCell.BOUNDS_ACCURACY)){l=c;break}}var d=t,m=t,h=t,f=t,g=o.length,p=a.toDouble(g-1)/a.toDouble(g);0==i&&(d=0,g>2?m*=p:m/=2),i==g-1&&(m=0,g>2?d*=p:d/=2),g>2&&0!=i&&i!=g-1&&(1==i&&i==g-2?(d*=1-p,m*=1-p):1==i?(d*=1-p,m/=2):i==g-2?(m*=1-p,d/=2):(d/=2,m/=2));var v=n.length,C=a.toDouble(v-1)/a.toDouble(v);return 0==l&&(h=0,v>2?f*=C:f/=2),l==v-1&&(f=0,v>2?h*=C:h/=2),v>2&&0!=l&&l!=v-1&&(1==l&&l==v-2?(h*=1-C,f*=1-C):1==l?(h*=1-C,f/=2):l==v-2?(f*=1-C,h/=2):(h/=2,f/=2)),[d,m,h,f]},updatedCellBounds:function(e,t,r){var o=this.forma.finalFrame,n=r?e.finalFrame.intersectionWith(o):e.finalFrame,i=a.clone(this.gridStyle.overlappingCells()),l=a.containsEq(i,t,F._equality_GridCell_GridCell)?0:this.gridStyle.spacing,s=a.clone(this.getAdjustedSpacingsForCell(t,l)),u=s[0],c=s[1],d=s[2],m=s[3],h=new L.TheoRect(n.minX-u,n.minY-d,n.maxX+c,n.maxY+m);return new L.TheoRect((h.minX-o.minX)/o.width,(h.minY-o.minY)/o.height,(h.maxX-o.minX)/o.width,(h.maxY-o.minY)/o.height)},updateCellRegion:function(e,t,r,o){if(void 0===o&&(o=!0),null!=a.as(this.forma,b.GroupForma)){var i=e.bounds,l=null,s=null,u=null;r==F.GridCellHandle.Left?(l=i.verticalLine(0),s=t.minX):r==F.GridCellHandle.Right?(l=i.verticalLine(1),s=t.maxX):r==F.GridCellHandle.Top?(l=i.horizontalLine(0),u=t.minY):r==F.GridCellHandle.Bottom&&(l=i.horizontalLine(1),u=t.maxY);var c=this.getCellRegion(e,null,t);if(o&&Math.min(c.width,c.height)<n.MIN_CELL_DIM)return a.opt(D.Host.logging,(function(e){return e.info("new cell too small")})),!1;if(null!=s&&(s<0||s>1)||null!=u&&(u<0||u>1))return a.opt(D.Host.logging,(function(e){return e.info("shifted out of bounds  "+i.asString+" -> "+t.asString)})),!1;var d=[],m=[];if(d.push({cell:e,bounds:t}),m.push({cell:e,bounds:e.bounds}),null!=l&&a.containsEq(this.backgroundGridCells,e,F._equality_GridCell_GridCell))for(var h=a.iter(this.gridCells);!h.done;h.next()){var f=h.value;if(!a.eq(F._equality_GridCell_GridCell,f,e)){var g=f.bounds,p=g,v=l.projectionOffset(f.handlePosition(F.GridCellHandle.Left)).length(),C=l.projectionOffset(f.handlePosition(F.GridCellHandle.Right)).length(),y=l.projectionOffset(f.handlePosition(F.GridCellHandle.Top)).length(),I=l.projectionOffset(f.handlePosition(F.GridCellHandle.Bottom)).length();if(null!=s&&(v<C&&v<.02?p=new L.TheoRect(s,g.minY,g.maxX,g.maxY):v>C&&C<.02&&(p=new L.TheoRect(g.minX,g.minY,s,g.maxY))),null!=u&&(I<y&&I<.02?p=new L.TheoRect(g.minX,g.minY,g.maxX,u):I>y&&y<.02&&(p=new L.TheoRect(g.minX,u,g.maxX,g.maxY))),g.minX!=p.minX&&g.maxX!=p.maxX||g.minY!=p.minY&&g.maxY!=p.maxY)return!1;if(c=this.getCellRegion(f,null,p),p.minX<0||p.minY<0||p.maxX>1||p.maxY,o&&Math.min(c.width,c.height)<n.MIN_CELL_DIM)return!1;d.push({cell:f,bounds:p}),m.push({cell:f,bounds:f.bounds})}}for(var S=a.clone(this.gridStyle.nonOverlappingCells()),T=a.iter(d);!T.done;T.next()){var M=T.value;this.gridStyle.updateCell(M.cell,M.bounds)}for(var P=a.iter(S);!P.done;P.next()){if(f=P.value,!this.gridBounds_.contains(f.bounds))return a.opt(D.Host.logging,(function(e){return e.info("out of bounds "+f.bounds)})),!1;f.bounds.area}if(this.gridStyle.nonOverlappingCells().length!=S.length){for(var x=a.iter(this.gridCells);!x.done;x.next())f=x.value,a.opt(D.Host.logging,(function(e){return e.info("gridCell "+f.bounds.asString)}));for(var _=a.iter(m);!_.done;_.next())M=_.value,this.gridStyle.updateCell(M.cell,M.bounds);return!1}return!0}return!1},inferBackgroundCellAssignment:function(){for(var e=a.iter(this.gridCells);!e.done;e.next())for(var t=e.value,r=this.getCellRegion(t),o=a.iter(this.forma.visitAsArray(h.FormaTraversal.JustChildren));!o.done;o.next()){var n,i=o.value;(n=i.finalFrame)&&n.equalWithAccuracy(r,.01)&&(i.controller.moveable&&i.kind!=w.ShapeForma.KIND||this.gridStyle.mapCellToForma(i,t))}},backgroundShapeFormaForCell:function(e,t){void 0===t&&(t=null);for(var r=a.clone(null!=t?t:this.formaMappingSwiftDict),o=a.iter(r);!o.done;o.next()){var n,i=o.key,l=o.value;if(a.eq(F._equality_GridCell_GridCell,l,e)&&(n=this.forma.formaByID(i))&&n.kind==w.ShapeForma.KIND&&this.isGridCell(n))return a.as(n,w.ShapeForma)}return null},isGridCell:function(e){if(e.hasIntent(h.Forma.INTENT_GRID_CELL))return!0;if(a.opt(e.controller,(function(e){return 1==e.floating})))return!1;if(e.hasIntent(h.Forma.INTENT_ICON)||e.hasIntent(h.Forma.INTENT_FLOATING_SHAPE)||e.hasIntent(h.Forma.INTENT_LOGO)||e.hasIntent(h.Forma.INTENT_FLOATING_IMAGE))return!1;if(e.parent==this.forma&&(e.isShape()||e.isImage())){var t,r;if((t=a.as(e,w.ShapeForma))&&null==t.contentNode)return!0;if(e.isBackgroundImage())return!0;if(r=e.finalFrame)for(var o=a.iter(this.gridCells);!o.done;o.next()){var n=o.value;if(this.getCellRegion(n).equalWithAccuracy(r,.1))return!0}if(e.kind==b.GroupForma.KIND)return!1;if(null==a.opt(a.as(e,w.ShapeForma),(function(e){return e.contentNode}))&&e.isShape())return!0}return!1},childMoveableInDirection:function(e,t){if(e.isShape()||e.isImage()){var r,o,n;if((r=this.cellForForma(e))&&a.containsEq(this.foregroundGridCells,r,F._equality_GridCell_GridCell)&&(o=e.finalFrame)&&(n=a.opt(this.forma,(function(e){return e.finalFrame})))){if(Math.abs(o.width-n.width)<2&&t.x>0)return!1;if(Math.abs(o.height-n.height)<2&&t.y>0)return!1}return null==e.allowUserMove||e.allowUserMove}return!0},formaeForCell:function(e){for(var t=[],r=a.iter(this.formaMappingSwiftDict);!r.done;r.next()){var o,n=r.key,i=r.value;a.eq(F._equality_GridCell_GridCell,i,e)&&(o=this.forma.formaByID(n))&&t.push(o)}return t},cellForForma:function(e){var t;return null!=(t=a.opt(this.gridStyle,(function(t){return t.cellForForma(e)})))?t[1]:null},updateGridAssignments:function(){this.forma.bounds;for(var e=a.clone(this.forma.visitAsArray(h.FormaTraversal.JustChildren)),t=a.iter(this.gridCells);!t.done;t.next())for(var r=t.value,o=this.getCellRegion(r),n=a.containsEq(this.foregroundGridCells,r,F._equality_GridCell_GridCell),i=a.iter(e);!i.done;i.next()){var l,s,u=i.value;n&&u.isBackgroundImage()||(l=u.finalFrame)&&(s=l.intersectionWith(o))&&s.area/Math.max(o.area,l.area)>.9&&this.gridStyle.mapCellToForma(u,r)}},beginUpdateGroup:function(e){void 0===e&&(e=null),C.GroupController.prototype.beginUpdateGroup.call(this,e),this.inferGridCellAssignment()},updateGroup:function(){if(!this.blockUpdate){var e=!1,t=null,r=null;if(null!=this.oldBounds){t=a.clone(this.formaMappingSwiftDict),this.beginBlockedUpdate();var o=this.margin,n=this.maxMargin;r=this.spacing,this.updateGridColors(),this.inferGridCellAssignment(this.oldBounds);for(var i=a.iter(this.moveableFormae());!i.done;i.next()){var l=i.value;(null==this.formaMapping[l.formaID]||this.formaMapping[l.formaID].bounds.equalWithAccuracy(L.TheoRect.ONE_BY_ONE,F.GridCell.BOUNDS_ACCURACY))&&(e=!0)}if(e)for(var s=a.iter(this.moveableFormae());!s.done;s.next())l=s.value,this.gridStyle.removeMappingToFormaID(l.formaID);!e&&this.shouldRecreateGrid(this.oldBounds)&&this.owner.interactionMode==m.InteractionMode.AutomaticGrid&&this.recreateGrid(),Math.abs(o-n)<50&&(this.margin=.1,this.margin=o),this.endBlockedUpdate()}var u=this.gridStyle.cropType;if(1==this.gridStyle.numBackgroundCells&&"Original"==this.gridForma.page.sizeID){var c,d=a.clone(this.forma.filterWithCallback((function(e){return null!=e.parent&&e.parent.isBackgroundImage()&&e.kind==T.ImageForma.KIND})));1==d.length&&(c=a.as(d[0],T.ImageForma))&&c.bounds.size.similarity(this.gridForma.page.pageSize)<.001&&(this.gridStyle.cropType=f.CropType.FitBorder)}if(this.layoutGrid(this.gridStyle.moveableShift,this.oldBounds,a.clone(t),r),this.gridStyle.cropType=u,null!=this.oldBounds&&(this.setInitialFormaSizes(),e&&null!=t))for(var h=a.iter(t);!h.done;h.next()){var g=h.key,p=h.value;this.gridStyle.mapCellToFormaID(g,p)}}},colorGrid:function(e,t){for(var r=a.sort(e,(function(e,t){return e.bounds.minY<t.bounds.minY||!(e.bounds.minY>t.bounds.minY)&&e.bounds.minX<t.bounds.minX})),o=[],n=a.iter(r);!n.done;n.next())null!=(y=n.value).colorID&&null!=this.backgroundShapeFormaForCell(y,a.clone(t))&&o.push(y.colorID);var i,s=this.isBackgroundVisible(),u=this.forma.root.style.colors.colorID(d.ColorRole.FieldPrimary);0!=o.length||s||null!=(i=u)&&o.push(i);for(var c=a.iter(this.forma.page.colorLibraryController.getThemeColorKeys());!c.done;c.next()){var m=c.value;o.includes(m)||s&&m==u||o.push(m)}for(var h=a.clone(this.gridCells),g=a.sort(h,(function(e,t){return e.bounds.center.distanceTo(N.TheoPoint.ZERO)<t.bounds.center.distanceTo(N.TheoPoint.ZERO)})),p=a.iter(this.formaMappingSwiftDict);!p.done;p.next()){var v,C=p.key,y=p.value,b=this.forma.formaByID(C);if(null!=b&&b.isBackgroundImage())(v=a.as(b.controller,f.FrameController))&&(v.isBackgroundImageWithAlpha()||null!=(D=a.indexOfEq(g,y,F._equality_GridCell_GridCell))&&g.splice(D,1));else if(a.opt(a.opt(b,(function(e){return e.controller})),(function(e){return e.kind==B.TypeLockupController.KIND}))){var I;if((I=a.as(a.opt(b,(function(e){return e.controller})),B.TypeLockupController))&&(a.opt(I.lockupStyle,(function(e){return e.backing==P.LockupBacking.Banner}))||a.opt(I.lockupStyle,(function(e){return e.backing==P.LockupBacking.BannerHorizontal}))||a.opt(I.lockupStyle,(function(e){return e.backing==P.LockupBacking.BannerVertical}))||a.opt(I.lockupStyle,(function(e){return e.backing==P.LockupBacking.Knockout})))){var S,D,T,M=a.opt(b,(function(e){return e.style.colors.colorID(d.ColorRole.FieldSecondary)}));(S=this.gridStyle.updateCell(y,null,M,null))&&(null!=(D=a.indexOfEq(g,y,F._equality_GridCell_GridCell))&&g.splice(D,1),null!=(T=a.indexOf(o,S.colorID))&&o.push(o.splice(T,1)))}}}for(var x=[],_=0,G=a.iter(g);!G.done;G.next()){y=G.value;for(var k=!1,R=a.iter(this.formaeForCell(y));!R.done;R.next()){var w,A;(w=t[R.value.formaID])&&null!=(A=w.colorID)&&o.includes(A)&&(k=!0,this.gridStyle.updateCell(y,null,A,null),o.length>g.length&&a.remove(o,A))}k||x.push(y)}if(0==o.length)l.CoreAssert.fail("ERROR: incorrectly removed all background colors.","GridController.colorGrid","GridController.swift",3157);else for(var E=a.iter(x);!E.done;E.next())y=E.value,this.gridStyle.updateCell(y,null,o[_%o.length],null),_+=1},updateGridColors:function(){if(!this.blockUpdate)for(var e=a.iter(this.gridCells);!e.done;e.next()){var t,r=e.value;(t=this.backgroundShapeFormaForCell(r))&&(r.colorID==t.style.colors.colorID(d.ColorRole.FieldPrimary)&&r.opacity==t.style.opacity||this.gridStyle.updateCell(r,null,t.style.colors.colorID(d.ColorRole.FieldPrimary),t.style.opacity))}},getCellsSortedByRow:function(){return a.sort(this.gridCells,(function(e,t){return e.bounds.minY<t.bounds.minY||!(e.bounds.minY>t.bounds.minY)&&e.bounds.minX<t.bounds.minX}))},getCellsSortedByColumn:function(){return a.sort(this.gridCells,(function(e,t){return e.bounds.minX<t.bounds.minX||!(e.bounds.minX>t.bounds.minX)&&e.bounds.minY<t.bounds.minY}))},getContrastingColorForCell:function(e){var t=this.cellForForma(e);if(null!=t){var r=this.forma.page.colorLibraryController,o=[];this.isBackgroundVisible()&&null!=(i=a.opt(e.root,(function(e){return e.style.colors.colorID(d.ColorRole.FieldPrimary)})))&&(s=r.getSolidColorForKey(i))&&o.push(s);for(var n=a.iter(this.gridCells);!n.done;n.next()){var i,s,u=n.value;!a.eq(F._equality_GridCell_GridCell,t,u)&&t.mergeableWith(u)&&null!=(i=u.colorID)&&(s=r.getSolidColorForKey(i))&&o.push(s)}var c=a.clone(this.getContrastingThemeColorsInRandomOrder(a.clone(o)));if(c.length>0)return r.getTheoColorForKey(c[0]);l.CoreAssert.fail("failed in getContrastingColorForCell to get a color. we should never get here...","GridController.getContrastingColorForCell","GridController.swift",3273)}return null},getContrastingThemeColorsInRandomOrder:function(e){for(var t=a.clone(e),r=this.forma.page.colorLibraryController,o=r.getThemeColorKeys().concat(),n=[];o.length>0;){var i=u.CoreRandom.nextIntUniform(o.length),l=o[i];o.splice(i,1);for(var s=!1,c=a.iter(t);!c.done;c.next()){var d,m=c.value;(d=r.getSolidColorForKey(l))&&d.distanceTo(m)<23&&(s=!0)}s||(n.push(l),t.push(r.getSolidColorForKey(l)))}return n.length<2&&(n=r.getThemeColorKeys().concat()),n},buildCellColorGroups:function(){for(var e=a.clone(this.getCellsSortedByRow()),t={},r=a.iter(e);!r.done;r.next()){var o,n=r.value;if(o=this.backgroundShapeFormaForCell(n)){for(var i=o.formaID,l=!1,s=a.iter(a.keys(t));!s.done;s.next()){var u=s.value;(new G.ProfilingColorMap).checkIfTwoFormaAreInSamePaletteMappingGroup(u,i)&&(t[u].push(n),l=!0)}l||(t[i]=[n])}}return t},shuffleColorAssignment:function(){var e=a.clone(this.buildCellColorGroups()),t=this.forma.page.colorLibraryController,r=[];if(this.isBackgroundVisible()){var o=this.forma.root.style.colors.colorID(d.ColorRole.FieldPrimary);r.push(t.getSolidColorForKey(o))}for(var n=a.clone(this.getContrastingThemeColorsInRandomOrder(a.clone(r))),i=0,l=a.iter(e);!l.done;l.next()){for(var s=l.value,u=a.iter(s);!u.done;u.next()){var c,m,h=u.value;if((c=this.gridStyle.updateCell(h,null,n[i%n.length],null))&&(m=this.backgroundShapeFormaForCell(c))){var f=(new G.ProfilingColorMap).overridePaletteMappingDueToContrast(c.colorID,m.formaID);m.style.colors.setColorId(d.ColorRole.FieldPrimary,f)}}i+=1}},getCellIdsGroupedByColor:function(){for(var e=a.clone(this.getCellsSortedByRow()),t={},r=a.iter(e);!r.done;r.next()){var o,n,i,l,s=r.value,u=null;if((o=this.backgroundShapeFormaForCell(s))&&(u=o.formaID),(n=this.forma)&&null!=(i=s.colorID)&&(l=n.page.colorLibraryController.getSolidColorForKey(i))){for(var d=l.rgbString,m=!1,h=a.iter(a.keys(t));!h.done;h.next()){var f=h.value;c.ColorSelectorUtils.compareTwoColorStringsWithMargin(f,d)&&null!=u&&(t[f].push(u),m=!0)}m||null==u||(t[d]=[u])}}return t},moveableFormae:function(){for(var e=[],t=a.iter(this.forma.visitAsArray(h.FormaTraversal.JustChildren));!t.done;t.next()){var r=t.value;!r.controller.floating||!r.controller.moveable||r instanceof T.ImageForma||this.isGridCell(r)||e.push(r)}return a.sortInPlace(e,(function(e,t){return e.finalFrame.center.distanceTo(N.TheoPoint.ZERO)<t.finalFrame.center.distanceTo(N.TheoPoint.ZERO)})),e},removeOverlapCells:function(e,t){l.CoreAssert.isTrue(["vertical","horizontal"].includes(t),void 0,"GridController.removeOverlapCells","GridController.swift",3431);for(var r=[],o=a.iter(a.range(0,e.length,!1));!o.done;o.next()){var n=e[o.value];if(r.length>0){var i=r[r.length-1];"horizontal"==t?a.toDouble(Math.round(1e3*Math.max(n.bounds.minX,i.bounds.minX))/1e3)<a.toDouble(Math.round(1e3*Math.min(n.bounds.maxX,i.bounds.maxX))/1e3)||r.push(n):"vertical"==t&&(a.toDouble(Math.round(1e3*Math.max(n.bounds.minY,i.bounds.minY))/1e3)<a.toDouble(Math.round(1e3*Math.min(n.bounds.maxY,i.bounds.maxY))/1e3)||r.push(n))}else r.push(n)}return r},getCellRegion:function(e,t,r,o){void 0===t&&(t=null),void 0===r&&(r=null),void 0===o&&(o=null);var n=null!=t?t:this.forma.bounds,i=null!=r?r:e.bounds,l=n.evalRect(i).transform(this.forma.totalPlacement).rounded();if(a.containsEq(this.foregroundGridCells,e,F._equality_GridCell_GridCell))return l;var s=null!=o?o:this.gridStyle.spacing,u=a.clone(this.getAdjustedSpacingsForCell(e,s)),c=u[0],d=u[1],m=u[2],h=u[3];return new L.TheoRect(l.minX+c,l.minY+m,l.maxX-d,l.maxY-h).rounded()},updateHierarchy:function(){for(var e=a.iter(a.keys(this.formaMapping));!e.done;e.next()){var t,r=e.value;(t=a.opt(a.opt(this.forma,(function(e){return e.root})),(function(e){return e.formaByID(r)})))&&(t.parent==this.forma||t.parent.hasIntent(h.Forma.INTENT_INFERRED_TEMP_GROUP)||(t instanceof T.ImageForma?l.CoreAssert.fail("shouldn't have a mapping to an image ","GridController.updateHierarchy","GridController.swift",3488):this.gridForma.appendChild(t,!0)))}},layoutGrid:function(e,t,r,o){void 0===t&&(t=null),void 0===r&&(r=null),void 0===o&&(o=null);var n,i=this;if(!this.blockUpdate&&null!=this.forma.bounds){var l=new v.FormaGeometryChangedEvent(this.forma);this.forma.beginUpdate(l);var s=a.clone(this.moveableFormae()),u=a.clone(y.GroupDetector.detectProximityGroups(a.clone(s))),c=[];if(e&&this.owner.interactionMode!=m.InteractionMode.DefaultInteraction)for(var g=a.iter(a.range(0,this.gridCells.length,!1));!g.done;g.next()){for(var C=g.value,b=this.gridCells[C],I=this.getCellRegion(b),S=[],D=a.iter(this.formaeForCell(b));!D.done;D.next()){var T=D.value;a.containsEq(s,T,h._equality_Forma_Forma)&&S.push(T)}S.length>0&&(c=c.concat(S),this.evaluateCellAndSplit(a.clone(S),a.clone(u),I,t,a.clone(r),o))}if(null!=t&&c.length<s.length){for(var M=[],x=a.iter(s);!x.done;x.next())T=x.value,a.containsEq(c,T,h._equality_Forma_Forma)||M.push(T);this.moveFormaeToCell(a.clone(M),this.forma.frame,t,a.clone(r),o)}var _=a.clone(this.forma.filterWithCallback((function(e){return i.isGridCell(e)&&e.isShape()}),h.FormaTraversal.JustChildren));this.checkFramesForCropping_=[];for(var G=0,k=a.iter(a.range(0,this.gridCells.length,!1));!k.done;k.next()){C=k.value,b=this.gridCells[C],I=this.getCellRegion(b);for(var E=!1,N=[],Y=a.iter(this.formaeForCell(b));!Y.done;Y.next()){var U,O=Y.value;O.isBackgroundImage()&&(N.push(O),((n=a.opt(a.as(O,p.FrameForma),(function(e){return e.hasAlpha()})))||null!=n)&&n||(E=!0),O.frame.area>2*I.area&&this.checkFramesForCropping_.push(O),(U=a.as(O.controller,f.FrameController))&&U.fitWithCrop(I,this.gridStyle.cropType),O.intent=h.Forma.INTENT_GRID_CELL)}if(!E){var z;if(null==(j=this.backgroundShapeFormaForCell(b))?(j=a.as(this.forma.page.createFormaWithController(w.ShapeForma.KIND,R.ShapeController.KIND),w.ShapeForma),A.ShapeLibrary.applyToShapeForma(j,A.ShapeLibrary.Square)):a.remove(_,j),this.gridStyle.mapCellToForma(j,b),null==b.colorID){var X,H=this.forma.page.colorLibraryController.getThemeColorKeys()[0];b.bounds.equal(L.TheoRect.ONE_BY_ONE)&&null!=(X=a.opt(a.opt(this.forma,(function(e){return e.root})),(function(e){return e.style.colors.colorID(d.ColorRole.FieldPrimary)})))&&(H=X),b=this.gridStyle.updateCell(b,null,H,null)||b}null!=(z=b.colorID)&&(j.contentID=z+a.toString(G)),j.style.opacity=b.opacity,j.style.colors.setColorId(d.ColorRole.FieldPrimary,b.colorID),j.allowUserMove=a.containsEq(this.foregroundGridCells,b,F._equality_GridCell_GridCell),j.controller.fit(I),N.splice(0,0,j),j.intent=h.Forma.INTENT_GRID_CELL}for(var W=a.iter(N);!W.done;W.next()){var q=W.value,K=this.gridForma.indexOfChild(q);null!=K&&K==G||this.gridForma.insertChildAt(q,G),G+=1}}for(var V=a.iter(_);!V.done;V.next()){var j=V.value;this.gridStyle.removeMappingToForma(j),j.removeFromParent()}for(var Z=a.iter(c);!Z.done;Z.next()){var J,Q=Z.value;(J=a.as(Q.controller,B.TypeLockupController))&&(this.gridCells.length>1&&this.owner.interactionMode==m.InteractionMode.AutomaticGrid&&(a.opt(J.lockupStyle,(function(e){return e.backing==P.LockupBacking.Banner}))||a.opt(J.lockupStyle,(function(e){return e.backing==P.LockupBacking.BannerHorizontal}))||a.opt(J.lockupStyle,(function(e){return e.backing==P.LockupBacking.BannerVertical}))||a.opt(J.lockupStyle,(function(e){return e.backing==P.LockupBacking.Knockout})))&&(a.opt(J.lockupStyle,(function(e){return e.textLook=P.LockupTextLook.Fill})),a.opt(J.lockupStyle,(function(e){return e.backingArtworkID=null})),a.opt(J.lockupStyle,(function(e){return e.backing=P.LockupBacking.None}))),J.snapSizeToBounds())}this.forma.endUpdate(l)}},assertCorrectLayout:function(){this.gridStyle},evaluateCellAndSplit:function(e,t,r,o,n,i){if(void 0===o&&(o=null),void 0===n&&(n=null),void 0===i&&(i=null),0!=e.length)if(1!=e.length&&null==o){for(var l=e[0].finalFrame,s=a.iter(e);!s.done;s.next()){var u=s.value;l=l.unionWith(u.finalFrame)}for(var c=Math.max(r.aspectRatio,1/r.aspectRatio),d=Math.max(l.aspectRatio,1/l.aspectRatio),m=r.similarity(l)>.1?Math.min(a.toInt(c-1),Math.max(1,_.MathUtils.absInt(a.toInt(c-d)))):1,f=[],g=a.iter(t);!g.done;g.next()){for(var p=g.value,v=[],C=a.iter(e);!C.done;C.next())u=C.value,a.containsEq(p,u,h._equality_Forma_Forma)&&v.push(u);v.length>0&&f.push(a.clone(v))}for(var F=Math.min(e.length,m),b=a.iter(e);!b.done;b.next()){var I,S;u=b.value,(I=a.as(u.controller,B.TypeLockupController))&&null!=(S=I.averageLineHeight)&&S<.5*B.TypeLockupController.MIN_LINE_HEIGHT&&(F+=1)}f=a.clone(y.GroupDetector.splitFormaGroups(a.clone(f),Math.max(F,1)));var D=null;if(r.aspectRatio>2)D=a.clone(r.insetRel(.1,.1,0,0).split(f.length,!0));else{if(null!=n)return void this.moveFormaeToCell(a.clone(e),r,o,a.clone(n),i);for(var T=this.forma.root.finalFrame.height,M=[],P=a.iter(f);!P.done;P.next())if((p=P.value).length>0){l=p[0].finalFrame;for(var x=a.iter(p);!x.done;x.next())u=x.value,l=l.unionWith(u.finalFrame);M.push(l.height/T+.1)}D=a.clone(r.insetRel(0,0,.1,.1).split(f.length,!1,a.clone(M)))}var G=null;1==f.length&&(G=a.clone(n));for(var k=a.iter(a.range(0,f.length,!1));!k.done;k.next()){var R=k.value;this.moveFormaeToCell(a.clone(f[R]),D[R],null,a.clone(G),i)}}else this.moveFormaeToCell(a.clone(e),r,o,a.clone(n),i)},moveFormaeToCell:function(e,t,r,o,n){if(void 0===r&&(r=null),void 0===o&&(o=null),void 0===n&&(n=null),0!=e.length){var i,l=null;if(i=o)for(var s=null!=r?r:this.forma.bounds,u=a.iter(e);!u.done;u.next()){var c;if(c=i[u.value.formaID]){var d=this.getCellRegion(c,s,void 0,n);null==l||l.equal(d)||D.Host.logging.warning("possible error. more than one old cell. "),l=d}}for(var m=a.sort(e,(function(e,t){return e.parent.indexOfChild(e)<t.parent.indexOfChild(t)})),h={},f=a.iter(m);!f.done;f.next()){var g=f.value;a.opt(a.as(g.controller,B.TypeLockupController),(function(e){return e.snapSizeToBounds()})),h[g.formaID]=g.parent.indexOfChild(g)}var p=this.forma.page.createFormaWithController(b.GroupForma.KIND,C.GroupController.KIND);p.allowUserMove=!1;var v=p.controller;p.isModel=!0,this.gridForma.isModel=!0,e.length>E.TheoDocumentUtils.DESIGN_COMPLEXITY_HEURISTIC_THRESHOLD?v.preferredResizeType=k.ResizeLayoutType.Proportional:null==r&&(v.preferredResizeType=k.ResizeLayoutType.Pin),this.gridForma.appendChild(p);for(var F=m[0].finalFrame,y=a.iter(m);!y.done;y.next())g=y.value,F=F.unionWith(g.finalFrame);null==l?(p.placement=x.Matrix2D.translationXY(F.minX,F.minY),p.bounds=L.TheoRect.fromSize(F.size)):(p.placement=x.Matrix2D.translationXY(l.minX,l.minY),p.bounds=L.TheoRect.fromSize(l.size));var I=t.equal(this.forma.frame)&&null!=r;I&&(p.placement=x.Matrix2D.Identity,p.bounds=L.TheoRect.fromSize(r.size));for(var S=a.iter(m);!S.done;S.next())g=S.value,p.appendChild(g,!0);var T=Y.TheoSize.Zero;if(null!=l||I)T=t.size;else{var M=Math.min(50,.05*t.width),P=Math.min(50,.05*t.height),_=t.insetXY(M,P),G=Math.min(_.height,F.height);1==e.length&&(G=Math.max(G,.75*_.height)),T=new Y.TheoSize(_.width,G)}p.bounds=L.TheoRect.fromSize(T),p.move(x.Matrix2D.translation(p.finalFrame.evalXY(.5,.5).multiply(-1)).translate(t.center));for(var R=a.iter(m);!R.done;R.next())g=R.value,this.gridForma.insertChildAt(g,h[g.formaID],!0),t.contains(g.finalFrame)||a.opt(D.Host.logging,(function(e){return e.warning("warning. child forma "+g.finalFrame.asString+" must be within region "+t.asString+" ")}));p.removeFromParent(),this.gridForma.isModel=!1}},getAlignments:function(e){return void 0===e&&(e=!1),[]},postDecode:function(){var e=this;l.CoreAssert.isTrue(null!=this.forma,"forma present","GridController.postDecode","GridController.swift",4099),l.CoreAssert.isTrue(null!=this.gridStyle,"grid style present","GridController.postDecode","GridController.swift",4100),a.opt(this.gridStyle,(function(t){return t.forma=e.forma})),this.inferBackgroundCellAssignment(),this.inferGridCellAssignment(),this.updateGridColors()},getBasicShapeLayoutColor:function(){var e;return(e=this.gridStyle)&&1==e.gridCells.length&&e.gridCells[0].bounds.equalWithAccuracy(L.TheoRect.ONE_BY_ONE,.01)?e.gridCells[0].colorID:null},canMoveShape:function(e){if(e.parent!=this.forma)return!1;var t;if(l=this.cellForForma(e))return a.containsEq(this.foregroundGridCells,l,F._equality_GridCell_GridCell);if(t=e.finalFrame){for(var r={},o=[],n=a.iter(this.gridCells);!n.done;n.next()){var i,l=n.value,s=this.getCellRegion(l);(i=t.intersectionWith(s))&&i.area/s.area>.6&&(r[l]=i.area/s.area,o.push(l))}if(o.length>0)return a.sortInPlace(o,(function(e,t){return r[e]>r[t]})),a.containsEq(this.foregroundGridCells,o[0],F._equality_GridCell_GridCell)}return!1}}}),n)},JO5d:function(e,t,r){var o,n=t,i=r("oAGj"),a=r("0wFF"),l=r("aO0D"),s=r("CWW7"),u=r("yGNn"),c=r("AVHO"),d=r("Ohrj"),m=r("ascj"),h=r("FNB+"),f=r("H9Ol"),g=r("yHU1"),p=r("Pil/"),v=r("16hp"),C=r("P83h"),F=r("9Lk3"),y=r("x35w"),b=r("iCxV"),I=r("tGKA"),S=r("uxH+"),D=r("K0Rh"),T=r("7Ta2"),M=r("djAF"),P=r("35Q0"),x=r("T6jX"),_=r("oKlP"),G=r("sIWg"),k=r("qSCS");n.ShapeController=(o=function(e,t,r){f.FormaController.call(this,e,t,r)},i.defineClass({name:"ShapeController",ctor:o,superName:"FormaController",statics:{KIND:{get:function(){return"shape"}}},props:{duplicatable:{get:function(){return this.forma.hasIntent(h.Forma.INTENT_ICON)}},selectable:{get:function(){return null==this.forma||null==x.TheoDocumentUtils.getCellBackgroundImage(this.forma)}},rotateable:{get:function(){return this.forma.hasIntent(h.Forma.INTENT_ICON)||this.forma.hasIntent(h.Forma.INTENT_FLOATING_SHAPE)}},moveable:{get:function(){return null!=this.forma.allowUserMove?this.forma.allowUserMove:!(!this.forma.hasIntent(h.Forma.INTENT_ICON)&&!this.forma.hasIntent(h.Forma.INTENT_FLOATING_SHAPE))||((e=i.as(i.opt(i.opt(this.forma,(function(e){return e.parent})),(function(e){return e.controller})),F.GridController))?e.canMoveShape(this.forma):f.FormaController._getters.moveable.call(this));var e}},floating:{get:function(){return!(!this.forma.hasIntent(h.Forma.INTENT_ICON)&&!this.forma.hasIntent(h.Forma.INTENT_FLOATING_SHAPE))||!this.forma.hasIntent(h.Forma.INTENT_GRID_CELL)&&f.FormaController._getters.floating.call(this)}},deleteable:{get:function(){var e,t,r,o,n=this;return i.opt(this.forma,(function(e){return null!=e.controller&&n.forma.isGridCell()}))&&(e=i.as(i.opt(this.forma,(function(e){return e.root})),D.RootForma))&&(t=i.opt(i.as(e.controller,S.RootController),(function(e){return e.getGridController()})))?1==t.gridStyle.numBackgroundCells&&(r=i.opt(this.forma,(function(e){return e.finalFrame})))&&(o=i.opt(i.opt(this.forma,(function(e){return e.root})),(function(e){return e.finalFrame})))?!r.equal(o):t.canDeleteCellForForma(this.forma):f.FormaController._getters.deleteable.call(this)}},replaceable:{get:function(){return!(!i.opt(this.forma,(function(e){return null!=e.controller}))||this.forma.isGridCell()&&this.forma.controller.moveable)}},flippable:{get:function(){return this.forma.hasIntent(h.Forma.INTENT_ICON)}},nudgeable:{get:function(){return this.forma.hasIntent(h.Forma.INTENT_ICON)}},maintainAspectRatio:{get:function(){var e,t,r,o;return this.forma.hasIntent(h.Forma.INTENT_IMAGE_MASK)&&null!=(e=i.opt(i.as(this.forma,M.ShapeForma),(function(e){return e.shapeLibraryID})))&&(t=l.CropAssetLibrary.getCropShapeFromID(e))?t.fixAspectRatio:(!(r=i.opt(i.as(i.opt(i.as(this.forma,M.ShapeForma),(function(e){return e.contentNode})),k.URLBasedContentNode),(function(e){return e.mediaMetadata})))||null==(o=r.searchTerm)||"square"!=o.toLowerCase()&&"rectangle"!=o.toLowerCase())&&this.forma.hasIntent(h.Forma.INTENT_ICON)}},selectionHandlePositions:{get:function(){return this.forma.hasIntent(h.Forma.INTENT_GRID_CELL)?[new _.TheoPoint(.5,0),new _.TheoPoint(.5,1),new _.TheoPoint(1,.5),new _.TheoPoint(0,.5)]:f.FormaController._getters.selectionHandlePositions.call(this)}},processFormaResize:function(e){f.FormaController.prototype.processFormaResize.call(this,e)},processBeginFormaResize:function(e){f.FormaController.prototype.processBeginFormaResize.call(this,e)},processEndFormaResize:function(e){f.FormaController.prototype.processEndFormaResize.call(this,e),this.updateParentGroup()},processEvent:function(e){var t;return(t=i.as(e,p.BeginPointerTrackingEvent))?(t.trackingResponse=g.BeginPointerTrackingResponseEnum.TrackAsGroup,!1):f.FormaController.prototype.processEvent.call(this,e)},processFormaDoubleClick:function(e){this.owner.selection.replaceSelection(e.forma),this.owner.controllerSettingsState.settings=new c.ShapeControllerSettings(this)},addForma:function(e,t,r){var o;if(o=i.as(e.root,D.RootForma)){for(var n,a,l=i.clone(o.filterWithCallback((function(e){return e.isTypeLockup()}))),s=null,c=i.iter(l);!c.done;c.next()){var d;(d=c.value.style.colors.fieldPrimary)&&(s=d)}if((n=i.as(t,M.ShapeForma))&&(a=y.GridFacade.getPageGrid(t.page,!0))&&(a.forma.appendChild(n),r.suggestPlacement)){var h=new v.FormaPlacementSuggester(n,o),f=i.clone(h.createPlacementSuggestions(!0,n.bounds.aspectRatio));f.length>0&&f[0].apply()}return null==s?i.opt(this.forma,(function(e){return e.style.colors.setColorId(m.ColorRole.FieldPrimary,o.page.colorLibraryController.getThemeColorKeys()[0])})):i.opt(this.forma,(function(e){return e.style.colors.setColor(m.ColorRole.FieldPrimary,s)})),this.contrastCheck(!1),u.CorePromise.resolve(null)}return u.CorePromise.reject("failed to get critical references")},getSuggestableColors:function(){for(var e=this.forma.page.colorLibraryController,t=i.clone(e.getColorThemeAsArrayOfTheoColors()),r=[],o=this.getBackgroundColor(),n=i.iter(t);!n.done;n.next()){var a=n.value;if(!a.isBrandkitColor()){if(this.floating&&null!=o&&!o.contrasts(a.rgbColor,!1))continue;r.push([a])}}return r},fit:function(e){var t;(t=i.as(this.forma,M.ShapeForma))&&(t.size=this.maintainAspectRatio?e.fitAspectRatioWithin(t.bounds.aspectRatio):e.size,t.placement=I.Matrix2D.Identity,t.moveCenterToPoint(e.center))},setNewShape:function(e){var t=new C.FormaGeometryChangedEvent(this.forma);this.forma.beginUpdate(t),P.ShapeLibrary.applyToShapeForma(this.forma,e),this.forma.endUpdate(t)},styleChanged:function(){!this.blockUpdate&&this.forma.isGridCell()&&i.opt(i.as(i.opt(i.opt(this.forma,(function(e){return e.parent})),(function(e){return e.controller})),F.GridController),(function(e){return e.updateGridColors()}))},copyTo:function(e){var t;if(void 0===e&&(e=null),t=i.as(this.forma,M.ShapeForma)){var r=e||t.page,n=r.createFormaWithController(M.ShapeForma.KIND,o.KIND);return n.match(t),s.CreationFacade.addForma(r,n,new s.AddFormaParams(void 0,!1)).then((function(e){return n.style.match(t.style),n.intent=t.intent,n.contentID=t.contentID,t.hasIntent(h.Forma.INTENT_ICON)?i.opt(b.Host.logging,(function(e){return e.logToAnalytics(a.AnalyticsConstants.kAnalyticsDataIconDuplicated,{})})):i.opt(b.Host.logging,(function(e){return e.logToAnalytics(a.AnalyticsConstants.kAnalyticsDataShapeDuplicated,{})})),n}))}return u.CorePromise.reject("Why calling ShapeController.duplicate but not for a shape forma?")},shuffleColorAssignment:function(){var e;if(e=i.as(this.forma,M.ShapeForma))if(F.GridController.isBackgroundColoredCell(this.forma)){var t,r;(t=i.as(i.opt(i.opt(this.forma,(function(e){return e.parent})),(function(e){return e.controller})),F.GridController))&&(r=t.getContrastingColorForCell(this.forma))&&this.applyColors([r])}else{var o=null;x.TheoDocumentUtils.enableFastHeuristicsForComplexPage(this.forma.page)&&(o=i.clone(T.InferredRole.init_84d1(T.InferredRoleType.GraphicContent,1,T.InferredRoleType.Background,0)));var n=new d.ProfilingPrimaryColorSelector(e,!1).selectColorForGlobalRecolor(void 0,void 0,void 0,i.clone(o));e.style.colors.setColorId(m.ColorRole.FieldPrimary,n)}},containsPoint:function(e,t){if(void 0===t&&(t=0),!f.FormaController.prototype.containsPoint.call(this,e,t))return!1;var r,o;if((r=i.opt(i.as(this.forma,M.ShapeForma),(function(e){return e.maskImage})))&&(o=this.forma.bounds)){if(r.isEmpty())return!0;var n,a=new G.TheoRect(0,0,i.toDouble(r.width),i.toDouble(r.height)),l=new _.TheoPoint(e.x/o.width*a.width,e.y/o.height*a.height),s=.05*Math.max(a.width,a.height),u=new G.TheoRect(l.x-s,l.y-s,l.x+s,l.y+s);return!!(n=a.intersectionWith(u))&&r.sumRegion(n)>1e-5}return!0}}}),o)},KIfs:function(e,t,r){var o,n,i,a=t,l=r("oAGj"),s=r("SpAV"),u=r("gXiO"),c=r("iCxV"),d=r("tGKA"),m=r("g8Fi"),h=r("oKlP");a.kAllowMultipleDragsInFlight=!1,a.debug_print=function(e,t,r){void 0===t&&(t=" "),void 0===r&&(r="\n")},a.debug_print=function(e,t,r,o){void 0===r&&(r=" "),void 0===o&&(o="\n")},a.debug_print=function(e,t,r,o,n){void 0===o&&(o=" "),void 0===n&&(n="\n")},a.debug_print=function(e,t,r,o,n,i){void 0===n&&(n=" "),void 0===i&&(i="\n")},a.debug_print=function(e,t,r,o,n,i,a){void 0===i&&(i=" "),void 0===a&&(a="\n")},a.debug_print=function(e,t,r,o,n,i,a,l){void 0===a&&(a=" "),void 0===l&&(l="\n")},a.debug_print=function(e,t,r,o,n,i,a,l,s){void 0===l&&(l=" "),void 0===s&&(s="\n")},a.debug_print=function(e,t,r,o,n,i,a,l,s,u){void 0===s&&(s=" "),void 0===u&&(u="\n")},a.debug_print=function(e,t,r,o,n,i,a,l,s,u,c){void 0===u&&(u=" "),void 0===c&&(c="\n")},a.debug_print=function(e,t,r,o,n,i,a,l,s,u,c,d){void 0===c&&(c=" "),void 0===d&&(d="\n")},a.dot=function(e,t){return e.dotProduct(t)},a.cross=function(e,t){return e.x*t.y-e.y*t.x},a.concat=function(e,t,r){return d.Matrix2D.concat2(d.Matrix2D.concat2(e,t),r)},a.scale=function(e,t){return new h.TheoPoint(e*t.x,e*t.y)},a.blend=function(e,t,r){return a.scale(1-t,e).add(a.scale(t,r))},a.midpoint=function(e,t){return a.blend(e,.5,t)},a.moveBy=function(e){return d.Matrix2D.translation(e)},a.move=function(e,t){return a.moveBy(t.subtract(e))},a.PointerDrag=(o=function(e,t){this.begin=e,this.end=t},l.defineClass({name:"PointerDrag",ctor:o}),o),a.freeMovement_=function(e){if(1==e.length)return{movement:a.move(e[0].begin,e[0].end),rise:0,run:1};if(e.length>=2){var t=e[1].begin.subtract(e[0].begin),r=e[1].end.subtract(e[0].end);if(t.equal(h.TheoPoint.ZERO)&&r.equal(h.TheoPoint.ZERO))return{movement:a.move(e[0].begin,e[0].end),rise:0,run:1};if(t.equal(h.TheoPoint.ZERO))return{movement:a.move(e[0].begin,e[0].end),rise:0,run:1};var o=a.dot(t,t),n=a.dot(t,r),i=a.cross(t,r),l=n/o,u=i/o,c=new d.Matrix2D(l,u,-u,l,0,0),m=a.concat(a.moveBy(e[0].begin.invert()),c,a.moveBy(e[0].end));return s.CoreAssert.isTrue(0!=m.determinant,void 0,"freeMovement_","PointerStateMachine.swift",269),{movement:m,rise:i,run:n}}return{movement:d.Matrix2D.Identity,rise:0,run:1}},a.MoorePenrose10011001=function(e,t,r,o,n,i,a,s){var u=e-r,c=t-o,d=u*u,m=c*c,h=2*(d+m),f=c*(e+r),g=u*(t+o),p=[[2*u,2*c,-2*u,-2*c],[m-2*r*u,-f,m+2*e*u,f],[-g,d-2*o*c,g,d+2*t*c]];p=p.map((function(e){return e.map((function(e){return e/h}),this)}),this);var v=p.map((function(e){return function(e,t){return l.zip(l.clone(e),l.clone(t)).map((function(e){return e[0]*e[1]}),this).reduce((function(e,t){return e+t}),0)}(l.clone(e),[n,i,a,s])}),this);return{u:v[0],v:v[1],w:v[2]}},a.noRotation_=function(e){if(1==e.length)return a.move(e[0].begin,e[0].end);if(e.length>=2){var t=e[1].begin.subtract(e[0].begin),r=e[1].end.subtract(e[0].end);if(t.equal(h.TheoPoint.ZERO)&&r.equal(h.TheoPoint.ZERO))return a.move(e[0].begin,e[0].end);if(t.equal(h.TheoPoint.ZERO))return a.move(e[0].begin,e[0].end);var o=a.MoorePenrose10011001(e[0].begin.x,e[0].begin.y,e[1].begin.x,e[1].begin.y,e[0].end.x,e[0].end.y,e[1].end.x,e[1].end.y),n=o.u,i=o.v,l=o.w;return new d.Matrix2D(n,0,0,n,i,l)}return d.Matrix2D.Identity},a.noRotation2_=function(e,t){if(1==e.length)return a.move(e[0].begin,e[0].end);if(e.length>=2){var r=e[1].begin.subtract(e[0].begin),o=e[1].end.subtract(e[0].end);if(r.equal(h.TheoPoint.ZERO)&&o.equal(h.TheoPoint.ZERO))return a.move(e[0].begin,e[0].end);if(r.equal(h.TheoPoint.ZERO))return a.move(e[0].begin,e[0].end);var n=a.MoorePenrose10011001(e[0].begin.x,e[0].begin.y,e[1].begin.x,e[1].begin.y,e[0].end.x,e[0].end.y,e[1].end.x,e[1].end.y),i=n.u;n.v,n.w;return a.concat(a.moveBy(t.invert()),new d.Matrix2D(i,0,0,i,0,0),a.moveBy(t))}return d.Matrix2D.Identity},a.noScale_=function(e){if(1==e.length)return a.move(e[0].begin,e[0].end);if(e.length>=2){var t=e[1].begin.subtract(e[0].begin),r=e[1].end.subtract(e[0].end);if(t.equal(h.TheoPoint.ZERO)&&r.equal(h.TheoPoint.ZERO))return a.move(e[0].begin,e[0].end);if(t.equal(h.TheoPoint.ZERO))return a.move(e[0].begin,e[0].end);var o=a.MoorePenrose10011001(-e[0].begin.y,e[0].begin.x,-e[1].begin.y,e[1].begin.x,e[0].end.x-e[0].begin.x,e[0].end.y-e[0].begin.y,e[1].end.x-e[1].begin.x,e[1].end.y-e[1].begin.y),n=o.u,i=o.v,l=o.w;return new d.Matrix2D(Math.cos(n),Math.sin(n),-Math.sin(n),Math.cos(n),i,l)}return d.Matrix2D.Identity},a.noScale2_=function(e){if(1==e.length)return a.move(e[0].begin,e[0].end);if(e.length>=2){var t=e[1].begin.subtract(e[0].begin),r=e[1].end.subtract(e[0].end);if(t.equal(h.TheoPoint.ZERO)&&r.equal(h.TheoPoint.ZERO))return a.move(e[0].begin,e[0].end);if(t.equal(h.TheoPoint.ZERO))return a.move(e[0].begin,e[0].end);var o=a.dot(t,t),n=a.dot(r,r),i=a.dot(t,r),l=a.cross(t,r),u=Math.sqrt(o*n),c=i/u,m=l/u,f=new d.Matrix2D(c,m,-m,c,0,0),g=a.concat(a.moveBy(a.midpoint(e[0].begin,e[1].begin).invert()),f,a.moveBy(a.midpoint(e[0].end,e[1].end)));return s.CoreAssert.isTrue(0!=g.determinant,void 0,"noScale2_","PointerStateMachine.swift",610),g}return d.Matrix2D.Identity},a.noScale3_=function(e,t){if(1==e.length)return a.move(e[0].begin,e[0].end);if(e.length>=2){var r=e[1].begin.subtract(e[0].begin),o=e[1].end.subtract(e[0].end);if(r.equal(h.TheoPoint.ZERO)&&o.equal(h.TheoPoint.ZERO))return a.move(e[0].begin,e[0].end);if(r.equal(h.TheoPoint.ZERO))return a.move(e[0].begin,e[0].end);var n=a.dot(r,r),i=a.dot(o,o),l=a.dot(r,o),u=a.cross(r,o),c=Math.sqrt(n*i),m=l/c,f=u/c,g=new d.Matrix2D(m,f,-f,m,0,0),p=a.concat(a.moveBy(t.invert()),g,a.moveBy(t));return s.CoreAssert.isTrue(0!=p.determinant,void 0,"noScale3_","PointerStateMachine.swift",651),p}return d.Matrix2D.Identity},a.closestApproach_=function(e,t,r,o){var n=e.subtract(r),i=o.subtract(t),l=a.dot(i,i);return 0==l?{distance:Math.sqrt(a.dot(n,n)),time:0}:{distance:a.cross(i,n)/Math.sqrt(l),time:a.dot(i,n)/l}},a.DragPace=l.defineEnum("DragPace",{StoppedPace:0,SlowPace:1,MediumPace:2,FastPace:3}),a.DragMode=l.defineEnum("DragMode",{UniformScaleNoSkew:0,NoScaleNoSkew:1,UniformScaleNoRotationNoSkew:2}),a.ActiveDragDelegateProtocol=l.defineProtocol("ActiveDragDelegateProtocol",{modifierKeys:"Dictionary<String>",activeDragDidBegin:"(ActiveDrag) -> Void",activeDragDidActivate:"(ActiveDrag) -> Boolean",activeDragDidDeactivate:"(ActiveDrag, Boolean) -> Void",activeDragClaimNewPointers:"(ActiveDrag, Array<PointerState>, Boolean) -> Array<PointerState>",activeDragDidCommit:"(ActiveDrag) -> Void",activeDragDidMove:"(ActiveDrag, DragPace) -> Void",activeDragDidChangePace:"(ActiveDrag, DragPace, DragPace) -> Void",activeDragHeldPointerEndedAsTap:"(ActiveDrag, PointerState) -> Void",activeDragDidEnd:"(ActiveDrag, Boolean, Array<PointerState>) -> Void"}),a.ActiveDrag=(n=function(e,t,r,o,n){this.initiated=!1,this.dragMode_=a.DragMode.UniformScaleNoSkew,this.pointers=[],this.totalMovement=d.Matrix2D.Identity,this.currentlySnapped_=!1,this.activationClock_=0,this._assignment=0,this.activeDragDelegate=t,this.pointerStateMachine=e,this.currentPace=a.DragPace.MediumPace,this.stoppedUtmost=9,this.slowUtmost=48,this.mediumUtmost=300,this.stoppedSlack=.5,this.slowSlack=.333,this.transientSlack=.333,this.futurePace=this.currentPace,this.pointers=[],this.uncommitedMovement=d.Matrix2D.Identity,this.newDragPlacement_=o,this.viewportScale=n,u.CoreObject.call(this),this.commitWithNewPointers(r)},l.defineClass({name:"ActiveDrag",ctor:n,superName:"CoreObject",props:{dragMode:{get:function(){return this.dragMode_},set:function(e){this.dragMode_,this.dragMode_=e}},currentlySnapped:{get:function(){return this.currentlySnapped_},set:function(e){this.currentlySnapped_!=e&&(this.currentlySnapped_=e)}},startPaceTimer:function(){if(null==this.paceTimer){var e=this;this.paceTimer=c.Host.async.startTimer(.6,(function(){var t;(t=e)&&(t.activePace(),t.paceTimer=null,t.startPaceTimer())}))}},stopPaceTimer:function(){l.opt(this.paceTimer,(function(e){return e.cancel()})),this.paceTimer=null},activeDragDidCommit:function(){this.activeDragDelegate.activeDragDidCommit(this)},commitDrag:function(){this.slipPointers(!1),this.activeDragDidCommit(),this.totalMovement=d._asterisk_Matrix2D_Matrix2D(this.totalMovement,this.uncommitedMovement);var e=this.uncommitedMovement;return this.uncommitedMovement=d.Matrix2D.Identity,e},newDragPlacement:{get:function(){return this.newDragPlacement_},set:function(e){this.newDragPlacement_=e}},commitWithNewPointers:function(e,t){void 0===t&&(t=!0);for(var r=l.iter(e);!r.done;r.next()){var o=r.value;o.pointerStatus=m.PointerStatus.DragHeld,this.pointers.push(o)}this.commitDrag();var n=this.activationClock_,i=this;c.Host.async.postOnMainThread(.6,(function(){var e;(e=i)&&(n==e.activationClock_&&e.activateAll()?a.debug_print("time activated"):a.debug_print("not time activated"))})),e.splice(0)},claimPointers:function(e,t){return this.activeDragDelegate.activeDragClaimNewPointers(this,l.clone(e),t)},activeDragDidDeactivate:function(){var e=this.currentlySnapped;this.currentlySnapped=!1,this.activeDragDelegate.activeDragDidDeactivate(this,e)},deactivateAll:function(){if(this.initiated){this.commitDrag();for(var e=l.iter(this.pointers);!e.done;e.next()){var t=e.value;t.pointerStatus==m.PointerStatus.DragActive&&(t.pointerStatus=m.PointerStatus.DragInactive)}this.stopPaceTimer(),this.activeDragDidDeactivate()}},activeDragDidBegin:function(){this.activeDragDelegate.activeDragDidBegin(this)},activeDragDidActivate:function(){return this.activeDragDelegate.activeDragDidActivate(this)},activeDragDidMove:function(){this.activeDragDelegate.activeDragDidMove(this,this.currentPace)},activeDragDidEnd:function(e){this.initiated&&this.stopPaceTimer(),this.activeDragDelegate.activeDragDidEnd(this,this.initiated,l.clone(e)),this.pointers.splice(0)},activateAll:function(){for(var e=!1,t=l.iter(this.pointers);!t.done;t.next()){var r=t.value;r.pointerStatus!=m.PointerStatus.DragActive&&(r.pointerStatus=m.PointerStatus.DragActive,e=!0)}return!!e&&(this.activationClock_+=1,this.initiated||(this.initiated=!0,this.activeDragDidBegin()),this.selectDragMode(),this.startPaceTimer(),this.activeDragDidActivate()&&this.slipPointers(!0),!0)},slipPointers:function(e){for(var t=l.iter(this.pointers);!t.done;t.next()){var r=t.value,o=h._minus_TheoPoint_TheoPoint(r.currentLocation,r.startLocation);r.slippage=e?h._plus_TheoPoint_TheoPoint(r.slippage,o):h.TheoPoint.ZERO,r.startLocation=r.currentLocation,r.startTime=r.currentTime}},selectDragMode:function(){var e=this;if(this.pointers.length<=1)return a.debug_print("just one pointer"),void(this.dragMode=a.DragMode.UniformScaleNoSkew);var t=function(t){return h._minus_TheoPoint_TheoPoint(e.pointers[t].currentLocation,e.pointers[t].startLocation)},r=t(0),o=t(1),n=a.dot(r,o)/r.length()/o.length(),i=n>.5;if(a.debug_print("cosine_subtended",n),i)return a.debug_print("same direction"),void(this.dragMode=a.DragMode.UniformScaleNoRotationNoSkew);var l,s=d.Matrix2D.Identity;s=(l=this.pointers[0].viewportTransform)?l:d.Matrix2D.uniformScaling(this.viewportScale);var u=this.freeMovement(s),c=u.movement,m=u.rise,f=u.run,g=c.determinant;a.debug_print("activateAll",Math.sqrt(g),m/f);var p=this.closestApproach(),v=p.distance;if(p.time,1==g&&0==m)a.debug_print("==== translate"),this.dragMode=a.DragMode.UniformScaleNoSkew;else if(1==g)a.debug_print("==== rotate"),this.dragMode=a.DragMode.NoScaleNoSkew;else if(0==m)a.debug_print("==== scale"),this.dragMode=a.DragMode.UniformScaleNoRotationNoSkew;else{var C=.7*Math.abs(1-Math.sqrt(g)),F=Math.abs(m/f);C>1.1*F&&C>.01?(a.debug_print("==== scale"),this.dragMode=a.DragMode.UniformScaleNoRotationNoSkew):F>1.1*C&&F>.01?(a.debug_print("==== rotate"),this.dragMode=a.DragMode.NoScaleNoSkew):(a.debug_print("==== free"),this.dragMode=a.DragMode.UniformScaleNoRotationNoSkew)}this.dragMode==a.DragMode.UniformScaleNoRotationNoSkew&&Math.abs(v)>100&&(a.debug_print("!!!!!!!!override"),this.dragMode=a.DragMode.NoScaleNoSkew)},notifyPaceChanged:function(e,t){},activeDragDidChangePace:function(e,t){this.notifyPaceChanged(e,t),this.activeDragDelegate.activeDragDidChangePace(this,e,t)},activePace:function(){var e,t=this.dragVelocity*this.viewportScale;if(e=t<=this.stoppedUtmost?a.DragPace.StoppedPace:t<this.slowUtmost?a.DragPace.SlowPace:t<this.mediumUtmost?a.DragPace.MediumPace:a.DragPace.FastPace,this.futurePace!=e){this._assignment+=1;var r=this._assignment;if(this.futurePace=e,this.currentPace!=this.futurePace){var o=this.transientSlack;this.futurePace==a.DragPace.SlowPace&&(o=this.slowSlack),this.futurePace==a.DragPace.StoppedPace&&(o=this.stoppedSlack);var n=this;c.Host.async.postOnMainThread(o,(function(){var e;if((e=n)&&e._assignment==r){var t=e.currentPace;e.currentPace=e.futurePace,e.activeDragDidChangePace(t,e.currentPace),e.currentPace==a.DragPace.StoppedPace&&e.deactivateAll()}}))}}return this.currentPace},dragVelocity:{get:function(){for(var e=0,t=l.iter(this.pointers);!t.done;t.next()){var r=t.value.pointerVelocity();r>e&&(e=r)}return e}},activePointers:function(e){for(var t=[],r=l.iter(this.pointers);!r.done;r.next()){var o=r.value;o.pointerStatus==m.PointerStatus.DragActive&&t.push(new a.PointerDrag(e.transformPoint(o.startLocation),e.transformPoint(o.currentLocation)))}return t},freeMovement:function(e){var t=l.clone(this.activePointers(e));return a.freeMovement_(l.clone(t))},noScale:function(e,t){var r=l.clone(this.activePointers(e));return a.noScale3_(l.clone(r),t)},noRotation:function(e,t){var r=l.clone(this.activePointers(e));return a.noRotation2_(l.clone(r),t)},closestApproach:function(){for(var e=[],t=l.iter(this.pointers);!t.done;t.next()){var r=t.value;r.pointerStatus==m.PointerStatus.DragActive&&(e.push(r),a.debug_print("gorg=======",r.currentTime))}if(e.length<=1)return{distance:0,time:0};var o=d.Matrix2D.uniformScaling(this.viewportScale),n=function(t){for(var r=o.transformPoint(e[t].startLocation),n=o.transformPoint(e[t].currentLocation),i=e[t].startTime,s=e[t].currentTime,u=r.equal(n)?h.TheoPoint.ZERO:n.subtract(r).multiply(1/(s-i)),c=l.iter(e[t].history);!c.done;c.next()){var d=c.value;a.debug_print("\t......... "+d)}return{point:n,velocity:u}},i=n(0),s=n(1);return a.closestApproach_(i.point,i.velocity,s.point,s.velocity)}}}),n),a.PointerStateMachineDelegateProtocol=l.defineProtocol("PointerStateMachineDelegateProtocol",{createDragsForPointers:"(PointerStateMachine, Array<PointerState>, Boolean, Integer) -> Array<PointerState>",activeDragDidFinish:"(PointerStateMachine, ActiveDrag) -> Void"}),a.PointerStateMachine=(i=function(e){this.trackingStarted_=!1,this.drags_=[],this.delegate=e,u.CoreObject.call(this)},l.defineClass({name:"PointerStateMachine",ctor:i,superName:"CoreObject",statics:{_implements:function(e){return"TheoMessageSubscriber"==e}},props:{attach:function(e,t){this.owner=e,this.subscription_=t.subscribe(this,m.PointersStateChangeMessage.TYPE)},detach:function(){l.opt(this.subscription_,(function(e){return e.unsubscribe()})),this.subscription_=null,this.owner=null},onMessage:function(e){var t;(t=l.as(e,m.PointersStateChangeMessage))&&(this.trackingStarted_?t.changeType==m.PointersStateChangeTypeEnum.PointersDown?this.processDown(t):t.changeType==m.PointersStateChangeTypeEnum.PointersMoved?this.processMove(t):t.changeType==m.PointersStateChangeTypeEnum.PointersUp&&this.processUp(t):t.changeType==m.PointersStateChangeTypeEnum.PointersDown&&(this.trackingStarted_=!0,this.drags_=[],this.processDown(t)))},processDown:function(e){if(null!=e){for(var t=e,r=l.clone(t.pointers),o=l.iter(this.drags_);!o.done;o.next()){var n=o.value;r=l.clone(n.claimPointers(l.clone(r),a.kAllowMultipleDragsInFlight))}0!=r.length&&(r=l.clone(this.delegate.createDragsForPointers(this,l.clone(r),a.kAllowMultipleDragsInFlight,this.drags_.length)))}},appendDrag:function(e){this.drags_.push(e)},processMove:function(e){for(var t=l.iter(this.drags_);!t.done;t.next()){for(var r=t.value,o=r.viewportScale*r.viewportScale,n=[],i=l.iter(e.pointers);!i.done;i.next()){var s=i.value;r.pointers.includes(s)&&n.push(s)}if(0!=n.length){for(var u=l.iter(n);!u.done;u.next()){(s=u.value).pointerStatus,m.PointerStatus.DragActive;var c=h._minus_TheoPoint_TheoPoint(s.currentLocation,s.startLocation),d=c.dotProduct(c)*o;if(d>81){r.activateAll()&&a.debug_print("move activated",Math.sqrt(d));break}}r.initiated&&r.activeDragDidMove()}}},activeDragTouchesEnded:function(e,t){for(var r=l.iter(t);!r.done;r.next()){var o,n=r.value;n.pointerStatus==m.PointerStatus.DragHeld&&e.activeDragDelegate.activeDragHeldPointerEndedAsTap(e,n),null!=(o=l.indexOf(e.pointers,n))&&l.clone(e.pointers.splice(o,1))}e.commitDrag()},processUp:function(e){for(var t=0;t<this.drags_.length;){for(var r=this.drags_[t],o=[],n=l.iter(e.pointers);!n.done;n.next()){var i=n.value;r.pointers.includes(i)&&o.push(i)}o.length==r.pointers.length?(r.activeDragDidEnd(l.clone(o)),this.delegate.activeDragDidFinish(this,r),l.clone(this.drags_.splice(t,1))):(this.activeDragTouchesEnded(r,l.clone(o)),t+=1)}}}}),i)},LhEC:function(e,t,r){var o,n=t,i=r("oAGj"),a=r("ZK0l");n.PROPERTY_SIZE_DEPRECATED="size",n.ResponsiveController=(o=function(e,t,r){a.GroupController.call(this,e,t,r)},i.defineClass({name:"ResponsiveController",ctor:o,superName:"GroupController",statics:{KIND:{get:function(){return"responsive"}}}}),o)},NkBu:function(e,t,r){var o,n=t,i=r("oAGj"),a=r("SpAV"),l=r("AVHO"),s=r("ascj"),u=r("H9Ol"),c=r("6ZWm"),d=r("yHU1"),m=r("Pil/"),h=r("cmoc"),f=r("fdtz"),g=r("lmwz"),p=r("uWOl"),v=r("37nf"),C=r("tGKA"),F=r("jcfx"),y=r("fAXt"),b=r("oKlP"),I=r("sIWg");n.ImageController=(o=function(e,t,r){u.FormaController.call(this,e,t,r)},i.defineClass({name:"ImageController",ctor:o,superName:"FormaController",statics:{KIND:{get:function(){return"image"}}},props:{rotateable:{get:function(){return!0}},flippable:{get:function(){return!this.forma.isLogo()}},nudgeable:{get:function(){return!0}},floating:{get:function(){var e;return(e=i.as(i.opt(i.opt(this.forma,(function(e){return e.parent})),(function(e){return e.controller})),c.FrameController))?e.floating:u.FormaController._getters.floating.call(this)}},moveable:{get:function(){var e,t;if((e=i.as(this.forma,f.ImageForma))&&(t=e.parent)){var r;if((r=i.opt(i.opt(e.page.document,(function(e){return e.controller})),(function(e){return e.selection})))&&r.isSelected(t)&&r.inCropMode)return!0;if(t.isGridCell())return!0}return!1}},match:function(e){},setCrop:function(e,t,r){var o,n;if((o=this.forma)&&(n=o.bounds))if(r!=c.CropType.PreserveFocus&&r!=c.CropType.PreserveFocusAndScale||null==t)if(r==c.CropType.ScaleCrop&&null!=t){F=o.placement.transformValuesRKST;var l=Math.max(e.width/t.width,e.height/t.height);o.placement=o.placement.scaleTo(l*F.xscale,l*F.yscale)}else{var s,u,d,m=e.transform(o.placement.inverse),h=i.opt(t,(function(e){return e.transform(o.placement.inverse)})),g=null;if((s=i.opt(i.opt(i.as(this.forma,f.ImageForma),(function(e){return e.contentNode})),(function(e){return e.focusRegion})))&&(g=v.ImageUtils.suggestCrop(this.forma.bounds.size,s,m,h,r)),null==g&&(u=i.opt(i.as(o,f.ImageForma),(function(e){return e.contentNode})))&&(g=new I.TheoRect(0,0,i.toDouble(u.pixelWidth),i.toDouble(u.pixelHeight))),d=g){o.move(C.Matrix2D.uniformScaling(m.width/d.width));var p=o.placement.transformPoint(d.center);o.move(C.Matrix2D.translation(e.center.subtract(p)))}}else{var F=o.placement.transformValuesRKST,y=C._asterisk_Matrix2D_Matrix2D(C.Matrix2D.rotation(F.rotCosine,F.rotSine),C.Matrix2D.skewing(F.skew).scaleXY(F.xscale>0?1:-1,F.yscale>0?1:-1)),S=C.Matrix2D.scalingXY(Math.abs(F.xscale),Math.abs(F.yscale)),D=S.translateXY(F.tx,F.ty),T=C._asterisk_TheoRect_Matrix2D(n,o.placement).intersectionWith(t);null==T&&(T=t);var M,P,x,_=C._asterisk_TheoRect_Matrix2D(T,D.inverse),G=T.center,k=t.locate(G.x,G.y);if((M=i.opt(i.as(o,f.ImageForma),(function(e){return e.getFocusRegion()})))&&(P=M.intersectionWith(T))&&(k=t.locate(P.center.x,P.center.y)),r==c.CropType.PreserveFocusAndScale){var R=_.eval(k),w=C.Matrix2D.translation(b._negate_TheoPoint(R));w=C._asterisk_Matrix2D_Matrix2D(w,S);var A=e.eval(k);w=w.translate(A),x=C._asterisk_Matrix2D_Matrix2D(y,w)}else{w=C.Matrix2D.calculateResizeTransform(_,e,k,c.FitType.ProportionalFit),x=C._asterisk_Matrix2D_Matrix2D(y,w);var E=e.transform(x.inverse);n.contains(E)||(w=C.Matrix2D.calculateResizeTransform(_,e,k,c.FitType.ProportionalFill),x=C._asterisk_Matrix2D_Matrix2D(y,w))}o.placement=x}else a.CoreAssert.fail("ERROR. image has no bounds. possibly a corrupted document","ImageController.setCrop","ImageController.swift",182)},processFormaClick:function(e){var t;if((t=i.opt(this.forma,(function(e){return e.parent})))&&t.kind==h.FrameForma.KIND)return e.forma=t,void i.opt(t.controller,(function(t){return t.processFormaClick(e)}));u.FormaController.prototype.processFormaClick.call(this,e)},processEvent:function(e){var t;return(t=i.as(e,m.BeginPointerTrackingEvent))?(i.opt(t.selectionState,(function(e){return 1==e.inCropMode}))?t.trackingResponse=d.BeginPointerTrackingResponseEnum.TrackWithinGroup:t.trackingResponse=d.BeginPointerTrackingResponseEnum.TrackAsGroup,!1):u.FormaController.prototype.processEvent.call(this,e)},processEndFormaDrag:function(e){var t;u.FormaController.prototype.processEndFormaDrag.call(this,e),(t=i.as(i.opt(i.opt(this.forma,(function(e){return e.parent})),(function(e){return e.controller})),c.FrameController))&&t.fitChildrenToFrame()},afterProcessEndFormaDrag:function(e){var t;g.ImageFacade.inCropMode(this.forma)||(t=i.as(i.opt(i.opt(this.forma,(function(e){return e.parent})),(function(e){return e.controller})),c.FrameController))&&t.fitChildrenToFrame()},processFormaDoubleClick:function(e){var t;g.ImageFacade.inCropMode(this.forma)||((t=i.opt(this.forma,(function(e){return e.parent})))&&t.kind==h.FrameForma.KIND&&(e.forma=t),this.owner.selection.replaceSelection(e.forma),this.owner.selection.isSelected(e.forma)&&(this.owner.controllerSettingsState.settings=new l.ImageControllerSettings(this)))},fit:function(e){var t,r;(t=this.forma)&&(t.placement=C.Matrix2D.Identity,(r=t.frame)&&(y.TransformFacade.scaleForma(t,r.aspectRatio>=1?e.width/r.width:e.height/r.height),t.moveCenterToPoint(e.center)),this.updateParentGroup())},internalShuffleColorAssignment:function(e){var t;if(t=this.forma){if(t.isLogo())return;var r,o;if((r=i.as(t.style,p.ImageStyle))&&r.isColorizedFilter&&(o=t.page.imageFilterLibrary.getNextImageStyleOfSameType(r,!1))){var n,a;if(null!=(n=o.colors.colorID(s.ColorRole.FieldPrimary))){var l=e?(new F.ProfilingColorMap).overridePaletteMappingDueToContrast(n,t.formaID):n;o.colors.setColorIDs([{key:s.ColorRole.FieldPrimary,value:l}])}null!=(a=o.colors.colorID(s.ColorRole.FieldSecondary))&&(l=e?(new F.ProfilingColorMap).overridePaletteMappingDueToContrast(a,t.formaID+F.ProfilingColorMap.backingColorKey):a,o.colors.setColorIDs([{key:s.ColorRole.FieldSecondary,value:l}])),t.applyStyle(o)}}},shuffleColorAssignment:function(){this.internalShuffleColorAssignment(!0)},shuffleColorAssignmentForAnimation:function(){this.internalShuffleColorAssignment(!1)}}}),o)},"Pil/":function(e,t,r){var o,n,i,a,l,s,u,c,d,m,h,f,g,p=t,v=r("oAGj"),C=r("+nk0"),F=r("FNB+"),y=r("yHU1");p.FormaControllerEvent=(o=function(){},v.defineClass({name:"FormaControllerEvent",ctor:o,superName:"ControllerEvent",props:{forma:{get:function(){return v.first(this.formae)},set:function(e){v.eq(F._equality_Forma_Forma,v.first(this.formae),e)||(this.formae[0]=e)}},init_939b:function(e,t){this.formae=v.clone(t),C.ControllerEvent.call(this,e)},init_83ea:function(e,t){this.init_939b(e,[t])}}}),o),p.PSMFormaControllerEvent=(n=function(){},v.defineClass({name:"PSMFormaControllerEvent",ctor:n,superName:"FormaControllerEvent",props:{init_939b:function(e,t){v.super_init(this,p.FormaControllerEvent,p.FormaControllerEvent.prototype.init_939b,e,v.clone(t))},init_83ea:function(e,t){v.super_init(this,p.FormaControllerEvent,p.FormaControllerEvent.prototype.init_83ea,e,t)}}}),n),p.BeginPointerTrackingEvent=(i=function(){this.trackingResponse=y.BeginPointerTrackingResponseEnum.TrackAsGroup},v.defineClass({name:"BeginPointerTrackingEvent",ctor:i,superName:"PSMFormaControllerEvent",statics:{TYPE:{get:function(){return"BeginPointerTrackingEvent"}}},props:{dragTargetForma:{get:function(){return v.first(this.dragTargetFormae)},set:function(e){v.eq(F._equality_Forma_Forma,v.first(this.dragTargetFormae),e)||(this.dragTargetFormae[0]=e)}},init_bef7:function(e,t,r){this.dragTargetFormae=v.clone(t),this.selectionState=r,v.super_init(this,p.PSMFormaControllerEvent,p.PSMFormaControllerEvent.prototype.init_939b,i.TYPE,[e])},init_e511:function(e,t,r){this.init_bef7(e,[t],r)}}}),i),p.PSMFormaDragControllerEvent=(a=function(e,t){this.drag=t,this.dragDelegate=t.activeDragDelegate,v.super_init(this,p.PSMFormaControllerEvent,p.PSMFormaControllerEvent.prototype.init_939b,e,v.clone(this.dragDelegate.draggedFormae))},v.defineClass({name:"PSMFormaDragControllerEvent",ctor:a,superName:"PSMFormaControllerEvent"}),a),p.BeginFormaDragEvent=(l=function e(t){p.PSMFormaDragControllerEvent.call(this,e.TYPE,t)},v.defineClass({name:"BeginFormaDragEvent",ctor:l,superName:"PSMFormaDragControllerEvent",statics:{TYPE:{get:function(){return"BeginFormaDragEvent"}}}}),l),p.FormaDragEvent=(s=function e(t){p.PSMFormaDragControllerEvent.call(this,e.TYPE,t)},v.defineClass({name:"FormaDragEvent",ctor:s,superName:"PSMFormaDragControllerEvent",statics:{TYPE:{get:function(){return"FormaDragEvent"}}}}),s),p.EndFormaDragEvent=(u=function e(t){p.PSMFormaDragControllerEvent.call(this,e.TYPE,t)},v.defineClass({name:"EndFormaDragEvent",ctor:u,superName:"PSMFormaDragControllerEvent",statics:{TYPE:{get:function(){return"EndFormaDragEvent"}}}}),u),p.BeginFormaResizeEvent=(c=function e(t,r){this.spot=r,v.super_init(this,p.FormaControllerEvent,p.FormaControllerEvent.prototype.init_939b,e.TYPE,[t])},v.defineClass({name:"BeginFormaResizeEvent",ctor:c,superName:"FormaControllerEvent",statics:{TYPE:{get:function(){return"BeginFormaResizeEvent"}}}}),c),p.FormaResizeEvent=(d=function e(t,r,o){this.newSize=r,this.pin=o,v.super_init(this,p.FormaControllerEvent,p.FormaControllerEvent.prototype.init_939b,e.TYPE,[t])},v.defineClass({name:"FormaResizeEvent",ctor:d,superName:"FormaControllerEvent",statics:{TYPE:{get:function(){return"FormaResizeEvent"}}}}),d),p.EndFormaResizeEvent=(m=function e(t){v.super_init(this,p.FormaControllerEvent,p.FormaControllerEvent.prototype.init_939b,e.TYPE,[t])},v.defineClass({name:"EndFormaResizeEvent",ctor:m,superName:"FormaControllerEvent",statics:{TYPE:{get:function(){return"EndFormaResizeEvent"}}}}),m),p.FormaClickEvent=(h=function e(t){this.modifierKeys={},v.super_init(this,p.PSMFormaControllerEvent,p.PSMFormaControllerEvent.prototype.init_939b,e.TYPE,[t])},v.defineClass({name:"FormaClickEvent",ctor:h,superName:"PSMFormaControllerEvent",statics:{TYPE:{get:function(){return"FormaClickEvent"}}}}),h),p.FormaDoubleClickEvent=(f=function e(t){this.modifierKeys={},v.super_init(this,p.PSMFormaControllerEvent,p.PSMFormaControllerEvent.prototype.init_939b,e.TYPE,[t])},v.defineClass({name:"FormaDoubleClickEvent",ctor:f,superName:"PSMFormaControllerEvent",statics:{TYPE:{get:function(){return"FormaDoubleClickEvent"}}}}),f),p.AddFormaEvent=(g=function e(t){v.super_init(this,p.FormaControllerEvent,p.FormaControllerEvent.prototype.init_939b,e.TYPE,[t])},v.defineClass({name:"AddFormaEvent",ctor:g,superName:"FormaControllerEvent",statics:{TYPE:{get:function(){return"AddFormaEvent"}}}}),g)},ZK0l:function(e,t,r){var o,n=t,i=r("oAGj"),a=r("0wFF"),l=r("SpAV"),s=r("CWW7"),u=r("yGNn"),c=r("ascj"),d=r("FNB+"),m=r("H9Ol"),h=r("6ZWm"),f=r("yHU1"),g=r("Pil/"),p=r("cmoc"),v=r("/afT"),C=r("pnSN"),F=r("X0GW"),y=r("iCxV"),b=r("Qlvz"),I=r("NkBu"),S=r("fdtz"),D=r("lmwz"),T=r("tGKA"),M=r("JFv5"),P=r("voLh"),x=r("DjTP"),_=r("T6jX"),G=r("8t9B"),k=r("mL0c"),R=r("zjod"),w=r("QTen");n.GroupController=(o=function(e,t,r){this.preserveResizeController_=!1,this.resizeLayoutController_=null,this.preferrededResizeType_=null,m.FormaController.call(this,e,t,r)},i.defineClass({name:"GroupController",ctor:o,superName:"FormaController",statics:{KIND:{get:function(){return"group"}},USER_GROUP_PROPERTY:"user-group",isImageOrVideo:function(e){return e.kind==S.ImageForma.KIND||e.kind==R.VideoForma.KIND}},props:{oldBounds:{get:function(){return this.oldBounds_}},updatedChild:{get:function(){return this.updatedChild_},set:function(e){this.updatedChild_=e}},preserveResizeController:{get:function(){return this.preserveResizeController_},set:function(e){this.preserveResizeController_=e}},preferredResizeType:{get:function(){return this.preferrededResizeType_},set:function(e){this.preferrededResizeType_=e}},resizeLayoutController:{get:function(){return this.resizeLayoutController_}},selectable:{get:function(){return this.userGroup}},duplicatable:{get:function(){return this.userGroup}},replaceable:{get:function(){return!1}},userGroup:{get:function(){var e;return!(!(e=i.opt(this.forma,(function(e){return e.hasIntent(d.Forma.INTENT_USER_GROUP)})))&&null==e)&&e}},maintainAspectRatio:{get:function(){if(this.userGroup)return!0;if(this.forma.hasIntent(d.Forma.INTENT_INFERRED_TEMP_GROUP))for(var e=i.iter(this.forma.visitAsArray(d.FormaTraversal.JustChildren));!e.done;e.next()){var t=e.value;if(null!=t.controller&&t.finalFrame.equalWithAccuracy(this.forma.finalFrame,10))return t.controller instanceof G.TypeLockupController||t.controller.maintainAspectRatio}return!1}},clone:function(e){return m.FormaController.prototype.clone.call(this,e)},addFormaToGroup:function(e){var t;(t=i.as(this.forma,C.GroupForma))&&t.appendChild(e,!0)},removeFormaFromGroup:function(e){var t;(t=i.as(this.forma,C.GroupForma))&&(i.opt(i.as(e.controller,o),(function(e){return e.handleRemoval()})),t.removeChild(e))},handleRemoval:function(){},replaceChildWithForma:function(e,t,r){var n,s,u;if(void 0===r&&(r=!1),o.isImageOrVideo(e)&&l.CoreAssert.isTrue(t.kind==e.kind,"replacing an ImageForma or VideoForma with a "+t.kind,"GroupController.replaceChildWithForma","GroupController.swift",198),(u=i.as(this.forma,C.GroupForma))&&null!=(s=u.indexOfChild(e))){u.insertChildAt(t,s),null!=e.allowUserMove&&(t.allowUserMove=e.allowUserMove),t.matchColors(e),t.isLogo()||t.isSticker()||(t.allowUserMove=!1);var m,f,g,v=e.rotationInRadians();if(e.controller.rotate(-v),t.controller.floating&&(t.isLogo()||t.isSticker())?t.controller.fitInArea(e.frame):t.controller.fit(e.frame),t.allowUserMove=e.allowUserMove,t.intent=e.intent,D.ImageFacade.formaHasMask(e)&&(m=D.ImageFacade.getFrameFormaForForma(e))&&(f=i.opt(D.ImageFacade.getFrameFormaForForma(t),(function(e){return e.controller})))&&(g=i.opt(D.ImageFacade.getImageFormaForForma(t),(function(e){return e.controller})))&&m.placement.determinant<0){var F=m.placement.transformValuesRKST.yscale<0;f.flip(F),g.flip(F)}e.controller.rotate(v),t.controller.rotate(v),e.removeFromParent();var M,P=i.clone(t.filterWithCallback(o.isImageOrVideo)),x=i.clone(e.filterWithCallback(o.isImageOrVideo));if(P.length>0){for(var _=i.iter(P);!_.done;_.next()){var G,k,R,A=_.value;if((G=i.as(A,S.ImageForma))&&(k=i.as(A.controller,I.ImageController)))G.hasAlpha()&&e.isBackgroundImage()&&(A.allowUserMove=!1),!G.hasAlpha()||t.isLogo()||t.isSticker()||(R=i.as(t.controller,h.FrameController))&&R.fitWithCrop(e.frame,h.CropType.FitBorder),i.opt(y.Host.logging,(function(e){return e.logToAnalytics(a.AnalyticsConstants.kAnalyticsImageReplaced,{hasAlpha:G.hasAlpha()?"true":"false",isLogo:G.isLogo()?"true":"false",isBackground:k.floating?"false":"true"})}));if(x.length>0){var E,B,N,L,Y=r,U=x[0];if(E=i.as(U,S.ImageForma)){var O,z,X=E.style.clone(),H=i.opt(i.opt(X,(function(e){return e.adjustments})),(function(e){return e.blur}));i.opt(X,(function(e){return e.adjustments=b.ImageAdjustments.createDefault().copyWithNewValues((n=H)||null!=n?n:0)})),(O=i.as(X,w.VideoStyle))&&((z=i.as(A.style,w.VideoStyle))?(O.startTime=z.startTime,O.duration=z.duration):t.kind==S.ImageForma.KIND&&(X=O.downgradeToImageStyle())),A.applyStyle(X)}if(0==Y&&(B=i.opt(i.opt(i.as(A,S.ImageForma),(function(e){return e.contentNode})),(function(e){return e.mediaMetadata})))&&(N=i.opt(i.opt(i.as(U,S.ImageForma),(function(e){return e.contentNode})),(function(e){return e.mediaMetadata})))&&null!=B.assetID&&null!=N.assetID&&B.assetID==N.assetID&&(Y=!0),1==Y){var W=A,q=e.isBackgroundImage()?U:e,K=T.Matrix2D.uniformScaling(W.bounds.aspectRatio>=1?W.bounds.width/q.bounds.width:W.bounds.height/q.bounds.height);W.placement=K.inverse.concat(q.placement)}(L=D.ImageFacade.getMaskFormaForForma(e))&&D.ImageFacade.setMaskForForma(t,L)}}var V;(V=i.as(P[0],S.ImageForma))&&i.opt(i.opt(V.contentNode,(function(e){return e.image})),(function(e){return e.whenLoaded((function(){return V.page.colorLibraryController.extractImageColors()}))}))}(M=i.opt(i.opt(i.opt(this.forma,(function(e){return e.page.document})),(function(e){return e.controller})),(function(e){return e.selection})))&&(M.removeStaleSelections(),M.isSelected(e)&&M.deselectForma(e),l.CoreAssert.isTrue(M.selectedCount==M.asFormaArray().length,void 0,"GroupController.replaceChildWithForma","GroupController.swift",372))}else if(u=i.as(this.forma,p.FrameForma)){var j,Z;null!=e.frame&&i.eq(d._equality_Forma_Forma,D.ImageFacade.getMaskFormaForForma(u),e)&&(D.ImageFacade.setMaskForForma(u,t),null!=e.allowUserMove&&(t.allowUserMove=e.allowUserMove),null!=(j=e.style.colors.colorID(c.ColorRole.FieldPrimary))&&t.style.colors.setColorId(c.ColorRole.FieldPrimary,j),null!=(Z=e.style.colors.colorID(c.ColorRole.FieldSecondary))&&t.style.colors.setColorId(c.ColorRole.FieldSecondary,Z))}},match:function(e){m.FormaController.prototype.match.call(this,e),this.updateGroup()},postClone:function(e){},getPinBounds:function(e){return e==k.PinBoundsType.ChildrenBounds?this.forma.childrenBoundsInCoordSpace(T.Matrix2D.Identity):i.opt(this.forma,(function(e){return e.bounds}))},processEvent:function(e){var t,r,o,n;if(n=i.as(e,g.BeginPointerTrackingEvent)){var a=!(!(t=i.opt(i.opt(this.forma,(function(e){return e.controller})),(function(e){return e.userGroup})))&&null==t)&&t,l=(r=i.opt(i.opt(i.opt(this.forma,(function(e){return e.page.document})),(function(e){return e.controller})),(function(e){return e.selection.selectedCount})))||null!=r?r:0,s=!(!(o=i.opt(i.opt(i.opt(this.forma,(function(e){return e.page.document})),(function(e){return e.controller})),(function(e){return e.selection.isSelected(n.dragTargetForma)})))&&null==o)&&o,u=!1;return l<=1&&s&&(u=this.forma.page.document.controller.enableMoveableChildren),n.trackingResponse=a&&!u?f.BeginPointerTrackingResponseEnum.TrackAsGroup:f.BeginPointerTrackingResponseEnum.TrackWithinGroup,!1}return m.FormaController.prototype.processEvent.call(this,e)},childUpdate:function(e){void 0===e&&(e=null),this.updatedChild_=e,this.updateGroup()},beginChildResizeEvent:function(e){},endChildResizeEvent:function(e){var t,r;((t=i.opt(i.opt(i.opt(this.forma,(function(e){return e.page.document})),(function(e){return e.controller})),(function(e){return e.selection.inCropMode})))||null!=t)&&t||!(r=i.opt(i.opt(this.forma,(function(e){return e.controller})),(function(e){return e.userGroup})))&&null==r||!r||F.GroupFacade.updateUserGroupHierarchy(this.forma)},processBeginFormaResize:function(e){m.FormaController.prototype.processBeginFormaResize.call(this,e),this.preserveResizeController_=!0},processEndFormaResize:function(e){m.FormaController.prototype.processEndFormaResize.call(this,e),this.preserveResizeController_=!1},childMoveableInDirection:function(e,t){return!0},groupVisualParent:{get:function(){return v.GroupDetector.getGroupVisualParent(this.forma)}},processFormaDrag:function(e){m.FormaController.prototype.processFormaDrag.call(this,e)},processBeginFormaDrag:function(e){m.FormaController.prototype.processBeginFormaDrag.call(this,e)},processEndFormaDrag:function(e){m.FormaController.prototype.processEndFormaDrag.call(this,e)},canClaimForma:function(e){return!1},claimForma:function(e){this.forma!=e.parent&&!i.eq(d._equality_Forma_Forma,this.forma,e)&&this.canClaimForma(e)&&i.opt(i.as(this.forma,C.GroupForma),(function(t){return t.appendChild(e,!0)}))},beginUpdateGroup:function(e){void 0===e&&(e=null),null==this.oldBounds_&&(this.oldBounds_=null!=e?e:i.opt(this.forma,(function(e){return e.bounds})),null==this.resizeLayoutController_&&this.setCurrentResizeLayoutController(),i.opt(this.resizeLayoutController_,(function(e){return e.beginUpdateGroup()})))},setCurrentResizeLayoutController:function(){var e=this.preferredResizeType;if(null==e){var t=this.forma.childCount;e=t>_.TheoDocumentUtils.DESIGN_COMPLEXITY_HEURISTIC_THRESHOLD||this.userGroup?M.ResizeLayoutType.Proportional:t<=3||this.kind!=o.KIND?M.ResizeLayoutType.Pin:M.ResizeLayoutType.Spring}e==M.ResizeLayoutType.Pin?this.resizeLayoutController_=new M.PinLayoutController(this.forma):e==M.ResizeLayoutType.Spring?(this.kind==G.TypeLockupController.KIND&&l.CoreAssert.fail("Don't use a spring layout with a typelockup. It's overkill and lockups should be extremely fast.","GroupController.setCurrentResizeLayoutController","GroupController.swift",543),this.resizeLayoutController_=new x.SpringLayoutController(this.forma)):e==M.ResizeLayoutType.Proportional?this.resizeLayoutController_=new P.ProportionalLayoutController(this.forma):(l.CoreAssert.fail("Invalid layout type, defaulting to proportional","GroupController.setCurrentResizeLayoutController","GroupController.swift",552),this.resizeLayoutController_=new P.ProportionalLayoutController(this.forma))},endUpdateGroup:function(){this.oldBounds_=null,i.opt(this.resizeLayoutController_,(function(e){return e.endUpdateGroup()})),this.preserveResizeController_||(this.resizeLayoutController_=null)},updateGroup:function(){this.blockUpdate||null==this.oldBounds_||this.oldBounds_.equal(this.forma.bounds)||(this.beginBlockedUpdate(),i.opt(this.resizeLayoutController_,(function(e){return e.updateGroup()})),this.endBlockedUpdate())},applyColors:function(e,t){if(void 0===t&&(t=c.ColorRole.FieldPrimary),this.userGroup)for(var r=i.iter(this.forma.visitAsArray(d.FormaTraversal.JustChildren));!r.done;r.next()){var o;(o=r.value.controller)&&o.applyColors(i.clone(e),t)}else m.FormaController.prototype.applyColors.call(this,i.clone(e),t)},currentOpacity:{get:function(){for(var e,t=[],r=i.iter(this.forma.visitAsArray(d.FormaTraversal.JustChildren));!r.done;r.next()){var o=r.value,n=(e=i.opt(o.controller,(function(e){return e.currentOpacity})))||null!=e?e:1;t.includes(n)||t.push(n)}return t.length>0?t.length>1?1:t[0]:1}},applyOpacity:function(e){if(this.userGroup)for(var t=i.iter(this.forma.visitAsArray(d.FormaTraversal.JustChildren));!t.done;t.next()){var r;(r=t.value.controller)&&r.applyOpacity(e)}else m.FormaController.prototype.applyOpacity.call(this,e)},copyTo:function(e){void 0===e&&(e=null);var t,r=this;return this.userGroup?(t=i.as(this.forma,C.GroupForma))?s.CreationFacade.copyItems(i.clone(t.childrenAsArray),e).then((function(e){return F.GroupFacade.groupItems(i.clone(e))})).then((function(e){var t;return(t=i.as(e,d.Forma))?(t.match(r.forma),t):null})):u.CorePromise.reject("Should never get here. GroupController must have a GroupForma"):m.FormaController.prototype.copyTo.call(this,e)},contrastCheck:function(e){if(void 0===e&&(e=!0),this.userGroup)for(var t=i.iter(this.forma.visitAsArray(d.FormaTraversal.JustChildren));!t.done;t.next()){var r;(r=t.value.controller)&&r.contrastCheck(e)}else m.FormaController.prototype.contrastCheck.call(this,e)}}}),o)},mL0c:function(e,t,r){var o,n=t,i=r("oAGj"),a=r("tGKA"),l=r("oKlP");n.PinBoundsType=i.defineEnum("PinBoundsType",{ChildrenBounds:0,Bounds:1}),n.TheoPin=(o=function(e,t,r,o,n,i,a,l,s,u){void 0===l&&(l=0),void 0===s&&(s=0),void 0===u&&(u=!1),this.forma=e,this.pinType=t,this.pinPoint=r,this.referenceForma=o,this.referencePinType=n,this.referencePoint=i,this.targetHeight=a,this.absoluteHeightDistance=l,this.relativeHeightDistance=s,this.useAbsoluteHeight=u,this.containedInParent=e.parent.finalFrame.insetRel(-.1,-.1,-.1,-.1).contains(e.finalFrame)},i.defineClass({name:"TheoPin",ctor:o,superName:"CoreObject",statics:{evalPinPoint:function(e,t,r){var o;if(o=i.opt(e.controller,(function(e){return e.getPinBounds(t)}))){var n=o.eval(r);return e.totalPlacement.transformPoint(n)}return null}},props:{offset:function(){var e,t,r;if((e=o.evalPinPoint(this.forma,this.pinType,this.pinPoint))&&(t=o.evalPinPoint(this.referenceForma,this.referencePinType,this.referencePoint))&&null!=(r=i.opt(this.referenceForma.controller,(function(e){return e.currentHeightScale})))){var n=this.useAbsoluteHeight?this.absoluteHeightDistance:r*this.relativeHeightDistance,a=1==this.pinPoint.y?-1:1;return new l.TheoPoint(t.x-e.x,t.y-e.y+a*n)}return l.TheoPoint.ZERO},offsetMatrix:function(){var e=this.offset(),t=l._minus_TheoPoint_TheoPoint(this.forma.totalPlacement.inverse.concat(this.forma.placement).transformPoint(e),this.forma.totalPlacement.inverse.concat(this.forma.placement).transformPoint(l.TheoPoint.ZERO));return a.Matrix2D.translation(t)},isRelativePin:{get:function(){return 0!=this.absoluteHeightDistance||0!=this.relativeHeightDistance}}}}),o)},"uxH+":function(e,t,r){var o,n=t,i=r("oAGj"),a=r("SpAV"),l=r("yhkb"),s=r("AVHO"),u=r("ascj"),c=r("FNB+"),d=r("cmoc"),m=r("9Lk3"),h=r("ZK0l"),f=r("pnSN"),g=r("fdtz"),p=r("8t9B"),v=r("3UhB");n.RootController=(o=function(e,t,r){h.GroupController.call(this,e,t,r)},i.defineClass({name:"RootController",ctor:o,superName:"GroupController",statics:{KIND:{get:function(){return"root"}}},props:{selectable:{get:function(){return!0}},moveable:{get:function(){return!1}},deleteable:{get:function(){return!1}},flippable:{get:function(){return!1}},nudgeable:{get:function(){return!1}},replaceable:{get:function(){var e=i.clone(this.forma.filterByControllerKind(m.GridController.KIND)),t=i.clone(this.forma.filterWithCallback((function(e){return e.isBackgroundImage()})));return 0==e.length&&0==t.length}},processFormaDoubleClick:function(e){this.owner.controllerSettingsState.settings=new s.RootControllerSettings(this)},getSuggestableColors:function(){for(var e=i.clone(h.GroupController.prototype.getSuggestableColors.call(this)),t=i.iter(this.forma.filterWithCallback((function(e){return e.isTypeLockup()})));!t.done;t.next()){var r,o=t.value;if(r=i.as(o.controller,p.TypeLockupController)){var n=r.lockupStyle.colors.fieldPrimary;if(r.textBacked&&(n=r.lockupStyle.colors.fieldSecondary),null!=n){for(var a=[],l=i.iter(e);!l.done;l.next()){var s=l.value;s[0].rgbColor.contrasts(n,!1)&&a.push(i.clone(s))}return a}}}return e},suggestTransparentBackground:function(){var e=i.clone(v.TypeLockupUtils.getFullCanvasLockups(this.forma));if(e.length>0&&i.opt(e[0].lockupStyle,(function(e){return 1==e.backingOpacity})))return!0;var t,r=this.forma.filterWithCallback((function(e){var t,r;return!(!(t=i.as(e,g.ImageForma))||!(r=i.as(e.parent,d.FrameForma)))&&!t.hasAlpha()&&r.isBackgroundImage()})).length,o=1,n=i.clone(this.forma.filterByControllerKind(m.GridController.KIND));return!(n.length>0&&(t=i.as(n[0].controller,m.GridController))&&(o=t.gridStyle.gridCells.length,t.margin>.01))&&(0==r&&1==o)},setBackgroundTransparency:function(e){var t=this;i.opt(this.forma,(function(r){return r.style.colors.fieldPrimary=i.opt(i.opt(t.forma,(function(e){return e.style.colors.fieldPrimary})),(function(t){return t.withAlphaOf(e)}))}));for(var r=i.iter(this.forma.filterWithCallback((function(e){return m.GridController.isBackgroundColoredCell(e)})));!r.done;r.next())r.value.style.opacity=e},getBackgroundTransparency:function(){var e;return(e=i.opt(i.opt(this.forma,(function(e){return e.style.colors.fieldPrimary})),(function(e){return e.alpha})))||null!=e?e:1},createGridControllerIfNone:function(){var e=i.clone(this.forma.filterByControllerKind(m.GridController.KIND));return 0==e.length&&(this.applyGridStyle(this.owner.document.gridLibrary.basicFullDesignGridStyle()),e=i.clone(this.forma.filterByControllerKind(m.GridController.KIND))),e.length>0?i.as(e[0].controller,m.GridController):null},getGridController:function(){var e=i.clone(this.forma.filterByControllerKind(m.GridController.KIND));return e.length>0?i.as(e[0].controller,m.GridController):null},applyGridStyle:function(e,t){void 0===t&&(t=0);var r=i.clone(this.forma.filterByControllerKind(m.GridController.KIND));r.length>1&&a.CoreAssert.fail("can't have more than one grid at the moment","RootController.applyGridStyle","RootController.swift",163);var o=null,n=!1;if(0==r.length){var s=this.forma.root.page.createFormaWithController(f.GroupForma.KIND,m.GridController.KIND);s.applyStyle(this.owner.document.gridLibrary.basicFullDesignGridStyle()),this.forma.insertChildAt(s,0),o=i.as(s.controller,m.GridController),a.CoreAssert.isTrue(i.opt(i.opt(o,(function(e){return e.gridStyle})),(function(e){return 1==e.gridCells.length})),"Created a brand new grid controller. Why isn't there 1 grid cell?","RootController.applyGridStyle","RootController.swift",177),n=!0}else o=i.as(r[0].controller,m.GridController);o.beginBlockedUpdate();var d=i.opt(this.forma,(function(e){return e.bounds}));o.forma.bounds=d;for(var h=i.iter(this.forma.visitAsArray(c.FormaTraversal.JustChildren));!h.done;h.next()){var g=h.value;i.eq(c._equality_Forma_Forma,g,o.forma)||(g.controller.moveable?o.forma.appendChild(g):o.forma.insertChildAt(g,0))}if(o.endBlockedUpdate(),o.applyStyle(e,t),n){var p,v=o.gridStyle.gridCells[0];null!=(p=this.forma.style.colors.colorID(u.ColorRole.FieldPrimary))&&(o.gridStyle.updateCell(v,null,p,null),p!=l.ColorLibraryController.BLACK_KEY&&this.forma.style.colors.setColorId(u.ColorRole.FieldPrimary,"themeColor0"==p?"themeColor1":"themeColor0"),i.opt(o,(function(e){return e.updateGroup()})))}}}}),o)}}]);
//# sourceMappingURL=vendors_npm_spark_d441b764-48cb7e89.js.map