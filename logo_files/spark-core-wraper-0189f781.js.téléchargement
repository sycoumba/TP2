(window.webpackJsonp=window.webpackJsonp||[]).push([["spark-core-wraper"],{289:function(e,t,r){"use strict";r.r(t);var o=r(33),n=r(29),i=r(631),a=r(1),s=r(7),c=(r(8),r(39)),l=r(958),d=r(550),u=r(630),h=(r(763),new(function(){function e(){o(this,e),this._onSyncModeSet=this._onSyncModeSet.bind(this),this._onSyncTimer=this._onSyncTimer.bind(this),this._handleStorageSyncNow=this._handleStorageSyncNow.bind(this)}return n(e,[{key:"_handleSparkAssetUpdated",value:function(e){var t=this.getLocalProjectById(e.get("id"));if(t)t.name=e.get("name");else{var r=this.getCurrentFolder();this.createProject(e,r).then((function(e){}))}}},{key:"attach",value:function(){return this._isListening||(this._isListening=!0,window.marvel.events.on("set-sync-mode",this._onSyncModeSet),window.marvel.events.on("storage-sync-now",this._handleStorageSyncNow),this._handleSparkAssetUpdated=this._handleSparkAssetUpdated.bind(this),window.marvel.events.on("folder-document-updated",this._handleSparkAssetUpdated)),l.a.attach(this)}},{key:"_detach",value:function(){this._isListening&&(this._isListening=!1,this._syncInProgressKey=null,this._syncTimer=null,this._syncInProgress=null,this._currentFolderSpec=null,window.marvel.events.off("set-sync-mode",this._onSyncModeSet))}},{key:"isSpecCurrent",value:function(e){return e&&this._currentFolderSpec&&e===this._currentFolderSpec.getKey()}},{key:"_handleStorageSyncNow",value:function(){this._clearSyncTimer(),this._onSyncTimer()}},{key:"_onSyncTimer",value:function(e){var t=this,r=e||0;if(!this.isSpecCurrent(this._syncInProgressKey)){this._currentFolderSpec||(this._currentFolderSpec=new u.a);var o=this._currentFolderSpec.getKey();this._syncInProgressKey=o,this._syncInProgress=l.a.refreshOrganizer(this._currentFolderSpec).then((function(){t.isSpecCurrent(o)&&(t._syncInProgressKey=null,t._syncTimer=null,t._setSyncTimer())}),(function(e){t._syncInProgressKey=null;var o=0;r>1&&(o=500*Math.pow(2,r)),o>3e5?(window.marvel.logger.error("[Core:Folders] ACPSparkController abandoning refresh after "+r+" attempts, notifying user"),window.marvel.events.trigger("service-borked")):window.setTimeout((function(){t._onSyncTimer(r+1)}),o)})).done()}}},{key:"_setSyncTimer",value:function(){this._syncTimer||(this._syncTimer=window.setTimeout(this._onSyncTimer,12e4))}},{key:"_clearSyncTimer",value:function(){this._syncTimer&&(window.clearTimeout(this._syncTimer),this._syncTimer=null)}},{key:"isEditorOpen",value:function(){return"sync-editor"===this._syncMode}},{key:"_onSyncModeSet",value:function(e){e&&("sync-group"===e.mode&&"sync-group"!==this._syncMode&&(this._clearSyncTimer(),e.folderSpec&&(this._currentFolderSpec=e.folderSpec),this._onSyncTimer(),"sync-home"!==this._syncMode&&window.marvel.events.trigger("left-editing-session",{})),"sync-home"===e.mode?("sync-editor"===this._syncMode&&this._onSyncTimer(),this._clearSyncTimer(),e.previousFolderCallback&&e.previousFolderCallback(this._currentFolderSpec),e.folderSpec&&(this._currentFolderSpec=e.folderSpec)):"sync-group"===e.mode?(e.folderSpec&&(this._currentFolderSpec&&this._currentFolderSpec.getKey()===e.folderSpec.getKey()||this._clearSyncTimer(),this._currentFolderSpec=e.folderSpec),this._setSyncTimer()):"sync-editor"!==e.mode&&"sync-disabled"!==e.mode||this._clearSyncTimer(),this._syncMode=e.mode)}},{key:"_resetODB",value:function(){s.getAccessToken().then((function(e){window.fetch("/sp-storage/folders",{method:"DELETE",headers:new window.Headers({"x-access-token":e})}).then((function(e){marvel.navigate("/",{trigger:!0}),window.location.reload()})).catch((function(e){window.marvel.logger.warn("[Core:Folders] ACPSparkController failed to reset ODB",e)}))}))}},{key:"getCurrentFolder",value:function(){return this._currentFolderSpec?this.getLocalFolderById(this._currentFolderSpec.getFolderId()):null}},{key:"getLocalFolderById",value:function(e){return l.a.getLocalFolderById(e)}},{key:"getLocalProjectById",value:function(e){return l.a.getLocalProjectById(e)}},{key:"discoverFolder",value:function(e){return l.a.setCurrentSpec(e),l.a.attach(this).then((function(){return l.a.loadFolder(e)}))}},{key:"getLatestProjects",value:function(e){return l.a.attach(this).then((function(){return l.a.getLatestProjects(e)}))}},{key:"loadMoreProjects",value:function(e){return l.a.loadMoreProjects(e)}},{key:"createFolder",value:function(e,t){return c.load().then((function(r){return r.ActionController.execAction({title:"Create Folder: "+e,do:function(r){return l.a.authFetchJSON({method:"POST",uri:"/sp-storage/folders",body:{parentFolderId:t.id,name:e}}).then((function(r){var o=t.getDiscoveryContext(),n=l.a.folderFactory({id:r.id,parentFolder:t,name:e},t);return o.addFolderLocal(n),window.marvel.events.trigger("odb-folders-changed",{added:[n]}),window.marvel.logger.info('[Core:Folders] Created new folder "'+e+'" in folder id: '+t.id),n}))},retry:function(r,o){return window.marvel.logger.warn('[Core:Folders] Retrying to create new folder "'+e+'" in folder id: '+t.id),r.retryConflicts(o,1)}})}))}},{key:"deleteSubfolder",value:function(e,t){return c.load().then((function(r){return r.ActionController.execAction({title:"Delete Folder",do:function(r){return l.a.flushFolderWithId(t),window.marvel.logger.info("[Core:Folders] Deleting folder id: "+t+" from folder id: "+e.id),l.a.authFetch({method:"DELETE",uri:"/sp-storage/folders/"+e.id+"/"+t})},retry:function(r,o){return window.marvel.logger.warn("[Core:Folders] Retrying to delete folder id: "+t+" from folder id: "+e.id),r.retryConflicts(o,1)}})}))}},{key:"renameFolder",value:function(e,t){var r=e.name;return e.setName(t),c.load().then((function(o){return o.ActionController.execAction({title:"Rename folder to "+t,do:function(o){return l.a.authFetchJSON({method:"POST",uri:"/sp-storage/patch-folder/"+e.id,body:{name:t}}).then((function(o){window.marvel.logger.info("[Core:Folders] Folder "+e.id+' renamed from "'+r+'" to "'+t+'"')})).catch((function(t){e.setName(r),window.marvel.logger.warn("[Core:Folders] ACPSparkController failed to rename folder",t)}))},retry:function(o,n){return window.marvel.logger.warn("[Core:Folders] Retrying to rename folder id: "+e.id+' from "'+r+'" to "'+t+'"'),o.retryConflicts(n,1)}})}))}},{key:"removeProjectFromParentFolder",value:function(e){var t=e.parentFolder,r=t.name||"ROOT",o=[];return e.id?(o.push(e.id),c.load().then((function(n){return n.ActionController.execAction({title:"Remove project "+e.name+" from "+r,do:function(n){return l.a.authFetchJSON({method:"POST",uri:"/sp-storage/patch-folder-remove/"+t.id,body:{projects:o}}).then((function(o){window.marvel.logger.info("[Core:Folders] Removed project "+e.name+" from "+r),t.getDiscoveryContext().removeProjectLocal(e)}))},retry:function(t,o){return window.marvel.logger.warn("[Core:Folders] Retrying to remove project "+e.name+" from "+r),t.retryConflicts(o,1)}})}))):(window.marvl.logger.warn("[Core:Folders] removeProjectFromParentFolder received invalid object."),a.reject())}},{key:"removeProjectFromMetaParentFolder",value:function(e){var t=e.metaFolder,r=t&&t.name||"ROOT",o=t&&t.id||"root",n=[];return e.id?(n.push(e.id),c.load().then((function(t){return t.ActionController.execAction({title:"Remove project "+e.name+" from "+r,do:function(t){return l.a.authFetchJSON({method:"POST",uri:"/sp-storage/patch-folder-remove/"+o,body:{projects:n}}).then((function(t){window.marvel.logger.info("[Core:Folders] Removed project "+e.name+" via meta from "+r)}))},retry:function(t,o){return window.marvel.logger.warn("[Core:Folders] Retrying to remove project "+e.name+" via meta from "+r),t.retryConflicts(o,1)}})}))):(window.marvl.logger.warn("[Core:Folders] removeProjectFromMetaParentFolder received invalid object."),a.reject())}},{key:"deleteProjectLocal",value:function(e){e.parentFolder.getDiscoveryContext().removeProjectLocal(e)}},{key:"createProject",value:function(e,t,r){var o=this,n=[e.getMyPrimaryApp().isBranded(e),e.getURN(),e.getImageRendition()];return a.allSettled(n).spread((function(n,i,a){var s=l.a.projectFactory({id:e.id,assetId:i.value,parentFolder:t,metaFolder:r,name:e.getProjectName(),type:e.getDCXComposite().type,modified:e.getContentModifiedDate().toISOString(),thumbnail:a.value||"",eTag:e.getContentModEtag(),isPublished:e.isPublished(),collaboration:e.getCollaboration(),isBranded:n.value,ccpath:e.getStoragePath()});return t&&"root"===t.id?(t.getDiscoveryContext().addProjectLocal(s,!0),s):t?o.move([s],t).then((function(){return s})):s}))}},{key:"_applyMovesToModel",value:function(e,t){i(e,(function(e){e instanceof d.a?(e.parentFolder&&e.parentFolder.getDiscoveryContext().removeFolderLocal(e),t.getDiscoveryContext().addFolderLocal(e)):(e.parentFolder&&e.parentFolder.getDiscoveryContext().removeProjectLocal(e),t.getDiscoveryContext().addProjectLocal(e,!0)),e.parentFolder=t,e.metaFolder={id:t.id,name:"root"!==t.id&&t.name||null}}))}},{key:"move",value:function(e,t){var r=this;return c.load().then((function(o){return o.ActionController.execAction({title:"Move item(s)",do:function(o){var n=[];return e.forEach((function(e){var r={};e.parentFolder?r.oldFolderId=e.parentFolder.id:r.oldFolderId="root",r.newFolderId=t.id,e instanceof d.a?r.folderId=e.id:r.projectId=e.id,n.push(r)})),l.a.authFetchJSON({method:"POST",uri:"/sp-storage/patch-folders",body:{updates:n}}).then((function(){r._applyMovesToModel(e,t);var o=t.name||"Root";return window.marvel.logger.info("[Core:Folders] Moved "+e.length+" project(s) to "+o),t}))},retry:function(r,o){return!(o&&String(o).indexOf("errorCode:412")>=0)&&(window.marvel.logger.warn("[Core:Folders] Retrying to move "+e.length+' items to folder "'+t.name+'"'),r.retryConflicts(o,1))}})}))}},{key:"reset",value:function(){l.a.reset()}},{key:"getCompositeDoc",value:function(e){return l.a.getCompositeDoc(e)}},{key:"addCompositeDocLocal",value:function(e,t){return l.a.addCompositeDocLocal(e,t)}},{key:"organizerIndexNext",value:function(e){var t,r;switch(e){case"rebuildIndex":r=!0;break;case"pageIndex":t=!0;break;default:window.marvel.logger.error("[Core:Folders] Unsupported indexMode "+e)}return c.load().then((function(e){var o={usePageToken:t,forceRebuild:r};return l.a.authFetchJSON({method:"POST",uri:"/sp-storage/index",body:{params:o}}).then((function(e){return window.marvel.logger.info("[Core:Folders] ODB Index Next request completed",e),e}))}))}},{key:"listAuthoringContexts",value:function(e,t){return this.attach().then((function(){return l.a.getLocalAuthoringContextList(e).then((function(e){return e}))}))}},{key:"setAllProjectsCount",value:function(e){this._allProjectsCountDefer&&(this._allProjectsCountDefer.resolve(e),this._allProjectsCountDefer=null),this._allProjectsCount=e}},{key:"getAllProjectsCount",value:function(){return this._allProjectsCountDefer||void 0!==this._allProjectsCount?a.resolve(this._allProjectsCount):(this._allProjectsCountDefer=a.defer(),this._allProjectsCountDefer.promise)}},{key:"isOrganizerIndexing",value:function(){return l.a.getOrganizerIndexingWorking()}},{key:"getOrganizerIndexingPromise",value:function(){return l.a.getOrganizerIndexingPromise()}}]),e}())),f=function(){function e(t){o(this,e),this.title=t.title,this.fnDo=t.do,this.fnRetry=t.retry,this.defer=a.defer(),this._tried=0}return n(e,[{key:"do",value:function(){return this._tried++,this.fnDo(this)}},{key:"retry",value:function(e){return!!this.fnRetry&&this.fnRetry(this,e)}},{key:"retryDelay",value:function(){var e=this._tried-1;return e>0?500*Math.pow(e,2):0}},{key:"retryConflicts",value:function(e,t){return!!(e&&String(e).indexOf("errorCode:409")>=0&&this._tried<=t)}}]),e}();f.COMPONENT_NAME="spark-action";var g=f,m=function(){function e(){o(this,e),this._actionQueue=[],this._currentIndex=0,this._actionOutstanding=null}return n(e,[{key:"busy",value:function(){return!!this._actionOutstanding}},{key:"_nextAction",value:function(){this._actionOutstanding=null,this._currentIndex++,this._action()}},{key:"_handleOnlineError",value:function(e){var t=this;this._actionOutstanding.retry(e)?window.setTimeout((function(){window.marvel.logger.debug("retrying action "+t._actionOutstanding.title),t._actionOutstanding=null,t._action()}),this._actionOutstanding.retryDelay()):(this._actionOutstanding.defer.reject(e),this._nextAction())}},{key:"_action",value:function(){var e=this;!this._actionOutstanding&&this._actionQueue[this._currentIndex]&&(this._actionOutstanding=this._actionQueue[this._currentIndex],this._actionOutstanding.do().then((function(t){e._actionOutstanding.defer.resolve(t),e._nextAction()}),(function(t){s.checkIsOffline().then((function(r){r?window.marvel.logger.warn("suspending action processing due to being offline"):e._handleOnlineError(t)}))})).done())}},{key:"execAction",value:function(e){var t=new g(e);return this._actionQueue[this._actionQueue.length]=t,this._action(),t.defer.promise}}]),e}();m.COMPONENT_NAME="action-controller";var v=m;h.attach();t.default={ACPSparkController:h,ActionController:new v,SparkFolderDiscoverySpec:u.a,SparkStorageLoader:l.a}},550:function(e,t,r){"use strict";var o=r(33),n=r(29),i=r(630),a=r(957),s=(r(763),"root"),c=function(){function e(t,r){o(this,e),this._controller=r;var n=t||{};n.discoverySpec?this.id=n.discoverySpec.getFolderId():this.id=n.id,this.isFolder=!0,this.parentFolder=n.parentFolder||null,this.name=n.name,this.id!==s||this.name||(this.name="Projects"),n.discoverySpec||(n.discoverySpec=new i.a(null,null,null,null,this.id)),this._discoveryContext=new a.a(n.discoverySpec,r),this._discoveryContext.getSpec().folder=this,void 0!==n.folderCount&&(this._discoveryContext.totalFolders=n.folderCount),void 0!==n.projectCount&&(this._discoveryContext.totalProjects=n.projectCount)}return n(e,[{key:"refreshInfo",value:function(e){return e.name!==this.name&&(this.name=e.name,!0)}},{key:"setName",value:function(e){this.name=e}},{key:"setSpec",value:function(e){this._discoveryContext.setSpec(e)}},{key:"getSpec",value:function(){return this._discoveryContext.getSpec()}},{key:"delete",value:function(){return this._controller.deleteSubfolder(this.parentFolder,this.id)}},{key:"rename",value:function(e){return this._controller.renameFolder(this,e)}},{key:"getDiscoveryContext",value:function(){return this._discoveryContext}},{key:"move",value:function(e){return this._controller.move([this],e)}},{key:"getDisplayName",value:function(){return this.name}}]),e}();c.COMPONENT_NAME="spark-folder",t.a=c},630:function(e,t,r){"use strict";var o=r(33),n=r(29),i="root",a=function(){function e(t){o(this,e);var r=t||{};this._filter=r.filter,this._incomingCollabOnly=r.incomingCollabOnly,this._sort=r.sort,this._sortDirection=r.sortDirection,this._folderId=r.folderId||i,this._useFlatApi=r.useFlatApi||!1}return n(e,[{key:"getKey",value:function(){return this.getFolderId()+this.getFilter()+this.getIncomingCollabOnly()+this.getSort()+this.getSortDirection()}},{key:"getFolderId",value:function(){return this._folderId}},{key:"getFilter",value:function(){return this._filter||"all"}},{key:"setFilter",value:function(e){this._filter=e}},{key:"getIncomingCollabOnly",value:function(){return this._incomingCollabOnly||"none"}},{key:"setIncomingCollabOnly",value:function(e){this._incomingCollabOnly=e}},{key:"getSort",value:function(){return this._sort||"modified"}},{key:"setSort",value:function(e){this._sort=e}},{key:"getSortDirection",value:function(){return this._sortDirection||"desc"}},{key:"setSortDirection",value:function(e){this._sortDirection=e}},{key:"getBasePath",value:function(){return this._useFlatApi?"flat":"folders"}}]),e}();a.COMPONENT_NAME="spark-folder-discovery-spec",t.a=a},763:function(e,t,r){"use strict";var o=r(33),n=r(29),i=r(340),a=r(339),s=r(341),c=r(1),l=r(20),d=r(17),u=r(117),h=r(550),f=r(958),g=function(){function e(t,r){o(this,e),this._controller=r,this.id=t?t.id:null,this.assetId=t?t.assetId:null,this.parentFolder=t&&t.parentFolder instanceof h.a?t.parentFolder:null,this.name=t?t.name:"",this.type=t?t.type:null,this.contentModified=t?t.modified:null,this.thumbnail=t?t.thumbnail:"",this.eTag=t?t.eTag:"",this.isPublished=!!t&&!!t.isPublished,this._collaboration=t?t.collaboration:null,this._isBranded=!!t&&t.isBranded,this._ccpath=t?t.ccpath:"",this._sg=t?t._sg:null,this.metaFolder=t?t.metaFolder:null}return n(e,[{key:"isBranded",value:function(){return c.resolve(this._isBranded)}},{key:"isIncomingCollaboration",value:function(){return"INCOMING"===this.getCollaboration()}},{key:"isOutgoingCollaboration",value:function(){return"OUTGOING"===this.getCollaboration()}},{key:"getCollaborationForAnalytics",value:function(){var e=this.getCollaboration();return"INCOMING"===e?"collabRecipient":"OUTGOING"===e?"collabOwner":"collabNone"}},{key:"refreshInfo",value:function(e){var t=!1;return this.name===e.name&&this.contentModified===e.modified&&this.thumbnail===e.thumbnail&&this._isBranded===e.isBranded&&this._collaboration==e.collaboration||(t=!0),this.name=e.name,this.contentModified=e.modified,this.thumbnail=e.thumbnail,this._isBranded=e.isBranded,this._collaboration=e.collaboration,this.eTag=e.eTag,!this.parentFolder&&e.parentFolder&&e.parentFolder instanceof h.a&&(this.parentFolder=e.parentFolder),t}},{key:"getStorageURL",value:function(){return"https://"+window.marvel.settings.ss.replace("-creativesdk","")+"/id/"+this.assetId}},{key:"getStoragePath",value:function(){return this._ccpath}},{key:"getURN",value:function(){return c.resolve(this.assetId)}},{key:"getCompositeDoc",value:function(){var e=this;return f.a.getCompositeDocWithMetadata(this.assetId,{collaboration:this.getCollaboration()}).then((function(t){return t.linkSparkAsset(e),t}))}},{key:"downloadComponents",value:function(e){var t=[],r=e.current.allComponents();return r instanceof Array&&(t=r.map((function(t){return d.getComponent(t,e)}))),c.allSettled(t)}},{key:"updateFromLinkedDoc",value:function(e){var t=this;if(e){this.name=e.getProjectName();var r=e.getImageRendition(400);r&&r.then((function(e){e.url&&(t.thumbnail=e.url)}))}}},{key:"getCollaboration",value:function(){return this._collaboration}},{key:"setCollaboration",value:function(e){this._collaboration!==e&&(this._collaboration=e)}},{key:"getMyApp",value:function(){var e=l.getAppByDocType(this.type);return e||"application/vnd.adobe.ginger.document+dcx"!==this.type||(e=l.getAppByDocType("application/vnd.adobe.ginger.project+dcx")),e}},{key:"getMyPrimaryApp",value:function(){return this.getMyApp()}},{key:"getProjectName",value:function(e){return this.name}},{key:"rename",value:function(e){var t=this;this.name=e,this.getCompositeDoc().then((function(r){t.getMyApp().setProjectName(r,e)}))}},{key:"move",value:function(e){return this._controller.move([this],e)}},{key:"duplicate",value:function(e,t,r){var o=this.getMyApp().getSetting("syncGroup");return this._duplicate(o,e,t,null,r)}},{key:"_duplicate",value:function(e,t,r,o,n){var i=this;return this.getCompositeDoc().then((function(a){var s=a.get("compositeObj");return i.downloadComponents(s).then((function(a){var l=d.newCompositeAsCopyOf(s,o);if(l){var h=new u({name:t,id:l.id,modified:!1,syncGroupName:e,compositeObj:l});h.clearUnneededDuplicationData(),h.getMyApp().usesContentModifiedEtags()&&h.setContentModifiedIfNeeded(),h.getDCXRoot().setValue("name",t);var g=d.AdobeDCXUtil.appendPathElements("assets",e,l.id),m=c.defer();d.dcx.compositeXfer.createComposite(l,g,!1,d.dcxSession,(function(e,t){e?m.reject(e):(h.set("assetId",t),f.a.addCompositeDocLocal(t,h),m.resolve(t))}));return m.promise.then((function(){return d.pushComposite(l,e)})).then((function(){var e=h.getMyApp();return(e.postDuplicate?e.postDuplicate(h):c.resolve()).then((function(){return i._controller.createProject(h,r,n)}))}))}return c.reject(new Error("Failed to duplicate project"))}))}))}},{key:"getContentModifiedDate",value:function(){return this._unZpadDate(this.contentModified)}},{key:"_unZpadDate",value:function(e){var t=Date.parse(e),r=Number(t);if(r==r)return new Date(t);var o,n=e.split("T"),i=1*n[1].substring(0,2);if(i>23){var a=n[0]+"T23"+n[1].substring(2);return(o=new Date(a)).setUTCHours(o.getUTCHours()+(i-23)),o}return new Date}},{key:"belongsToUser",value:function(){return"INCOMING"!==this.getCollaboration()}}]),e}();g.COMPONENT_NAME="spark-asset";var m={voice:"video",theo:"post",slate:"page"},v=function(e){function t(){var e;o(this,t);for(var r=arguments.length,n=new Array(r),s=0;s<r;s++)n[s]=arguments[s];return i(this,(e=a(t)).call.apply(e,[this].concat(n)))}return s(t,e),n(t,[{key:"get",value:function(e){return this[e]?this[e]:null}},{key:"getDisplayName",value:function(){var e=this.getMyApp();return e?e.getProjectName(this):""}},{key:"getItemTypeName",value:function(){var e=this.getMyApp(),t=e?e.getAppTypeID():null;return t?m[t]:"unknown"}},{key:"preflightDuplicateStockImages",value:function(){var e=this;return this.getCompositeDoc().then((function(t){return e.getMyPrimaryApp().batchCheckLicenses(t)}))}}]),t}(g);v.COMPONENT_NAME="spark-project";t.a=v},957:function(e,t,r){"use strict";var o=r(33),n=r(29),i=r(1275),a=r(1277),s=function(){function e(t,r){o(this,e),this._controller=r,this._spec=t,this._sgLastTimestampMap={},this.folderName="",this.breadCrumbs=[],this.reset()}return n(e,[{key:"_makeItemHolder",value:function(){return{loaded:0,total:0,items:[]}}},{key:"reset",value:function(){this._etagBundle="",this._sgLastTimestampMap={},this.localProjects=this._makeItemHolder(),this.localFolders=this._makeItemHolder()}},{key:"_orderItems",value:function(e){var t=[],r=this._spec.getSort(),o=this._spec.getSortDirection();return"modified"===r?(t=e.sort((function(e,t){var r=e.getContentModifiedDate(),o=t.getContentModifiedDate();return r.getTime()<o.getTime()?-1:r.getTime()>o.getTime()?1:0})),"asc"!==o&&t.reverse()):t=a(e,[function(e){return i(e[r]).toLowerCase()},"id"],[o,"asc"]),t}},{key:"_sortItems",value:function(e){var t=this._spec.getSort(),r=this._spec.getSortDirection(),o=[];return o="modified"===t?e.sort((function(e,t){var r=e.getContentModifiedDate(),o=t.getContentModifiedDate();return r.getTime()<o.getTime()?-1:r.getTime()>o.getTime()?1:0})):e.sort((function(e,r){var o=e[t].toLowerCase(),n=r[t].toLowerCase();return o<n?-1:o>n?1:0})),"asc"!==r&&o.reverse(),o}},{key:"setSpec",value:function(e){this._spec&&e.getKey()===this._spec.getKey()||(this._spec=e,this.reset())}},{key:"getSpec",value:function(){return this._spec}},{key:"getPagingToken",value:function(){return this.projects.length>0?this.projects[this.projects.length-1].id:""}},{key:"getEtagBundle",value:function(){return this._etagBundle}},{key:"setEtagBundle",value:function(e){this._etagBundle=e}},{key:"getSgLastTimestampMap",value:function(){return this._sgLastTimestampMap}},{key:"setSgLastTimestampMap",value:function(e){this._sgLastTimestampMap=e||{}}},{key:"_findLocalItem",value:function(e,t){var r=-1;return e.items.forEach((function(e,o){e.id===t.id&&(r=o)})),r}},{key:"_addLocalItem",value:function(e,t){this._findLocalItem(e,t)<0&&(e.items[e.items.length]=t,e.loaded++,e.total++)}},{key:"_removeItemLocal",value:function(e,t){var r=this._findLocalItem(e,t);return r>-1&&(e.items.splice(r,1),e.loaded--,e.total--,!0)}},{key:"addProjectLocal",value:function(e,t){this._addLocalItem(this.localProjects,e),t&&this.sortProjects()}},{key:"addFolderLocal",value:function(e){this._addLocalItem(this.localFolders,e)}},{key:"removeFolderLocal",value:function(e){return this._removeItemLocal(this.localFolders,e)}},{key:"removeProjectLocal",value:function(e){return this._removeItemLocal(this.localProjects,e)}},{key:"sortProjects",value:function(){var e=this._orderItems(this.localProjects.items);this.localProjects.items=e}},{key:"loadMore",value:function(){return this._controller.loadMoreProjects(this)}},{key:"projects",get:function(){return this.localProjects.items}},{key:"folders",get:function(){return this.localFolders.items}},{key:"totalProjects",get:function(){return this.localProjects.total},set:function(e){this.localProjects.total=e}},{key:"totalFolders",get:function(){return this.localFolders.total},set:function(e){this.localFolders.total=e}}]),e}();s.COMPONENT_NAME="spark-folder-discovery-context",t.a=s},958:function(e,t,r){"use strict";var o=r(436),n=r(33),i=r(29),a=r(631),s=r(1287),c=r(1),l=r(7),d=r(39),u=r(8),h=(r(9),r(17)),f=r(20),g=r(117),m=r(957),v=r(630),p=r(550),y=r(763),_=new(function(){function e(){n(this,e),this._handlePreloaderReadyEvent=this._handlePreloaderReadyEvent.bind(this),this.reset(),window.marvel.events.on("document-collaboration-changed",this._handleProjectCollabChange.bind(this))}return i(e,[{key:"reset",value:function(){this._folderPromises={},this._foldersLocal={},this._projectsLocal={},this._currentSpecKey="",this._authoringContextsLocal={},this._compositeDocsLocal={},this._compositeDocPromises={},this._brandsCachePromise=null}},{key:"addCompositeDocLocal",value:function(e,t){this._compositeDocsLocal[e]&&window.marvel.logger.warn("SparkStorageLoader adding local doc that already exists"),this._compositeDocsLocal[e]=t}},{key:"getCompositeDoc",value:function(e){return this.getCompositeDocWithMetadata(e)}},{key:"getCompositeDocWithMetadata",value:function(e,t){var r=this;return this._compositeDocsLocal[e]?c.resolve(this._compositeDocsLocal[e]):this._compositeDocPromises[e]?this._compositeDocPromises[e]:(this._compositeDocPromises[e]=this.createComposite(e,null).then((function(o){var n=f.getAppByDocType(o.type);if(!n)return window.marvel.logger.warn("SparkStorageLoader failed to find app for document type",{type:o.type,id:o.id}),c.reject(new Error("SparkStorageLoader failed to find app for document type"));var i=new g({name:o.current.name,id:o.id,modified:void 0,syncGroupName:n.getSetting("syncGroup"),compositeObj:o});return(t?c.resolve(t):i.discoverDocumentMetadata()).then((function(t){return i.setCollaboration(t.collaboration),delete r._compositeDocPromises[e],r._compositeDocsLocal[e]=i,i}))})).catch((function(t){delete r._compositeDocPromises[e]})),this._compositeDocPromises[e])}},{key:"createComposite",value:function(e,t,r){var o=h.dcx.newCompositeWithAssetId(e);return this._doPullComposite(o,t)}},{key:"_doPullComposite",value:function(e,t){return h.pullComposite(e).then((function(t){return e})).fail((function(e){if("NO_COMPOSITE"===e.code){var t=e.underlyingError&&e.underlyingError.response||{},r={responseStatusCode:t.statusCode,responseStatusText:t.statusText};window.marvel.logger.warn("AUDIT SyncGroup cleaning up deadend composite reference",r)}return c.reject(e)}))}},{key:"_doACCacheInvalidate",value:function(e){try{var t,r=l.getProfile().userId,o=window.localStorage.getItem(r+"aclistcache2");if(o){var n=JSON.parse(o);if(e)for(t=0;t<n.brands.length;t++)n.brands[t].urn===e&&n.brands.splice(t--,1);else n.etag=null;window.localStorage.setItem(r+"aclistcache2",JSON.stringify(n))}}catch(e){window.marvel.logger.warn("[Core:ClientStorage] exception invalidating brand cache",{error:e})}}},{key:"invalidateAuthoringContextCache",value:function(e){var t=this;return this._brandsCachePromise?this._brandsCachePromise.then((function(){t._doACCacheInvalidate(e)})):(this._doACCacheInvalidate(e),c.resolve())}},{key:"flushLocalAuthoringContext",value:function(e){var t=this;return this.invalidateAuthoringContextCache(e).then((function(){t._authoringContextsLocal[e]&&delete t._authoringContextsLocal[e]}))}},{key:"getLocalAuthoringContextList",value:function(e){var t=this;if(this._brandsCachePromise)return this._brandsCachePromise;var r,n,i,a=l.getProfile().userId;if(window.localStorage&&(i=window.localStorage.getItem(a+"aclistcache2"))){try{i=JSON.parse(i)}catch(e){window.marvel.logger.warn("[Core:ClientStorage] exception parsing brand cache",{error:e})}n=i.etag;var s=(new Date).getTime()-i.cacheTime;i.etag&&s<12e4&&(r=c.resolve(i))}if(!r){r=this.authFetchJSON({uri:"/sp-storage/brands",headers:{etag:n}}).then((function(e){if((i=i||{}).cacheTime=(new Date).getTime(),e.noChanges?i.brands=i.brands||[]:(i.etag=e.brandsEtag,i.brands=e.brands,i.brandsToRetry=e.brandsToRetry),window.localStorage)try{window.localStorage.setItem(a+"aclistcache2",JSON.stringify(i))}catch(e){window.marvel.logger.warn("[Core:ClientStorage] exception storing brand cache",{error:e})}return i}))}return this._brandsCachePromise=r.then((function(r){var n={},i=[];return r.brands.forEach((function(r){if(n[r.urn]=!0,t._authoringContextsLocal[r.urn])i.push(t._authoringContextsLocal[r.urn].createPromise.then((function(){t._authoringContextsLocal[r.urn].compositeDoc.setCollaboration(r.collaboration)})));else{var o=c.defer(),a={info:r,createPromise:o.promise};t._authoringContextsLocal[r.urn]=a,i.push(t.createComposite(a.info.urn,a.info.modified).then((function(t){return a.composite=t,a.compositeDoc=new g({name:t.current.name,id:t.assetId,modified:a.info.modified,syncGroupName:"adobe-spark-authoring-contexts",compositeObj:t}),a.compositeDoc.setIsMounted(!0),a.compositeDoc.setCollaboration(a.info.collaboration),a.authoringContext=e(a.compositeDoc),o.resolve(),!0})).catch((function(e){o.reject(e)})))}})),Object.keys(t._authoringContextsLocal).forEach((function(e){n[e]||delete t._authoringContextsLocal[e]})),c.allSettled(i).then((function(e){t._brandsCachePromise=null;var n=[];(Object.entries(t._authoringContextsLocal).forEach((function(e){var t=o(e,2),r=(t[0],t[1]);n.push(r.authoringContext)})),r)&&((new Date).getTime()-r.cacheTime<12e4&&r.brandsToRetry&&r.brandsToRetry.forEach((function(e){t.createComposite(e.urn,e.modified).then((function(t){r.brands.push(e),window.localStorage&&window.localStorage.setItem(a+"aclistcache2",JSON.stringify(r))})).catch((function(t){"NO_COMPOSITE"===t.code?window.marvel.logger.warn("[Client:Storage] brand composite not found",{error:t,urn:e.urn||"UNKNOWN"}):window.marvel.logger.error("[Client:Storage] failed retry for brand composite",{error:t,urn:e.urn||"UNKNOWN"})}))})));return n}))})),this._brandsCachePromise}},{key:"getOrganizerIndexingWorking",value:function(){return this._organizerIndexBackgroundWorking}},{key:"getOrganizerIndexingPromise",value:function(){return this._organizerIndexBackgroundPromise||c.resolve()}},{key:"addLocalProject",value:function(e){this._projectsLocal[e.id]=e}},{key:"getLocalProjectById",value:function(e){return this._projectsLocal[e]}},{key:"flushProjectWithId",value:function(e){var t=this._projectsLocal[e];Object.entries(this._foldersLocal).forEach((function(e){var r=o(e,2),n=(r[0],r[1]);n&&n.getDiscoveryContext().removeProjectLocal(t)})),delete this._projectsLocal[e]}},{key:"getLocalFolderById",value:function(e){return this._foldersLocal[e]}},{key:"flushFolderWithId",value:function(e){var t=this._foldersLocal[e];Object.entries(this._foldersLocal).forEach((function(e){var r=o(e,2),n=(r[0],r[1]);n&&n.getDiscoveryContext().removeFolderLocal(t)})),delete this._foldersLocal[e]}},{key:"folderFactory",value:function(e,t){var r;if(e.discoverySpec)r=e.discoverySpec.getFolderId();else{if(!e.id)throw new Error("Unkown folder model factory ",e);r=e.id}var o=this._foldersLocal[r];return o?e.discoverySpec&&o.setSpec(e.discoverySpec):(o=new p.a(e,this._controller),this._foldersLocal[o.id]=o),t&&(o.parentFolder=t),s(o.name)&&"root"!==o.id&&(o.name=e.name),o}},{key:"loadFolder",value:function(e){var t=this,r=this.folderFactory({discoverySpec:e});if(!this._folderPromises[e.getKey()]){var o=r.getDiscoveryContext();this._folderPromises[e.getKey()]=this.loadMoreProjects(o).then((function(){if(r.name=o.folderName,"root"!==e.getFolderId()&&!r.parentFolder){if(!o.folderParentId)throw new Error("SparkStorageLoader requires parentFolderId to load folder");var n=t.folderFactory({name:o.folderParentName,discoverySpec:new v.a({filter:null,incomingCollabOnly:"none",sort:null,sortDirection:null,folderId:o.folderParentId})});r.parentFolder=n}return r}))}return this._folderPromises[e.getKey()]}},{key:"projectFactory",value:function(e){var t=new y.a(e,this._controller);return this._projectsLocal[e.id]=t,e.parentFolder&&e.parentFolder.getDiscoveryContext().addProjectLocal(t),t}},{key:"getLatestProjects",value:function(e){var t=this,r=4;e>0&&(r=Math.min(e,8));return this.authFetchJSON({uri:"/sp-storage/flat/root/all/all/modified/desc/"}).then((function(e){return e.folderProjects.slice(0,r).map((function(e){var r=t._projectsLocal[e.id];return r?r.thumbnail!==e.thumbnail&&(r.thumbnail=e.thumbnail):r=t.projectFactory(e),r}))}))}},{key:"refreshOrganizer",value:function(e){var t=this;return d.load().then((function(r){return r.ACPSparkController.discoverFolder(e).then((function(n){return r.ActionController.execAction({title:"Refresh organizer",do:function(i){if(!r.ACPSparkController.isSpecCurrent(e.getKey()))return c.resolve();var a=n.getDiscoveryContext(),s=a.getEtagBundle(),l=Math.max(a.projectsDesired||a.projectsFetchedCount,a.projects.length),d=e.getBasePath();u.hasFeature("enable-odb")||(d="flat");var h="/sp-storage/"+d+"/"+e.getFolderId()+"/"+e.getFilter()+"/"+e.getIncomingCollabOnly()+"/"+e.getSort()+"/"+e.getSortDirection()+"?stopCount="+l+"&etagBundle="+s;return t.authFetchJSON({uri:h}).then((function(i){if(!r.ACPSparkController.isSpecCurrent(e.getKey()))return c.resolve();if(!t._organizerIndexBackgroundWorking&&(i.rebuildIndexRequired||i.moreIndexingRequired))return t._handleOdbIndexingBackground(i.rebuildIndexRequired,a).then((function(){return t.refreshOrganizer(e)}));if(i.noChanges)return c.resolve();a.setEtagBundle(i.etagBundle);var s={},l={added:[],updated:[],removed:[]};i.folderProjects.forEach((function(e){var r=t._projectsLocal[e.id];s[e.id]=!0,r?r.refreshInfo(e)&&l.updated.push(r):(e.parentFolder=n,r=t.projectFactory(e),l.added.push(r))})),Object.entries(t._projectsLocal).forEach((function(e){var r=o(e,2),i=r[0],a=r[1];a.parentFolder&&a.parentFolder.id===n.id&&(s[a.id]||(t.flushProjectWithId(i),l.removed.push(a)))})),a.totalProjects=i.totalProjects,l.removed.length&&a.setSgLastTimestampMap(i.sgLastTimestampMap),(l.added.length||l.removed.length||l.updated.length)&&(n.getDiscoveryContext().sortProjects(),window.marvel.events.trigger("odb-projects-changed",l),window.marvel.events.trigger("organizer-reload-datasource"));var d={added:[],removed:[],updated:[]},u={};return i.folders&&i.folders.forEach((function(e){u[e.id]=!0;var r=t._foldersLocal[e.id];r?r.refreshInfo(e)&&d.updated.push(r):(r=t.folderFactory(e,n),a.addFolderLocal(r),d.added.push(r))})),Object.entries(t._foldersLocal).forEach((function(e){var r=o(e,2),i=r[0],a=r[1];a&&!u[i]&&"root"!==i&&n.id===a.parentFolder.id&&(t.flushFolderWithId(i),d.removed.push(a))})),(d.added.length||d.removed.length||d.updated.length)&&(window.marvel.events.trigger("odb-folders-changed",d),window.marvel.events.trigger("organizer-reload-datasource")),c.resolve()}))}})}))}))}},{key:"loadMoreProjects",value:function(e,t,r,o){var n=this;if(this._organizerIndexBackgroundWorking)return window.marvel.logger.info("[Core:Folders] loadMoreProjects while indexing a large account"),this._organizerIndexBackgroundPromise;var i=e.getSpec(),a=i.getBasePath();u.hasFeature("enable-odb")||(a="flat");var c="";if(e instanceof m.a){var l=e.getSgLastTimestampMap();c=this._getTimestampQueryParams(l)}"flat"===a||s(t)||(c=this._getTimestampQueryParams(t)+"&processingMore=true");var d="/sp-storage/"+a+"/"+i.getFolderId()+"/"+i.getFilter()+"/"+i.getIncomingCollabOnly()+"/"+i.getSort()+"/"+i.getSortDirection()+"/"+e.getPagingToken()+c;return this.authFetchJSON({uri:d}).then((function(t){return n._initWithJSON(t,e,r||"loadMoreProjects",o)}))}},{key:"_getTimestampQueryParams",value:function(e){var t=e?Object.keys(e):[],r="";return t.forEach((function(t){r+="&".concat(t,"=").concat(e[t])})),r.replace("&","?")}},{key:"_rerequestPreloader",value:function(){return l.requiresAuth().then((function(){var e=document.createElement("script");e.type="text/javascript",e.src="/sp-storage/organizer?u="+String(Math.round(1e3*Math.random())),document.getElementsByTagName("head")[0].appendChild(e)})).catch((function(e){window.marvel.logger.error("[Client:Storage] unexpected error awaiting auth before reloading preloader",e)}))}},{key:"_initWithPreloader",value:function(){return this._initWithJSON(window._sgPreload||{},null,"preloader")}},{key:"_processAuthoringContextData",value:function(e){if(e.brands){if(window.localStorage){var t=l.getProfile().userId,r=JSON.parse(window.localStorage.getItem(t+"aclistcache2")||"{}");r&&r.etag&&r.etag===e.brandsEtag||(r.cacheTime=(new Date).getTime(),r.etag=e.brandsEtag,r.brands=e.brands,r.brandsToRetry=e.brandsToRetry,window.localStorage.setItem(t+"aclistcache2",JSON.stringify(r)))}}}},{key:"_initWithJSON",value:function(e,t,r,o){var n,i=this,s=t,l=o||[];if(e.noChanges)return c.resolve();if(this._processAuthoringContextData(e),void 0===e.folderProjects)return c.resolve();if(s)n=this.folderFactory({discoverySpec:s.getSpec()});else{var d=new v.a({folderId:e.folderId||"root",incomingCollabOnly:e.incomingCollabOnly||"none",filter:e.filter||"all",sort:e.sort||"modified",sortDirection:e.sortDirection||"desc",useFlatApi:!1===e.foldersEnabled||e.useFlat});n=this.folderFactory({discoverySpec:d}),s=n.getDiscoveryContext(),this._folderPromises[d.getKey()]=c.resolve(n)}if(!this._organizerIndexBackgroundWorking&&(e.rebuildIndexRequired||e.moreIndexingRequired))return window.marvel.logger.info("[Core:Folders] initiate indexing in the background"),this._handleOdbIndexingBackground(e.rebuildIndexRequired,s).then((function(){return i.loadMoreProjects(s)}));var u="".concat(e.folderId).concat(e.filter).concat(e.incomingCollabOnly).concat(e.sort).concat(e.sortDirection);if("preloader"!==r&&this._currentSpecKey!==u)return c.resolve();if(s.folderName=e.folderName,s.folderParentId=e.folderParentId,s.folderParentName=e.folderParentName,s.projectsFetchedCount=e.projectsFetchedCount,s.firstTimeODBUser=e.firstTimeODBUser,s.indexCompletion=e.indexCompletion,s.projectsInAnyFolderTotal=e.projectsInAnyFolderTotal,s.hasMore=e.hasMore,s.setEtagBundle(e.etagBundle),l=l.concat(e.folderProjects),"preloader"!==r&&e.needsMoreProcessing){var h=Object.assign({},e.sgLastTimestampMap,e.moreSgTimeStamp);return window.marvel.logger.info("[Core:Folders] storage result needs more processing, loading more projects",{moreSgTimeStamp:e.moreSgTimeStamp,mergedTimestamps:h,initContext:r,discoveryCtxt:t,projectsWorkingList:l}),this.loadMoreProjects(s,h,"moreProcessing",l)}l.forEach((function(e,t){var r;e.parentFolder=n,i._projectsLocal[e.id]&&(r=i._projectsLocal[e.id]).refreshInfo(e),r?s.addProjectLocal(r):r=i.projectFactory(e)}));var f={};a(this._projectsLocal,(function(e){f[e._sg]=e.contentModified})),s.totalProjects=e.totalProjects,s.setSgLastTimestampMap(f),this._controller.setAllProjectsCount(e.allProjectsCount);var g=e.folders||[];return g.forEach((function(e){var t=i.folderFactory(e,n);s.addFolderLocal(t)})),s.totalFolders=g.length,e.breadCrumbs instanceof Array&&(s.breadCrumbs=e.breadCrumbs),s.sortProjects(),c.resolve()}},{key:"_handleOdbIndexingBackground",value:function(e,t){var r=this;if(this._organizerIndexBackgroundWorking)return window.marvel.logger.warn("[Core:Folders] unexpected duplicate request to index in the background",{stack:(new Error).stack}),this._organizerIndexBackgroundPromise||c.resolve();this._organizerIndexBackgroundWorking=!0;var o="pageIndex";e&&(o="rebuildIndex");var n=d.load().then((function(e){return e.ACPSparkController.organizerIndexNext(o).then((function(e){return r._organizerIndexBackgroundWorking=!1,e.indexCompletion<1&&e.indexProcessedCount>0?(window.marvel.logger.info("[Core:Folders] handleOdbIndexingBackground continues "+e.indexCompletion,e),r._handleOdbIndexingBackground(e.rebuildIndexRequired,t)):(window.marvel.logger.info("[Core:Folders] handleOdbIndexingBackground indexing complete",e),r._organizerIndexBackgroundPromise=null,c.resolve())}))})).catch((function(e){r._organizerIndexBackgroundWorking=!1,r._organizerIndexBackgroundPromise=null,window.marvel.logger.error("[Core:Folders] handleOdbIndexingBackground failed.",e)}));return this._organizerIndexBackgroundPromise||(this._organizerIndexBackgroundPromise=n),n}},{key:"_detach",value:function(){this._attachDefer=null,window.marvel.events.off("sg-preload-ready",this._handlePreloaderReadyEvent)}},{key:"_handlePreloaderReadyEvent",value:function(){var e=this;window._sgPreloadUnauth&&!window._sgPreloaderUnauthRetry?(window._sgPreloaderUnauthRetry=!0,window._sgPreloadUnauth=!1,this._rerequestPreloader()):this._initWithPreloader().then((function(){e._attachDefer.resolve()}),(function(t){e._attachDefer.reject(t)}))}},{key:"_handleProjectCollabChange",value:function(e){var t=e.composite,r=e.collab,o=this._projectsLocal[t.id];if(o){var n=o.getCollaboration();0===r.collaborators.length?o.setCollaboration(void 0):n||o.setCollaboration("OUTGOING")}}},{key:"attach",value:function(e){var t=this;return this._controller=e,this._attachDefer||(this._attachDefer=c.defer(),window._sgPreloadUnauth&&(window._sgPreloadUnauth=!1,this._rerequestPreloader()),window._sgPreload?this._initWithPreloader().then((function(){t._attachDefer.resolve()}),(function(e){t._attachDefer.reject(e)})):window.marvel.events.on("sg-preload-ready",this._handlePreloaderReadyEvent)),this._attachDefer.promise}},{key:"setCurrentSpec",value:function(e){this._currentSpecKey=e.getKey()}},{key:"authFetchJSON",value:function(e){var t;return e.body instanceof String?t=e:(t=Object.assign({},e),t=Object.assign(t,{body:JSON.stringify(e.body)})),t.headers?t.headers["content-type"]||(t.headers["content-type"]="application/json"):t.headers={"content-type":"application/json"},this.authFetch(t).then((function(e){var t=c.defer();return e.json().then((function(e){t.resolve(e)})).catch((function(e){t.reject(e)})),t.promise}))}},{key:"authFetch",value:function(e){return l.requiresAuth().then((function(){return l.getAccessToken().then((function(t){var r=c.defer(),o=Object.assign({},e.headers);return o=Object.assign(o,{"x-access-token":t}),window.fetch(e.uri,{method:e.method||"GET",headers:new window.Headers(o),body:e.body}).then((function(e){if(200===e.status||204===e.status)r.resolve(e);else if(401===e.status)r.reject(new Error("Request auth failed; errorCode:"+e.status+"; errorText:"+e.statusText)),l.clearScope(),window.marvel.events.trigger("spark-auth-failed");else{var t=new Error("Request failed; errorCode:"+e.status+"; errorText:"+e.statusText);t.statusCode=e.status,r.reject(t)}}),(function(e){r.reject(e)})).catch((function(e){r.reject(e)})),r.promise}))}))}}]),e}());t.a=_}}]);
//# sourceMappingURL=spark-core-wraper-0189f781.js.map