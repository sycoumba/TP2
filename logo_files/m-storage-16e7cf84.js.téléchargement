(window.webpackJsonp=window.webpackJsonp||[]).push([["m-storage"],{2439:function(e,t,r){var o,n;o=[r(0)],void 0===(n=function(e){"use strict";var t=!1;function r(){t||(t=!0)}return{applyPatches:r,setStorageInstance:function(e){e,r()}}}.apply(t,o))||(e.exports=n)},273:function(e,t,r){var o,n;o=[r(3),r(0),r(1),r(127),r(7),r(5)],void 0===(n=function(e,t,r,o,n,s){"use strict";return{initializeStorage:function(){var e;return this.dcx=new this.AdobeDCX({xhrBaseBranchSupport:!0}),this.dcxService=this.dcx.createHTTPService((function(t){n.getAccessToken().then((function(r){r===e?(this.logger.error("Storage rejected our token, but IMS says it's valid, giving up!"),t.setAuthToken()):(e=r,t.setAuthToken(r))}))})),n.getAccessToken().then(function(e){this.dcxService.setAuthToken(e),this.dcxService.setApiKey(s.key);var t=this.storageServer;this.dcxSession=this.dcx.createStorageSession(this.dcxService,"https://"+t),this.dcxSession.getCompositeManifestHref=function(e,t,r){r(null,"/id/"+e._assetId+"/:manifest")};var r=this.AdobeDCXUtil.endPointOf,o=this.AdobeDCXUtil.appendPathElements;return this.dcxSession._resolveUrl=function(e){return r(e)?(e.indexOf("cc-api-storage")>=0&&e.indexOf("-creativesdk")<0&&(e=e.replace("cc-api-storage","cc-api-storage-creativesdk")),e):o(this._server,e)}.bind(this.dcxSession),this.dcxSession.getHrefForComposite=function(e,r){return e.href?e.href:this.AdobeDCXUtil.appendPathElements(t,"assets",r,e.id)}.bind(this),this.storageEnabled=!0,this.enabledDefer.resolve(),marvel.events.trigger("storage-enabled",!0),!0}.bind(this))},waitForQuiet:function(e,t){var n=r.defer(),s=0,i=(new Date,function(){(t?t(e):e.isMidCommit()||e._commitQueue.length>0||o.inProgress())||2!=++s?window.setTimeout(i,50):n.resolve(e)});return i(),n.promise}}}.apply(t,o))||(e.exports=n)},274:function(e,t,r){var o,n;o=[r(3),r(0),r(1),r(127),r(7),r(59),r(2439),r(9),r(118)],void 0===(n=function(e,t,r,o,n,s,i,a,c){"use strict";return{installDCX3Shim:function(){i.setStorageInstance(this)},loadBaseBranch:function(e){var t=r.defer();try{e.loadBaseBranch((function(r,o){r?t.reject(r):(o._core._compositeAssetId=e.assetId,t.resolve(o))}))}catch(e){window.marvel.logger.error("dcx-storage-utils unexpected error in loadBaseBranch",e),t.reject(e)}return t.promise},deleteCompositeDoc:function(e){var t=e.get("syncGroupName"),r=e.get("id"),o=this.syncGroups[t];return o&&o.removeCompositeDoc(e),this._deleteComposite(t,r)},_deleteComposite:function(e,t){var o,n=r.defer();return o=-1===t.search(/urn/)?this.AdobeDCXUtil.appendPathElements(this.dcxSession._server,"assets",e,t)+"?recursive=true&invocation_mode=sync":this.AdobeDCXUtil.appendPathElements(this.dcxSession._server,"id",t)+"?recursive=true&invocation_mode=sync",this.logger.info("Invoke DCX DELETE",o),this.dcxSession._service.invoke("DELETE",o,{"If-match":"*"},void 0,void 0,function(e,t){e?(this.logger.error("Delete failed with "+e,e),n.reject(e)):n.resolve()}.bind(this)),n.promise},pullComposite:function(e){return this._pullCompositeWithRetry(e)},_pullCompositeWithRetry:function(e,t){var o="pullComposite";t&&(o="pullCompositeManifestOnly");var n=0;return c(this._pullComposite.bind(this,e,t),{maxAttempts:6,shouldRetry:this._isRetryableError,counter_cb:function(){n++},loggerFn:window.marvel.logger.info.bind(window.marvel.logger),logMessagePrefix:"[Core:ClientStorage] RETRY: "})().then(function(e){return n>0&&window.marvel.logger.info("[Core:ClientStorage] "+o+" succeeded after retry ("+n+")"),e}.bind(this)).catch(function(t){return this._isRetryableError(t)?window.marvel.logger.warn("[Core:ClientStorage] "+o+" gave up after retry",{projectId:e.id,href:e._href,error:t}):t&&"NO_COMPOSITE"===t.code?window.marvel.logger.info("[Core:ClientStorage] "+o+" encountered NO_COMPOSITE error",{projectId:e.id,href:e._href,error:t}):window.marvel.logger.error("[Core:ClientStorage] "+o+" error",{projectId:e.id,href:e._href,error:t}),r.reject(t)}.bind(this))},_isRetryableError:function(e){var t=e&&e.underlyingError||{},r=e.statusCode||t.response&&t.response.statusCode;return e&&(this.DCXRetryCodes().includes(e.code)||500==r||503==r||504==r)},_pullComposite:function(e,t){var o=r.defer();try{this.dcx.compositeXfer.pullCompositeManifestOnly(e,this.dcxSession,function(r,n){var s;r?o.reject(r):t?o.resolve(n):(s=n?e.resolvePullWithBranch(n):e.current,o.resolve(s))}.bind(this))}catch(e){o.reject(e)}return o.promise},pullCompositeManifestOnly:function(e){return this._pullCompositeWithRetry(e,!0)},pushComposite:function(e,t,o){var n=0,s=!1;return c(function(){return this._pushComposite(e,t,s||o)}.bind(this),{maxAttempts:6,shouldRetry:function(t){var r=this._isRetryableError(t);return!r&&t&&"INVALID_STATE"===t.code&&(r=!0,s=!0,this.logger.info("[Core:ClientStorage] pushComposite encountered INVALID_STATE, forcing push",{projectId:e.id,href:e._href,error:t})),r}.bind(this),counter_cb:function(){n++}})().then(function(e){return n>0&&this.logger.info("[Core:ClientStorage] pushComposite succeeded after retry ("+n+")"),e}.bind(this)).catch(function(t){return this._isRetryableError(t)?this.logger.warn("[Core:ClientStorage] pushComposite failed gave up after retry",{projectId:e.id,href:e._href,error:t}):!t||"UPDATE_CONFLICT"!==t.code&&"EXCEEDS_QUOTA"!==t.code?this.logger.error("[Core:ClientStorage] pushComposite failed not retryable",{projectId:e.id,href:e._href,error:t}):"EXCEEDS_QUOTA"===t.code?this.logger.warn("[Core:ClientStorage] pushComposite failed not retryable EXCEEDS_QUOTA",{projectId:e.id,href:e._href,error:t}):this.logger.info("[Core:ClientStorage] pushComposite encountered "+t.code,{projectId:e.id,href:e._href,error:t}),a.trackEvent("core:dcxClientSaveFailure",{},"core:storage"),r.reject(t)}.bind(this))},_pushComposite:function(e,t,o){var n=r.defer();e.href||(e.href=this.dcxSession.getHrefForComposite(e,t));this.dcx.compositeXfer.pushComposite(e,!!o,this.dcxSession,function(t,r){if(t)n.reject(t);else{var o=e.acceptPush();n.resolve(o)}}.bind(this));return n.promise},_convertCanvas:function(e){var t=r.defer();return e.canvas.toBlob(function(e){var r=URL.createObjectURL(e),o=document.createElement("img");o.onload=function(){t.resolve({blob:e,url:r,img:this})},o.onerror=function(){URL.revokeObjectURL(r),t.reject(new Error("StorageDCXUtilsMixin::_convertCanvas::newImage::onerror"))},o.src=r}.bind(this)),t.promise},pushCanvasComponent:function(e,t,r,o){return this._convertCanvas(e.copyFrom).then(function(n){return delete e.copyFrom,e.file=n.blob,this.pushComponent(e,t,r,o)}.bind(this))},_dataURLtoBlob:function(e){var t;t=e.split(",")[0].indexOf("base64")>=0?atob(e.split(",")[1]):window.unescape(e.split(",")[1]);for(var r=e.split(",")[0].split(":")[1].split(";")[0],o=new Uint8Array(t.length),n=0;n<t.length;n++)o[n]=t.charCodeAt(n);return new Blob([o],{type:r})},pushDataUrlComponent:function(e,t,r,o){return e.file=this._dataURLtoBlob(e.copyFrom.url),delete e.copyFrom,this.pushComponent(e,t,r,o)},pushComponentWithoutRetry:function(e,t,r,o){return this._pushComponent(e,t,r,o)},pushComponent:function(e,t,o,n){var s=0;return c(this._pushComponent.bind(this,e,t,o,n),{maxAttempts:6,shouldRetry:this._isRetryableError,counter_cb:function(){s++}})().then(function(e){return s>0&&this.logger.info("[Core:ClientStorage] pushComponent succeeded after retry ("+s+")"),e}.bind(this)).catch(function(e){return this._isRetryableError(e)?this.logger.warn("[Core:ClientStorage] pushComponent failed gave up after retry",{projectId:t.id,href:t._href,error:e}):e&&"EXCEEDS_QUOTA"===e.code?this.logger.warn("[Core:ClientStorage] pushComponent failed not retryable EXCEEDS_QUOTA",{projectId:t.id,href:t._href,error:e}):e&&0===e.readyState?this.logger.info("[Core:ClientStorage] pushComponent failed readyState zero",{projectId:t.id,href:t._href,error:e,statusText:e.statusText}):e&&!0===e.isDownloadErr?this.logger.info("[Core:ClientStorage] pushComponent failed due to download failure",{projectId:t.id,href:t._href,error:e}):this.logger.error("[Core:ClientStorage] pushComponent failed not retryable",{projectId:t.id,href:t._href,error:e}),a.trackEvent("core:dcxClientSaveFailure",{},"core:storage"),r.reject(e)}.bind(this))},_pushComponent:function(e,t,o,n){var s,i,a,c,d=r.defer();try{if(s=e.copyFrom){if("canvas"===s.source)return this.pushCanvasComponent(e,t,o,n);if("dataUrl"===s.source)return this.pushDataUrlComponent(e,t,o,n)}if(i=e.cover,c=function(r,o){if(r)return r.isDownloadErr?415===r.status||404===r.status||410===r.status?this.logger.warn("Upload warning in download with"+r.message,r):this.logger.error("Upload failed in download with "+r.message,r):this.logger.error("Upload failed with "+r,r),d.reject(r);try{var s=t.current;if(n){var i=e.absolutePath||"/"+e.path;a=s.getComponentWithAbsolutePath(i),a=s.updateComponentWithUploadResults(a,o),d.resolve(a)}else a=s.addComponentWithUploadResults(e.name,e.relationship,e.path,e.parent||s.rootNode,o),d.resolve(a)}catch(t){this.logger.error("[Core:ClientStorage] uploadComplete error in _pushComponent:"+e.path+" "+e,{err:t}),t.uploadResults=o,d.reject(t)}}.bind(this),n){var p=e.absolutePath||"/"+e.path;if(a=t.current.getComponentWithAbsolutePath(p))s?this.transload(t,a,s,c):i?this.uploadCover(t,a,i,c):this.dcx.compositeXfer.uploadComponent(a,e.file,t,this.dcxSession,c);else{var l="null component in pushComponent:"+e.path+" "+e;this.logger.error(l),d.reject(new Error(l))}}else s?this.transload(t,e.id,s,c,o):i?this.uploadCover(t,e.id,i,c):this.dcx.compositeXfer.uploadNewComponent(e.file,e.type,t,e.id,this.dcxSession,c)}catch(e){this.logger.error("unexpected error caught in pushComponent",{err:e}),d.reject(e)}return d.promise},transload:function(r,o,s,i,a){var c,d,p,l=s.source;"string"==typeof o?p=o:o?(d=o,p=o.id):p=this.AdobeDCXUtil.generateUuid();switch(l){case"dooplo":c=s.assetId.replace(/^https?\:\/\/[^\.]*\.adobe\.io\/api\/v1\/assets\/([^\/]*)\/.*$/,"$1");break;case"dropbox":c=s.assetId.replace(/^https?\:\/\/[^\/]*\/db_files\/(.*)$/,"$1");break;case"lightroom":c=s.assetId.replace(/^https?\:\/\/[^\/]*\/lr_files\/(.*)$/,"$1");break;case"cc":c=s.assetId.replace(/^https?\:\/\/[^\/]*\/files\/(.*)$/,"$1");break;case"ccl":c=s.assetId;break;case"google drive":c=s.assetId,l="googleDrive";break;case"google photos":c=s.assetId,l="google";break;case"facebook":c=s.assetId,l="facebook";break;case"cp":c=s.assetId;break;default:if(!l){var h=new Error("falsy imageSource in transload: "+l);return this.logger.error(h.message,{err:h,composite:r,copyFrom:s}),i(h)}c=s.assetId}r.href||(r.href=this.dcxSession.getHrefForComposite(r,a));var u={asset_id:c,path:r.href.replace(/^(?:[^\.]*\.adobe\.io)\/([^\#\?]*)([^\#]*)(.*)$/,"$1")+"/"+p,allowedTypes:["image/png","image/jpeg"]},f=this.AdobeDCXUtil.generateUuid(),g={method:"PUT",url:"/transload/"+l,dataType:"json",data:u,beforeSend:function(e){e.setRequestHeader("X-Request-Id",f)},success:function(e,t,o){if(200!=o.status)return i(new Error("Transload came back with "+o.status+" "+o.responseText));var n=new this.AdobeDCXComponent._UploadResults(r.id);n.records[p]=new this.AdobeDCXComponent._UploadRecord(p,o.getResponseHeader("etag"),o.getResponseHeader("x-latest-version"),e.md5,e.size,e.type),i(null,n)}.bind(this),error:function(e){try{var r=JSON.parse(e.responseText||e.response);e.isDownloadErr=r.isDownloadErr,e.message=r.error,e.imageService=l}catch(r){t.extend(e,{data:u,url:"/transload/"+l,requestId:f}),this.logger.error("Bad error response in transload",e)}return n.checkIsOffline(),i(e)}.bind(this)};d&&(g.headers={"If-Match":d.etag}),e.ajax(g)},upload:function(t,r,o,s){var i;i=o?o.id:this.AdobeDCXUtil.generateUuid();var a=new FormData;a.append("path",r.href.replace(/^https?\:\/\/[^\.]*\.adobe\.io\/([^\#\?]*)([^\#]*)(.*)$/,"$1")+"/"+i),a.append("file",t);var c={method:"PUT",url:"/transload/font",dataType:"json",data:a,processData:!1,contentType:!1,success:function(e,t,o){if(200!=o.status&&201!=o.status)return s(new Error("Upload came back with "+o.status+" "+o.responseText));var n=new this.AdobeDCXComponent._UploadResults(r.id);n.records[i]=new this.AdobeDCXComponent._UploadRecord(i,o.getResponseHeader("etag"),o.getResponseHeader("x-latest-version"),e.md5,e.size,e.type),s(null,n)}.bind(this),error:function(e){return n.checkIsOffline(),s(e)}.bind(this)};o&&(c.headers={"If-Match":o.etag}),e.ajax(c)},uploadCover:function(t,r,o,n){var s,i;i="string"==typeof r?r:r?(s=r).id:o.target.split("/")[1];var a={method:"POST",url:"/cover",dataType:"json",data:{source_path:o.source,target_path:o.target,x:o.x,y:o.y,type:o.type},success:function(e,r,o){if(200!=o.status)return n(new Error("Cover came back with "+o.status+" "+o.responseText));var s=new this.AdobeDCXComponent._UploadResults(t.id);s.records[i]=new this.AdobeDCXComponent._UploadRecord(i,o.getResponseHeader("etag"),o.getResponseHeader("x-latest-version"),e.md5,e.size,e.type),n(null,s)}.bind(this),error:function(e){return n(e)}};s&&(a.headers={"If-Match":s.etag}),e.ajax(a)},_stripEtag:function(e){return e&&0===e.indexOf('"')&&(e=e.substring(1)),e&&e.indexOf('"')===e.length-1&&(e=e.substring(0,e.length-1)),e},_privateGetComponentHref:function(e,t){var o=r.defer();return this.dcxSession.getComponentHref(t,void 0,(function(e,t){e?(window.marvel.logger.error("failed to get component href",e),o.reject(e)):o.resolve(t)})),o.promise},getComponentRenditionHref:function(e,t,o,n){var s,i,a=r.defer();return t instanceof this.AdobeDCXComponent?i="/"+(s=t).path:(i=t,s=e.current.getComponentWithAbsolutePath(i)),this.dcxSession.getComponentRenditionHref(s,s.version,o,function(e,t){var r;e?(window.marvel.logger.error("failed to get component rendition href: "+e),a.reject(e)):(0===(t=t.replace(this.storageServer,window.location.host)).indexOf(window.location.host+"/assets/")?(t=t.replace(/\/assets/,"/image_assets"),r=/^(https?\:\/\/[^\/]+\/image_assets\/[^\/]+\/[^\/]+)\/.*$/):(t=t.replace(/\/id/,"/image_assets"),window.marvel.logger.traceflow("dcx-3","getComponentRenditionHref "+JSON.stringify({href:t,componentId:s.id,etag:s.etag})),r=/^(https?\:\/\/[^\/]+\/id\/[^\/]+)\/.*$/),t=t.replace(r,"$1"+i+"?asset_id="+s.id+"&img_etag="+this._stripEtag(s.etag)+"&version="+s.version),n&&(t+="&mime="+encodeURIComponent(n)),a.resolve(t))}.bind(this)),a.promise},_dep_getComponentHref:function(e,t,r,o){var n,s;e instanceof String||"string"==typeof e?(s=e,n=t.current.getComponentWithAbsolutePath(s)):s="/"+(n=e).path;var i=this.dcxSession.getComponentHref(n);if(r){var a;(i=i.replace(this.storageServer,window.location.host)).indexOf("/assets/")>0?(i=i.replace(/\/assets/,"/image_assets"),a=/^(https?\:\/\/[^\/]+\/image_assets\/[^\/]+\/[^\/]+)\/.*$/):(i=i.replace(/\/id/,"/image_assets"),a=/^(https?\:\/\/[^\/]+\/image_assets\/[^\/]+)\/.*$/),i=i.replace(a,"$1"+s+"?asset_id="+n.id+"&img_etag="+this._stripEtag(n.etag));for(var c in o)if(o.hasOwnProperty(c)&&void 0!==o[c]){var d=o[c];i+="&"+encodeURIComponent(c)+"="+encodeURIComponent(d)}}return i},getComponent:function(e,t){var o,s,i=r.defer();return e instanceof this.AdobeDCXComponent?s="/"+(o=e).path:(s=e,o=t.current.getComponentWithAbsolutePath(s)),o?this.dcxSession.getComponent(o,"text",function(e,t){return e?(n.checkIsOffline(),i.reject(e)):200!=t.statusCode?i.reject(new Error("Response for component "+s+" was "+t.statusCode)):void i.resolve(t.responseText)}.bind(this)):i.resolve(),i.promise}}}.apply(t,o))||(e.exports=n)},275:function(e,t,r){var o,n;o=[r(432)],void 0===(n=function(e){return{DCXRetryCodes:function(){return[e.NETWORK_ERROR,e.RETRYABLE_SERVER_ERROR,e.TIMED_OUT,e.UNEXPECTED_RESPONSE,e.COMPONENT_DOWNLOAD_ERROR,e.COMPONENT_UPLOAD_ERROR,e.UNEXPECTED,e.NO_COMPOSITE]}}}.apply(t,o))||(e.exports=n)}}]);
//# sourceMappingURL=m-storage-16e7cf84.js.map